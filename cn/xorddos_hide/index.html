<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>xorddos 样本进程隐藏的小伎俩 | 安全代码</title><meta name="author" content="曼福吉"><meta name="copyright" content="曼福吉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="进程隐藏上周由于工作原因接触到xorddos的样本，这个样本在过去一年的时间里非常常见，变种也很多，拿到的样本比较有趣的是 ps 无法发现进程。 123456789101112131415161718192021[root@localhost ~]# ps -ef  | grep &#x2F;usr&#x2F;bin...root      4597  4594  0 00:37 ?        00:00:00">
<meta property="og:type" content="article">
<meta property="og:title" content="xorddos 样本进程隐藏的小伎俩">
<meta property="og:url" content="https://usmacd.com/cn/xorddos_hide/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="进程隐藏上周由于工作原因接触到xorddos的样本，这个样本在过去一年的时间里非常常见，变种也很多，拿到的样本比较有趣的是 ps 无法发现进程。 123456789101112131415161718192021[root@localhost ~]# ps -ef  | grep &#x2F;usr&#x2F;bin...root      4597  4594  0 00:37 ?        00:00:00">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2023-09-06T03:00:51.915Z">
<meta property="article:modified_time" content="2023-09-06T03:00:51.915Z">
<meta property="article:author" content="曼福吉">
<meta property="article:tag" content="Malware">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "xorddos 样本进程隐藏的小伎俩",
  "url": "https://usmacd.com/cn/xorddos_hide/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2023-09-06T03:00:51.915Z",
  "dateModified": "2023-09-06T03:00:51.915Z",
  "author": [
    {
      "@type": "Person",
      "name": "曼福吉",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/xorddos_hide/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'xorddos 样本进程隐藏的小伎俩',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/self/atom-one-light.css"><link rel="stylesheet" href="/self/nord.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">安全代码</span></a><a class="nav-page-title" href="/"><span class="site-name">xorddos 样本进程隐藏的小伎俩</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">xorddos 样本进程隐藏的小伎俩</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-06T03:00:51.915Z" title="发表于 2023-09-06 11:00:51">2023-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-06T03:00:51.915Z" title="更新于 2023-09-06 11:00:51">2023-09-06</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="进程隐藏"><a href="#进程隐藏" class="headerlink" title="进程隐藏"></a>进程隐藏</h2><p>上周由于工作原因接触到xorddos的样本，这个样本在过去一年的时间里非常常见，<br>变种也很多，拿到的样本比较有趣的是 ps 无法发现进程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]# ps -ef  | grep /usr/bin<br><br>...<br><br>root      4597  4594  0 00:37 ?        00:00:00 gnome-pty-helper<br>root      4598  4594  0 00:37 pts/1    00:00:00 bash<br>oracle    5359     1  0 00:41 ?        00:00:00 ora_smco_orcl<br>oracle    5378     1  0 00:41 ?        00:00:00 ora_w000_orcl<br>oracle    5586     1  0 00:42 ?        00:00:00 ora_j000_orcl<br>oracle    5588     1  0 00:42 ?        00:00:00 ora_j001_orcl<br>root      5666     1  0 00:43 ?        00:00:00 sh<br>root      5669     1  0 00:43 ?        00:00:00 <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;find&quot;</span><br>root      5672     1  0 00:43 ?        00:00:00 <span class="hljs-built_in">ls</span> -la<br>root      5675     1  0 00:43 ?        00:00:00 bash<br>root      5678     1  0 00:43 ?        00:00:00 gnome-terminal<br>root      5683     1  0 00:43 ?        00:00:00 <span class="hljs-built_in">cd</span> /etc<br>root      5686     1  0 00:43 ?        00:00:00 top<br>root      5689     1  0 00:43 ?        00:00:00 sh<br>root      5692     1  0 00:43 ?        00:00:00 gnome-terminal<br>root      5695     1  0 00:43 ?        00:00:00 ifconfig<br>root      5696  4598  0 00:43 pts/1    00:00:00 ps -ef<br></code></pre></td></tr></table></figure>

<p>而使用lsof却可以清除地看见样本正在努力地干活。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]# lsof +d /usr/bin<br>COMMAND    PID USER  FD   TYPE DEVICE    SIZE    NODE NAME<br>hidd      1853 root txt    REG    3,1   33708 2467454 /usr/bin/hidd<br>ckucbzknt 2014 root txt    REG    3,1  610331 2459176 /usr/bin/ckucbzkntb<br>xfs       2143  xfs txt    REG    3,1  107460 2468483 /usr/bin/xfs<br>Xorg      3117 root txt    REG    3,1 1890596 2466732 /usr/bin/Xorg<br>gnome-ses 4073 root txt    REG    3,1  129356 2459482 /usr/bin/gnome-session<br>ssh-agent 4201 root txt    REG    3,1   88996 2467513 /usr/bin/ssh-agent<br>dbus-laun 4245 root txt    REG    3,1   23796 2471600 /usr/bin/dbus-launch<br>gnome-key 4255 root txt    REG    3,1   97396 2473617 /usr/bin/gnome-keyring-daemon<br>metacity  4290 root txt    REG    3,1  521080 2464500 /usr/bin/metacity<br>gnome-pan 4296 root txt    REG    3,1  540868 2465177 /usr/bin/gnome-panel<br>nautilus  4298 root txt    REG    3,1 1348932 2461620 /usr/bin/nautilus<br>gnome-vol 4310 root txt    REG    3,1   65240 2464498 /usr/bin/gnome-volume-manager<br>bt-applet 4334 root txt    REG    3,1   30452 2464773 /usr/bin/bt-applet<br>nm-applet 4352 root txt    REG    3,1  312432 2467723 /usr/bin/nm-applet<br>gnome-pow 4381 root txt    REG    3,1  195284 2459473 /usr/bin/gnome-power-manager<br>pam-panel 4383 root txt    REG    3,1   39148 2461862 /usr/bin/pam-panel-icon<br>dbus-laun 4473 root txt    REG    3,1   23796 2471600 /usr/bin/dbus-launch<br>gnome-scr 4512 root txt    REG    3,1  168628 2468487 /usr/bin/gnome-screensaver<br>gnome-ter 4594 root txt    REG    3,1  309368 2464648 /usr/bin/gnome-terminal<br>gadcgkcqn 4681 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni<br>gadcgkcqn 4684 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni<br>gadcgkcqn 4687 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni<br>gadcgkcqn 4690 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni<br>gadcgkcqn 4693 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni<br></code></pre></td></tr></table></figure>

<p>阅读汇编代码，分析具体原因，发现xorddos将一些关键信息加密了，F5处理过的代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">encrypt_code</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2)</span><br>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// ecx@2</span><br><br>  <span class="hljs-keyword">if</span> ( a2 &gt; <span class="hljs-number">0</span> )<br>  &#123;<br>    v2 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      *(_BYTE *)(v2 + a1) ^= xorkeys[(((_BYTE)v2 + ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(v2 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt; <span class="hljs-number">28</span>)) &amp; <span class="hljs-number">0xF</span>)<br>                                   - ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(v2 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt; <span class="hljs-number">28</span>)];<br>      ++v2;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( v2 != a2 );<br>  &#125;<br>  <span class="hljs-keyword">return</span> a1;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>xorkey 为 BB2FA36AAA9541F0</p>
<p>用idapython 写个小脚本，简单处理一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> idautils <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> idc <span class="hljs-keyword">import</span> *<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_string</span>(<span class="hljs-params">addr</span>):<br>  out = <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">if</span> Byte(addr) != <span class="hljs-number">0</span>:<br>      out += <span class="hljs-built_in">chr</span>(Byte(addr))<br>    <span class="hljs-keyword">else</span>:<br>      <span class="hljs-keyword">break</span><br>    addr += <span class="hljs-number">1</span><br>  <span class="hljs-keyword">return</span> out<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">data</span>):<br><br>  xorkey = <span class="hljs-string">&#x27;BB2FA36AAA9541F0&#x27;</span><br>  length = <span class="hljs-built_in">len</span>(data)<br>  o = <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">if</span> length &gt; <span class="hljs-number">0</span>:<br>    v2 = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> v2 &lt; length:<br>      o += <span class="hljs-built_in">chr</span>( <span class="hljs-built_in">ord</span>(data[v2]) ^  <span class="hljs-built_in">ord</span>(xorkey[((v2 + ((v2 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt; <span class="hljs-number">28</span>)) &amp; <span class="hljs-number">0xF</span>) - ( (v2 &gt;&gt; <span class="hljs-number">31</span>) &gt;&gt; <span class="hljs-number">28</span>)]) )<br>      v2 += <span class="hljs-number">1</span><br><br>  <span class="hljs-keyword">return</span> o<br><br>ea = ScreenEA()<br>string = get_string(ea)<br>dec = decrypt(string)<br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;Addr: 0x%x, %s&#x27;</span> % (ea, dec)<br>MakeComm(ea, dec)<br></code></pre></td></tr></table></figure>

<p>处理后可以看到伪装的命令行信息，daemonname。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs asm">.data:080CBB40 daemonname      db &#x27;!#Ff3VE.-7&#x27;,17h,&#x27;V[_ 0&#x27;,0 ; DATA XREF: main+31Eo<br>.data:080CBB40                                         ; main+4AEo ...<br>.data:080CBB40                                         ; cat resolv.conf<br>.data:080CBB51                 align 4<br>.data:080CBB54 a12             db &#x27;1*2&#x27;,0              ; sh<br>.data:080CBB58                 db    0<br>.data:080CBB59                 db    0<br>.data:080CBB5A                 db    0<br>.data:080CBB5B                 db    0<br>.data:080CBB5C                 db    0<br>.data:080CBB5D                 db    0<br>.data:080CBB5E                 db    0<br>.data:080CBB5F                 db    0<br>.data:080CBB60                 db    0<br>.data:080CBB61                 db    0<br>.data:080CBB62                 db    0<br>.data:080CBB63                 db    0<br>.data:080CBB64                 db    0<br>.data:080CBB65                 db    0<br>.data:080CBB66                 db    0<br>.data:080CBB67                 db    0<br>.data:080CBB68                 db  20h                 ; bash<br>.data:080CBB69                 db  23h ; #<br>.data:080CBB6A                 db  41h ; A<br>.data:080CBB6B                 db  2Eh ; .<br>.data:080CBB6C                 db  41h ; A<br>.data:080CBB6D                 db    0<br>.data:080CBB6E                 db    0<br>.data:080CBB6F                 db    0<br>.data:080CBB70                 db    0<br>.data:080CBB71                 db    0<br><br>...<br><br>.data:080CBBB8                 db  2Eh ; .             ; ls -la<br>.data:080CBBB9                 db  31h ; 1<br>.data:080CBBBA                 db  12h<br>.data:080CBBBB                 db  6Bh ; k<br>.data:080CBBBC                 db  2Dh ; -<br>.data:080CBBBD                 db  52h ; R<br>.data:080CBBBE                 db  36h ; 6<br>.data:080CBBBF                 db    0<br>.data:080CBBC0                 db    0<br>.data:080CBBC1                 db    0<br>.data:080CBBC2                 db    0<br>.data:080CBBC3                 db    0<br>.data:080CBBC4                 db    0<br>.data:080CBBC5                 db    0<br>.data:080CBBC6                 db    0<br>.data:080CBBC7                 db    0<br>.data:080CBBC8                 db    0<br>.data:080CBBC9                 db    0<br>.data:080CBBCA                 db    0<br>.data:080CBBCB                 db    0<br>.data:080CBBCC                 db  36h ; 6             ; top<br>.data:080CBBCD                 db  2Dh ; -<br>.data:080CBBCE                 db  42h ; B<br>.data:080CBBCF                 db  46h ; F<br>.data:080CBBD0                 db    0<br>.data:080CBBD1                 db    0<br>.data:080CBBD2                 db    0<br><br>...<br></code></pre></td></tr></table></figure>

<p>呵呵，已经看到 top， ls -al 等信息了，查看daemonname 的交叉引用，发现在main函数<br>中，到main里看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0804AC30 ; int __cdecl main(int argc, const char **argv, const char **envp)<br>.text:0804AC30                 public main<br>.text:0804AC30 main            proc near               ; DATA XREF: _start+17o<br><br>....<br><br>.text:0804AF4E                 mov     ebx, offset daemonname ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;<br><br>...<br><br>.text:0804AFC2 loc_804AFC2:                            ; CODE XREF: main+3ABj<br>.text:0804AFC2                 mov     [esp], ebx<br>.text:0804AFC5                 add     ebx, 14h<br>.text:0804AFC8                 mov     dword ptr [esp+4], 14h<br>.text:0804AFD0                 call    encrypt_code<br>.text:0804AFD5                 cmp     ebx, offset unk_80CBD0C<br>.text:0804AFDB                 jnz     short loc_804AFC2<br></code></pre></td></tr></table></figure>

<p>这段汇编代码，使用了一个循环，调用encrypt_code 对daemonname进行了解密。<br>后面的代码，用到了daemonname的地方有下面几处，</p>
<p>第一处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0804B29F                 call    getpid<br>.text:0804B2A4                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;<br>.text:0804B2AC                 mov     dword ptr [esp+4], 0Ah<br>.text:0804B2B4                 mov     [esp], esi             ；第三形参 pid<br>.text:0804B2B7                 mov     [esp+0Ch], eax<br>.text:0804B2BB                 call    snprintf<br>.text:0804B2C0                 mov     dword ptr [esp+4], 17h<br>.text:0804B2C8                 mov     dword ptr [esp], 0<br>.text:0804B2CF                 call    randomid<br>.text:0804B2D4                 mov     [esp+8], esi<br>.text:0804B2D8                 mov     [esp], edi             ；第一形参 要跑的木马<br>.text:0804B2DB                 movzx   eax, ax<br>.text:0804B2DE                 lea     eax, [eax+eax*4]<br>.text:0804B2E1                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;<br>.text:0804B2E8                 mov     [esp+4], eax           ; 第二形参  daemonname<br>.text:0804B2EC                 call    LinuxExec_Argv2<br></code></pre></td></tr></table></figure>

<p>第二处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0804B932                 lea     edx, [ebp+var_1888]<br>.text:0804B938                 add     ebx, 1<br>.text:0804B93B                 mov     [esp], edx<br>.text:0804B93E                 call    randmd5<br>.text:0804B943                 mov     [ebp+var_22], 0<br>.text:0804B94A                 mov     [ebp+var_1E], 0<br>.text:0804B951                 mov     [ebp+var_1A], 0<br>.text:0804B957                 call    getpid<br>.text:0804B95C                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;<br>.text:0804B964                 mov     dword ptr [esp+4], 0Ah<br>.text:0804B96C                 mov     [esp], esi<br>.text:0804B96F                 mov     [esp+0Ch], eax<br>.text:0804B973                 call    snprintf<br>.text:0804B978                 mov     dword ptr [esp+4], 17h<br>.text:0804B980                 mov     dword ptr [esp], 0<br>.text:0804B987                 call    randomid<br>.text:0804B98C                 mov     [esp+8], esi<br>.text:0804B990                 movzx   eax, ax<br>.text:0804B993                 lea     eax, [eax+eax*4]<br>.text:0804B996                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;<br>.text:0804B99D                 mov     [esp+4], eax<br>.text:0804B9A1                 lea     eax, [ebp+var_1888]<br>.text:0804B9A7                 mov     [esp], eax<br>.text:0804B9AA                 call    LinuxExec_Argv2<br></code></pre></td></tr></table></figure>

<p>第三处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0804B9DF                 lea     edx, [ebp+var_1C88]<br>.text:0804B9E5                 add     ebx, 1<br>.text:0804B9E8                 mov     [esp], edx<br>.text:0804B9EB                 call    randmd5<br>.text:0804B9F0                 mov     [ebp+var_22], 0<br>.text:0804B9F7                 mov     [ebp+var_1E], 0<br>.text:0804B9FE                 mov     [ebp+var_1A], 0<br>.text:0804BA04                 call    getpid<br>.text:0804BA09                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;<br>.text:0804BA11                 mov     dword ptr [esp+4], 0Ah<br>.text:0804BA19                 mov     [esp], esi<br>.text:0804BA1C                 mov     [esp+0Ch], eax<br>.text:0804BA20                 call    snprintf<br>.text:0804BA25                 mov     dword ptr [esp+4], 17h<br>.text:0804BA2D                 mov     dword ptr [esp], 0<br>.text:0804BA34                 call    randomid<br>.text:0804BA39                 mov     [esp+8], esi<br>.text:0804BA3D                 movzx   eax, ax<br>.text:0804BA40                 lea     eax, [eax+eax*4]<br>.text:0804BA43                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;<br>.text:0804BA4A                 mov     [esp+4], eax<br>.text:0804BA4E                 lea     eax, [ebp+var_1C88]<br>.text:0804BA54                 mov     [esp], eax<br>.text:0804BA57                 call    LinuxExec_Argv2<br></code></pre></td></tr></table></figure>

<p>都是作为LinuxExec_Argv2 参数使用的，接着来看LinuxExec_Argv2 的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:08048520 LinuxExec_Argv2 proc near               ; CODE XREF: DelService+B3p<br>.text:08048520                                         ; DelService+CBlp ...<br>.text:08048520<br>.text:08048520 argv            = dword ptr -18h<br>.text:08048520 var_14          = dword ptr -14h<br>.text:08048520 var_10          = dword ptr -10h<br>.text:08048520 var_C           = dword ptr -0Ch<br>.text:08048520 var_8           = dword ptr -8<br>.text:08048520 var_4           = dword ptr -4<br>.text:08048520 file            = dword ptr  8<br>.text:08048520 arg_4           = dword ptr  0Ch<br>.text:08048520 arg_8           = dword ptr  10h<br>.text:08048520<br>.text:08048520                 push    ebp<br>.text:08048521                 mov     ebp, esp<br>.text:08048523                 sub     esp, 28h<br>.text:08048526                 mov     [ebp+var_4], esi<br>.text:08048529                 mov     esi, [ebp+file]<br>.text:0804852C                 mov     [ebp+var_8], ebx<br>.text:0804852F                 mov     [ebp+argv], 0<br>.text:08048536                 mov     [ebp+var_14], 0<br>.text:0804853D                 mov     [ebp+var_10], 0<br>.text:08048544                 mov     [ebp+var_C], 0<br>.text:0804854B                 call    doublefork<br>.text:08048550                 test    eax, eax<br>.text:08048552                 jz      short ZERO<br>.text:08048554                 mov     ebx, [ebp+var_8]<br>.text:08048557                 mov     esi, [ebp+var_4]<br>.text:0804855A                 mov     esp, ebp<br>.text:0804855C                 pop     ebp<br>.text:0804855D                 retn<br>.text:0804855E ; ---------------------------------------------------------------------------<br>.text:0804855E<br>.text:0804855E ZERO:                                   ; CODE XREF: LinuxExec_Argv2+32j<br>.text:0804855E                 mov     ebx, 3<br>.text:08048563<br>.text:08048563 LOOP:                                   ; CODE XREF: LinuxExec_Argv2+54j<br>.text:08048563                 mov     [esp], ebx      ; fd<br>.text:08048566                 add     ebx, 1<br>.text:08048569                 call    close<br>.text:0804856E                 cmp     ebx, 400h       ；400h == 1024<br>.text:08048574                 jnz     short LOOP<br>.text:08048576                 mov     eax, [ebp+arg_4]<br>.text:08048579                 mov     [ebp+argv], esi<br>.text:0804857C                 mov     [esp], esi      ; file<br>.text:0804857F                 mov     [ebp+var_14], eax<br>.text:08048582                 mov     eax, [ebp+arg_8]；eax = pid<br>.text:08048585                 mov     [ebp+var_10], eax<br>.text:08048588                 lea     eax, [ebp+argv]<br>.text:0804858B                 mov     [esp+4], eax    ; argv<br>.text:0804858F                 call    execvp<br>.text:08048594                 mov     dword ptr [esp], 0 ; status<br>.text:0804859B                 call    exit<br>.text:0804859B LinuxExec_Argv2 endp<br></code></pre></td></tr></table></figure>

<p>LinuxExec_Argv2 有三个参数。最终执行了execvp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:0804857C                 mov     [esp], esi      ; file <br>...<br>.text:0804858B                 mov     [esp+4], eax    ; argv<br>.text:0804858F                 call    execvp<br></code></pre></td></tr></table></figure>

<p>伪代码为，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">execvp(file, &amp;argv);<br></code></pre></td></tr></table></figure>

<p>file 就是arg_0, 需要分析argv， 调出栈图就比较清晰了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-00000018 argv            dd ?                    ; offset<br>-00000014 var_14          dd ?<br>-00000010 var_10          dd ?<br>-0000000C var_C           dd ?<br>-00000008 var_8           dd ?<br>-00000004 var_4           dd ?<br>+00000000  s              db 4 dup(?)<br>+00000004  r              db 4 dup(?)<br>+00000008 file            dd ?                    ; offset<br>+0000000C arg_4           dd ?<br>+00000010 arg_8           dd ?<br><br></code></pre></td></tr></table></figure>

<p>首先是这句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:08048529                 mov     esi, [ebp+file]<br>...<br>.text:0804852F                 mov     [ebp+argv], 0<br>...<br>.text:08048579                 mov     [ebp+argv], esi<br><br></code></pre></td></tr></table></figure>

<p>执行了这几句代码后，栈图发生了变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-00000018 argv            arg_0                       ; offset<br>-00000014 var_14          dd ?<br>-00000010 var_10          dd ?<br>-0000000C var_C           dd ?<br>-00000008 var_8           dd ?<br>-00000004 var_4           dd ?<br>+00000000  s              db 4 dup(?)<br>+00000004  r              db 4 dup(?)<br>+00000008 file            dd ?                    ; offset<br>+0000000C arg_4           dd ?<br>+00000010 arg_8           dd ?<br></code></pre></td></tr></table></figure>


<p>再看这几句代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:08048576                 mov     eax, [ebp+arg_4]<br>.text:08048579                 mov     [ebp+argv], esi<br>...<br>.text:0804857F                 mov     [ebp+var_14], eax<br></code></pre></td></tr></table></figure>

<p>执行了这几句代码后，栈图发生了变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-00000018 argv            arg_0                   ; offset<br>-00000014 var_14          arg_4<br>-00000010 var_10          dd ?<br>-0000000C var_C           dd ?<br>-00000008 var_8           dd ?<br>-00000004 var_4           dd ?<br>+00000000  s              db 4 dup(?)<br>+00000004  r              db 4 dup(?)<br>+00000008 file            dd ?                    ; offset<br>+0000000C arg_4           dd ?<br>+00000010 arg_8           dd ?<br></code></pre></td></tr></table></figure>

<p>接下来是这几句代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.text:08048582                 mov     eax, [ebp+arg_8]；eax = pid<br>.text:08048585                 mov     [ebp+var_10], eax<br></code></pre></td></tr></table></figure>

<p>执行了这几句代码后，栈图发生了变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-00000018 argv            arg_0                   ; offset<br>-00000014 var_14          arg_4<br>-00000010 var_10          arg_8<br>-0000000C var_C           0<br>-00000008 var_8           dd ?<br>-00000004 var_4           dd ?<br>+00000000  s              db 4 dup(?)<br>+00000004  r              db 4 dup(?)<br>+00000008 file            dd ?                    ; offset<br>+0000000C arg_4           dd ?<br>+00000010 arg_8           dd ?<br>`<br></code></pre></td></tr></table></figure>

<p>main函数中对LinuxExec_Argv2 的调用的为代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LinuxExec_Argv2(&#x27;木马路径&#x27;, &#x27;伪装命令行&#x27;, pid);<br></code></pre></td></tr></table></figure>

<p>因此最后调用的execvp的伪代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">execvp(&#x27;木马路径&#x27;, argv);<br></code></pre></td></tr></table></figure>

<p>将进入 main 函数参数个数为3的流程，用IDA重命名后，关键代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">text:0804B5D3 PARAM_NUM_3:                            ; CODE XREF: main+3CDj<br><br>.text:0804B5D3                 lea     eax, [ebp+var_18]<br>.text:0804B5D6                 mov     [esp+4], eax<br>.text:0804B5DA                 lea     eax, [ebp+self_path]<br>.text:0804B5E0                 mov     [esp], eax<br>.text:0804B5E3                 call    readfile<br>.text:0804B5E8                 mov     edx, [ebp+argv_arr]<br>.text:0804B5EE                 mov     ebx, [edx+4]<br>.text:0804B5F1                 mov     [ebp+self_file_content], eax<br>.text:0804B5F7                 mov     [esp], ebx<br>.text:0804B5FA                 call    strlen<br>.text:0804B5FF                 mov     [esp+4], ebx<br>.text:0804B603                 mov     [esp+8], eax<br>.text:0804B607                 lea     eax, [ebp+fake_cmd]<br>.text:0804B60D                 mov     [esp], eax<br>.text:0804B610                 call    memmove<br>.text:0804B615                 mov     dword ptr [esp+0Ch], 0<br>.text:0804B61D                 mov     dword ptr [esp+8], 0Ah<br>.text:0804B625                 mov     dword ptr [esp+4], 0<br>.text:0804B62D                 mov     edx, [ebp+argv_arr]<br>.text:0804B633                 mov     eax, [edx+8]<br>.text:0804B636                 mov     [esp], eax<br>.text:0804B639                 call    __strtol_internal<br>.text:0804B63E                 mov     esi, eax<br>.text:0804B640                 mov     eax, [ebp+argv_arr]<br>.text:0804B646                 mov     ebx, [eax]<br>.text:0804B648                 mov     [esp], ebx<br>.text:0804B64B                 call    strlen<br>.text:0804B650                 mov     [esp], ebx<br>.text:0804B653                 mov     dword ptr [esp+4], 0<br>.text:0804B65B                 mov     [esp+8], eax<br>.text:0804B65F                 call    memset<br>.text:0804B664                 mov     edx, [ebp+argv_arr]<br>.text:0804B66A                 mov     ebx, [edx+4]<br>.text:0804B66D                 mov     [esp], ebx<br>.text:0804B670                 call    strlen<br>.text:0804B675                 mov     [esp], ebx<br>.text:0804B678                 mov     dword ptr [esp+4], 0<br>.text:0804B680                 mov     [esp+8], eax<br>.text:0804B684                 call    memset<br>.text:0804B689                 mov     eax, [ebp+argv_arr]<br>.text:0804B68F                 mov     ebx, [eax+8]<br>.text:0804B692                 mov     [esp], ebx<br>.text:0804B695                 call    strlen<br>.text:0804B69A                 mov     [esp], ebx<br>.text:0804B69D                 mov     dword ptr [esp+4], 0<br>.text:0804B6A5                 mov     [esp+8], eax<br>.text:0804B6A9                 call    memset<br>.text:0804B6AE                 lea     edx, [ebp+fake_cmd]<br>.text:0804B6B4                 mov     [esp+4], edx<br>.text:0804B6B8                 mov     edx, [ebp+argv_arr]<br>.text:0804B6BE                 mov     eax, [edx]<br>.text:0804B6C0                 mov     [esp], eax<br>.text:0804B6C3                 call    strcpy<br>.text:0804B6C8                 lea     eax, [ebp+filename]<br>.text:0804B6CE                 mov     [esp+0Ch], esi<br>.text:0804B6D2                 lea     esi, [ebp+randstr_10]<br></code></pre></td></tr></table></figure>

<p>上面代码的原理大致等同于下面这段代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>&#123;<br>    <span class="hljs-type">char</span> fake_cmd[<span class="hljs-number">256</span>];<br>    <span class="hljs-built_in">memset</span>(&amp;fake_cmd, <span class="hljs-number">0</span>, <span class="hljs-number">256</span>);<br>    <span class="hljs-type">char</span> * argv_arr_1 = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> argv_arr_1_length = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>    memmove(&amp;fake_cmd, argv_arr_1, argv_arr_1_length);<br>    <span class="hljs-type">long</span> pid_long = strtol(argv[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-type">char</span> * v29 = (<span class="hljs-type">char</span> *)*argv;<br>    <span class="hljs-type">int</span> v30 = <span class="hljs-built_in">strlen</span>(*argv);<br>    <span class="hljs-built_in">memset</span>(v29, <span class="hljs-number">0</span>, v30);<br>    <span class="hljs-type">char</span> * v31 = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> v32 = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">memset</span>(v31, <span class="hljs-number">0</span>, v32);<br>    <span class="hljs-type">char</span> * v33 = argv[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> v34 = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">2</span>]);<br>    <span class="hljs-built_in">memset</span>(v33, <span class="hljs-number">0</span>, v34);<br>    <span class="hljs-built_in">strcpy</span>(*argv, fake_cmd);<br>    sleep(<span class="hljs-number">300</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>编译后执行可以看到效果和运行样本的一样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">➜  ~ gcc -o fakeexe exe.c<br>➜  ~ ./fakeexe <span class="hljs-string">&quot;ls -al&quot;</span> 2554<br><br>➜  ~ <span class="hljs-built_in">cat</span> /proc/2605/cmdline<br><span class="hljs-built_in">ls</span> -al<br><br>➜  ~ <span class="hljs-built_in">ls</span> -l /proc/2605/exe<br>lrwxrwxrwx. 1 henices henices 0 8月   2 12:01 /proc/2605/exe -&gt; /home/henices/research/xorddos/fakeexe<br><br>➜  ~ ps -elf | grep <span class="hljs-string">&quot;ls -al&quot;</span> | grep -v grep<br>0 S henices   2605 25307  0  80   0 -  1043 hrtime 12:01 pts/5    00:00:00 <span class="hljs-built_in">ls</span> -al<br></code></pre></td></tr></table></figure>

<p>其实效果并不好，可以轻易发现踪迹。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">➜  ~ ps -e | grep fakeexe<br> 2605 pts/9    00:00:00 fakeexe<br><br></code></pre></td></tr></table></figure>

<p>其实有更好的做法，使用 prctl ，至少可以把ps给搞定。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>&#123;<br>    <span class="hljs-type">char</span> fake_cmd[<span class="hljs-number">256</span>];<br>    <span class="hljs-built_in">memset</span>(&amp;fake_cmd, <span class="hljs-number">0</span>, <span class="hljs-number">256</span>);<br>    <span class="hljs-type">char</span> * argv_arr_1 = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> argv_arr_1_length = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>    memmove(&amp;fake_cmd, argv_arr_1, argv_arr_1_length);<br>    <span class="hljs-type">long</span> pid_long = strtol(argv[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br>    <span class="hljs-type">char</span> * v29 = (<span class="hljs-type">char</span> *)*argv;<br>    <span class="hljs-type">int</span> v30 = <span class="hljs-built_in">strlen</span>(*argv);<br>    <span class="hljs-built_in">memset</span>(v29, <span class="hljs-number">0</span>, v30);<br>    <span class="hljs-type">char</span> * v31 = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> v32 = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">memset</span>(v31, <span class="hljs-number">0</span>, v32);<br>    <span class="hljs-type">char</span> * v33 = argv[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> v34 = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">2</span>]);<br>    <span class="hljs-built_in">memset</span>(v33, <span class="hljs-number">0</span>, v34);<br>    <span class="hljs-built_in">strcpy</span>(*argv, fake_cmd);<br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;bash&quot;</span>);<br>    sleep(<span class="hljs-number">300</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>编译执行后可以看到效果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">➜  ~ ps -e | grep bash<br> 4858 pts/5    00:00:00 bash<br><br>➜  ~ <span class="hljs-built_in">cat</span> /proc/4858/cmdline <br><span class="hljs-built_in">ls</span> -al<br><br>➜  ~ lsof -d txt | grep fakeexe<br>bash       4858 henices txt       REG  253,2      8816  4588423 /home/henices/research/xorddos/fakeexe<br></code></pre></td></tr></table></figure>


<h2 id="xorddos-的多态-（Polymorphic）"><a href="#xorddos-的多态-（Polymorphic）" class="headerlink" title="xorddos 的多态 （Polymorphic）"></a>xorddos 的多态 （Polymorphic）</h2><p>xorddos这个样本还值得一提的是，这个样本会不断变化，多态这个词翻译的可能不太准确，<br>可以参见上面的英文，自行理解。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">randmd5</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename)</span><br>&#123;<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// eax@1</span><br>  <span class="hljs-type">int</span> fd_dup; <span class="hljs-comment">// esi@1</span><br>  <span class="hljs-type">mode_t</span> v4; <span class="hljs-comment">// [sp+8h] [bp-20h]@0</span><br>  <span class="hljs-type">int</span> addr; <span class="hljs-comment">// [sp+15h] [bp-13h]@1</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [sp+19h] [bp-Fh]@1</span><br>  __int16 v7; <span class="hljs-comment">// [sp+1Dh] [bp-Bh]@1</span><br>  <span class="hljs-type">char</span> v8; <span class="hljs-comment">// [sp+1Fh] [bp-9h]@1</span><br><br>  addr = <span class="hljs-number">0</span>;<br>  v6 = <span class="hljs-number">0</span>;<br>  v7 = <span class="hljs-number">0</span>;<br>  v8 = <span class="hljs-number">0</span>;<br>  fd = open(filename, <span class="hljs-number">1</span>, v4);<br>  fd_dup = fd;<br>  <span class="hljs-keyword">if</span> ( fd &gt; <span class="hljs-number">0</span> )<br>  &#123;<br>    lseek(fd, <span class="hljs-number">0</span>, SEEK_END);<br>    randstr((<span class="hljs-type">int</span>)&amp;addr, <span class="hljs-number">10</span>);<br>    write(fd_dup, &amp;addr, <span class="hljs-number">11u</span>);<br>    close(fd_dup);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>xorddos 样本多态主要就是用这个函数，每次在文件末尾写上10个字节的随机字符。<br>这样样本md5和大小都会发生变化，使得一些检测方法失效。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>正因为这种隐藏方法并不理想，后面xorddos出现了带rootkit的版本，进化了。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://usmacd.com">曼福吉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/xorddos_hide/">https://usmacd.com/cn/xorddos_hide/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://usmacd.com" target="_blank">安全代码</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Malware/">Malware</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/living_younger_healthier_logger/" title="端粒效应"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">端粒效应</div></div><div class="info-2"><div class="info-item-1">获得 2009 年诺贝尔生理或医学奖的 伊丽莎白·布莱克本在 《端粒效应》一书中说明：人只所以变老，是由于某些细胞不再更新了，而细胞分裂更新的限制在于 “端粒”。 端粒是染色体末端的 DNA 序列，在细胞分裂过程中，端粒起到保护 DNA 序列的作用。所以，人之所变老的本质原因是 「端粒变短」。 影响端粒变短的因素  思想压力：研究表明长期照顾患病小孩的母亲，端粒长度较正常人变短 敌意：看哪儿都不对，和周围的人关系极差 悲观：对事情总有一个负面的预期 胡思乱想：抑郁，都是乱想负面的东西，觉得不公平对待  缓解负面情绪的方法  把压力视为挑战：对压力的反应是威胁还是挑战，决定压力的性质 专注力训练：冥想 找到人生的目标：find something bigger than yourself  锻炼对端粒的好处  人体是反脆弱系统：锻炼的本质是对身体的适度打击 细胞的反击：适度的锻炼能使端粒变长，并增加「自由基」 抗氧化剂增多：突然增多的自由基使得身体增加抗氧化剂，锻炼改变了自由基和抗氧化剂的平衡 锻炼到底是影响端粒还是端粒脢，分子生物学上的机制科学家现在还不知道  两种科学的锻炼方法...</div></div></div></a><a class="pagination-related" href="/cn/Windows_Rx034/" title="解决 Windows Rx034"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">解决 Windows Rx034</div></div><div class="info-2"><div class="info-item-1">以前没有遇上这个错误，这次遇上这个错误是装vim的YouCompleteMe插件后出现，因此很容易想到是装插件引起的这个错误，错误提示Runtime Error 如下图：  先放狗搜一下，微软的对R6034的解释如下： 12345An application has made an attempt to load the C runtime library without usinga manifest. This is an unsupported way to load Visual C++ DLLs. You need tomodify your application to build with a manifest. For more information, see the&quot;Visual C++ Libraries as Shared Side-by-Side Assemblies&quot; topic in the productdocumentation.  微软的链接中也提到了解决的方法 123456Rebuild your application ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/malware_time_delay_escape/" title="通过延迟执行的方法来逃逸杀软"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2015-12-03</div><div class="info-item-2">通过延迟执行的方法来逃逸杀软</div></div><div class="info-2"><div class="info-item-1">pony 2.01234567891011121314151617181920212223242526272829303132333435363738; KAV heuristic fuckerKAVHeurKiller proc uses esi    LOCAL   counter: DWORD    AntiDisasmTrick    push    eax    mov ecx, ecx    pop eax    mov ecx, ecx    push    eax    sub esi, esi    pop eax    mov ecx, ecx    push    19131011    mov ecx, ecx    pop counter    mov edx, eax    .WHILE  counter        mov edx, eax        mov ecx, ecx        add eax, esi        mov edx, eax        mov ecx, ecx        push    eax       ...</div></div></div></a><a class="pagination-related" href="/cn/BankBot/" title="Bankbot APK 样本分析"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Bankbot APK 样本分析</div></div><div class="info-2"><div class="info-item-1">0x00 样本概况   字段 内容    样本名 BankBot   MD5 3c42c391bec405bb28b28195c2961778   SHA256 93b64019ee48177889d908c393703a2a2fe05ca33793c14b175467ce619b1b94   文件类型 APK   这是一个以盗窃信用卡用户密码为主要目的的bot。安装后显示为Android图标。打开App后会以Android系统更新的形式，诱导用户操作达到常驻系统的目的。 0x01 行为分析开机自启动123456789101112&lt;receiver android:name=&quot;com.android.market.Autorun&quot;&gt;    &lt;intent-filter android:priority=&quot;999&quot;&gt;        &lt;action android:name=&quot;android.intent.action.REBOOT&quot; /&gt;        &lt;action androi...</div></div></div></a><a class="pagination-related" href="/cn/malware_DZSM/" title="DZSM apk 样本分析"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2015-10-21</div><div class="info-item-2">DZSM apk 样本分析</div></div><div class="info-2"><div class="info-item-1">概况 MD5: 14792786094250715197540fd3b58439 SHA256: 456caeaaa8346c7a9e2198af5a0ca49d87e616a2603884580df22728a49893d7  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152Certificate:    Data:        Version: 3 (0x2)        Serial Number: 1208868505 (0x480dde99)    Signature Algorithm: sha256WithRSAEncryption        Issuer: C=CN, ST=sc, L=sc, O=maizi, OU=maizi, CN=pktool        Validity            Not Before: Sep  9 09:11:13 2015 GMT            Not After...</div></div></div></a><a class="pagination-related" href="/cn/android_malware/" title="关于恶意 Android 软件的那些事"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-05</div><div class="info-item-2">关于恶意 Android 软件的那些事</div></div><div class="info-2"><div class="info-item-1">  近年来，Android手机平台上的恶意App呈不断上升的趋势，根据G DATA的数据仅2015年 第一季度发现了440267 种新的安卓恶意软件，也就是说，全球范围内每18秒就有一个新的恶意软件被发现。而天朝由于Google被封的原因，更是使恶意软件的传播更加猖獗。Google Play store 为了保证Android用户的安全做了大量的努力，和国内的一些第三方应用市场相比安全一些的。    重打包是Android App主流的传播方式之一，和以前单独的恶意App不同，重打包的软件 在合法正常的App中插入恶意代码，迷惑性极强，一般用户觉察不出什么不同。而重打包选取 的App也大多是非常流行的App，如愤怒的小鸟之类,这些都在地下市场隐秘的进行着。重打包 App然后上传第三方App应用市场，第三方市场把关不严格的话，这些插入了恶意代码的App 就可以下载安装了。   除了重打包软件，彩信也是Android 恶意App传播的主要方式，和以前QQ的消息尾巴类似发一些奇怪的话，后面加上短链接。短链接就是经过压缩的链接，没法一些看出原始的链接，点击后会自动下载恶意App。臭名昭著...</div></div></div></a><a class="pagination-related" href="/cn/malware_Dyre/" title="Dyre 简单分析"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2015-09-17</div><div class="info-item-2">Dyre 简单分析</div></div><div class="info-2"><div class="info-item-1">0. 概述123sha256   : 523b9e8057ef0905e2c7d51b742d4be9374cf2eee5a810f05d987604847c549dmd5      : c2d73485095efdbd7ab625e469affb11filename : Invoice_00739287.scr  脱壳后的程序中可以看到 C:\CPP_PROJECTS_GIT\DYRE\x64\Release\dyrecontroller.pdb 因此大多数杀软将样本命名为dyre。Dyre的主要目标为在线银行。样本看上去是一个PDF文件，其实则是使用scr后缀的可执行文件，引诱受害者点击文件。 Dyre的一些其他样本 MD5：  999bc5e16312db6abff5f6c9e54c546f b44634d90a9ff2ed8a9d0304c11bf612 dd207384b31d118745ebc83203a4b04a  1. 感染与传播从网上的公开资料来看，样本主要传播途径为钓鱼邮件。  2. 工作流程 复制自身 (C:\Documents and Settings\u...</div></div></div></a><a class="pagination-related" href="/cn/anti_sandbox/" title="一些反沙盒的新技术"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">一些反沙盒的新技术</div></div><div class="info-2"><div class="info-item-1">Upatre 使用了一些新的逃逸技术来逃逸动态沙盒引擎的检查，这些技巧都非常的简单，但是非常的有效果。事实上，VirusTotal上Upatre的检出率并不高，新变种出来基本都检测不出来，说明现在的恶意软件对付杀毒软件是越来越有办法了。 目前在恶意软件上加壳倒是越来越少了，因为加壳容易引起杀软引擎的注意，相反地目前的恶意软件大量使用边执行边修改自身代码的方法来躲避杀软，不执行的话看起来就像是一个正常的软件，而真正执行起来代码却全变了，这也算是一种进化。 下面说说两种最近遇到的沙盒逃逸的办法，样本md5: ac3558b973402ef6a27e03c391f20533 检查开机时间一般使用沙盒的分析引擎的做法都是安装一个全新的系统，做系统镜像。然后在检查的时候加载镜像，执行样本。而开机的时间往往都被忽略了，基本都不会超过10分钟。 Upatre 样本所采取的方法是利用GetTickCount 获取开机的毫秒数，当开机时间小于12分钟是就不执行恶意的行为。 12345678004013B3    BB D8FE0A00         MOV EBX,0AFED8004013B8 ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">曼福吉</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F"><span class="toc-number">1.</span> <span class="toc-text">进程隐藏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xorddos-%E7%9A%84%E5%A4%9A%E6%80%81-%EF%BC%88Polymorphic%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">xorddos 的多态 （Polymorphic）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.</span> <span class="toc-text">其他</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/gemini_in_chrome/" title="开启 Gemini in Chrome 的方法">开启 Gemini in Chrome 的方法</a><time datetime="2026-01-29T16:00:00.000Z" title="发表于 2026-01-30 00:00:00">2026-01-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/sucess_is_the_mother_of_sucess/" title="成功是成功之母">成功是成功之母</a><time datetime="2026-01-27T16:00:00.000Z" title="发表于 2026-01-28 00:00:00">2026-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/ai_studio_podcast_transcript/" title="利用 AI Studio 整理播客音频的逐字稿">利用 AI Studio 整理播客音频的逐字稿</a><time datetime="2026-01-07T16:00:00.000Z" title="发表于 2026-01-08 00:00:00">2026-01-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/anti-weakness-learning/" title="反脆弱式的学习方法">反脆弱式的学习方法</a><time datetime="2025-12-30T16:00:00.000Z" title="发表于 2025-12-31 00:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/keep_hard/" title="坚持的秘诀">坚持的秘诀</a><time datetime="2025-12-15T16:00:00.000Z" title="发表于 2025-12-16 00:00:00">2025-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 曼福吉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="/js/tw_cn.js?v=5.5.4"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>