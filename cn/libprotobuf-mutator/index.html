<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>libprotobuf-mutator 简单分析 | 安全代码</title><meta name="author" content="曼福吉"><meta name="copyright" content="曼福吉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="What are protocol buffers?Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You defi">
<meta property="og:type" content="article">
<meta property="og:title" content="libprotobuf-mutator 简单分析">
<meta property="og:url" content="https://usmacd.com/cn/libprotobuf-mutator/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="What are protocol buffers?Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You defi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2023-09-06T03:00:51.596Z">
<meta property="article:modified_time" content="2023-09-06T03:00:51.596Z">
<meta property="article:author" content="曼福吉">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "libprotobuf-mutator 简单分析",
  "url": "https://usmacd.com/cn/libprotobuf-mutator/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2023-09-06T03:00:51.596Z",
  "dateModified": "2023-09-06T03:00:51.596Z",
  "author": [
    {
      "@type": "Person",
      "name": "曼福吉",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/libprotobuf-mutator/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'libprotobuf-mutator 简单分析',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/self/atom-one-light.css"><link rel="stylesheet" href="/self/nord.css"><meta name="generator" content="Hexo 8.1.0"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">171</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">安全代码</span></a><a class="nav-page-title" href="/"><span class="site-name">libprotobuf-mutator 简单分析</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">libprotobuf-mutator 简单分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-06T03:00:51.596Z" title="发表于 2023-09-06 11:00:51">2023-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-06T03:00:51.596Z" title="更新于 2023-09-06 11:00:51">2023-09-06</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="What-are-protocol-buffers"><a href="#What-are-protocol-buffers" class="headerlink" title="What are protocol buffers?"></a><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">What are protocol buffers?</a></h2><p>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages.</p>
<p>这段是 Google 官方网站给出的介绍，protobuf 可以自动化生成代码，用于读入或者写入结构化数据。一个简单的 protobuf 文件可以是这样的：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-keyword">message </span><span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-keyword">required</span> <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">required</span> <span class="hljs-type">int32</span> id = <span class="hljs-number">2</span>;<br>  <span class="hljs-keyword">optional</span> <span class="hljs-type">string</span> email = <span class="hljs-number">3</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>具体的语法可以参考Google 的文档 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2</a> 和 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">proto3</a>。c++ 语言使用 protobuf 的示例可以参见<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">Protocol Buffer Basics: C++</a> 文档，基本步骤总结如下：</p>
<ol>
<li>写 protobuf 文件，表达数据结构</li>
<li>利用 protoc 自动生成代码 （支持多种语言 C++ Java 等）</li>
<li>利用生成的文件解析或者写入相关数据结构</li>
</ol>
<h2 id="libprotobuf-mutator"><a href="#libprotobuf-mutator" class="headerlink" title="libprotobuf-mutator"></a>libprotobuf-mutator</h2><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>参考： <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/README.md">https://github.com/google/libprotobuf-mutator/blob/master/README.md</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/google/libprotobuf-mutator.git<br><span class="hljs-built_in">mkdir</span> build<br><span class="hljs-built_in">cd</span> build<br>cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug<br>https_proxy=http://127.0.0.1:3128 ninja check<br></code></pre></td></tr></table></figure>

<p>由于需要从Google下载一些源码，所以在 <code>ninja check</code> 的时候需要挂上代理，结果编译出错了，找不到 <code>libxml2.a</code>，排查一下编译参数，发现需要添加编译静态库的参数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/cmake/external/libxml2.cmake b/cmake/external/libxml2.cmake</span><br><span class="hljs-comment">index c00ace2..a944fab 100644</span><br><span class="hljs-comment">--- a/cmake/external/libxml2.cmake</span><br><span class="hljs-comment">+++ b/cmake/external/libxml2.cmake</span><br><span class="hljs-meta">@@ -38,6 +38,7 @@</span> ExternalProject_Add($&#123;LIBXML2_TARGET&#125;<br>     UPDATE_COMMAND &quot;&quot;<br>     CONFIGURE_COMMAND $&#123;LIBXML2_SRC_DIR&#125;/autogen.sh --without-python<br>                                                     --prefix=$&#123;LIBXML2_INSTALL_DIR&#125;<br><span class="hljs-addition">+                                                    --enable-static=yes</span><br>                                                     CC=$&#123;CMAKE_C_COMPILER&#125;<br>                                                     CXX=$&#123;CMAKE_CXX_COMPILER&#125;<br>                                                     CFLAGS=$&#123;LIBXML2_CFLAGS&#125;<br></code></pre></td></tr></table></figure>

<p>修改后可以正常通过 <code>ninja check</code> 命令的所有检查。默认情况下 <code>ninja install</code> 会安装到 &#x2F;usr&#x2F;local 目录，因为考虑到后续需要给 <code>afl+</code>使用，所以需要使用下的命令重新 cmake 一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \<br>-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug<br></code></pre></td></tr></table></figure>
<h3 id="libprotobuf-mutator-代码实现"><a href="#libprotobuf-mutator-代码实现" class="headerlink" title="libprotobuf-mutator 代码实现"></a>libprotobuf-mutator 代码实现</h3><p>libfuzzer_macro.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, Proto)                 \</span><br><span class="hljs-meta">  extern <span class="hljs-string">&quot;C&quot;</span> int LLVMFuzzerTestOneInput(const uint8_t* data, size_t size) &#123; \</span><br><span class="hljs-meta">    using protobuf_mutator::libfuzzer::LoadProtoInput;                      \</span><br><span class="hljs-meta">    Proto input;                                                            \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (LoadProtoInput(use_binary, data, size, &amp;input))                     \</span><br><span class="hljs-meta">      TestOneProtoInput(input);                                             \</span><br><span class="hljs-meta">    return 0;                                                               \</span><br><span class="hljs-meta">  &#125;</span><br>  <br><span class="hljs-comment">// Defines custom mutator, crossover and test functions using default</span><br><span class="hljs-comment">// serialization format. Default is text.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_PROTO_FUZZER(arg) DEFINE_TEXT_PROTO_FUZZER(arg)</span><br><span class="hljs-comment">// Defines custom mutator, crossover and test functions using text</span><br><span class="hljs-comment">// serialization. This format is more convenient to read.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_TEXT_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(false, arg)</span><br><span class="hljs-comment">// Defines custom mutator, crossover and test functions using binary</span><br><span class="hljs-comment">// serialization. This makes mutations faster. However often test function is</span><br><span class="hljs-comment">// significantly slower than mutator, so fuzzing rate may stay unchanged.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_BINARY_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(true, arg)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_PROTO_FUZZER_IMPL(use_binary, arg)                              \</span><br><span class="hljs-meta">  static void TestOneProtoInput(arg);                                          \</span><br><span class="hljs-meta">  using FuzzerProtoType = std::remove_const&lt;std::remove_reference&lt;             \</span><br><span class="hljs-meta">      std::function<span class="hljs-string">&lt;decltype(TestOneProtoInput)&gt;</span>::argument_type&gt;::type&gt;::type; \</span><br><span class="hljs-meta">  DEFINE_CUSTOM_PROTO_MUTATOR_IMPL(use_binary, FuzzerProtoType)                \</span><br><span class="hljs-meta">  DEFINE_CUSTOM_PROTO_CROSSOVER_IMPL(use_binary, FuzzerProtoType)              \</span><br><span class="hljs-meta">  DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, FuzzerProtoType)                \</span><br><span class="hljs-meta">  DEFINE_POST_PROCESS_PROTO_MUTATION_IMPL(FuzzerProtoType)                     \</span><br><span class="hljs-meta">  static void TestOneProtoInput(arg)</span><br></code></pre></td></tr></table></figure>

<p>调用路径为 <code>DEFINE_PROTO_FUZZER</code> -&gt; <code>DEFINE_TEXT_PROTO_FUZZER</code> -&gt; <code>DEFINE_PROTO_FUZZER_IMPL</code> -&gt; <code>DEFINE_TEST_ONE_PROTO_INPUT_IMPL</code> -&gt; <code>LLVMFuzzerTestOneInput</code> -&gt; <code>TestOneProtoInput</code>。<br>最终还是实现了<code>LLVMFuzzerTestOneInput</code> libfuzzer 的入口方法，使用 macro 可以少写不少代码非常方便，从这里就可以看出 fuzz 的 target function 必须和 <code>LLVMFuzzerTestOneInput</code> 的参数类型一致</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fuzz_target.cc</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">int</span> <span class="hljs-title function_">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Data, <span class="hljs-type">size_t</span> Size)</span> &#123;<br>  DoSomethingInterestingWithMyAPI(Data, Size);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// Non-zero return values are reserved for future use.</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>libfuzzer_macro.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">LoadProtoInput</span><span class="hljs-params">(<span class="hljs-type">bool</span> binary, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size,</span></span><br><span class="hljs-params"><span class="hljs-function">                    protobuf::Message* input)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetCache</span>()-&gt;<span class="hljs-built_in">LoadIfSame</span>(data, size, input)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">auto</span> result = binary ? <span class="hljs-built_in">ParseBinaryMessage</span>(data, size, input)<br>                       : <span class="hljs-built_in">ParseTextMessage</span>(data, size, input);<br>  <span class="hljs-keyword">if</span> (!result) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-built_in">GetMutator</span>()-&gt;<span class="hljs-built_in">Seed</span>(size);<br>  <span class="hljs-built_in">GetMutator</span>()-&gt;<span class="hljs-built_in">Fix</span>(input);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>LoadProtoInput</code> 返回 <code>true</code> 或者 <code>false</code>，如果解析成功，将调用 <code>TestOneProtoInput</code>，<code>DEFINE_PROTO_FUZZER</code> macro 其实就是写 TestOneProtoInput 的实现。</p>
<h2 id="libprotobuf-mutator-fuzzing-learning"><a href="#libprotobuf-mutator-fuzzing-learning" class="headerlink" title="libprotobuf-mutator_fuzzing_learning"></a>libprotobuf-mutator_fuzzing_learning</h2><p>这是 github 上一位同行写的学习 libprotobuf-mutator fuzzing 的文章，总体写的不错，但是其中有一些错误的地方，在实践过程中都记录了其中的修改。</p>
<h3 id="Simple-protobuf-example"><a href="#Simple-protobuf-example" class="headerlink" title="Simple protobuf example"></a>Simple protobuf example</h3><p>文章：<a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf</a></p>
<p>先写一个简单的 protobuf 文件，test.proto</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto2&quot;</span>;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">TEST</span> &#123;<br>  <span class="hljs-keyword">required</span> <span class="hljs-type">uint32</span> a = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">required</span> <span class="hljs-type">string</span> b = <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用 <code>protoc</code> 编译 protobuf 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> genfiles  <br>protoc ./test.proto --cpp_out=./genfiles<br></code></pre></td></tr></table></figure>

<p>将自动生成两个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> ./genfiles<br>test.pb.cc  test.pb.h<br></code></pre></td></tr></table></figure>

<p>写一个测试程序 test_proto.cc</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> std::cin;<br><span class="hljs-keyword">using</span> std::cout;<br><span class="hljs-keyword">using</span> std::endl;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    TEST t;<br>    t.<span class="hljs-built_in">set_a</span>(<span class="hljs-number">101</span>);<br>    t.<span class="hljs-built_in">set_b</span>(<span class="hljs-string">&quot;testtest&quot;</span>);<br>    cout &lt;&lt; t.<span class="hljs-built_in">a</span>() &lt;&lt; endl;<br>    cout &lt;&lt; t.<span class="hljs-built_in">b</span>() &lt;&lt; endl;   <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125; <br></code></pre></td></tr></table></figure>

<p>写 Makefile 来编译 <code>test_proto.cc</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CXX=clang++<br>PB_SRC=test.pb.cc<br><br>PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/<br>PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a<br>INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span><br><br><span class="hljs-section">test_proto: test_proto.cc <span class="hljs-variable">$(PB_SRC)</span></span><br>	<span class="hljs-variable">$(CXX)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><span class="hljs-section">clean: </span><br>	rm test_proto<br></code></pre></td></tr></table></figure>

<p>执行 <code>make</code> 后报错 .&#x2F;test.pb.h:17:2: error: This file was generated by an older version of protoc which is，因为我们在编译的时候使用了 <code>-DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON</code> 下载了新版本的 protobuf，所以出了这个错误。只好使用下载的 protoc 重新生成 <code>test.pb.cc</code> 和 <code>test.pb.h</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">~/code/libprotobuf-mutator/build/external.protobuf/bin/protoc ./test.proto --cpp_out=./genfiles<br></code></pre></td></tr></table></figure>

<p>这次可以成功 make 了，实际执行的命令是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">clang++ -o test_proto test_proto.cc test.pb.cc /home/henices/code/libprotobuf-mutator/build/external.protobuf//lib/libprotobufd.a \<br> -I/home/henices/code/libprotobuf-mutator/build/external.protobuf//include<br></code></pre></td></tr></table></figure>

<p>运行 <code>./test_proto</code>, 输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">101<br>testtest<br></code></pre></td></tr></table></figure>

<h3 id="Combine-libprotobuf-mutator-with-libfuzzer"><a href="#Combine-libprotobuf-mutator-with-libfuzzer" class="headerlink" title="Combine libprotobuf-mutator with libfuzzer"></a>Combine libprotobuf-mutator with libfuzzer</h3><p>代码在： <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer</a></p>
<p>harness.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FuzzTEST</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *data, <span class="hljs-type">size_t</span> size)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(data[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\x01&#x27;</span>) &#123;<br>        __builtin_trap();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中 FuzzTEST 是我们需要测试的目标函数。</p>
<p>lpm_libfuzz.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><br><span class="hljs-keyword">using</span> std::cin;<br><span class="hljs-keyword">using</span> std::cout;<br><span class="hljs-keyword">using</span> std::endl;<br><br><span class="hljs-function">std::string <span class="hljs-title">ProtoToData</span><span class="hljs-params">(<span class="hljs-type">const</span> TEST &amp;test_proto)</span> </span>&#123;<br>    std::stringstream all;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;aa = test_proto.<span class="hljs-built_in">a</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;bb = test_proto.<span class="hljs-built_in">b</span>();<br>    all.<span class="hljs-built_in">write</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)&amp;aa, <span class="hljs-built_in">sizeof</span>(aa));<br>    <span class="hljs-keyword">if</span>(bb.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span>) &#123;<br>        all.<span class="hljs-built_in">write</span>(bb.<span class="hljs-built_in">c_str</span>(), bb.<span class="hljs-built_in">size</span>());<br>    &#125;<br><br>    std::string res = all.<span class="hljs-built_in">str</span>();<br>    <span class="hljs-keyword">if</span> (bb.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span> &amp;&amp; res.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// set PROTO_FUZZER_DUMP_PATH env to dump the serialized protobuf</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *dump_path = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;PROTO_FUZZER_DUMP_PATH&quot;</span>)) &#123;<br>            <span class="hljs-function">std::ofstream <span class="hljs-title">of</span><span class="hljs-params">(dump_path)</span></span>;<br>            of.<span class="hljs-built_in">write</span>(res.<span class="hljs-built_in">data</span>(), res.<span class="hljs-built_in">size</span>());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FuzzTEST</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size)</span></span>; <span class="hljs-comment">// our customized fuzzing function</span><br><br><span class="hljs-built_in">DEFINE_PROTO_FUZZER</span>(<span class="hljs-type">const</span> TEST &amp;test_proto) &#123;<br>    <span class="hljs-keyword">auto</span> s = <span class="hljs-built_in">ProtoToData</span>(test_proto); <span class="hljs-comment">// convert protobuf to raw data</span><br>    <span class="hljs-built_in">FuzzTEST</span>((<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*)s.<span class="hljs-built_in">data</span>(), s.<span class="hljs-built_in">size</span>()); <span class="hljs-comment">// fuzz the function</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>在文件的最开头导入 <code>libfuzzer_macro.h</code>， 后面就可以使用一些宏来写代码了，<code>DEFINE_PROTO_FUZZER</code> 是关键的 fuzzer 入口。结构化变异部分 libprotobuf-mutator 已经完成了，需要实现的是一个由 protobuf 转需要的数据类型的函数，如上面的 <code>ProtoToData</code></p>
<h4 id="代码编译"><a href="#代码编译" class="headerlink" title="代码编译"></a>代码编译</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs makefile">TARGET=lpm_libfuzz<br>CXX=clang++<br>CXXFLAGS=-g -fsanitize=fuzzer,address<br>PB_SRC=test.pb.cc<br><br>PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/<br>LPM_DIR=<span class="hljs-variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator<br>PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a<br>LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a<br>INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(LPM_DIR)</span>/<span class="hljs-keyword">include</span><br>DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST<br><br><span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span></span><br><br><span class="hljs-comment"># for testing libprotobuf + libfuzzer</span><br><span class="hljs-comment"># compile harness first</span><br><span class="hljs-comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span><br><span class="hljs-section">harness.o: harness.cc</span><br>	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c <span class="hljs-variable">$(DFUZZ)</span> <span class="hljs-variable">$&lt;</span><br><br><span class="hljs-variable">$(TARGET)</span>: harness.o <span class="hljs-variable">$(TARGET)</span>.cc<br>	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PB_SRC)</span> <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span> <span class="hljs-comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><span class="hljs-section">clean: </span><br>	rm <span class="hljs-variable">$(TARGET)</span> *.o<br></code></pre></td></tr></table></figure>

<p>make 后报错，找不到头文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/home/henices/code/AFL+/external/libprotobuf-mutator/include/libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h:24:10: fatal error: &#x27;port/protobuf.h&#x27; file not found<br>#include &quot;port/protobuf.h&quot;<br>         ^~~~~~~~~~~~~~~~~<br>1 error generated.<br></code></pre></td></tr></table></figure>

<p>port&#x2F;protobuf.h  来自 <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h">https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h</a>  修改 Makefile 如下</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs makefile">TARGET=lpm_libfuzz<br>CXX=clang++<br>CXXFLAGS=-g -fsanitize=fuzzer,address<br>PB_SRC=test.pb.cc<br><br>PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/<br>LPM_DIR=<span class="hljs-variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator<br>PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a<br>LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a<br>INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/ -I<span class="hljs-variable">$(LPM_DIR)</span>/<span class="hljs-keyword">include</span><br>DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST<br><br><span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span></span><br><br><span class="hljs-comment"># for testing libprotobuf + libfuzzer</span><br><span class="hljs-comment"># compile harness first</span><br><span class="hljs-comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span><br><span class="hljs-section">harness.o: harness.cc</span><br>	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c <span class="hljs-variable">$(DFUZZ)</span> <span class="hljs-variable">$&lt;</span><br><br><span class="hljs-variable">$(TARGET)</span>: harness.o <span class="hljs-variable">$(TARGET)</span>.cc<br>	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PB_SRC)</span> <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span> <span class="hljs-comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><span class="hljs-section">clean: </span><br>	rm <span class="hljs-variable">$(TARGET)</span> *.o<br></code></pre></td></tr></table></figure>

<p>修改 makefile 后，可以正常编译通过。经过我们上面的分析，不需要定义 <code>DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST</code> 将这行删除掉，同样可以编译通过。</p>
<p>执行 <code>lpm_libfuzz</code> 运行正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">➜  ./lpm_libfuzz                                                                                                                                                                                          <br>INFO: found LLVMFuzzerCustomMutator (0x758a80). Disabling -len_control by default.<br>INFO: Running with entropic power schedule (0xFF, 100).                                    <br>INFO: Seed: 331712324                       <br>INFO: Loaded 1 modules   (434 inline 8-bit counters): 434 [0xa056b8, 0xa0586a), <br>INFO: Loaded 1 PC tables (434 PCs): 434 [0x939398,0x93aeb8), <br>INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes<br>INFO: A corpus is not provided, starting from an empty corpus<br>#2      INITED cov: 82 ft: 83 corp: 1/1b exec/s: 0 rss: 35Mb<br>        NEW_FUNC[1/41]: 0x75abb0 in TEST::~TEST() /tmp/genfiles/test.pb.cc:116<br>        NEW_FUNC[2/41]: 0x75ca10 in google::protobuf::UnknownFieldSet* google::protobuf::internal::InternalMetadata::mutable_unknown_fields&lt;google::protobuf::UnknownFieldSet&gt;() /home/henices/code/libprotobuf-mut<br>ator/build/external.protobuf//include/google/protobuf/metadata_lite.h:117<br>#3      NEW    cov: 135 ft: 159 corp: 2/12b lim: 4096 exec/s: 0 rss: 36Mb L: 11/11 MS: 1 CustomCrossOver-<br>#4      NEW    cov: 138 ft: 162 corp: 3/201b lim: 4096 exec/s: 0 rss: 36Mb L: 189/189 MS: 2 InsertRepeatedBytes-Custom-<br>#38     REDUCE cov: 138 ft: 162 corp: 3/127b lim: 4096 exec/s: 0 rss: 37Mb L: 115/115 MS: 5 CustomCrossOver-CustomCrossOver-Custom-InsertRepeatedBytes-Custom-<br>#60     REDUCE cov: 138 ft: 162 corp: 3/124b lim: 4096 exec/s: 0 rss: 37Mb L: 112/112 MS: 4 CustomCrossOver-ShuffleBytes-ChangeByte-Custom-<br>#98     REDUCE cov: 138 ft: 162 corp: 3/56b lim: 4096 exec/s: 0 rss: 37Mb L: 44/44 MS: 5 CrossOver-Custom-Custom-CMP-Custom- DE: &quot;~\xff\xff\xff\xff\xff\xff\xff&quot;-<br>#144    REDUCE cov: 138 ft: 162 corp: 3/53b lim: 4096 exec/s: 0 rss: 37Mb L: 41/41 MS: 2 CrossOver-Custom-<br>#182    REDUCE cov: 138 ft: 162 corp: 3/25b lim: 4096 exec/s: 0 rss: 37Mb L: 13/13 MS: 5 ChangeBit-Custom-Custom-InsertByte-Custom-<br>#324    REDUCE cov: 138 ft: 162 corp: 3/24b lim: 4096 exec/s: 0 rss: 38Mb L: 12/12 MS: 3 CustomCrossOver-EraseBytes-Custom-<br></code></pre></td></tr></table></figure>

<h3 id="Handling-input-from-AFL-in-our-custom-mutator"><a href="#Handling-input-from-AFL-in-our-custom-mutator" class="headerlink" title="Handling input from AFL++ in our custom mutator"></a>Handling input from AFL++ in our custom mutator</h3><p><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input</a></p>
<p>主要内容是将 libprotobuf-mutator 和 afl++ 结合起来，使用的 afl++ 的 custom mutator，值得一提的是在这个例子里，需要使用 <code>-fPIC</code> 参数编译 libprotobuf-mutator。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \<br>-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator \<br>-DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug \<br>-DCMAKE_C_FLAGS=<span class="hljs-string">&quot;-fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="hljs-string">&quot;-fPIC&quot;</span><br></code></pre></td></tr></table></figure>

<p>主要的步骤在 <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/blob/master/5_libprotobuf_aflpp_custom_mutator_input/README.md">readme.md</a> 中已经介绍得比较清楚了。</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.cc</code> 是 afl++ 的 custom mutator shared library<ul>
<li>解析输入数据（testcase buffer）并将其转成 <code>TEST</code> protobuf message</li>
<li>使用 <code>libprotobuf-mutator</code> 变异 <code>TEST</code> protobuf message</li>
<li>注册一个 <code>PostProcessor</code> 处理变异后的 <code>TEST</code> protobuf message （非必要步骤）</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_fuzz</span><span class="hljs-params">(MyMutator *mutator, <span class="hljs-comment">// return value from afl_custom_init</span></span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-comment">// input data to be mutated</span></span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> **out_buf, <span class="hljs-comment">// output buffer</span></span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> *add_buf, <span class="hljs-type">size_t</span> add_buf_size,  <span class="hljs-comment">// add_buf can be NULL</span></span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">size_t</span> max_size)</span> </span>&#123;<br>    <span class="hljs-comment">// This function can be named either &quot;afl_custom_fuzz&quot; or &quot;afl_custom_mutator&quot;</span><br>    <span class="hljs-comment">// A simple test shows that &quot;buf&quot; will be the content of the current test case</span><br>    <span class="hljs-comment">// &quot;add_buf&quot; will be the next test case ( from AFL++&#x27;s input queue )</span><br>    <br>    TEST input;<br>    <span class="hljs-comment">// parse input data to TEST</span><br>    <span class="hljs-comment">// Notice that input data should be a serialized protobuf data</span><br>    <span class="hljs-comment">// Check ./in/ii and test_protobuf_serializer for more detail</span><br>    <span class="hljs-type">bool</span> parse_ok = input.<span class="hljs-built_in">ParseFromArray</span>(buf, buf_size);<br>    <span class="hljs-keyword">if</span>(!parse_ok) &#123;<br>        <span class="hljs-comment">// Invalid serialize protobuf data. Don&#x27;t mutate.</span><br>        <span class="hljs-comment">// Return a dummy buffer. Also mutated_size = 0</span><br>        <span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> *dummy = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[<span class="hljs-number">10</span>]; <span class="hljs-comment">// dummy buffer with no data</span><br>        *out_buf = dummy;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-comment">// mutate the protobuf</span><br>    mutator-&gt;<span class="hljs-built_in">Mutate</span>(&amp;input, max_size);<br>    <br>    <span class="hljs-comment">// Convert protobuf to raw data</span><br>    <span class="hljs-type">const</span> TEST *p = &amp;input;<br>    std::string s = <span class="hljs-built_in">ProtoToData</span>(*p);<br>    <span class="hljs-comment">// Copy to a new buffer ( mutated_out )</span><br>    <span class="hljs-type">size_t</span> mutated_size = s.<span class="hljs-built_in">size</span>() &lt;= max_size ? s.<span class="hljs-built_in">size</span>() : max_size; <span class="hljs-comment">// check if raw data&#x27;s size is larger than max_size</span><br>    <span class="hljs-type">uint8_t</span> *mutated_out = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[mutated_size<span class="hljs-number">+1</span>];<br>    <span class="hljs-built_in">memcpy</span>(mutated_out, s.<span class="hljs-built_in">c_str</span>(), mutated_size); <span class="hljs-comment">// copy the mutated data</span><br>    <span class="hljs-comment">// Assign the mutated data and return mutated_size</span><br>    *out_buf = mutated_out;<br>    <span class="hljs-keyword">return</span> mutated_size;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mutator-&gt;Mutate(&amp;input, max_size);</code> 为真正起作用的核心代码</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.h</code>  继承了protobuf_mutator::Mutator， 可以使用 libprotobuf-mutator 的 Mutate 方法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libprotobuf-mutator/src/mutator.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMutator</span> : <span class="hljs-keyword">public</span> protobuf_mutator::Mutator &#123;<br>&#125;;<br></code></pre></td></tr></table></figure>
<ul>
<li><p><code>test_proto_serializer.cc</code></p>
<ul>
<li>用于生成一条序列化的 <code>TEST</code> protobuf message，可以作为 fuzz 的初始化 testcase 使用</li>
</ul>
</li>
<li><p><code>vuln.c</code> 漏洞测试程序</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-type">char</span> str[<span class="hljs-number">100</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>, str, <span class="hljs-number">100</span>);<br>    <span class="hljs-type">int</span> *ptr = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span>( str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\x02&#x27;</span> || str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\xe8&#x27;</span>) &#123;<br>        *ptr = <span class="hljs-number">123</span>; <br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>漏洞测试程序比较简单，只要第一个字节是 <code>0xe8</code> 或者 <code>0x02</code> 即可，libprotobuf-mutator 的变异在这个例子里效率并不高，所以需要使用 <code>PostProcessor</code> 来优化变异。</p>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs makefile">TARGET=lpm_aflpp_custom_mutator_input<br>CXX=clang++-11<br>AFLCC=<span class="hljs-variable">$(HOME)</span>/AFLplusplus/afl-gcc<br>PB_SRC=test.pb.cc<br><br>PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/libprotobuf-mutator/build/external.protobuf<br>PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a<br><br>LPM_DIR=<span class="hljs-variable">$(HOME)</span>/libprotobuf-mutator<br>LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/build/src/libfuzzer/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/build/src/libprotobuf-mutator.a<br><br>INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(LPM_DIR)</span><br><br><span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span>.so</span><br><br><span class="hljs-variable">$(TARGET)</span>.so: <span class="hljs-variable">$(TARGET)</span>.cc <span class="hljs-variable">$(PB_SRC)</span><br>	<span class="hljs-variable">$(CXX)</span> -fPIC -c <span class="hljs-variable">$^</span> <span class="hljs-variable">$(INC)</span><br>	<span class="hljs-variable">$(CXX)</span> -shared -Wall -O3 -o <span class="hljs-variable">$@</span> *.o <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span><br><br><span class="hljs-section">vuln: vuln.c</span><br>	<span class="hljs-variable">$(AFLCC)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span><br><br><span class="hljs-section">test_proto_serializer: test_proto_serializer.cc <span class="hljs-variable">$(PB_SRC)</span></span><br>	<span class="hljs-variable">$(CXX)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span><br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><span class="hljs-section">clean: </span><br>	rm *.so *.o vuln test_proto_serializer<br></code></pre></td></tr></table></figure>

<p>Makefile 有瑕疵，这个章节的内容和 libfuzzer 没有关系，不需要链接 <code>libprotobuf-mutator-libfuzzer.a</code></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">https://developers.google.com/protocol-buffers/docs/cpptutorial</a><br><a target="_blank" rel="noopener" href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md</a><br><a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/">https://github.com/google/libprotobuf-mutator/</a><br><a target="_blank" rel="noopener" href="https://llvm.org/docs/LibFuzzer.html">https://llvm.org/docs/LibFuzzer.html</a><br><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://usmacd.com">曼福吉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/libprotobuf-mutator/">https://usmacd.com/cn/libprotobuf-mutator/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://usmacd.com" target="_blank">安全代码</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Security/">Security</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/llvm_coverage/" title="llvm Coverage 可视化"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">llvm Coverage 可视化</div></div><div class="info-2"><div class="info-item-1">Google 提供的工具Google 提供了一个工具 https://cs.chromium.org/chromium/src/tools/code_coverage/coverage.py 12345678$ gn gen out/coverage \    --args=&#x27;use_clang_coverage=true is_component_build=false dcheck_always_on=true&#x27;$ python tools/code_coverage/coverage.py \    crypto_unittests url_unittests \    -b out/coverage -o out/report \    -c &#x27;out/coverage/crypto_unittests&#x27; \    -c &#x27;out/coverage/url_unittests --gtest_filter=URLParser.PathURL&#x27; \    -f url/ -f crypto/  一些参数的含义: 1...</div></div></div></a><a class="pagination-related" href="/cn/iPhone_white_apple/" title="iPhone 内存满了, 白苹果问题解决方法"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">iPhone 内存满了, 白苹果问题解决方法</div></div><div class="info-2"><div class="info-item-1">上周媳妇的 iPhone 提示内存满了，重启后就进入白苹果状态。安装 itunes 以更新的方式重刷系统后恢复正常 （如果选择恢复模式则会丢失数据）。刷系统的时候一度遇上 14 错误，重新使用更新系统的方式再刷了一遍后，顺利通过 （运气不错）。顺利登录 iPhone 后马上删除各种 App，清理后台驻留的程序，在此也提示大家 iPhone 手机也是要定期维护啊。 说起来就上面几句话，实际操作起来比较麻烦，大概弄了一个早上，把几个要点总结一下。 强制重新启动 iPhone其实在刷机前我尝试了强制重启 iPhone，强制重启 iPhone 的方法可以参考下面链接：https://support.apple.com/zh-cn/guide/iphone/iph8903c3ee6/ios 新版 iPhone 可以使用下面的方法 12345强制重新启动配备面容 ID 的 iPhone若要强制重新启动 iPhone X、iPhone XS、iPhone XR、iPhone 11、iPhone 12 或 iPhone 13，请执行以下操作：按下并快速松开调高音量按钮，按下并快速松开调低音量按钮...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/mitmproxy/" title="mitmproxy 简介"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-19</div><div class="info-item-2">mitmproxy 简介</div></div><div class="info-2"><div class="info-item-1">主要特色：Intercept HTTP &amp; HTTPS requests and responses and modify them on the fly 使用python编写，可以在windows，Linux， Mac 下运行，这点比 fiddler 有优势。可以修改报文内容，这点很不错。  官方网站： https://www.mitmproxy.org/ 文档：https://docs.mitmproxy.org/stable/  ☆ 1. 安装参考 https://docs.mitmproxy.org/stable/overview-installation/ 12sudo dnf install -y python-pip python-devel libffi-devel openssl-devel libxml2-devel libxslt-devel libpng-devel libjpeg-develsudo pip install mitmproxy  # or pip install --user mitmproxy ☆ 2. 基本使用mitmprox...</div></div></div></a><a class="pagination-related" href="/cn/sqlmap_sql_injection/" title="sqlmap 中的 SQL Injection 检测技术"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2017-07-07</div><div class="info-item-2">sqlmap 中的 SQL Injection 检测技术</div></div><div class="info-2"><div class="info-item-1">https://github.com/henices/sqlihttps://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005) 基于信道的 sql injection 分类InbandSQL代码注入和SQL injection 结果的获取在同一频道(e.g. 浏览器), 获得的数据直接显示在应用程序页面的正常输出或者错误信息中,这是最简单的攻击类型。 Out-of-bandSQL查询数据的传输使用不同的频道(e.g HTTP，DNS)， 这是从数据库中获取大量数据简单的方法。 Inferential没用真实有用的数据传输，但是攻击者可以通过发送特定的请求，观察数据库服务器的返回的结果的行为重建信息。 基于 sql inject 检测技术的分类boolean-based blind SQL injection也被称为推理SQL注入：SqlMap替换或追加HTTP请求中受影响的参数，一个有效的SQL语句字符串包含 SELECT 子语句，或任何其他用户要检索输出的SQL语句。对于每个HTTP响应，将其 he...</div></div></div></a><a class="pagination-related" href="/cn/halfempty/" title="halfempty 的一些使用说明"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-25</div><div class="info-item-2">halfempty 的一些使用说明</div></div><div class="info-2"><div class="info-item-1">https://github.com/googleprojectzero/halfempty google P0 @taviso 提供的 testcase 并行快速精简工具 （A fast, parallel test case minimization tool）需要注意的是 halfempty 只能精简导致目标程序 crash 的 testcase，如果 testcase 不导致目标程序 crash， 还是需要使用 afl-tmin 类似的工具根据 coverage 来精简。 halfempty 工具向测试脚本传递内容时使用的是 pipe， 如果测试的程序只接受文件路径作为参数时，需要一些技巧，README 虽然有提及但是说的比较晦涩。 以 upx 为例，upx 的命令行帮助如下 12345678910111213141516171819202122root@fuzzing-5:/mnt/disk/halfempty# ./upx.out_x86-64                       Ultimate Packer for eXecutables         ...</div></div></div></a><a class="pagination-related" href="/cn/oracle_run_os_cmd/" title="Execute os command in Oracle Database"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Execute os command in Oracle Database</div></div><div class="info-2"><div class="info-item-1">1. 正统方法1.1 使用JAVA1.1.1 代码Oracle 数据库都支持Java，可以利用java来实现我们需要的功能。 123456789101112131415161718192021222324252627282930313233343536373839404142434445CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED &quot;JAVACMD&quot; ASimport java.lang.*;import java.io.*;public class JAVACMD&#123; public static void execCommand (String command) throws IOException &#123;    try &#123;        String[] finalCommand;        if (System.getProperty(&quot;os.name&quot;).toLowerCase().indexOf(&quot;windows&quot;) != -1) &...</div></div></div></a><a class="pagination-related" href="/cn/ubuntu_cuda_hashcat/" title="在Ubuntu 14.04 上安装 oclHashcat 的方法 (cuda)"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2015-03-24</div><div class="info-item-2">在Ubuntu 14.04 上安装 oclHashcat 的方法 (cuda)</div></div><div class="info-2"><div class="info-item-1">首先需要下载正确的驱动和软件，下载的软件版本一定要正确。下面的两个链接地址是我实验成功的版本。 N卡驱动 ：http://us.download.nvidia.com/XFree86/Linux-x86_64/346.47/NVIDIA-Linux-x86_64-346.47.runoclHashcat: https://hashcat.net/files/cudaHashcat-1.35.7z 关键是需要ForceWare 346.x或者更新的版本，ForceWare驱动是nVIDIA 系列显卡最新官方版本名称, 估计和AMD的催化剂类似。如果安装驱动的版本不对运行oclhashcat的时候会报 ERROR: cuModuleLoad() 209 错误，排查了较长时间发现是驱动版本不对，340.x的驱动无法正常工作，一定需要 346.x 的驱动。 基本要求http://us.download.nvidia.com/XFree86/Linux-x86_64/346.47/README/index.html 12345678binutils                  2.9...</div></div></div></a><a class="pagination-related" href="/cn/onefuzz/" title="onefuzz 简单分析"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">onefuzz 简单分析</div></div><div class="info-2"><div class="info-item-1">deploy agent (部署)123unzip onefuzz-deployment-$VERSION.zippip install -r requirements.txt./deploy.py $REGION $RESOURCE_GROUP_NAME $ONEFUZZ_INSTANCE_NAME $CONTACT_EMAIL_ADDRESS  Azure CLI logged in 后，执行上面命令可以在 Azure 上部署 agent 需要订阅 Azure， 可能要收费 安装 onefuzz CLI123wget https://github.com/microsoft/onefuzz/releases/download/1.0.0/onefuzz-1.0.0-py3-none-any.whlwget https://github.com/microsoft/onefuzz/releases/download/1.0.0/onefuzztypes-1.0.0-py3-none-any.whlpip install ./onefuzz*.whl  执行 fuzz 任务1on...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">曼福吉</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">171</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-are-protocol-buffers"><span class="toc-number">1.</span> <span class="toc-text">What are protocol buffers?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libprotobuf-mutator"><span class="toc-number">2.</span> <span class="toc-text">libprotobuf-mutator</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">编译安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libprotobuf-mutator-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">libprotobuf-mutator 代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libprotobuf-mutator-fuzzing-learning"><span class="toc-number">3.</span> <span class="toc-text">libprotobuf-mutator_fuzzing_learning</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Simple-protobuf-example"><span class="toc-number">3.1.</span> <span class="toc-text">Simple protobuf example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Combine-libprotobuf-mutator-with-libfuzzer"><span class="toc-number">3.2.</span> <span class="toc-text">Combine libprotobuf-mutator with libfuzzer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91"><span class="toc-number">3.2.1.</span> <span class="toc-text">代码编译</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handling-input-from-AFL-in-our-custom-mutator"><span class="toc-number">3.3.</span> <span class="toc-text">Handling input from AFL++ in our custom mutator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/ai_studio_podcast_transcript/" title="利用 AI Studio 整理播客音频的逐字稿">利用 AI Studio 整理播客音频的逐字稿</a><time datetime="2026-01-07T16:00:00.000Z" title="发表于 2026-01-08 00:00:00">2026-01-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/anti-weakness-learning/" title="反脆弱式的学习方法">反脆弱式的学习方法</a><time datetime="2025-12-30T16:00:00.000Z" title="发表于 2025-12-31 00:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/keep_hard/" title="坚持的秘诀">坚持的秘诀</a><time datetime="2025-12-15T16:00:00.000Z" title="发表于 2025-12-16 00:00:00">2025-12-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/investment_category2/" title="金融市场中的不同流派 (2)">金融市场中的不同流派 (2)</a><time datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/how_to_set_a_goal/" title="如何设定一个好目标">如何设定一个好目标</a><time datetime="2025-12-04T16:00:00.000Z" title="发表于 2025-12-05 00:00:00">2025-12-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 曼福吉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><script src="/js/tw_cn.js?v=5.5.3"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.3"></script></div></div></body></html>