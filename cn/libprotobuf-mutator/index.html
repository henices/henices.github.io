

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="henices">
  <meta name="keywords" content="">
  
    <meta name="description" content="What are protocol buffers?Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You defi">
<meta property="og:type" content="article">
<meta property="og:title" content="libprotobuf-mutator 简单分析">
<meta property="og:url" content="https://usmacd.com/cn/libprotobuf-mutator/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="What are protocol buffers?Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You defi">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-09-06T03:00:51.596Z">
<meta property="article:modified_time" content="2023-09-06T03:00:51.596Z">
<meta property="article:author" content="henices">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>libprotobuf-mutator 简单分析 - 安全代码</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"usmacd.com","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":false,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 40vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>安全代码</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/thoughts" target="_self">
                <i class="iconfont icon-exp-fill"></i>
                <span>thoughts</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/rss.xml" target="_self">
                <i class="iconfont icon-rss"></i>
                <span>rss</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/random.html" target="_self">
                
                <span>random</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/sitemap.xml" target="_self">
                
                <span>sitemap</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://images.unsplash.com/photo-1473181488821-2d23949a045a?w=640') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">libprotobuf-mutator 简单分析</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-06 11:00" pubdate>
          2023年9月6日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          19 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">libprotobuf-mutator 简单分析</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="What-are-protocol-buffers"><a href="#What-are-protocol-buffers" class="headerlink" title="What are protocol buffers?"></a><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">What are protocol buffers?</a></h2><p>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages.</p>
<p>这段是 Google 官方网站给出的介绍，protobuf 可以自动化生成代码，用于读入或者写入结构化数据。一个简单的 protobuf 文件可以是这样的：</p>
<div class="code-wrapper"><pre><code class="hljs protobuf"><span class="hljs-keyword">message </span><span class="hljs-title class_">Person</span> &#123;
  <span class="hljs-keyword">required</span> <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">required</span> <span class="hljs-type">int32</span> id = <span class="hljs-number">2</span>;
  <span class="hljs-keyword">optional</span> <span class="hljs-type">string</span> email = <span class="hljs-number">3</span>;
&#125;</code></pre></div>

<p>具体的语法可以参考Google 的文档 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2</a> 和 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">proto3</a>。c++ 语言使用 protobuf 的示例可以参见<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">Protocol Buffer Basics: C++</a> 文档，基本步骤总结如下：</p>
<ol>
<li>写 protobuf 文件，表达数据结构</li>
<li>利用 protoc 自动生成代码 （支持多种语言 C++ Java 等）</li>
<li>利用生成的文件解析或者写入相关数据结构</li>
</ol>
<h2 id="libprotobuf-mutator"><a href="#libprotobuf-mutator" class="headerlink" title="libprotobuf-mutator"></a>libprotobuf-mutator</h2><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>参考： <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/README.md">https://github.com/google/libprotobuf-mutator/blob/master/README.md</a></p>
<div class="code-wrapper"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/google/libprotobuf-mutator.git
<span class="hljs-built_in">mkdir</span> build
<span class="hljs-built_in">cd</span> build
cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug
https_proxy=http://127.0.0.1:3128 ninja check</code></pre></div>

<p>由于需要从Google下载一些源码，所以在 <code>ninja check</code> 的时候需要挂上代理，结果编译出错了，找不到 <code>libxml2.a</code>，排查一下编译参数，发现需要添加编译静态库的参数</p>
<div class="code-wrapper"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/cmake/external/libxml2.cmake b/cmake/external/libxml2.cmake</span>
<span class="hljs-comment">index c00ace2..a944fab 100644</span>
<span class="hljs-comment">--- a/cmake/external/libxml2.cmake</span>
<span class="hljs-comment">+++ b/cmake/external/libxml2.cmake</span>
<span class="hljs-meta">@@ -38,6 +38,7 @@</span> ExternalProject_Add($&#123;LIBXML2_TARGET&#125;
     UPDATE_COMMAND &quot;&quot;
     CONFIGURE_COMMAND $&#123;LIBXML2_SRC_DIR&#125;/autogen.sh --without-python
                                                     --prefix=$&#123;LIBXML2_INSTALL_DIR&#125;
<span class="hljs-addition">+                                                    --enable-static=yes</span>
                                                     CC=$&#123;CMAKE_C_COMPILER&#125;
                                                     CXX=$&#123;CMAKE_CXX_COMPILER&#125;
                                                     CFLAGS=$&#123;LIBXML2_CFLAGS&#125;</code></pre></div>

<p>修改后可以正常通过 <code>ninja check</code> 命令的所有检查。默认情况下 <code>ninja install</code> 会安装到 &#x2F;usr&#x2F;local 目录，因为考虑到后续需要给 <code>afl+</code>使用，所以需要使用下的命令重新 cmake 一下</p>
<div class="code-wrapper"><pre><code class="hljs bash">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \
-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug</code></pre></div>
<h3 id="libprotobuf-mutator-代码实现"><a href="#libprotobuf-mutator-代码实现" class="headerlink" title="libprotobuf-mutator 代码实现"></a>libprotobuf-mutator 代码实现</h3><p>libfuzzer_macro.h</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, Proto)                 \</span>
<span class="hljs-meta">  extern <span class="hljs-string">&quot;C&quot;</span> int LLVMFuzzerTestOneInput(const uint8_t* data, size_t size) &#123; \</span>
<span class="hljs-meta">    using protobuf_mutator::libfuzzer::LoadProtoInput;                      \</span>
<span class="hljs-meta">    Proto input;                                                            \</span>
<span class="hljs-meta">    <span class="hljs-keyword">if</span> (LoadProtoInput(use_binary, data, size, &amp;input))                     \</span>
<span class="hljs-meta">      TestOneProtoInput(input);                                             \</span>
<span class="hljs-meta">    return 0;                                                               \</span>
<span class="hljs-meta">  &#125;</span>
  
<span class="hljs-comment">// Defines custom mutator, crossover and test functions using default</span>
<span class="hljs-comment">// serialization format. Default is text.</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_PROTO_FUZZER(arg) DEFINE_TEXT_PROTO_FUZZER(arg)</span>
<span class="hljs-comment">// Defines custom mutator, crossover and test functions using text</span>
<span class="hljs-comment">// serialization. This format is more convenient to read.</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_TEXT_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(false, arg)</span>
<span class="hljs-comment">// Defines custom mutator, crossover and test functions using binary</span>
<span class="hljs-comment">// serialization. This makes mutations faster. However often test function is</span>
<span class="hljs-comment">// significantly slower than mutator, so fuzzing rate may stay unchanged.</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_BINARY_PROTO_FUZZER(arg) DEFINE_PROTO_FUZZER_IMPL(true, arg)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFINE_PROTO_FUZZER_IMPL(use_binary, arg)                              \</span>
<span class="hljs-meta">  static void TestOneProtoInput(arg);                                          \</span>
<span class="hljs-meta">  using FuzzerProtoType = std::remove_const&lt;std::remove_reference&lt;             \</span>
<span class="hljs-meta">      std::function<span class="hljs-string">&lt;decltype(TestOneProtoInput)&gt;</span>::argument_type&gt;::type&gt;::type; \</span>
<span class="hljs-meta">  DEFINE_CUSTOM_PROTO_MUTATOR_IMPL(use_binary, FuzzerProtoType)                \</span>
<span class="hljs-meta">  DEFINE_CUSTOM_PROTO_CROSSOVER_IMPL(use_binary, FuzzerProtoType)              \</span>
<span class="hljs-meta">  DEFINE_TEST_ONE_PROTO_INPUT_IMPL(use_binary, FuzzerProtoType)                \</span>
<span class="hljs-meta">  DEFINE_POST_PROCESS_PROTO_MUTATION_IMPL(FuzzerProtoType)                     \</span>
<span class="hljs-meta">  static void TestOneProtoInput(arg)</span></code></pre></div>

<p>调用路径为 <code>DEFINE_PROTO_FUZZER</code> -&gt; <code>DEFINE_TEXT_PROTO_FUZZER</code> -&gt; <code>DEFINE_PROTO_FUZZER_IMPL</code> -&gt; <code>DEFINE_TEST_ONE_PROTO_INPUT_IMPL</code> -&gt; <code>LLVMFuzzerTestOneInput</code> -&gt; <code>TestOneProtoInput</code>。<br>最终还是实现了<code>LLVMFuzzerTestOneInput</code> libfuzzer 的入口方法，使用 macro 可以少写不少代码非常方便，从这里就可以看出 fuzz 的 target function 必须和 <code>LLVMFuzzerTestOneInput</code> 的参数类型一致</p>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// fuzz_target.cc</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">int</span> <span class="hljs-title function_">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Data, <span class="hljs-type">size_t</span> Size)</span> &#123;
  DoSomethingInterestingWithMyAPI(Data, Size);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// Non-zero return values are reserved for future use.</span>
&#125;</code></pre></div>

<p>libfuzzer_macro.cc</p>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">LoadProtoInput</span><span class="hljs-params">(<span class="hljs-type">bool</span> binary, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size,</span></span>
<span class="hljs-params"><span class="hljs-function">                    protobuf::Message* input)</span> </span>&#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetCache</span>()-&gt;<span class="hljs-built_in">LoadIfSame</span>(data, size, input)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">auto</span> result = binary ? <span class="hljs-built_in">ParseBinaryMessage</span>(data, size, input)
                       : <span class="hljs-built_in">ParseTextMessage</span>(data, size, input);
  <span class="hljs-keyword">if</span> (!result) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-built_in">GetMutator</span>()-&gt;<span class="hljs-built_in">Seed</span>(size);
  <span class="hljs-built_in">GetMutator</span>()-&gt;<span class="hljs-built_in">Fix</span>(input);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
&#125;</code></pre></div>

<p><code>LoadProtoInput</code> 返回 <code>true</code> 或者 <code>false</code>，如果解析成功，将调用 <code>TestOneProtoInput</code>，<code>DEFINE_PROTO_FUZZER</code> macro 其实就是写 TestOneProtoInput 的实现。</p>
<h2 id="libprotobuf-mutator-fuzzing-learning"><a href="#libprotobuf-mutator-fuzzing-learning" class="headerlink" title="libprotobuf-mutator_fuzzing_learning"></a>libprotobuf-mutator_fuzzing_learning</h2><p>这是 github 上一位同行写的学习 libprotobuf-mutator fuzzing 的文章，总体写的不错，但是其中有一些错误的地方，在实践过程中都记录了其中的修改。</p>
<h3 id="Simple-protobuf-example"><a href="#Simple-protobuf-example" class="headerlink" title="Simple protobuf example"></a>Simple protobuf example</h3><p>文章：<a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/1_simple_protobuf</a></p>
<p>先写一个简单的 protobuf 文件，test.proto</p>
<div class="code-wrapper"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto2&quot;</span>;

<span class="hljs-keyword">message </span><span class="hljs-title class_">TEST</span> &#123;
  <span class="hljs-keyword">required</span> <span class="hljs-type">uint32</span> a = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">required</span> <span class="hljs-type">string</span> b = <span class="hljs-number">2</span>;
&#125;</code></pre></div>

<p>使用 <code>protoc</code> 编译 protobuf 文件</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> genfiles  
protoc ./test.proto --cpp_out=./genfiles</code></pre></div>

<p>将自动生成两个文件</p>
<div class="code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> ./genfiles
test.pb.cc  test.pb.h</code></pre></div>

<p>写一个测试程序 test_proto.cc</p>
<div class="code-wrapper"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>

<span class="hljs-keyword">using</span> std::cin;
<span class="hljs-keyword">using</span> std::cout;
<span class="hljs-keyword">using</span> std::endl;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span>
<span class="hljs-function"></span>&#123;
    TEST t;
    t.<span class="hljs-built_in">set_a</span>(<span class="hljs-number">101</span>);
    t.<span class="hljs-built_in">set_b</span>(<span class="hljs-string">&quot;testtest&quot;</span>);
    cout &lt;&lt; t.<span class="hljs-built_in">a</span>() &lt;&lt; endl;
    cout &lt;&lt; t.<span class="hljs-built_in">b</span>() &lt;&lt; endl;   
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div>

<p>写 Makefile 来编译 <code>test_proto.cc</code></p>
<div class="code-wrapper"><pre><code class="hljs makefile">CXX=clang++
PB_SRC=test.pb.cc

PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/
PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a
INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span>

<span class="hljs-section">test_proto: test_proto.cc <span class="hljs-variable">$(PB_SRC)</span></span>
	<span class="hljs-variable">$(CXX)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span>

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span>
<span class="hljs-section">clean: </span>
	rm test_proto</code></pre></div>

<p>执行 <code>make</code> 后报错 .&#x2F;test.pb.h:17:2: error: This file was generated by an older version of protoc which is，因为我们在编译的时候使用了 <code>-DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON</code> 下载了新版本的 protobuf，所以出了这个错误。只好使用下载的 protoc 重新生成 <code>test.pb.cc</code> 和 <code>test.pb.h</code></p>
<div class="code-wrapper"><pre><code class="hljs bash">~/code/libprotobuf-mutator/build/external.protobuf/bin/protoc ./test.proto --cpp_out=./genfiles</code></pre></div>

<p>这次可以成功 make 了，实际执行的命令是</p>
<div class="code-wrapper"><pre><code class="hljs bash">clang++ -o test_proto test_proto.cc test.pb.cc /home/henices/code/libprotobuf-mutator/build/external.protobuf//lib/libprotobufd.a \
 -I/home/henices/code/libprotobuf-mutator/build/external.protobuf//include</code></pre></div>

<p>运行 <code>./test_proto</code>, 输出如下</p>
<div class="code-wrapper"><pre><code class="hljs">101
testtest</code></pre></div>

<h3 id="Combine-libprotobuf-mutator-with-libfuzzer"><a href="#Combine-libprotobuf-mutator-with-libfuzzer" class="headerlink" title="Combine libprotobuf-mutator with libfuzzer"></a>Combine libprotobuf-mutator with libfuzzer</h3><p>代码在： <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/2_libprotobuf_libfuzzer</a></p>
<p>harness.cc</p>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span>

<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FuzzTEST</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *data, <span class="hljs-type">size_t</span> size)</span> </span>&#123;
    <span class="hljs-keyword">if</span>(data[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\x01&#x27;</span>) &#123;
        __builtin_trap();
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div>

<p>其中 FuzzTEST 是我们需要测试的目标函数。</p>
<p>lpm_libfuzz.cc</p>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>

<span class="hljs-keyword">using</span> std::cin;
<span class="hljs-keyword">using</span> std::cout;
<span class="hljs-keyword">using</span> std::endl;

<span class="hljs-function">std::string <span class="hljs-title">ProtoToData</span><span class="hljs-params">(<span class="hljs-type">const</span> TEST &amp;test_proto)</span> </span>&#123;
    std::stringstream all;
    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;aa = test_proto.<span class="hljs-built_in">a</span>();
    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;bb = test_proto.<span class="hljs-built_in">b</span>();
    all.<span class="hljs-built_in">write</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)&amp;aa, <span class="hljs-built_in">sizeof</span>(aa));
    <span class="hljs-keyword">if</span>(bb.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span>) &#123;
        all.<span class="hljs-built_in">write</span>(bb.<span class="hljs-built_in">c_str</span>(), bb.<span class="hljs-built_in">size</span>());
    &#125;

    std::string res = all.<span class="hljs-built_in">str</span>();
    <span class="hljs-keyword">if</span> (bb.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span> &amp;&amp; res.<span class="hljs-built_in">size</span>() != <span class="hljs-number">0</span>) &#123;
        <span class="hljs-comment">// set PROTO_FUZZER_DUMP_PATH env to dump the serialized protobuf</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *dump_path = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;PROTO_FUZZER_DUMP_PATH&quot;</span>)) &#123;
            <span class="hljs-function">std::ofstream <span class="hljs-title">of</span><span class="hljs-params">(dump_path)</span></span>;
            of.<span class="hljs-built_in">write</span>(res.<span class="hljs-built_in">data</span>(), res.<span class="hljs-built_in">size</span>());
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> res;
&#125;

<span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FuzzTEST</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* data, <span class="hljs-type">size_t</span> size)</span></span>; <span class="hljs-comment">// our customized fuzzing function</span>

<span class="hljs-built_in">DEFINE_PROTO_FUZZER</span>(<span class="hljs-type">const</span> TEST &amp;test_proto) &#123;
    <span class="hljs-keyword">auto</span> s = <span class="hljs-built_in">ProtoToData</span>(test_proto); <span class="hljs-comment">// convert protobuf to raw data</span>
    <span class="hljs-built_in">FuzzTEST</span>((<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>*)s.<span class="hljs-built_in">data</span>(), s.<span class="hljs-built_in">size</span>()); <span class="hljs-comment">// fuzz the function</span>
&#125;</code></pre></div>
<p>在文件的最开头导入 <code>libfuzzer_macro.h</code>， 后面就可以使用一些宏来写代码了，<code>DEFINE_PROTO_FUZZER</code> 是关键的 fuzzer 入口。结构化变异部分 libprotobuf-mutator 已经完成了，需要实现的是一个由 protobuf 转需要的数据类型的函数，如上面的 <code>ProtoToData</code></p>
<h4 id="代码编译"><a href="#代码编译" class="headerlink" title="代码编译"></a>代码编译</h4><div class="code-wrapper"><pre><code class="hljs makefile">TARGET=lpm_libfuzz
CXX=clang++
CXXFLAGS=-g -fsanitize=fuzzer,address
PB_SRC=test.pb.cc

PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/
LPM_DIR=<span class="hljs-variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator
PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a
LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a
INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(LPM_DIR)</span>/<span class="hljs-keyword">include</span>
DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST

<span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span></span>

<span class="hljs-comment"># for testing libprotobuf + libfuzzer</span>
<span class="hljs-comment"># compile harness first</span>
<span class="hljs-comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span>
<span class="hljs-section">harness.o: harness.cc</span>
	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c <span class="hljs-variable">$(DFUZZ)</span> <span class="hljs-variable">$&lt;</span>

<span class="hljs-variable">$(TARGET)</span>: harness.o <span class="hljs-variable">$(TARGET)</span>.cc
	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PB_SRC)</span> <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span> <span class="hljs-comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span>

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span>
<span class="hljs-section">clean: </span>
	rm <span class="hljs-variable">$(TARGET)</span> *.o</code></pre></div>

<p>make 后报错，找不到头文件</p>
<div class="code-wrapper"><pre><code class="hljs gauss">/home/henices/<span class="hljs-built_in">code</span>/AFL+/<span class="hljs-keyword">external</span>/libprotobuf-mutator/include/libprotobuf-mutator/src/libfuzzer/libfuzzer_macro.h:<span class="hljs-number">24</span>:<span class="hljs-number">10</span>: fatal <span class="hljs-built_in">error</span>: &#x27;port/protobuf.h&#x27; file <span class="hljs-keyword">not</span> found
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;port/protobuf.h&quot;</span></span>
         ^~~~~~~~~~~~~~~~~
<span class="hljs-number">1</span> <span class="hljs-built_in">error</span> generated.</code></pre></div>

<p>port&#x2F;protobuf.h  来自 <a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h">https://github.com/google/libprotobuf-mutator/blob/master/port/protobuf.h</a>  修改 Makefile 如下</p>
<div class="code-wrapper"><pre><code class="hljs makefile">TARGET=lpm_libfuzz
CXX=clang++
CXXFLAGS=-g -fsanitize=fuzzer,address
PB_SRC=test.pb.cc

PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/build/external.protobuf/
LPM_DIR=<span class="hljs-variable">$(HOME)</span>/code/AFL+/external/libprotobuf-mutator
PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a
LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/lib/libprotobuf-mutator.a
INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(HOME)</span>/code/libprotobuf-mutator/ -I<span class="hljs-variable">$(LPM_DIR)</span>/<span class="hljs-keyword">include</span>
DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST

<span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span></span>

<span class="hljs-comment"># for testing libprotobuf + libfuzzer</span>
<span class="hljs-comment"># compile harness first</span>
<span class="hljs-comment"># then link lpm_libfuzz with harness.o &amp; static libraries</span>
<span class="hljs-section">harness.o: harness.cc</span>
	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c <span class="hljs-variable">$(DFUZZ)</span> <span class="hljs-variable">$&lt;</span>

<span class="hljs-variable">$(TARGET)</span>: harness.o <span class="hljs-variable">$(TARGET)</span>.cc
	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PB_SRC)</span> <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span> <span class="hljs-comment"># $(LPM_LIB) must be placed before $(PROTOBUF_LIB)</span>

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span>
<span class="hljs-section">clean: </span>
	rm <span class="hljs-variable">$(TARGET)</span> *.o</code></pre></div>

<p>修改 makefile 后，可以正常编译通过。经过我们上面的分析，不需要定义 <code>DFUZZ=-DLLVMFuzzerTestOneInput=FuzzTEST</code> 将这行删除掉，同样可以编译通过。</p>
<p>执行 <code>lpm_libfuzz</code> 运行正常</p>
<div class="code-wrapper"><pre><code class="hljs dts">➜  ./lpm_libfuzz                                                                                                                                                                                          
<span class="hljs-symbol">INFO:</span> found LLVMFuzzerCustomMutator (<span class="hljs-number">0x758a80</span>). Disabling -len_control by default.
<span class="hljs-symbol">INFO:</span> Running with entropic power schedule (<span class="hljs-number">0xFF</span>, <span class="hljs-number">100</span>).                                    
<span class="hljs-symbol">INFO:</span> Seed: <span class="hljs-number">331712324</span>                       
<span class="hljs-symbol">INFO:</span> Loaded <span class="hljs-number">1</span> modules   (<span class="hljs-number">434</span> inline <span class="hljs-number">8</span>-bit counters): <span class="hljs-number">434</span> [<span class="hljs-number">0xa056b8</span>, <span class="hljs-number">0xa0586a</span>), 
<span class="hljs-symbol">INFO:</span> Loaded <span class="hljs-number">1</span> PC tables (<span class="hljs-number">434</span> PCs): <span class="hljs-number">434</span> [<span class="hljs-number">0x939398</span>,<span class="hljs-number">0x93aeb8</span>), 
<span class="hljs-symbol">INFO:</span> -max_len is not <span class="hljs-attr">provided</span><span class="hljs-punctuation">;</span> libFuzzer will not generate inputs larger than <span class="hljs-number">4096</span> bytes
<span class="hljs-symbol">INFO:</span> A corpus is not provided, starting from an empty corpus
<span class="hljs-meta">#2      INITED cov: 82 ft: 83 corp: 1/1b exec/s: 0 rss: 35Mb</span>
        NEW_FUNC[<span class="hljs-number">1</span>/<span class="hljs-number">41</span>]: <span class="hljs-number">0x75abb0</span> in TEST::~TEST() <span class="hljs-keyword">/tmp/</span>genfiles/test.pb.cc:<span class="hljs-number">116</span>
        NEW_FUNC[<span class="hljs-number">2</span>/<span class="hljs-number">41</span>]: <span class="hljs-number">0x75ca10</span> in google::protobuf::UnknownFieldSet* google::protobuf::internal::InternalMetadata::mutable_unknown_fields<span class="hljs-params">&lt;google::protobuf::UnknownFieldSet&gt;</span>() <span class="hljs-keyword">/home/</span>henices<span class="hljs-keyword">/code/</span>libprotobuf-mut
ator<span class="hljs-keyword">/build/</span>external.protobuf<span class="hljs-comment">//include/google/protobuf/metadata_lite.h:117</span>
<span class="hljs-meta">#3      NEW    cov: 135 ft: 159 corp: 2/12b lim: 4096 exec/s: 0 rss: 36Mb L: 11/11 MS: 1 CustomCrossOver-</span>
<span class="hljs-meta">#4      NEW    cov: 138 ft: 162 corp: 3/201b lim: 4096 exec/s: 0 rss: 36Mb L: 189/189 MS: 2 InsertRepeatedBytes-Custom-</span>
<span class="hljs-meta">#38     REDUCE cov: 138 ft: 162 corp: 3/127b lim: 4096 exec/s: 0 rss: 37Mb L: 115/115 MS: 5 CustomCrossOver-CustomCrossOver-Custom-InsertRepeatedBytes-Custom-</span>
<span class="hljs-meta">#60     REDUCE cov: 138 ft: 162 corp: 3/124b lim: 4096 exec/s: 0 rss: 37Mb L: 112/112 MS: 4 CustomCrossOver-ShuffleBytes-ChangeByte-Custom-</span>
<span class="hljs-meta">#98     REDUCE cov: 138 ft: 162 corp: 3/56b lim: 4096 exec/s: 0 rss: 37Mb L: 44/44 MS: 5 CrossOver-Custom-Custom-CMP-Custom- DE: <span class="hljs-string">&quot;~\xff\xff\xff\xff\xff\xff\xff&quot;</span>-</span>
<span class="hljs-meta">#144    REDUCE cov: 138 ft: 162 corp: 3/53b lim: 4096 exec/s: 0 rss: 37Mb L: 41/41 MS: 2 CrossOver-Custom-</span>
<span class="hljs-meta">#182    REDUCE cov: 138 ft: 162 corp: 3/25b lim: 4096 exec/s: 0 rss: 37Mb L: 13/13 MS: 5 ChangeBit-Custom-Custom-InsertByte-Custom-</span>
<span class="hljs-meta">#324    REDUCE cov: 138 ft: 162 corp: 3/24b lim: 4096 exec/s: 0 rss: 38Mb L: 12/12 MS: 3 CustomCrossOver-EraseBytes-Custom-</span></code></pre></div>

<h3 id="Handling-input-from-AFL-in-our-custom-mutator"><a href="#Handling-input-from-AFL-in-our-custom-mutator" class="headerlink" title="Handling input from AFL++ in our custom mutator"></a>Handling input from AFL++ in our custom mutator</h3><p><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/tree/master/5_libprotobuf_aflpp_custom_mutator_input</a></p>
<p>主要内容是将 libprotobuf-mutator 和 afl++ 结合起来，使用的 afl++ 的 custom mutator，值得一提的是在这个例子里，需要使用 <code>-fPIC</code> 参数编译 libprotobuf-mutator。</p>
<div class="code-wrapper"><pre><code class="hljs c">cmake .. -GNinja -DCMAKE_C_COMPILER=clang -DLIB_PROTO_MUTATOR_DOWNLOAD_PROTOBUF=ON \
-DCMAKE_INSTALL_PREFIX=/home/henices/code/AFL+/external/libprotobuf-mutator \
-DCMAKE_CXX_COMPILER=clang++ -DCMAKE_BUILD_TYPE=Debug \
-DCMAKE_C_FLAGS=<span class="hljs-string">&quot;-fPIC&quot;</span> -DCMAKE_CXX_FLAGS=<span class="hljs-string">&quot;-fPIC&quot;</span></code></pre></div>

<p>主要的步骤在 <a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning/blob/master/5_libprotobuf_aflpp_custom_mutator_input/README.md">readme.md</a> 中已经介绍得比较清楚了。</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.cc</code> 是 afl++ 的 custom mutator shared library<ul>
<li>解析输入数据（testcase buffer）并将其转成 <code>TEST</code> protobuf message</li>
<li>使用 <code>libprotobuf-mutator</code> 变异 <code>TEST</code> protobuf message</li>
<li>注册一个 <code>PostProcessor</code> 处理变异后的 <code>TEST</code> protobuf message （非必要步骤）</li>
</ul>
</li>
</ul>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_fuzz</span><span class="hljs-params">(MyMutator *mutator, <span class="hljs-comment">// return value from afl_custom_init</span></span></span>
<span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-comment">// input data to be mutated</span></span></span>
<span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> **out_buf, <span class="hljs-comment">// output buffer</span></span></span>
<span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">uint8_t</span> *add_buf, <span class="hljs-type">size_t</span> add_buf_size,  <span class="hljs-comment">// add_buf can be NULL</span></span></span>
<span class="hljs-params"><span class="hljs-function">                       <span class="hljs-type">size_t</span> max_size)</span> </span>&#123;
    <span class="hljs-comment">// This function can be named either &quot;afl_custom_fuzz&quot; or &quot;afl_custom_mutator&quot;</span>
    <span class="hljs-comment">// A simple test shows that &quot;buf&quot; will be the content of the current test case</span>
    <span class="hljs-comment">// &quot;add_buf&quot; will be the next test case ( from AFL++&#x27;s input queue )</span>
    
    TEST input;
    <span class="hljs-comment">// parse input data to TEST</span>
    <span class="hljs-comment">// Notice that input data should be a serialized protobuf data</span>
    <span class="hljs-comment">// Check ./in/ii and test_protobuf_serializer for more detail</span>
    <span class="hljs-type">bool</span> parse_ok = input.<span class="hljs-built_in">ParseFromArray</span>(buf, buf_size);
    <span class="hljs-keyword">if</span>(!parse_ok) &#123;
        <span class="hljs-comment">// Invalid serialize protobuf data. Don&#x27;t mutate.</span>
        <span class="hljs-comment">// Return a dummy buffer. Also mutated_size = 0</span>
        <span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> *dummy = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[<span class="hljs-number">10</span>]; <span class="hljs-comment">// dummy buffer with no data</span>
        *out_buf = dummy;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    &#125;
    <span class="hljs-comment">// mutate the protobuf</span>
    mutator-&gt;<span class="hljs-built_in">Mutate</span>(&amp;input, max_size);
    
    <span class="hljs-comment">// Convert protobuf to raw data</span>
    <span class="hljs-type">const</span> TEST *p = &amp;input;
    std::string s = <span class="hljs-built_in">ProtoToData</span>(*p);
    <span class="hljs-comment">// Copy to a new buffer ( mutated_out )</span>
    <span class="hljs-type">size_t</span> mutated_size = s.<span class="hljs-built_in">size</span>() &lt;= max_size ? s.<span class="hljs-built_in">size</span>() : max_size; <span class="hljs-comment">// check if raw data&#x27;s size is larger than max_size</span>
    <span class="hljs-type">uint8_t</span> *mutated_out = <span class="hljs-keyword">new</span> <span class="hljs-type">uint8_t</span>[mutated_size<span class="hljs-number">+1</span>];
    <span class="hljs-built_in">memcpy</span>(mutated_out, s.<span class="hljs-built_in">c_str</span>(), mutated_size); <span class="hljs-comment">// copy the mutated data</span>
    <span class="hljs-comment">// Assign the mutated data and return mutated_size</span>
    *out_buf = mutated_out;
    <span class="hljs-keyword">return</span> mutated_size;
&#125;</code></pre></div>

<p><code>mutator-&gt;Mutate(&amp;input, max_size);</code> 为真正起作用的核心代码</p>
<ul>
<li><code>lpm_aflpp_custom_mutator_input.h</code>  继承了protobuf_mutator::Mutator， 可以使用 libprotobuf-mutator 的 Mutate 方法</li>
</ul>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;libprotobuf-mutator/src/mutator.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;test.pb.h&quot;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMutator</span> : <span class="hljs-keyword">public</span> protobuf_mutator::Mutator &#123;
&#125;;</code></pre></div>
<ul>
<li><p><code>test_proto_serializer.cc</code></p>
<ul>
<li>用于生成一条序列化的 <code>TEST</code> protobuf message，可以作为 fuzz 的初始化 testcase 使用</li>
</ul>
</li>
<li><p><code>vuln.c</code> 漏洞测试程序</p>
</li>
</ul>
<div class="code-wrapper"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
&#123;
    <span class="hljs-type">char</span> str[<span class="hljs-number">100</span>]=&#123;&#125;;
    read(<span class="hljs-number">0</span>, str, <span class="hljs-number">100</span>);
    <span class="hljs-type">int</span> *ptr = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">if</span>( str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\x02&#x27;</span> || str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\xe8&#x27;</span>) &#123;
        *ptr = <span class="hljs-number">123</span>; 
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div>

<p>漏洞测试程序比较简单，只要第一个字节是 <code>0xe8</code> 或者 <code>0x02</code> 即可，libprotobuf-mutator 的变异在这个例子里效率并不高，所以需要使用 <code>PostProcessor</code> 来优化变异。</p>
<ul>
<li>Makefile</li>
</ul>
<div class="code-wrapper"><pre><code class="hljs makefile">TARGET=lpm_aflpp_custom_mutator_input
CXX=clang++-11
AFLCC=<span class="hljs-variable">$(HOME)</span>/AFLplusplus/afl-gcc
PB_SRC=test.pb.cc

PROTOBUF_DIR=<span class="hljs-variable">$(HOME)</span>/libprotobuf-mutator/build/external.protobuf
PROTOBUF_LIB=<span class="hljs-variable">$(PROTOBUF_DIR)</span>/lib/libprotobufd.a

LPM_DIR=<span class="hljs-variable">$(HOME)</span>/libprotobuf-mutator
LPM_LIB=<span class="hljs-variable">$(LPM_DIR)</span>/build/src/libfuzzer/libprotobuf-mutator-libfuzzer.a <span class="hljs-variable">$(LPM_DIR)</span>/build/src/libprotobuf-mutator.a

INC=-I<span class="hljs-variable">$(PROTOBUF_DIR)</span>/<span class="hljs-keyword">include</span> -I<span class="hljs-variable">$(LPM_DIR)</span>

<span class="hljs-section">all: <span class="hljs-variable">$(TARGET)</span>.so</span>

<span class="hljs-variable">$(TARGET)</span>.so: <span class="hljs-variable">$(TARGET)</span>.cc <span class="hljs-variable">$(PB_SRC)</span>
	<span class="hljs-variable">$(CXX)</span> -fPIC -c <span class="hljs-variable">$^</span> <span class="hljs-variable">$(INC)</span>
	<span class="hljs-variable">$(CXX)</span> -shared -Wall -O3 -o <span class="hljs-variable">$@</span> *.o <span class="hljs-variable">$(LPM_LIB)</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span>

<span class="hljs-section">vuln: vuln.c</span>
	<span class="hljs-variable">$(AFLCC)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span>

<span class="hljs-section">test_proto_serializer: test_proto_serializer.cc <span class="hljs-variable">$(PB_SRC)</span></span>
	<span class="hljs-variable">$(CXX)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span> <span class="hljs-variable">$(PROTOBUF_LIB)</span> <span class="hljs-variable">$(INC)</span>

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span>
<span class="hljs-section">clean: </span>
	rm *.so *.o vuln test_proto_serializer</code></pre></div>

<p>Makefile 有瑕疵，这个章节的内容和 libfuzzer 没有关系，不需要链接 <code>libprotobuf-mutator-libfuzzer.a</code></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/cpptutorial">https://developers.google.com/protocol-buffers/docs/cpptutorial</a><br><a target="_blank" rel="noopener" href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md</a><br><a target="_blank" rel="noopener" href="https://github.com/google/libprotobuf-mutator/">https://github.com/google/libprotobuf-mutator/</a><br><a target="_blank" rel="noopener" href="https://llvm.org/docs/LibFuzzer.html">https://llvm.org/docs/LibFuzzer.html</a><br><a target="_blank" rel="noopener" href="https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning">https://github.com/bruce30262/libprotobuf-mutator_fuzzing_learning</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Security/" class="print-no-link">#Security</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>libprotobuf-mutator 简单分析</div>
      <div>https://usmacd.com/cn/libprotobuf-mutator/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>henices</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年9月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/cn/llvm_coverage/" title="llvm Coverage 可视化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">llvm Coverage 可视化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/cn/iPhone_white_apple/" title="iPhone 内存满了, 白苹果问题解决方法">
                        <span class="hidden-mobile">iPhone 内存满了, 白苹果问题解决方法</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  




  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
