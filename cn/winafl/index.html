<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>winafl fuzz å·¥å…·çš„ä½¿ç”¨ | å®‰å…¨ä»£ç </title><meta name="author" content="æ›¼ç¦å‰"><meta name="copyright" content="æ›¼ç¦å‰"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="0. ä¸‹è½½ Visual Studio Community 2022ä¸‹è½½åœ°å€ï¼šhttps:&#x2F;&#x2F;aka.ms&#x2F;vs&#x2F;17&#x2F;release&#x2F;vs_community.exe ä»å¾®è½¯ç½‘ç«™ä¸‹è½½å¹¶å®‰è£… Visual Studio Community çš„æ—¶å€™é€Ÿåº¦åªæœ‰2 Kï¼Œä¸€ä¸‹åˆæ²¡èƒ½ä¸‹è½½æˆåŠŸã€‚å’¨è¯¢åŒäº‹å°é’»é£ï¼ŒæŒ‡å‡ºå¯èƒ½æ˜¯ DNS é—®é¢˜ï¼Œå°† DNS åˆ‡æ¢æˆé˜¿é‡Œçš„ DNS 223.5.5.5 åä¸‹è½½é€Ÿåº¦è¾¾åˆ° 4 M">
<meta property="og:type" content="article">
<meta property="og:title" content="winafl fuzz å·¥å…·çš„ä½¿ç”¨">
<meta property="og:url" content="https://usmacd.com/cn/winafl/index.html">
<meta property="og:site_name" content="å®‰å…¨ä»£ç ">
<meta property="og:description" content="0. ä¸‹è½½ Visual Studio Community 2022ä¸‹è½½åœ°å€ï¼šhttps:&#x2F;&#x2F;aka.ms&#x2F;vs&#x2F;17&#x2F;release&#x2F;vs_community.exe ä»å¾®è½¯ç½‘ç«™ä¸‹è½½å¹¶å®‰è£… Visual Studio Community çš„æ—¶å€™é€Ÿåº¦åªæœ‰2 Kï¼Œä¸€ä¸‹åˆæ²¡èƒ½ä¸‹è½½æˆåŠŸã€‚å’¨è¯¢åŒäº‹å°é’»é£ï¼ŒæŒ‡å‡ºå¯èƒ½æ˜¯ DNS é—®é¢˜ï¼Œå°† DNS åˆ‡æ¢æˆé˜¿é‡Œçš„ DNS 223.5.5.5 åä¸‹è½½é€Ÿåº¦è¾¾åˆ° 4 M">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2022-08-22T16:00:00.000Z">
<meta property="article:modified_time" content="2022-12-13T16:00:00.000Z">
<meta property="article:author" content="æ›¼ç¦å‰">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "winafl fuzz å·¥å…·çš„ä½¿ç”¨",
  "url": "https://usmacd.com/cn/winafl/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2022-08-22T16:00:00.000Z",
  "dateModified": "2022-12-13T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "æ›¼ç¦å‰",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/winafl/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'winafl fuzz å·¥å…·çš„ä½¿ç”¨',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/self/atom-one-light.css"><link rel="stylesheet" href="/self/nord.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="å®‰å…¨ä»£ç " type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="å®‰å…¨ä»£ç " type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> æƒ³æ³•</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">å®‰å…¨ä»£ç </span></a><a class="nav-page-title" href="/"><span class="site-name">winafl fuzz å·¥å…·çš„ä½¿ç”¨</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> æƒ³æ³•</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">winafl fuzz å·¥å…·çš„ä½¿ç”¨</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-08-22T16:00:00.000Z" title="å‘è¡¨äº 2022-08-23 00:00:00">2022-08-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-12-13T16:00:00.000Z" title="æ›´æ–°äº 2022-12-14 00:00:00">2022-12-14</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="0-ä¸‹è½½-Visual-Studio-Community-2022"><a href="#0-ä¸‹è½½-Visual-Studio-Community-2022" class="headerlink" title="0. ä¸‹è½½ Visual Studio Community 2022"></a>0. ä¸‹è½½ Visual Studio Community 2022</h2><p>ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://aka.ms/vs/17/release/vs_community.exe">https://aka.ms/vs/17/release/vs_community.exe</a></p>
<p>ä»å¾®è½¯ç½‘ç«™ä¸‹è½½å¹¶å®‰è£… Visual Studio Community çš„æ—¶å€™é€Ÿåº¦åªæœ‰2 Kï¼Œä¸€ä¸‹åˆæ²¡èƒ½ä¸‹è½½æˆåŠŸã€‚å’¨è¯¢åŒäº‹å°é’»é£ï¼ŒæŒ‡å‡ºå¯èƒ½æ˜¯ DNS é—®é¢˜ï¼Œå°† DNS åˆ‡æ¢æˆé˜¿é‡Œçš„ DNS 223.5.5.5 åä¸‹è½½é€Ÿåº¦è¾¾åˆ° 4 Mã€‚ä¸­å›½å¼€å‘è€…ç½‘ç»œæ€»æ˜¯ä¸ªé—®é¢˜ï¼Œå¤§å®¶éƒ½æŒºä¸å®¹æ˜“çš„ã€‚</p>
<h2 id="1-ç¼–è¯‘-winafl"><a href="#1-ç¼–è¯‘-winafl" class="headerlink" title="1. ç¼–è¯‘ winafl"></a>1. ç¼–è¯‘ winafl</h2><ol>
<li>ä¸‹è½½ <a target="_blank" rel="noopener" href="https://github.com/DynamoRIO/dynamorio/releases/download/cronbuild-9.0.19209/DynamoRIO-Windows-9.0.19209.zip">DynamoRIO</a> è§£å‹åˆ° D:\DynamoRIO</li>
<li>ä¸‹è½½ <a target="_blank" rel="noopener" href="https://github.com/Kitware/CMake/releases/download/v3.24.0/cmake-3.24.0-windows-x86_64.zip">cmake</a> è§£å‹åˆ° D:\cmake</li>
<li>ä» Github ä¸‹è½½ <a target="_blank" rel="noopener" href="https://github.com/googleprojectzero/winafl.git">winafl</a> ç¼–è¯‘ intel PT éœ€è¦åŒæ­¥ third_party çš„æºç </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/googleprojectzero/winafl.git<br><span class="hljs-built_in">cd</span> winafl<br>git submodule update --init --recursive<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ä»èœå•ä¸­é€‰æ‹©  <code>X64 native tool command prompt for VS 2022</code>ï¼Œæ‰§è¡Œç¼–è¯‘å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir build64<br>cd build64<br>D:\cmake\bin\cmake.exe -G&quot;Visual Studio 17 2022&quot; -A x64 .. -DDynamoRIO_DIR=D:\DynamoRIO\cmake -DINTELPT=1<br>D:\cmake\bin\cmake.exe --build . --config Release<br></code></pre></td></tr></table></figure>

<p><code>-DINTelPT=1</code>  å‚æ•°å°†ç¼–è¯‘ Intel PT æ¨¡å¼çš„æ”¯æŒï¼Œç¼–è¯‘å®Œæˆåï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.\build64\bin\Release&gt;.\afl-fuzz.exe<br><br>WinAFL 1.16b by &lt;ifratric@google.com&gt;<br>Based on AFL 2.43b by &lt;lcamtuf@google.com&gt;<br><br>.\afl-fuzz.exe [ afl options ] -- [instrumentation options] -- \path\to\fuzzed_app [ ... ]<br><br>Required parameters:<br><br>  -i dir        - input directory with test cases<br>  -o dir        - output directory for fuzzer findings<br>  -t msec       - timeout for each run<br><br>Instrumentation type:<br><br>  -D dir       - directory with DynamoRIO binaries (drrun, drconfig)<br>  -w winafl    - Path to winafl.dll<br>  -P           - use Intel PT tracing mode<br>  -Y           - enable the static instrumentation mode<br><br>Execution control settings:<br><br>  -f file       - location read by the fuzzed program (stdin)<br>  -m limit      - memory limit for the target process<br>  -p            - persist DynamoRIO cache across target process restarts<br>  -c cpu        - the CPU to run the fuzzed program<br><br>Fuzzing behavior settings:<br><br>  -d            - quick &amp; dirty mode (skips deterministic steps)<br>  -n            - fuzz without instrumentation (dumb mode)<br>  -x dir        - optional fuzzer dictionary (see README)<br><br>Other stuff:<br><br>  -I msec       - timeout for process initialization and first run<br>  -T text       - text banner to show on the screen<br>  -M \ -S id   - distributed mode (see parallel_fuzzing.txt)<br>  -C            - crash exploration mode (the peruvian rabbit thing)<br>  -e            - expert mode to run WinAFL as a DynamoRIO tool<br>  -l path       - a path to user-defined DLL for custom test cases processing<br>  -V            - show version number and exit<br><br>Attach:<br><br>  -A module     - attach to the process that loaded the provided module<br><br>For additional tips, please consult afl_docs\README.<br><br><br>C:\Users\zhouzhen\Downloads\winafl\build64\bin\Release&gt;<br></code></pre></td></tr></table></figure>

<h2 id="2-æ£€æŸ¥-DynamoRIO-æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ"><a href="#2-æ£€æŸ¥-DynamoRIO-æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ" class="headerlink" title="2. æ£€æŸ¥ DynamoRIO æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ"></a>2. æ£€æŸ¥ DynamoRIO æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ</h2><p>ä½¿ç”¨ IDA Pro å¯¹ test_gdiplus.exe è¿›è¡Œåæ±‡ç¼–ï¼Œtarget_offset ä¸º <code>0x10E0</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nasm">.text:00000001400010E0 ; int __cdecl main(int argc, const char **argv, const char **envp)<br>.text:00000001400010E0 main            proc near               ; CODE XREF: __scrt_common_main_seh(void)+107â†“p<br>.text:00000001400010E0                                         ; DATA XREF: .rdata:0000000140002B6Câ†“o ...<br></code></pre></td></tr></table></figure>

<p>å…ˆç”¨ drrun.exe æµ‹è¯• winafl æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå…¶å®å°±æ˜¯å¾ªç¯æ‰§è¡Œ 10 æ¬¡ç›®æ ‡ç¨‹åºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">D:\DynamoRIO\bin64\drrun.exe -c winafl.dll -debug ^<br>-target_module test_gdiplus.exe -target_offset 0x10E0 -fuzz_iterations 10 ^<br>-nargs 2 -- test_gdiplus.exe input.bmp<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤åï¼Œåœ¨å½“å‰ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª log æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º <code>afl.test_gdiplus.exe.14172.0000.proc.log</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Module loaded, dynamorio.dll<br>Module loaded, winafl.dll<br>Module loaded, drx.dll<br>Module loaded, drreg.dll<br>Module loaded, drmgr.dll<br>Module loaded, drwrap.dll<br>Module loaded, test_gdiplus.exe<br>Module loaded, gdiplus.dll<br>Module loaded, VCRUNTIME140.dll<br>Module loaded, msvcp_win.dll<br>Module loaded, win32u.dll<br>Module loaded, ucrtbase.dll<br>Module loaded, KERNELBASE.dll<br>Module loaded, gdi32full.dll<br>Module loaded, KERNEL32.dll<br>Module loaded, msvcrt.dll<br>Module loaded, IMM32.dll<br>Module loaded, RPCRT4.dll<br>Module loaded, GDI32.dll<br>Module loaded, combase.dll<br>Module loaded, USER32.dll<br>Module loaded, ntdll.dll<br>In pre_fuzz_handler<br>Module loaded, UxTheme.dll<br>Module loaded, OLEAUT32.dll<br>Module loaded, bcrypt.dll<br>Module loaded, SECHOST.dll<br>Module loaded, ADVAPI32.dll<br>Module loaded, WindowsCodecs.dll<br>Module loaded, MSCTF.dll<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>In pre_fuzz_handler<br>In post_fuzz_handler<br>Everything appears to be running normally.<br>Coverage map follows:<br>                                            <br></code></pre></td></tr></table></figure>

<p><code>Everything appears to be running normally.</code> è¡¨æ˜ winafl è‡ªå·±è®¤ä¸ºæ²¡æœ‰å‡ºé”™ã€‚ log æ–‡ä»¶ä¸­è¿˜åŒ…å«äº†å…¶ä»–æœ‰ç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ç›®æ ‡ç¨‹åºåŠ è½½çš„æ¨¡å—ã€‚è¿™äº›åŠ è½½çš„æ¨¡å—å¯ä»¥ç”¨æ¥è®¾ç½® <code>-coverage_module</code>æ¥ç»Ÿè®¡ä½ æ‰€å…³æ³¨çš„ coverageã€‚</p>
<p>ä½¿ç”¨ drrun.exe éªŒè¯æˆåŠŸåï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢å‘½ä»¤æµ‹è¯• winafl æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">afl-fuzz.exe -i <span class="hljs-keyword">in</span> -o out -D D:\DynamoRIO\bin64 -t 20000 ^<br>-- -coverage_module gdiplus.dll -coverage_module WindowsCodecs.dll -fuzz_iterations 5000 ^<br>-target_module test_gdiplus.exe -target_offset 0x10E0 -nargs 2 -- test_gdiplus.exe @@<br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œåä¸Šé¢çš„å‘½ä»¤åï¼Œå¦‚æœå‘ç° total paths çš„æ•°å­—åœ¨ä¸æ–­å˜åŒ–ï¼Œ winafl å°±å·²ç»å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œæ­å–œ ğŸ˜„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">+- process timing -------------------------------------+- overall results ----+<br>|        run time : 0 days, 0 hrs, 0 min, 1 sec        |  cycles done : 0     |<br>|   last new path : 0 days, 0 hrs, 0 min, 1 sec        |  total paths : 2     |<br>| last uniq crash : none seen yet                      | uniq crashes : 0     |<br>|  last uniq hang : none seen yet                      |   uniq hangs : 0     |<br>+- cycle progress --------------------+- map coverage -+----------------------+<br>|  now processing : 0 (0.00%)         |    map density : 1.65% / 1.65%        |<br>| paths timed out : 0 (0.00%)         | count coverage : 1.00 bits/tuple      |<br>+- stage progress --------------------+ findings in depth --------------------+<br>|  now trying : arith 8\8             | favored paths : 1 (50.00%)            |<br>| stage execs : 388/389 (99.74%)      |  new edges on : 2 (100.00%)           |<br>| total execs : 619                   | total crashes : 0 (0 unique)          |<br>|  exec speed : 353.3/sec             |  total tmouts : 0 (0 unique)          |<br>+- fuzzing strategy yields -----------+---------------+- path geometry -------+<br>|   bit flips : 0/56, 1/55, 0/53                      |    levels : 2         |<br>|  byte flips : 0/7, 0/6, 0/4                         |   pending : 2         |<br>| arithmetics : 0/0, 0/0, 0/0                         |  pend fav : 1         |<br>|  known ints : 0/0, 0/0, 0/0                         | own finds : 1         |<br>|  dictionary : 0/0, 0/0, 0/0                         |  imported : n/a       |<br>|       havoc : 0/0, 0/0                              | stability : 99.63%    |<br>|        trim : 0.00%/1, 0.00%                        +-----------------------+<br>^C----------------------------------------------------+   [cpu000001:  14%]<br></code></pre></td></tr></table></figure>

<h2 id="3-DynamoRIO-æ¨¡å¼-winafl-dll-å„ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰"><a href="#3-DynamoRIO-æ¨¡å¼-winafl-dll-å„ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰" class="headerlink" title="3. DynamoRIO æ¨¡å¼ winafl.dll å„ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰"></a>3. DynamoRIO æ¨¡å¼ winafl.dll å„ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰</h2><p>winafl.dll æ˜¯ DynamoRIO client (instrumentation) codeï¼Œå‚æ•°æŒºå¤š Winafl çš„ README ä¸­ä»‹ç»äº†ä¸‹é¢è¿™äº›å‚æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-covtype         - the type of coverage being recorded. Supported options are<br>                   bb (basic block, default) or edge.<br><br>-coverage_module - module for which to record coverage. Multiple module flags<br>                   are supported.<br><br>-target_module   - module which contains the target function to be fuzzed.<br>                   Either -target_method or -target_offset need to be<br>                   specified together with this option.<br><br>-target_method   - name of the method to fuzz in persistent mode. For this to<br>                   work either the method needs to be exported or the symbols<br>                   for target_module need to be available. Otherwise use<br>                   -target_offset instead.<br><br>-target_offset   - offset of the method to fuzz from the start of the module.<br><br>-fuzz_iterations - Maximum number of iterations for the target function to run<br>                   before restarting the target process.<br><br>-nargs           - Number of arguments the fuzzed method takes. This is used<br>                   to save/restore the arguments between runs.<br><br>-call_convention - The default calling convention is cdecl on 32-bit x86<br>                   platforms and Microsoft x64 for Visual Studio 64-bit<br>                   applications. Possible values:<br>                       * fastcall: fastcall<br>                       * ms64: Microsoft x64 (Visual Studio)<br>                       * stdcall: cdecl or stdcall<br>                       * thiscall: thiscall<br><br>-debug           - Debug mode. Does not try to connect to the server. Outputs<br>                   a log file containing loaded modules, opened files and<br>                   coverage information.<br><br>-logdir          - specifies in which directory the log file will be written<br>                   (only to be used with -debug).<br><br>-thread_coverage - If set, WinAFL will only collect coverage from a thread<br>                   that executed the target function<br></code></pre></td></tr></table></figure>

<ul>
<li><code>-nargs</code> target method æˆ–è€… target offset çš„å‚æ•°ä¸ªæ•°</li>
<li><code>-fuzz_iterations</code> é‡å¯è¿›ç¨‹å‰ï¼Œå¾ªç¯æ‰§è¡Œ target method æˆ–è€… target offset çš„æ¬¡æ•°</li>
<li><code>-target_moudle</code> fuzz çš„ç›®æ ‡æ¨¡å—ï¼Œéœ€è¦å’Œ target method æˆ–è€… target offset ä¸€èµ·ä½¿ç”¨</li>
<li><code>-target_method</code> persistent mode ä¸‹ fuzz çš„å‡½æ•°åï¼ˆæ–¹æ³•åï¼‰ï¼Œéœ€è¦æœ‰ç¬¦å· ï¼ˆsymbolsï¼‰</li>
<li><code>-target_offset</code> fuzz çš„å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰ç›¸å¯¹äºæ¨¡å—èµ·å§‹åœ°å€çš„åç§»</li>
<li><code>-coverage_module</code> ç»Ÿè®¡è¦†ç›–ç‡çš„æ¨¡å—ï¼Œå¯ä»¥ç»Ÿè®¡å¤šä¸ªæ¨¡å—çš„ coverageï¼Œå³æŒ‡å®šå¤šä¸ª -coverage_module å‚æ•°</li>
<li><code>-covtype</code> bb æˆ–è€… edgeï¼Œbb ï¼ˆbasic block ä¸ºé»˜è®¤å€¼ï¼‰</li>
<li><code> -thread_coverage</code> ç”¨äºå¤šçº¿ç¨‹ç¨‹åºï¼Œåªç»Ÿè®¡ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ target function çš„è¦†ç›–ç‡å˜åŒ–</li>
</ul>
<h2 id="4-WinAFL-intel-PT-æ¨¡å¼ä½¿ç”¨"><a href="#4-WinAFL-intel-PT-æ¨¡å¼ä½¿ç”¨" class="headerlink" title="4. WinAFL intel PT æ¨¡å¼ä½¿ç”¨"></a>4. WinAFL intel PT æ¨¡å¼ä½¿ç”¨</h2><p>Intel PT (Processor Tracing) æ˜¯ Intel CPU çš„ä¸€ä¸ªç‰¹æ€§ï¼Œä» Intel ç¬¬5ä»£å¤„ç†å™¨å¼€å§‹æ”¯æŒï¼Œ5th generation çš„å¾®æ¶æ„ä¸º <code>Broadwell</code>ã€‚ç›¸å…³è¯´æ˜å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/support/articles/000056730/processors.html">https://www.intel.com/content/www/us/en/support/articles/000056730/processors.html</a></p>
<p>Windows 10 ä» v1809 å¼€å§‹æä¾›äº† Intel PT çš„é©±åŠ¨ï¼Œä½†ç›®å‰æ²¡æœ‰å…¬å¼€çš„æ–‡æ¡£æè¿°æ­¤é©±åŠ¨ï¼Œä¹Ÿæ²¡æœ‰æä¾›å®˜æ–¹çš„ APIã€‚Â Alex Ionescu æä¾›äº† <a target="_blank" rel="noopener" href="https://github.com/ionescu007/winipt">winipt</a> library å’Œ Intel PT é©±åŠ¨äº¤äº’ï¼ŒWinAFL åˆ©ç”¨ winipt æ¥è·å¾— Intel PT çš„ Processo Tracing ä¿¡æ¯ã€‚</p>
<p>WinAFL ä½¿ç”¨ Intel PT æ¨¡å¼ï¼Œå’Œ DynamoRIO ä¸åŒéœ€è¦æŒ‡å®š <code>-P</code> , WinAFL Intel PT æ¨¡å¼é™¤äº†å’ŒDynamoRIO ç›¸åŒçš„å‚æ•°å¤–é¢å¤–æ·»åŠ äº†ä¸‹é¢å‡ ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>-trace_size</code> æ¯æ¬¡æ‰§è¡Œ traget æ‰‹æœºçš„ trace ä¿¡æ¯çš„å­—èŠ‚æ•°ï¼Œå¿…é¡»æ˜¯2 çš„æ¬¡æ–¹å¹¶ä¸”å¤§äº 4096</li>
<li><code>-decode</code> å¤„ç† trace ä¿¡æ¯çš„è§£ç å™¨ï¼Œæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š<code>tip</code>,  <code>tip_ref</code> å’Œ <code>full</code> (full ä¸ºé»˜è®¤å€¼)</li>
<li><code>-nopersistent_trace</code> ç”±äºæ€§èƒ½çš„ç¼˜æ•…ï¼ŒWinAFL æ¯æ¬¡å¾ªç¯æ‰§è¡Œ target æ˜¯ä¸é‡å¯ç¨‹åºï¼Œè¿™ä¸ªé€‰é¡¹å¯ä»¥å¼ºåˆ¶ WinAFL æ¯æ¬¡æ‰§è¡Œ target éƒ½é‡å¯ï¼Œä¸€èˆ¬æ˜¯ä¸ºäº†è°ƒè¯•æ‰ä¼šå¯ç”¨è¿™ä¸ªé€‰é¡¹</li>
<li><code>-trace_cache_size</code>  trace ä¿¡æ¯çš„ cache å­—èŠ‚æ•°ï¼Œå’Œ <code>full</code> è§£ç å™¨ä¸€èµ·ä½¿ç”¨</li>
</ul>
<h2 id="5-æ£€æŸ¥-Intel-PT-æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ"><a href="#5-æ£€æŸ¥-Intel-PT-æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ" class="headerlink" title="5. æ£€æŸ¥ Intel PT æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ"></a>5. æ£€æŸ¥ Intel PT æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">winaflpt-debug.exe -debug -coverage_module gdipluss.dll -coverage_module WindowsCodecs.dll ^<br>-fuzz_iterations 10  -target_module test_gdiplus.exe -target_offset 0x10E0 -nargs 2 -- test_gdiplus.exe @@<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢å‘½ä»¤å…¶å®å’Œæ£€æŸ¥ DynamoRIO æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œçš„å‘½ä»¤åŸºæœ¬ä¸€è‡´ï¼Œæ‰§è¡Œå‘½ä»¤åè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Module loaded: test_gdiplus.exe<br>Module loaded: ntdll.dll<br>Module loaded: KERNEL32.DLjL<br>Module loaded: KERNELBASE.dll<br>Module loaded: ucrtbase.dll<br>Module loaded: gdiplus.dll<br>Module loaded: msvcrt.dll<br>Module loaded: combase.dll<br>Module loaded: VCRUNTIME140.dll<br>Module loaded: RPCRT4.dll<br>Module loaded: USER32.dll<br>Module loaded: win32u.dll<br>Module loaded: GDI32.dll<br>Module loaded: gdi32full.dll<br>Module loaded: msvcp_win.dll<br>Module loaded: IMM32.DLL<br>iteration 0<br>Module loaded: uxtheme.dll<br>Module loaded: msctf.dll<br>Module loaded: oleaut32.dll<br>Module loaded: sechost.dll<br>Iteration finished normally<br>iteration 1<br>Iteration finished normally<br>iteration 2<br>Iteration finished normally<br>iteration 3<br>Iteration finished normally<br>iteration 4<br>Iteration finished normally<br>iteration 5<br>Iteration finished normally<br>iteration 6<br>Iteration finished normally<br>iteration 7<br>Iteration finished normally<br>iteration 8<br>Iteration finished normally<br>iteration 9<br>Iteration finished normally<br>Coverage map (hex): <br>00000000000000000000000000000000<br>00000000000000000000000000000000<br></code></pre></td></tr></table></figure>

<h2 id="6-ç”¨-Intel-PT-æ¨¡å¼-fuzz"><a href="#6-ç”¨-Intel-PT-æ¨¡å¼-fuzz" class="headerlink" title="6. ç”¨ Intel PT æ¨¡å¼ fuzz"></a>6. ç”¨ Intel PT æ¨¡å¼ fuzz</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">afl-fuzz.exe -i in -o out -P -t 20000 -- -coverage_module gdiplus.dll ^<br>-coverage_module WindowsCodecs.dll -fuzz_iterations 5000 ^<br>-target_module test_gdiplus.exe -target_offset 0x10E0 -nargs 2 -- test_gdiplus.exe @@<br></code></pre></td></tr></table></figure>

<p>ç”¨ä¸Šé¢çš„å‘½ä»¤è°ƒç”¨ afl-fuzzï¼Œå‘ç°å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œç•Œé¢å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">               WinAFL 1.16b based on AFL 2.43b (test_gdiplus.exe)<br><br>+- process timing -------------------------------------+- overall results ----+<br>|        run time : 0 days, 0 hrs, 0 min, 15 sec       |  cycles done : 0     |<br>|   last new path : 0 days, 0 hrs, 0 min, 1 sec        |  total paths : 9     |<br>| last uniq crash : none seen yet                      | uniq crashes : 0     |<br>|  last uniq hang : none seen yet                      |   uniq hangs : 0     |<br>+- cycle progress --------------------+- map coverage -+----------------------+<br>|  now processing : 0 (0.00%)         |    map density : 1.50% / 3.67%        |<br>| paths timed out : 0 (0.00%)         | count coverage : 1.40 bits/tuple      |<br>+- stage progress --------------------+ findings in depth --------------------+<br>|  now trying : havoc                 | favored paths : 1 (11.11%)            |<br>| stage execs : 2332/8192 (28.47%)    |  new edges on : 5 (55.56%)            |<br>| total execs : 3350                  | total crashes : 0 (0 unique)          |<br>|  exec speed : 221.4/sec             |  total tmouts : 0 (0 unique)          |<br>+- fuzzing strategy yields -----------+---------------+- path geometry -------+<br>|   bit flips : 0/48, 0/47, 1/45                      |    levels : 2         |<br>|  byte flips : 0/6, 0/5, 0/3                         |   pending : 9         |<br>| arithmetics : 1/335, 0/75, 0/0                      |  pend fav : 1         |<br>|  known ints : 0/28, 1/168, 1/120                    | own finds : 8         |<br>|  dictionary : 0/0, 0/0, 0/0                         |  imported : n/a       |<br>|       havoc : 0/0, 0/0                              | stability : 65.28%    |<br>|        trim : 0.00%/1, 0.00%                        +-----------------------+<br>+-----------------------------------------------------+   [cpu000001:  23%]<br><br></code></pre></td></tr></table></figure>


<h2 id="7-Winafl-çš„å¤šæ ¸ä½¿ç”¨æƒ…å†µ"><a href="#7-Winafl-çš„å¤šæ ¸ä½¿ç”¨æƒ…å†µ" class="headerlink" title="7. Winafl çš„å¤šæ ¸ä½¿ç”¨æƒ…å†µ"></a>7. Winafl çš„å¤šæ ¸ä½¿ç”¨æƒ…å†µ</h2><p>æ‰§è¡Œ Winafl çš„ PT æ¨¡å¼ï¼Œä½¿ç”¨ä»»åŠ¡ç®¡ç†å™¨ -&gt; æ‰“å¼€èµ„æºç›‘è§†å™¨ -&gt;  CPU å¯ä»¥è§‚å¯Ÿåˆ°åªæœ‰ä¸€ä¸ª CPU core è·‘æ»¡ 100%</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://github.com/googleprojectzero/winafl/blob/master/README.md">https://github.com/googleprojectzero/winafl/blob/master/README.md</a><br><a target="_blank" rel="noopener" href="https://github.com/googleprojectzero/winafl/blob/master/readme_dr.md">https://github.com/googleprojectzero/winafl/blob/master/readme_dr.md</a><br><a target="_blank" rel="noopener" href="https://github.com/googleprojectzero/winafl/blob/master/readme_pt.md">https://github.com/googleprojectzero/winafl/blob/master/readme_pt.md</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://usmacd.com">æ›¼ç¦å‰</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/winafl/">https://usmacd.com/cn/winafl/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://usmacd.com" target="_blank">å®‰å…¨ä»£ç </a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Security/">Security</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/root_android11_pixel2/" title="root Pixel2 Android 11 çš„æ–¹æ³•"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">root Pixel2 Android 11 çš„æ–¹æ³•</div></div><div class="info-2"><div class="info-item-1">è¦æ­£å¸¸ä½¿ç”¨ frida é¦–å…ˆéœ€è¦æŠŠæ‰‹æœºç»™ root äº†ï¼Œ åœ¨æœ€è¿‘æµ‹è¯•çš„æƒ…å†µå‘ç° Android 10 å’Œ Android 11 ç³»ç»Ÿå·¥ä½œæ¯”è¾ƒæ­£å¸¸ï¼Œ Android 6 å’Œå…¶ä»–ç³»ç»Ÿä¼¼ä¹å·®ä¸€äº›ï¼Ÿ è¦åˆ·æœºé¦–å…ˆéœ€è¦ä¸‹è½½ adb ç­‰å·¥å…·ï¼Œè¿™äº›å·¥å…·ç”± Android çš„ SDK platform tools æä¾›ï¼Œä¸‹è½½åœ°å€ä¸ºï¼šhttps://developer.android.com/studio/releases/platform-toolsé€‰æ‹©ç›¸åº”çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬ä¸‹è½½å³å¯ï¼Œ Google æä¾›äº† Windowsã€Linuxã€Mac ç­‰ç³»ç»Ÿçš„æ”¯æŒã€‚ åŸºç¡€é•œåƒå¯ä»¥é€‰æ‹©çš„ Google çš„å®˜æ–¹é•œåƒ Factory Imageï¼Œå¦‚æœèƒ½è‡ªå·±ç¼–è¯‘ Android ç³»ç»Ÿåˆ™æ›´å¥½ï¼Œåœ¨è°ƒè¯•çš„æ—¶å€™å¯ä»¥çœ‹åˆ°ç³»ç»Ÿåº“çš„ç¬¦å·ã€‚ æˆ‘çš„ Android æ‰‹æœºä¸º Pixel 2 åœ¨ https://developers.google.com/android/images#walleye ä¸Šå¯ä»¥æŸ¥æ‰¾ç›¸åº”çš„é•œåƒï¼Œ ä¸‹ä¸ªæœ€æ–°çš„ https://dl.google.com/dl/android/aosp/walleye-rp1a.2...</div></div></div></a><a class="pagination-related" href="/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/" title="When Hypervisor Met Snapshot Fuzzing"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">When Hypervisor Met Snapshot Fuzzing</div></div><div class="info-2"><div class="info-item-1">source: https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html 1. IntroductionHypervisor was known as hard target to fuzz over several years. Even though, lots of prior pioneers( Peter Hlavaty, Chaitin Tech, StarLabs, Peleg Hadar and Ophir Harpaz and many others ) doing amazing work to overcome this limit and found interesting bugs. But it is not an easy topic for some fresh newbie like me to starts from the bottom. I think manual code( or binary ) auditing and ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/afl/" title="afl-fuzz æ¡†æ¶"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">afl-fuzz æ¡†æ¶</div></div><div class="info-2"><div class="info-item-1">afl-fuzz çš„æ•´ä½“æ¶æ„ï¼Œæ–°æ‰‹ç†è§£èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒè´¹åŠ²ï¼Œç½‘ç»œä¸Šå‘ç°ä¸€å¼ å›¾è§‰å¾—ä¸é”™ï¼Œæ”¾ä¸Šæ¥å¤§å®¶çœ‹çœ‹ï¼Œæ„Ÿè°¢åŸä½œè€…ã€‚  </div></div></div></a><a class="pagination-related" href="/cn/afl-fuzz1/" title="Dissecting American Fuzzy Lop A FuzzBench Evaluation è¦ç‚¹"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Dissecting American Fuzzy Lop A FuzzBench Evaluation è¦ç‚¹</div></div><div class="info-2"><div class="info-item-1">paper: https://www.s3.eurecom.fr/docs/fuzzing22_fioraldi_report.pdf ä¸¤ä¸ªå®éªŒçš„ç»“è®º (ä¸»è¦åŸºäº FuzzBench) Our conclusion after this experiment is that AFL, and follow-ups fuzzers like AFL++, should provide an optionto disable hitcounts. AFL++ provides many different op-tions, and the users are suggested to run an instance of each variant when doing parallel fuzzing, a common use-case in real-world setups. The fact that in our experiments,hitcounts have shown a highly variadic behavior suggests that users ...</div></div></div></a><a class="pagination-related" href="/cn/sqlserver2005_xpcmdshell/" title="SQL Server 2005 xp_cmdshell"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2009-09-18</div><div class="info-item-2">SQL Server 2005 xp_cmdshell</div></div><div class="info-2"><div class="info-item-1">SQL Server 2005 ä¸­å¼•å…¥çš„ xp_cmdshell é€‰é¡¹æ˜¯æœåŠ¡å™¨é…ç½®é€‰é¡¹ï¼Œä½¿ç³»ç»Ÿç®¡ç†å‘˜èƒ½å¤Ÿæ§åˆ¶æ˜¯å¦å¯ä»¥åœ¨ç³»ç»Ÿä¸Šæ‰§è¡Œ xp_cmdshell æ‰©å±•å­˜å‚¨è¿‡ç¨‹ã€‚ 1.  å¦‚ä½•åœ¨sql server 2005 ä¸­å¼€å¯xp_cmdshell123456789101112-- To allow advanced options to be changed.EXEC sp_configure &#x27;show advanced options&#x27;, 1GO-- To update the currently configured value for advanced options.RECONFIGUREGO-- To enable the feature.EXEC sp_configure &#x27;xp_cmdshell&#x27;, 1GO-- To update the currently configured value for this feature.RECONFIGUREGO  2. å¦‚ä½•æŸ¥è¯¢sql server 2005 æ‹“å±•å­˜å‚¨è¿‡ç¨‹xp_cmds...</div></div></div></a><a class="pagination-related" href="/cn/webview_java/" title="Android WebView æ¼æ´"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Android WebView æ¼æ´</div></div><div class="info-2"><div class="info-item-1">â˜† æ¥è‡ª developer.android.com çš„ä¿¡æ¯Android å®˜æ–¹ç½‘ç«™å¯¹addJavascriptInterfaceçš„ä»‹ç»å¦‚ä¸‹ï¼š 123456789101112public void addJavascriptInterface (Object object, String name)  Added in API level 1Injects the supplied Java object into this WebView. The object is injected intothe JavaScript context of the main frame, using the supplied name. This allows the Java object&#x27;s methods to be accessed from JavaScript. For applicationstargeted to API level JELLY_BEAN_MR1 and above, only public methods that are annotated w...</div></div></div></a><a class="pagination-related" href="/cn/pdfium-fuzz.public/" title="ä½¿ç”¨ afl-fuzz fuzz pdfium"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-08</div><div class="info-item-2">ä½¿ç”¨ afl-fuzz fuzz pdfium</div></div><div class="info-2"><div class="info-item-1">ä¸‹è½½æºç å…ˆåœ¨ https://pdfium.googlesource.com/pdfium/ ä¸‹è½½æºç . 12345mkdir repocd repogclient config --unmanaged https://pdfium.googlesource.com/pdfium.gitgclient synccd pdfium  gclient å‘½ä»¤åœ¨ depot_tools ä¸­, éœ€è¦å®‰è£… å‚è€ƒä¸‹é¢çš„æ–‡ç«  http://www.chromium.org/developers/how-tos/install-depot-tools 12git clone https://chromium.googlesource.com/chromium/tools/depot_tools.gitexport PATH=`pwd`/depot_tools:&quot;$PATH&quot;  ä¸»è¦gclient sync åŒæ­¥æ—¶éœ€è¦ç¿»å¢™ï¼Œå¯ä»¥ç®€å•çš„ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹æ³•ã€‚ https_proxy=http://localhost:8118 gclient sync ä¸‹è½½ download goog...</div></div></div></a><a class="pagination-related" href="/cn/linux_ida_pro/" title="Linux ä¸‹è¿è¡Œ IDA Pro"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2013-06-19</div><div class="info-item-2">Linux ä¸‹è¿è¡Œ IDA Pro</div></div><div class="info-2"><div class="info-item-1">IDA Pro 6.2 + çš„Linux ç‰ˆæœ¬æä¾›äº†Qt ç•Œé¢ï¼Œå¯ä»¥åœ¨å„å¤§å¹³å°æ­£å¸¸è¿è¡Œã€‚ä¹°ä¸èµ·ä¹Ÿæœ‰åŠæ³• ï¼Œä½¿ç”¨ wine å¯ä»¥å¾ˆå¥½åœ°è¿è¡ŒIDA Proï¼Œæ˜¾ç¤ºæ•ˆæœåŸºæœ¬OKï¼Œçˆ±æŠ˜è…¾çš„åŒå­¦å¯ä»¥è‡ªè¡Œè°ƒæ•´å­—ä½“ã€‚ 1$ wine idag.exe  IDA Pro 6.1 æˆåŠŸè¿è¡Œ.ä½†æ˜¯idapython æœ‰äº›é—®é¢˜éœ€è¦å¤„ç†ï¼Œå¼•èµ·idapythonä¸èƒ½æ­£å¸¸è¿è¡Œçš„åŸå› ä¸»è¦æœ‰ä¸‹é¢ä¸¤ä¸ªï¼š æ–‡ä»¶ç¼ºå¤±å¤§æ¦‚ä¼šæŠ¥ä¸‹é¢é”™è¯¯  1err:module:import_dll Library python27.dll (which is needed by L&quot;C:\\ida61\\plugins\\python.plw&quot;) not found  è¦è§£å†³è¿™ä¸ªé”™è¯¯ï¼Œéœ€è¦ä»windowsä¸‹æ‹·è´ä¸¤ä¸ªæ–‡ä»¶è¿‡æ¥ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯ msvcr90.dllï¼Œpython27.dll ç¯å¢ƒå˜é‡1$ wine idag.exe  ä¼šæŠ¥ä¸‹é¢ç±»ä¼¼é”™è¯¯ï¼Œ ImportError: No module named siteï¼Œå‘ç”Ÿè¿™ä¸ªé”™è¯¯çš„åŸå› æ˜¯æ‰¾ä¸åˆ°pythonå®‰è£…è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨unixä¸‹çš„pythonä½¿ç”¨shellå‘½ä»¤è®¾ç½®...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">æ›¼ç¦å‰</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E4%B8%8B%E8%BD%BD-Visual-Studio-Community-2022"><span class="toc-number">1.</span> <span class="toc-text">0. ä¸‹è½½ Visual Studio Community 2022</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BC%96%E8%AF%91-winafl"><span class="toc-number">2.</span> <span class="toc-text">1. ç¼–è¯‘ winafl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%A3%80%E6%9F%A5-DynamoRIO-%E6%A8%A1%E5%BC%8F%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">2. æ£€æŸ¥ DynamoRIO æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-DynamoRIO-%E6%A8%A1%E5%BC%8F-winafl-dll-%E5%90%84%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E5%85%B7%E4%BD%93%E5%90%AB%E4%B9%89"><span class="toc-number">4.</span> <span class="toc-text">3. DynamoRIO æ¨¡å¼ winafl.dll å„ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-WinAFL-intel-PT-%E6%A8%A1%E5%BC%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">4. WinAFL intel PT æ¨¡å¼ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%A3%80%E6%9F%A5-Intel-PT-%E6%A8%A1%E5%BC%8F%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C"><span class="toc-number">6.</span> <span class="toc-text">5. æ£€æŸ¥ Intel PT æ¨¡å¼æ˜¯å¦æ­£å¸¸å·¥ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%94%A8-Intel-PT-%E6%A8%A1%E5%BC%8F-fuzz"><span class="toc-number">7.</span> <span class="toc-text">6. ç”¨ Intel PT æ¨¡å¼ fuzz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Winafl-%E7%9A%84%E5%A4%9A%E6%A0%B8%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">8.</span> <span class="toc-text">7. Winafl çš„å¤šæ ¸ä½¿ç”¨æƒ…å†µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">9.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/gemini_in_chrome/" title="å¼€å¯ Gemini in Chrome çš„æ–¹æ³•">å¼€å¯ Gemini in Chrome çš„æ–¹æ³•</a><time datetime="2026-01-29T16:00:00.000Z" title="å‘è¡¨äº 2026-01-30 00:00:00">2026-01-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/sucess_is_the_mother_of_sucess/" title="æˆåŠŸæ˜¯æˆåŠŸä¹‹æ¯">æˆåŠŸæ˜¯æˆåŠŸä¹‹æ¯</a><time datetime="2026-01-27T16:00:00.000Z" title="å‘è¡¨äº 2026-01-28 00:00:00">2026-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/ai_studio_podcast_transcript/" title="åˆ©ç”¨ AI Studio æ•´ç†æ’­å®¢éŸ³é¢‘çš„é€å­—ç¨¿">åˆ©ç”¨ AI Studio æ•´ç†æ’­å®¢éŸ³é¢‘çš„é€å­—ç¨¿</a><time datetime="2026-01-07T16:00:00.000Z" title="å‘è¡¨äº 2026-01-08 00:00:00">2026-01-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/anti-weakness-learning/" title="åè„†å¼±å¼çš„å­¦ä¹ æ–¹æ³•">åè„†å¼±å¼çš„å­¦ä¹ æ–¹æ³•</a><time datetime="2025-12-30T16:00:00.000Z" title="å‘è¡¨äº 2025-12-31 00:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/keep_hard/" title="åšæŒçš„ç§˜è¯€">åšæŒçš„ç§˜è¯€</a><time datetime="2025-12-15T16:00:00.000Z" title="å‘è¡¨äº 2025-12-16 00:00:00">2025-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By æ›¼ç¦å‰</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="/js/tw_cn.js?v=5.5.4"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åŠ è½½ä¸­</span></div><div class="local-search-input"><input placeholder="æœç´¢æ–‡ç« " type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>