<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>When Hypervisor Met Snapshot Fuzzing | 安全代码</title><meta name="author" content="曼福吉"><meta name="copyright" content="曼福吉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="source: https:&#x2F;&#x2F;null2root.github.io&#x2F;blog&#x2F;2022&#x2F;07&#x2F;21&#x2F;When-Hypervisor-Met-Snapshot-Fuzzing.html 1. IntroductionHypervisor was known as hard target to fuzz over several years. Even though, lots of prior">
<meta property="og:type" content="article">
<meta property="og:title" content="When Hypervisor Met Snapshot Fuzzing">
<meta property="og:url" content="https://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="source: https:&#x2F;&#x2F;null2root.github.io&#x2F;blog&#x2F;2022&#x2F;07&#x2F;21&#x2F;When-Hypervisor-Met-Snapshot-Fuzzing.html 1. IntroductionHypervisor was known as hard target to fuzz over several years. Even though, lots of prior">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2022-07-21T08:00:00.000Z">
<meta property="article:modified_time" content="2022-07-21T08:00:00.000Z">
<meta property="article:author" content="曼福吉">
<meta property="article:tag" content="Archives">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "When Hypervisor Met Snapshot Fuzzing",
  "url": "https://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2022-07-21T08:00:00.000Z",
  "dateModified": "2022-07-21T08:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "曼福吉",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'When Hypervisor Met Snapshot Fuzzing',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/self/atom-one-light.css"><link rel="stylesheet" href="/self/nord.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">安全代码</span></a><a class="nav-page-title" href="/"><span class="site-name">When Hypervisor Met Snapshot Fuzzing</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">When Hypervisor Met Snapshot Fuzzing</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-21T08:00:00.000Z" title="发表于 2022-07-21 16:00:00">2022-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-21T08:00:00.000Z" title="更新于 2022-07-21 16:00:00">2022-07-21</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>source: <a target="_blank" rel="noopener" href="https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html">https://null2root.github.io/blog/2022/07/21/When-Hypervisor-Met-Snapshot-Fuzzing.html</a></p>
<h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><p>Hypervisor was known as hard target to fuzz over several years. Even though, lots of prior pioneers( <a target="_blank" rel="noopener" href="https://rezer0dai.github.io/biug-bounties/">Peter Hlavaty</a>, <a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2021ams/materials/D2T2%20-%20Discovering%2010+%20Vulnerabilities%20in%20Virtualbox%20-%20Chen%20Nan.pdf">Chaitin Tech</a>, <a target="_blank" rel="noopener" href="https://starlabs.sg/blog/2020/04-adventures-in-hypervisor-oracle-virtualbox-research/#coverage-guided-fuzzing">StarLabs</a>, <a target="_blank" rel="noopener" href="https://github.com/SafeBreach-Labs/hAFL2">Peleg Hadar and Ophir Harpaz</a> and many others ) doing amazing work to overcome this limit and found interesting bugs.</p>
<p>But it is not an easy topic for some fresh newbie like me to starts from the bottom. I think manual code( or binary ) auditing and static analysis could be only considerable options if I start my research a few years ago without <strong>What The Fuzz</strong>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf">What The Fuzz</a>( a.k.a WTF ) is a snapshot-based fuzzer targeting Windows Ring-3 and Ring-0 component. WTF’s snapshot is based on memory dump both kernel and user-land. Because of that, WTF can not emulate any functionality which requires anything not within in-memory and can not create new process or thread because memory dump limited on single process. But WTF support <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/bochscpu_backend.cc#L265">breakpoint Handler</a> which you can set breakpoint on <strong>any</strong> address within memory dump and if fuzz execution reaches that address, pre-defined breakpoint handler will be executed. Based on this, we can trying to overcome some limitation on WTF such as <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fshooks.cc">file access</a>.</p>
<p>I really love WTF’s flexibility and its potential, and I am going to show one of example usage of WTF on targeting Virtualbox to prove how awesome it is.</p>
<h1 id="2-Developing-Fuzz-Module"><a href="#2-Developing-Fuzz-Module" class="headerlink" title="2. Developing Fuzz Module"></a>2. Developing Fuzz Module</h1><p>First, you should define your own fuzz module for your target. There are few examples on github( <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">fuzzer_hevd.cc</a>, <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">fuzzer_tlv_server.cc</a> ) and blog post( <a target="_blank" rel="noopener" href="https://blog.ret2.io/2021/07/21/wtf-snapshot-fuzzing/">ret2systems</a>, <a target="_blank" rel="noopener" href="https://doar-e.github.io/blog/2021/07/15/building-a-new-snapshot-fuzzer-fuzzing-ida/">Doar-e</a> ). </p>
<p>My Target was Virtualbox’s <strong>SVGA</strong> component.</p>
<p>SVGA is something like “<a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2021/1/6/mindshare-analysis-of-vmware-workstation-and-esxi-using-debug-symbols-from-flings">JavaScript of hypervisors</a>“. Because of its complex nature, many hypervisor bugs are oriented by SVGA. And that’s the reason why I choose it as a first target.</p>
<p>VirtualBox have a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4505">vmsvgaR3FifoLoop</a>. It <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4757">waits</a> until guest submit new command data through GPA. So this is a good spot( or should I call it <a target="_blank" rel="noopener" href="https://youtu.be/ZaOtY4i5w_U">source</a>? ) to take a snapshot.</p>
<p>I set a breakpoint on <code>vmsvgaR3FifoLoop+4E2</code> to take snapshot. It is same position as <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4783">here</a>, start of switch-case routine for <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Devices/Graphics/vmsvga_include/svga_reg.h#L152">SVGA</a> and <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163eabe8b7a7f14f29c88c13a458f38fe25e/src/VBox/Additions/3D/mesa/mesa-17.3.9/src/gallium/drivers/svga/include/svga3d_cmd.h#L56">SVGA3D</a> command.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah1.png" alt="blahblah1"></p>
<p>After creating snapshot, I had to decide make it <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_tlv_server.cc">run multiple times in single execution</a> or <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/main/src/wtf/fuzzer_hevd.cc">not</a>. Because SVGA is consist of various commands like define, update, delete something…, I thought fuzz campaign must handle multiple SVGA commands during single round.</p>
<p>First, I had to define structure to contains multiple testcases. Luckily, <a target="_blank" rel="noopener" href="https://twitter.com/0vercl0k">0vercl0k</a> already write <a target="_blank" rel="noopener" href="https://github.com/0vercl0k/wtf/blob/4a9bf55/src/wtf/fuzzer_tlv_server.cc#L24-L75">nice example</a> to doing that. So I did same thing as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SVGA_CMD_BODY_MAX 0xA000</span><br><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> SvgaCmdList[] = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">19</span>, <span class="hljs-number">22</span>, <span class="hljs-number">25</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">33</span>, <span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">36</span>, <span class="hljs-number">37</span>, <span class="hljs-number">38</span>, <span class="hljs-number">39</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">42</span>, <span class="hljs-number">1040</span>, <span class="hljs-number">1041</span>, <span class="hljs-number">1042</span>, <span class="hljs-number">1043</span>, <span class="hljs-number">1044</span>, <span class="hljs-number">1046</span>, <span class="hljs-number">1047</span>, <span class="hljs-number">1048</span>, <span class="hljs-number">1049</span>, <span class="hljs-number">1050</span>, <span class="hljs-number">1051</span>, <span class="hljs-number">1052</span>, <span class="hljs-number">1053</span>, <span class="hljs-number">1054</span>, <span class="hljs-number">1055</span>, <span class="hljs-number">1056</span>, <span class="hljs-number">1057</span>, <span class="hljs-number">1058</span>, <span class="hljs-number">1059</span>, <span class="hljs-number">1060</span>, <span class="hljs-number">1061</span>, <span class="hljs-number">1062</span>, <span class="hljs-number">1063</span>, <span class="hljs-number">1064</span>, <span class="hljs-number">1065</span>, <span class="hljs-number">1066</span>, <span class="hljs-number">1067</span>, <span class="hljs-number">1068</span>, <span class="hljs-number">1069</span>, <span class="hljs-number">1070</span>, <span class="hljs-number">1071</span>, <span class="hljs-number">1072</span>, <span class="hljs-number">1073</span>, <span class="hljs-number">1074</span>, <span class="hljs-number">1075</span>, <span class="hljs-number">1076</span>, <span class="hljs-number">1077</span>, <span class="hljs-number">1078</span>, <span class="hljs-number">1079</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1081</span>&#125;;<br><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> SvgaCmdListLen = <span class="hljs-number">58</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SvgaCmd_t</span> &#123;<br>  <span class="hljs-type">uint32_t</span> SvgaCmdCode;<br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; SvgaBody;<br>  <span class="hljs-built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmd_t, SvgaCmdCode, SvgaBody);<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SvgaCmds_t</span> &#123;<br>  std::vector&lt;SvgaCmd_t&gt; SvgaCmds;<br>  <span class="hljs-built_in">NLOHMANN_DEFINE_TYPE_INTRUSIVE</span>(SvgaCmds_t, SvgaCmds);<br>&#125;;<br><br><span class="hljs-keyword">struct</span> &#123;<br>  std::deque&lt;SvgaCmd_t&gt; SvgaCmds;<br>  CpuState_t Context;<br>  <span class="hljs-type">uint8_t</span> SvgaCmdBody[SVGA_CMD_BODY_MAX];<br>  <span class="hljs-type">uint32_t</span> SvgaCmdBodySize;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RestoreGprs</span><span class="hljs-params">(Backend_t *B)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;C = Context;<br>    B-&gt;<span class="hljs-built_in">Rsp</span>(C.Rsp);<br>    B-&gt;<span class="hljs-built_in">Rip</span>(C.Rip);<br>    B-&gt;<span class="hljs-built_in">Rax</span>(C.Rax);<br>    B-&gt;<span class="hljs-built_in">Rbx</span>(C.Rbx);<br>    B-&gt;<span class="hljs-built_in">Rcx</span>(C.Rcx);<br>    B-&gt;<span class="hljs-built_in">Rdx</span>(C.Rdx);<br>    B-&gt;<span class="hljs-built_in">Rsi</span>(C.Rsi);<br>    B-&gt;<span class="hljs-built_in">Rdi</span>(C.Rdi);<br>    B-&gt;<span class="hljs-built_in">R8</span>(C.R8);<br>    B-&gt;<span class="hljs-built_in">R9</span>(C.R9);<br>    B-&gt;<span class="hljs-built_in">R10</span>(C.R10);<br>    B-&gt;<span class="hljs-built_in">R11</span>(C.R11);<br>    B-&gt;<span class="hljs-built_in">R12</span>(C.R12);<br>    B-&gt;<span class="hljs-built_in">R13</span>(C.R13);<br>    B-&gt;<span class="hljs-built_in">R14</span>(C.R14);<br>    B-&gt;<span class="hljs-built_in">R15</span>(C.R15);<br>  &#125;<br>&#125; GlobalState;<br><br><span class="hljs-function">SvgaCmds_t <span class="hljs-title">Deserialize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Buffer, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> BufferSize)</span> </span>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;Root = json::json::<span class="hljs-built_in">parse</span>(Buffer, Buffer + BufferSize);<br>  <span class="hljs-keyword">return</span> Root.<span class="hljs-built_in">get</span>&lt;SvgaCmds_t&gt;();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">InsertTestcase</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span> *Buffer, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> BufferSize)</span> </span>&#123;<br>  GlobalState.SvgaCmds.<span class="hljs-built_in">clear</span>();<br><br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;Root = <span class="hljs-built_in">Deserialize</span>(Buffer, BufferSize);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> SvgaCmd : Root.SvgaCmds) &#123;<br>    GlobalState.SvgaCmds.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">move</span>(SvgaCmd));<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>It is almost identical as example.</p>
<p>Next question was, how can I insert data into snapshot? I had to find a insertion point and proper memory address. Luckily( again ), VirtualBox using a function called <a target="_blank" rel="noopener" href="https://github.com/mdaniel/virtualbox-org-svn-vbox-trunk/blob/8fe9163/src/VBox/Devices/Graphics/DevVGA-SVGA.cpp#L4183">vmsvgaR3FifoGetCmdPayload</a> to receive command data from guest to host. I define a breakpoint handler in <code>Init()</code> callback function as below.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//</span><br><span class="hljs-comment">// unsigned __int8 *__fastcall vmsvgaR3FifoGetCmdPayload(</span><br><span class="hljs-comment">//       unsigned int cbPayloadReq,</span><br><span class="hljs-comment">//       volatile unsigned int *pFIFO,</span><br><span class="hljs-comment">//       unsigned int offCurrentCmd,</span><br><span class="hljs-comment">//       unsigned int offFifoMin,</span><br><span class="hljs-comment">//       unsigned int offFifoMax,</span><br><span class="hljs-comment">//       unsigned __int8 *pbBounceBuf,</span><br><span class="hljs-comment">//       unsigned int *pcbAlreadyRead,</span><br><span class="hljs-comment">//       PDMTHREAD *pThread,</span><br><span class="hljs-comment">//       VGAState *pThis,</span><br><span class="hljs-comment">//       VMSVGAR3STATE *pSVGAState,</span><br><span class="hljs-comment">//       PDMDEVINSR3 *pDevIns)</span><br><span class="hljs-comment">//</span><br><span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">Setbreakpoint</span>(<span class="hljs-string">&quot;VBoxDD!vmsvgaR3FifoGetCmdPayload&quot;</span>, [](Backend_t *Backend) &#123;<br>  <span class="hljs-type">uint32_t</span> cbPayloadReq = Backend-&gt;<span class="hljs-built_in">GetArg</span>(<span class="hljs-number">0</span>);<br>  Gva_t pbBounceBuf_gva = Backend-&gt;<span class="hljs-built_in">GetArgGva</span>(<span class="hljs-number">5</span>);<br>  Gva_t pcbAlreadyRead_gva = Backend-&gt;<span class="hljs-built_in">GetArgGva</span>(<span class="hljs-number">6</span>);<br><br>  <span class="hljs-keyword">if</span>(cbPayloadReq &gt; GlobalState.SvgaCmdBodySize) &#123;<br>    <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;cbpayloadReq(&#123;:#x&#125;) &gt; SvgaCmdBodySize(&#123;:#x&#125;), restore context and goto next round\n&quot;</span>, cbPayloadReq, GlobalState.SvgaCmdBodySize);<br>    <span class="hljs-keyword">return</span> GlobalState.<span class="hljs-built_in">RestoreGprs</span>(Backend);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>(cbPayloadReq &gt; u32PbBounceBufMaxSize) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> RetAddr = Backend-&gt;<span class="hljs-built_in">VirtRead8</span>(<span class="hljs-built_in">Gva_t</span>(Backend-&gt;<span class="hljs-built_in">Rsp</span>()));<br>    <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;check this, RetAddr = &#123;:#x&#125;\n&quot;</span>, RetAddr);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!Backend-&gt;<span class="hljs-built_in">VirtWriteDirty</span>(pbBounceBuf_gva, GlobalState.SvgaCmdBody, cbPayloadReq)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to write pbBounceBuf, pbBounceBuf = &#123;:#x&#125;, cbPayloadReq = &#123;:#x&#125;, SvgaCmdBodySize = &#123;:#x&#125;\n&quot;</span>,<br>                pbBounceBuf_gva.<span class="hljs-built_in">U64</span>(), cbPayloadReq, GlobalState.SvgaCmdBodySize);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!Backend-&gt;<span class="hljs-built_in">VirtWriteStructDirty</span>(pcbAlreadyRead_gva, &amp;cbPayloadReq)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Faile to write pcbAlreadyRead, pcbAlreadyRead = &#123;:#x&#125;\n&quot;</span>, pcbAlreadyRead_gva.<span class="hljs-built_in">U64</span>());<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(pbBounceBuf_gva.<span class="hljs-built_in">U64</span>());<br><br>&#125;)) &#123;<br>  fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to Setbreakpoint on VBoxDD!vmsvgaR3FifoGetCmdPayload\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>I also had to define end point of execution. After some reversing, I found two spots and using it as end point.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">const</span> Gva_t SvgaLoopEnd = <span class="hljs-built_in">Gva_t</span>(g_Dbg.<span class="hljs-built_in">GetSymbol</span>(<span class="hljs-string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="hljs-number">0x24AB</span>);<br><span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">Setbreakpoint</span>(SvgaLoopEnd, [](Backend_t *Backend) &#123;<br>  <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;loop end reached, restore context\n&quot;</span>);<br>  GlobalState.<span class="hljs-built_in">RestoreGprs</span>(g_Backend);<br>&#125;)) &#123;<br>  fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to Setbreakpoint on SvgaLoopEnd\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-type">const</span> Gva_t SvgLoopEnd2 = <span class="hljs-built_in">Gva_t</span>(g_Dbg.<span class="hljs-built_in">GetSymbol</span>(<span class="hljs-string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="hljs-number">0x24B2</span>);<br><span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">Setbreakpoint</span>(SvgLoopEnd2, [](Backend_t *Backend) &#123;<br>  <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;loop end2 reached, restore context\n&quot;</span>);<br>  GlobalState.<span class="hljs-built_in">RestoreGprs</span>(g_Backend);<br>&#125;)) &#123;<br>  fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to Setbreakpoint on SvgLoopEnd2\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>As I said above, I create a snapshot on <code>vmsvgaR3FifoLoop+4E2</code>. So if I restore register context, next execution flow starts from there. Because of that, I had to parse new testcase using breakpoint Handler.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">const</span> Gva_t SvgaLoopStart = <span class="hljs-built_in">Gva_t</span>(g_Dbg.<span class="hljs-built_in">GetSymbol</span>(<span class="hljs-string">&quot;VBoxDD!vmsvgaR3FifoLoop&quot;</span>) + <span class="hljs-number">0x4e2</span>);<br><span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">Setbreakpoint</span>(SvgaLoopStart, [](Backend_t *Backend) &#123;<br>  <span class="hljs-keyword">if</span>(GlobalState.SvgaCmds.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;testcase deque empty! goto next round...\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> Backend-&gt;<span class="hljs-built_in">Stop</span>(<span class="hljs-built_in">Ok_t</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">auto</span> &amp;Testcase = GlobalState.SvgaCmds.<span class="hljs-built_in">front</span>();<br><br>  <span class="hljs-keyword">while</span> (Testcase.SvgaCmdCode == <span class="hljs-number">1045</span>) &#123;<br>    GlobalState.SvgaCmds.<span class="hljs-built_in">pop_front</span>();<br><br>    <span class="hljs-keyword">if</span>(GlobalState.SvgaCmds.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;testcase deque empty during cmd filtering! goto next round...\n&quot;</span>);<br>      <span class="hljs-keyword">return</span> Backend-&gt;<span class="hljs-built_in">Stop</span>(<span class="hljs-built_in">Ok_t</span>());<br>    &#125;<br><br>    Testcase = GlobalState.SvgaCmds.<span class="hljs-built_in">front</span>();<br>  &#125;<br><br>  Backend-&gt;<span class="hljs-built_in">Rbx</span>(Testcase.SvgaCmdCode);<br><br>  <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;SvgaCmdCode = &#123;:#x&#125;\n&quot;</span>, Testcase.SvgaCmdCode);<br><br>  <span class="hljs-keyword">if</span>(Testcase.SvgaCmdCode &gt;= <span class="hljs-number">1040</span>) &#123;<br>    <br>    <span class="hljs-built_in">DebugPrint</span>(<span class="hljs-string">&quot;Have to avoid AssertBreak(pHdr-&gt;size &lt; pThis-&gt;svga.cbFIFO), write &#123;:#x&#125; on first DWORD\n&quot;</span>, Testcase.SvgaBody.<span class="hljs-built_in">size</span>());<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> Svga3dCmdSize = Testcase.SvgaBody.<span class="hljs-built_in">size</span>();<br>    <span class="hljs-keyword">if</span>(Svga3dCmdSize &gt;= <span class="hljs-number">0x200000</span>) &#123;<br>      fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Svga3dCmdSize(&#123;:#x&#125;) &gt; cbFIFO, abort\n&quot;</span>, Svga3dCmdSize);<br>      std::<span class="hljs-built_in">abort</span>();<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="hljs-number">0</span>], &amp;Svga3dCmdSize, <span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">memcpy</span>(&amp;GlobalState.SvgaCmdBody[<span class="hljs-number">4</span>], Testcase.SvgaBody.<span class="hljs-built_in">data</span>(), Testcase.SvgaBody.<span class="hljs-built_in">size</span>());<br>    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="hljs-built_in">size</span>() + <span class="hljs-number">4</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">memcpy</span>(GlobalState.SvgaCmdBody, Testcase.SvgaBody.<span class="hljs-built_in">data</span>(), Testcase.SvgaBody.<span class="hljs-built_in">size</span>());<br>    GlobalState.SvgaCmdBodySize = Testcase.SvgaBody.<span class="hljs-built_in">size</span>();<br>  &#125;    <br><br>  GlobalState.SvgaCmds.<span class="hljs-built_in">pop_front</span>();<br>&#125;)) &#123;<br>  fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to Setbreakpoint on SvgaLoopStart\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>After some investigation, I found <code>CreateDeviceEx</code> call in <code>vmsvga3dContextDefine</code> keep causing <strong>CR3 context switching</strong> and I didn’t found any way to handling it using breakpoint handler. So I just blacklisting it( <code>SVGA_3D_CMD_CONTEXT_DEFINE</code> &#x3D; <code>1045</code> ).</p>
<p>I disclose almost every part of fuzz module except mutation part. I just use libfuzzer mutator to mutate body data of SVGA command and pick one of command in array randomly.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">CustomMutator_t</span><span class="hljs-params">(std::mt19937_64 &amp;Rng, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> TestcaseMaxSize)</span></span><br><span class="hljs-function">  : Rng_(Rng), TestcaseMaxSize_(TestcaseMaxSize) &#123;</span><br><br>    <span class="hljs-comment">// set maximum size for multiple (mutated) testcase( Default = 1MB )</span><br>    ScratchBuffer__ = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">uint8_t</span>[]&gt;(_1MB);<br>    ScratchBuffer_  = &#123;ScratchBuffer__.<span class="hljs-built_in">get</span>(), _1MB&#125;;<br><br>    BodyMutator_ = <span class="hljs-built_in">make_unique</span>&lt;LibfuzzerMutator_t&gt;(Rng, TestcaseMaxSize);<br>&#125;<br><br><span class="hljs-comment">// skip for brevity...</span><br><br><span class="hljs-function">std::string <span class="hljs-title">Mutate</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> *Data, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> DataLen, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> MaxSize)</span> </span>&#123;<br>  <span class="hljs-keyword">auto</span> Root = <span class="hljs-built_in">Deserialize</span>(Data, DataLen);<br>  <span class="hljs-keyword">auto</span> &amp;SvgaCmds = Root.SvgaCmds;<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;SvgaCmd : SvgaCmds) &#123;<br><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// 50%</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) &#123;  <br>      <span class="hljs-type">uint32_t</span> SvgaCmdRandomIdx = <span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0</span>, SvgaCmdListLen);<br>      SvgaCmd.SvgaCmdCode = SvgaCmdList[SvgaCmdRandomIdx];<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="hljs-built_in">data</span>(), SvgaCmd.SvgaBody.<span class="hljs-built_in">size</span>());<br>    <span class="hljs-type">size_t</span> NewTestcaseSize = BodyMutator_-&gt;Mut_.<span class="hljs-built_in">Mutate</span>(GlobalMutBuffer, SvgaCmd.SvgaBody.<span class="hljs-built_in">size</span>(), MaxSize);<br>    SvgaCmd.SvgaBody.<span class="hljs-built_in">resize</span>(NewTestcaseSize);<br>    <span class="hljs-built_in">memcpy</span>(SvgaCmd.SvgaBody.<span class="hljs-built_in">data</span>(), GlobalMutBuffer, NewTestcaseSize);<br>  &#125;<br>  <br>  json::json Serialized;<br>  <span class="hljs-built_in">to_json</span>(Serialized, Root);<br>  <span class="hljs-keyword">return</span> Serialized.<span class="hljs-built_in">dump</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>I also define generator function. It is very useful if you are too lazy to create random input like me ^~^.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">std::string <span class="hljs-title">GenerateTestcase</span><span class="hljs-params">()</span> </span>&#123;<br>  SvgaCmds_t Root;<br>  <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> N = <span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> Idx = <span class="hljs-number">0</span>; Idx &lt; N; Idx++) &#123;<br>    SvgaCmd_t SvgaCmd;<br>    <br>    SvgaCmd.SvgaCmdCode = SvgaCmdList[<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0</span>, SvgaCmdListLen)];<br>    SvgaCmd.SvgaBody.<span class="hljs-built_in">resize</span>(<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0x100</span>, <span class="hljs-number">0x400</span>));<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="hljs-built_in">size</span>(); i++) &#123;<br>        SvgaCmd.SvgaBody[i] = <span class="hljs-number">0x41</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SvgaCmd.SvgaBody.<span class="hljs-built_in">size</span>(); i++) &#123;<br>        SvgaCmd.SvgaBody[i] = (<span class="hljs-type">uint8_t</span>)<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>);<br>      &#125;<br>    &#125;<br><br>    Root.SvgaCmds.<span class="hljs-built_in">emplace_back</span>(SvgaCmd);<br>  &#125;<br><br>  json::json Serialized;<br>  <span class="hljs-built_in">to_json</span>(Serialized, Root);<br>  <span class="hljs-keyword">return</span> Serialized.<span class="hljs-built_in">dump</span>();<br>&#125;<br><br><span class="hljs-function">std::string <span class="hljs-title">GetNewTestcase</span><span class="hljs-params">(<span class="hljs-type">const</span> Corpus_t &amp;Corpus)</span> <span class="hljs-keyword">override</span> </span>&#123;<br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// 20%</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">GetUint32</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>) == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GenerateTestcase</span>();<br>  &#125;<br><br>  <span class="hljs-type">const</span> Testcase_t *Testcase = Corpus.<span class="hljs-built_in">PickTestcase</span>();<br><br>  <span class="hljs-keyword">if</span> (!Testcase) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;The corpus is empty, generate random one\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GenerateTestcase</span>();<br>  &#125;<br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Copy the input in a buffer we&#x27;re going to mutate.</span><br>  <span class="hljs-comment">//</span><br><br>  <span class="hljs-built_in">memcpy</span>(ScratchBuffer_.<span class="hljs-built_in">data</span>(), Testcase-&gt;Buffer_.<span class="hljs-built_in">get</span>(),<br>         Testcase-&gt;BufferSize_);<br><br>  <span class="hljs-comment">// return Mutate(ScratchBuffer_.data(), Testcase-&gt;BufferSize_, TestcaseMaxSize_);</span><br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Mutate</span>(ScratchBuffer_.<span class="hljs-built_in">data</span>(), Testcase-&gt;BufferSize_, u32PbBounceBufMaxSize - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint32_t</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Aaaaannnd, this is everything you need to fuzz! I skip some formal code for brevity, but I think you can easily find what you need to define fully working fuzz module.</p>
<p>…..Ooooh wait, I forgot something. After some hours of struggle, I define a blacklist which cause CR3 context switching. I just put it on the end of <code>Init()</code> function.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SetupVBoxBlacklistHooks</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VBoxRT!RTLogLoggerEx&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VBoxRT!RTLogLoggerEx\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VBoxVMM!PDMCritSectLeave&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VBoxVMM!PDMCritSectLeave\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VBoxC!util::AutoLockBase::release&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::release\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VBoxC!util::AutoLockBase::acquire&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VBoxC!util::AutoLockBase::acquire\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VirtualBoxVM!UIFrameBufferPrivate::NotifyChange&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VirtualBoxVM!UIFrameBufferPrivate::NotifyChange\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;VBoxRT!SUPSemEventWaitNoResume&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on VBoxRT!SUPSemEventWaitNoResume\n&quot;</span>);<br>    std::<span class="hljs-built_in">abort</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;d3d9!CBaseDevice::Release&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on d3d9!CBaseDevice::Release\n&quot;</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;d3d9!CD3DBase::Clear&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on d3d9!CD3DBase::Clear\n&quot;</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;d3d9!CMipMap::SetAutoGenFilterType&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::SetAutoGenFilterType\n&quot;</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;d3d9!CMipMap::GenerateMipSubLevels&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on d3d9!CMipMap::GenerateMipSubLevels\n&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(!g_Backend-&gt;<span class="hljs-built_in">SetBreakpoint</span>(<span class="hljs-string">&quot;USER32!GetDC&quot;</span>, [](Backend_t *Backend) &#123;<br>    Backend-&gt;<span class="hljs-built_in">SimulateReturnFromFunction</span>(<span class="hljs-number">0x1337</span>);<br>  &#125;)) &#123;<br>    fmt::<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to SetBreakpoint on USER32!GetDC\n&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Yep. That’s really everything. I use this fuzz module several hours and it founds interesting crash.</p>
<h1 id="3-Vulnerability-TL-DR"><a href="#3-Vulnerability-TL-DR" class="headerlink" title="3. Vulnerability( TL;DR )"></a>3. Vulnerability( TL;DR )</h1><p>Crash occurred in <code>vmsvga3dSurfaceCopy</code> function( <strong>PageHeap</strong> needed ).</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah2.png" alt="blahblah2"></p>
<p>This function trying to copy surface data from one to another using surface id and there’s no boundary check between surface, so it become exploitable wildcopy vulnerability in heap memory.</p>
<p><img src="https://github.com/henices/pictures/raw/master/wtf-vbox-blahblah3.png" alt="spot the bug"></p>
<p>This vulnerability patched in <a target="_blank" rel="noopener" href="https://www.oracle.com/security-alerts/cpujul2022.html">6.1.36 release</a> at July, 2022.</p>
<h1 id="4-Conclusion"><a href="#4-Conclusion" class="headerlink" title="4. Conclusion"></a>4. Conclusion</h1><p>I think importance of snapshot fuzzing is, it makes researcher to focus on target itself. </p>
<p>Unlike other fuzzers based on runtime and DBI are often create (very) unreasonable side effect or need lots of time to create working harness. The concept of snapshot fuzzing makes it possible to reduce this waste of time.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://usmacd.com">曼福吉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/">https://usmacd.com/cn/2022-07-21-When-Hypervisor-Met-Snapshot-Fuzzing/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://usmacd.com" target="_blank">安全代码</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Archives/">Archives</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/winafl/" title="winafl fuzz 工具的使用"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">winafl fuzz 工具的使用</div></div><div class="info-2"><div class="info-item-1">0. 下载 Visual Studio Community 2022下载地址：https://aka.ms/vs/17/release/vs_community.exe 从微软网站下载并安装 Visual Studio Community 的时候速度只有2 K，一下午没能下载成功。咨询同事小钻风，指出可能是 DNS 问题，将 DNS 切换成阿里的 DNS 223.5.5.5 后下载速度达到 4 M。中国开发者网络总是个问题，大家都挺不容易的。 1. 编译 winafl 下载 DynamoRIO 解压到 D:\DynamoRIO 下载 cmake 解压到 D:\cmake 从 Github 下载 winafl 编译 intel PT 需要同步 third_party 的源码  123git clone https://github.com/googleprojectzero/winafl.gitcd winaflgit submodule update --init --recursive   从菜单中选择  X64 native tool command prompt for V...</div></div></div></a><a class="pagination-related" href="/cn/ssd/" title="SSD 迁移记"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">SSD 迁移记</div></div><div class="info-2"><div class="info-item-1">由于某些需求，决定上SSD，提高一下硬盘读写速度。上二手东买了三星(SAMSUNG) 860 EVO 最初的想法是作为数据盘使用，即操作系统还是跑在机械硬盘上，仔细一思考，还是折腾一下，要不实在是有些浪费，事实证明，折腾是值得的，感觉就像飞一样。 首先查看一下磁盘原始的情况： 1234$ mount/dev/sda1 on /boot type ext4 (rw,relatime,seclabel,stripe=4)/dev/mapper/fedora-root on / type ext4 (rw,relatime,seclabel)  当然首先要把 SSD 处理一下，安装一下 gparted 图形化界面很好用。 1sudo dnf install gparted  建个分区表，选择 gpt，分个区，/dev/mapper/fedora-root 大小为50G，先分个50G的分区，剩下的全部给 另外一个分区，格式化为 ext4。操作完成后，用fdisk 查看一下： 123456789101112$ fdisk -lDisk /dev/sdb：232.9 GiB，25005935...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/How%20to%20be%20successful/" title="How to be successful"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-09</div><div class="info-item-2">How to be successful</div></div><div class="info-2"><div class="info-item-1">source: https://blog.samaltman.com/how-to-be-successful I’ve observed thousands of founders and thought a lot about what it takes to make a huge amount of money or to create something important. Usually, people start off wanting the former and end up wanting the latter. Here are 13 thoughts about how to achieve such outlier success. Everything here is easier to do once you’ve already reached a baseline degree of success (through privilege or effort) and want to put in the work to turn that in...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">曼福吉</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Introduction"><span class="toc-number">1.</span> <span class="toc-text">1. Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Developing-Fuzz-Module"><span class="toc-number">2.</span> <span class="toc-text">2. Developing Fuzz Module</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Vulnerability-TL-DR"><span class="toc-number">3.</span> <span class="toc-text">3. Vulnerability( TL;DR )</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Conclusion"><span class="toc-number">4.</span> <span class="toc-text">4. Conclusion</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/gemini_in_chrome/" title="开启 Gemini in Chrome 的方法">开启 Gemini in Chrome 的方法</a><time datetime="2026-01-29T16:00:00.000Z" title="发表于 2026-01-30 00:00:00">2026-01-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/sucess_is_the_mother_of_sucess/" title="成功是成功之母">成功是成功之母</a><time datetime="2026-01-27T16:00:00.000Z" title="发表于 2026-01-28 00:00:00">2026-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/ai_studio_podcast_transcript/" title="利用 AI Studio 整理播客音频的逐字稿">利用 AI Studio 整理播客音频的逐字稿</a><time datetime="2026-01-07T16:00:00.000Z" title="发表于 2026-01-08 00:00:00">2026-01-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/anti-weakness-learning/" title="反脆弱式的学习方法">反脆弱式的学习方法</a><time datetime="2025-12-30T16:00:00.000Z" title="发表于 2025-12-31 00:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/keep_hard/" title="坚持的秘诀">坚持的秘诀</a><time datetime="2025-12-15T16:00:00.000Z" title="发表于 2025-12-16 00:00:00">2025-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 曼福吉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="/js/tw_cn.js?v=5.5.4"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>