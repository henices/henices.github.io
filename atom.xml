<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>安全代码</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://usmacd.com/"/>
  <updated>2021-07-23T05:11:52.733Z</updated>
  <id>http://usmacd.com/</id>
  
  <author>
    <name>henices</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>fedora 上安装 fcitx5 rime</title>
    <link href="http://usmacd.com/2021/07/23/fcitx5-rime/"/>
    <id>http://usmacd.com/2021/07/23/fcitx5-rime/</id>
    <published>2021-07-23T05:11:52.733Z</published>
    <updated>2021-07-23T05:11:52.733Z</updated>
    
    <content type="html"><![CDATA[<p>现在 fcitx 已经升级到了 fcitx5, 本来用着 fcitx4 挺好，也没有想着升级，在折腾 fcitx.vim 的时候发现 fcitx 居然升级了，<br>使得我的 vim 插件无法正常工作了，一顿折腾，本来以为很简单没想到进了个大坑 。<br>主要是不愿意放弃我的一万多行的 rime 用户词库，多年的积累了，不过 Linux 用户不就是老折腾吗， 唉。</p><p>fcitx5-rime 的默认的配置目录已经变为 <code>~/.local/share/fcitx5/rime</code>， fcitx4 默认的配置目录是 <code>~/.config/fcitx/rime</code></p><h3 id="安装-fcitx5-和-fcitx5-rime"><a href="#安装-fcitx5-和-fcitx5-rime" class="headerlink" title="安装 fcitx5 和 fcitx5 rime"></a>安装 fcitx5 和 fcitx5 rime</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install -y fcitx5 fcitx5-autostart fcitx5-chinese-addons fcitx5-configtool fcitx5-gtk fcitx5-qt</span><br><span class="line">sudo dnf install -y fcitx5-rime</span><br></pre></td></tr></table></figure><p>Fedora dnf 已经默认有 fcitx5-rime 的安装包了，不用自己重新编译了，非常不错。 <code>fcitx5-chinese-addons</code><br>为 fcitx5 自己默认带的中文输入法，这些和 rime 没有什么关系，网络上有人说， fcitx 的中文输入较以前有较大改进。<br><code>fcitx5-autostart</code> 用于自启动。后面发现系统自带的启动环境变量好像设置的有问题，不安装其实也没有什么问题，<br>自己手动执行 <code>fcitx5 -d</code> 即可。</p><h3 id="设置正确的环境变量"><a href="#设置正确的环境变量" class="headerlink" title="设置正确的环境变量"></a>设置正确的环境变量</h3><p>修改  <code>~/.xprofile</code>， <code>~/.zshrc</code> ， <code>/etc/profile</code> 等文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GTK_IM_MODULE=fcitx5</span><br><span class="line">export QT_IM_MODULE=fcitx5</span><br><span class="line">export XMODIFIERS=&quot;@im=fcitx5&quot;</span><br></pre></td></tr></table></figure><h3 id="编译-fcitx5-qt5"><a href="#编译-fcitx5-qt5" class="headerlink" title="编译 fcitx5-qt5"></a>编译 fcitx5-qt5</h3><p>为了使我们自己编译的 vnote 可以正常使用 fcitx5， 需要编译 fcitx5-qt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:fcitx/fcitx5-qt.git</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; <span class="string">EOF &gt; build_linux.sh</span></span><br><span class="line"><span class="string">QTDIR=&quot;/home/henices/Qt5.12.9/5.12.9/gcc_64/&quot;</span></span><br><span class="line"><span class="string">PATH=&quot;$QTDIR/bin:$PATH&quot;</span></span><br><span class="line"><span class="string">LDFLAGS=-L$QTDIR/lib</span></span><br><span class="line"><span class="string">CPPFLAGS=-I$QTDIR/include</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">rm -rf build</span></span><br><span class="line"><span class="string">mkdir -p build</span></span><br><span class="line"><span class="string">cd build</span></span><br><span class="line"><span class="string">cmake ..</span></span><br><span class="line"><span class="string">make -j8</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">bash build_linux.sh</span><br></pre></td></tr></table></figure><p>编译完成后将生成的 so 文件 copy 到 qt 的插件目录： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cp ./qt5/platforminputcontext/libfcitx5platforminputcontextplugin.so /home/henices/Qt5.12.9/5.12.9/gcc_64/plugins/platforminputcontexts/</span><br></pre></td></tr></table></figure><h3 id="配置中文环境"><a href="#配置中文环境" class="headerlink" title="配置中文环境"></a>配置中文环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/locale.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LANG=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br><span class="line"><span class="built_in">export</span> LC_CTYPE=<span class="string">&quot;zh_CN.UTF-8&quot;</span></span><br></pre></td></tr></table></figure><h3 id="安装词库"><a href="#安装词库" class="headerlink" title="安装词库"></a>安装词库</h3><p>rime 现在已经使用 plum 管理词库，如果需要安装双拼输入法的，可以执行下面的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://git.io/rime-install | bash</span><br><span class="line">rime_frontend=fcitx5-rime bash rime-install double_pinyin</span><br></pre></td></tr></table></figure><p>rime 为了保证输入速度，词库很小，为了能够自动显示更多的词组，就需要使用拓展词库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/rime-aca/dictionaries.git</span><br><span class="line">cp dictionaries/luna_pinyin.dict/* ~/.<span class="built_in">local</span>/share/fcitx5/rime/</span><br></pre></td></tr></table></figure><p>安装了上面的拓展词库后，输入特殊符号的能力还是比较弱，需要把 symbols.yaml 也给加进来。</p><p><a href="https://github.com/rime/rime-prelude">https://github.com/rime/rime-prelude</a> 提供了我们所需要的 symbols.yaml 和 default.yaml,<br>可以使用 <a href="https://github.com/rime/plum">東風破</a> 安裝： <code>rime_frontend=fcitx5-rime bash rime-install prelude</code></p><p>由于我们使用的是自然码双拼，需要修改的文件为 <code>double_pinyin.custom.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">patch:</span></span><br><span class="line">  <span class="comment"># 載入朙月拼音擴充詞庫</span></span><br><span class="line">  <span class="attr">&quot;translator/dictionary&quot;:</span> <span class="string">luna_pinyin.extended</span></span><br><span class="line">  <span class="attr">&quot;punctuator/import_preset&quot;:</span> <span class="string">symbols</span></span><br><span class="line">  <span class="attr">&quot;recognizer/patterns/punct&quot;:</span> <span class="string">&quot;^/([A-Z|a-z]*|[0-9]|10)$&quot;</span></span><br></pre></td></tr></table></figure><p>设置完成后，要重新启动输入法，比如要输入 ☆ ，输入  <code>/xh</code> 即可</p><h3 id="将用户词库导入-rime"><a href="#将用户词库导入-rime" class="headerlink" title="将用户词库导入 rime"></a>将用户词库导入 rime</h3><p><code>rime_dict_manager -i luna_pinyin luna_pinyin.userdb.txt</code></p><p>这一步很关键啊，多年的积累不能浪费了。</p><h3 id="配置-fcitx5-皮肤"><a href="#配置-fcitx5-皮肤" class="headerlink" title="配置 fcitx5 皮肤"></a>配置 fcitx5 皮肤</h3><p>fcitx5 默认的皮肤不太好看，所以下载更新了皮肤。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/thep0y/fcitx5-themes.git</span><br><span class="line">cp spring ~/.<span class="built_in">local</span>/share/fcitx5/themes -r</span><br></pre></td></tr></table></figure><p>修改配置文件 <code>~/.config/fcitx5/conf/classicui.conf</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 垂直候选列表</span></span><br><span class="line"><span class="string">Vertical</span> <span class="string">Candidate</span> <span class="string">List=False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按屏幕 DPI 使用</span></span><br><span class="line"><span class="string">PerScreenDPI=True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Font (设置成你喜欢的字体)</span></span><br><span class="line"><span class="string">Font=&quot;Smartisan</span> <span class="string">Compact</span> <span class="string">CNS</span> <span class="number">13</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 主题(这里要改成你想要使用的主题名，主题名就在下面)</span></span><br><span class="line"><span class="string">Theme=spring</span></span><br></pre></td></tr></table></figure><h3 id="设置-fcitx-rime-单行模式"><a href="#设置-fcitx-rime-单行模式" class="headerlink" title="设置 fcitx rime 单行模式"></a>设置 fcitx rime 单行模式</h3><p>如果要将输入法设置为单行模式，需要修改配置文件 <code>~/.config/fcitx5/conf/rime.conf</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PreeditInApplication=True</span></span><br></pre></td></tr></table></figure><p>或者按快捷键 <code>ctrl + alt + p</code></p><h3 id="让-fcitx5-正确显示菜单"><a href="#让-fcitx5-正确显示菜单" class="headerlink" title="让 fcitx5 正确显示菜单"></a>让 fcitx5 正确显示菜单</h3><p>要让 fcitx 正确显示菜单，关键在于让 rime 输入法默认处于激活状态，根据 fcitx5 配置的提示第一个输入法为非激活状态。</p><ul><li>（1） 将第一个输入法设置为  键盘-英语 （美国），第二个输入法设置为 中州韵</li><li>（2） 在全局设置中，勾上默认状态为激活，共享输入状态设置为 <code>程序</code></li></ul><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="https://xuthus.cc/misc/fedora-install-fcitx5.html">https://xuthus.cc/misc/fedora-install-fcitx5.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;现在 fcitx 已经升级到了 fcitx5, 本来用着 fcitx4 挺好，也没有想着升级，在折腾 fcitx.vim 的时候发现 fcitx 居然升级了，&lt;br&gt;使得我的 vim 插件无法正常工作了，一顿折腾，本来以为很简单没想到进了个大坑 。&lt;br&gt;主要是不愿意放弃我
      
    
    </summary>
    
    
    
      <category term="linux" scheme="http://usmacd.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>恢复 Android App 的截屏功能</title>
    <link href="http://usmacd.com/2021/07/20/disable_security_flags/"/>
    <id>http://usmacd.com/2021/07/20/disable_security_flags/</id>
    <published>2021-07-20T08:34:48.860Z</published>
    <updated>2021-07-20T08:34:48.860Z</updated>
    
    <content type="html"><![CDATA[<p>今天遇上某 App 禁止截屏，其实就是使用了下面这段代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getWindow().setFlags(LayoutParams.FLAG_SECURE, LayoutParams.FLAG_SECURE);</span><br></pre></td></tr></table></figure><p>使用 frida 脚本可以绕过绕过这个限制 （使用 frida 需要将手机 root）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// https://developer.android.com/reference/android/view/WindowManager.LayoutParams.html#FLAG_SECURE</span></span><br><span class="line">   <span class="keyword">var</span> FLAG_SECURE = <span class="number">0x2000</span>;</span><br><span class="line">   <span class="keyword">var</span> Window = Java.use(<span class="string">&quot;android.view.Window&quot;</span>);</span><br><span class="line">   <span class="keyword">var</span> setFlags = Window.setFlags;  <span class="comment">//.overload(&quot;int&quot;, &quot;int&quot;)</span></span><br><span class="line"></span><br><span class="line">   setFlags.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">flags, mask</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&quot;Disabling FLAG_SECURE...&quot;</span>);</span><br><span class="line">       flags &amp;= ~FLAG_SECURE;</span><br><span class="line">       setFlags.call(<span class="built_in">this</span>, flags, mask);</span><br><span class="line">       <span class="comment">// Since setFlags returns void, we don&#x27;t need to return anything</span></span><br><span class="line">   &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>执行 frida 命令 <code>frida -U -l disable.js -n com.apps.android --no-pause</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l disable.js -n com.apps.android --no-pause</span><br><span class="line"></span><br><span class="line">[Pixel 2::com.apps.android]-&gt;</span><br><span class="line">[Pixel 2::com.apps.android]-&gt;</span><br><span class="line">[Pixel 2::com.apps.android]-&gt; Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br><span class="line">Disabling FLAG_SECURE...</span><br></pre></td></tr></table></figure><p>值得注意的是，这里使用了 <code>-n</code> 参数， attach 到目标进程，要不 App 会自动重启。看到输出调试信息后，<br>就可以正常截屏了。</p><h3 id="使用-objection"><a href="#使用-objection" class="headerlink" title="使用 objection"></a>使用 objection</h3><p>objection「2」有此功能，执行下面命令即可： <code>android ui FLAG_SECURE false</code>  但是我测试失败了。</p><h3 id="截屏小技巧-（lzx）"><a href="#截屏小技巧-（lzx）" class="headerlink" title="截屏小技巧 （lzx）"></a>截屏小技巧 （lzx）</h3><p>Android 截屏，可以使用一个快速的技巧  <code>adb exec-out screencap -p &gt; test.png</code></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li>[1] <a href="https://bhamza.me/2019/11/03/Android-Frida-hooking-disabling-FLAG-SECURE.html">https://bhamza.me/2019/11/03/Android-Frida-hooking-disabling-FLAG-SECURE.html</a></li><li>[2] <a href="https://github.com/sensepost/objection">https://github.com/sensepost/objection</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;今天遇上某 App 禁止截屏，其实就是使用了下面这段代码&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;
      
    
    </summary>
    
    
    
      <category term="Security" scheme="http://usmacd.com/tags/Security/"/>
    
      <category term="Android" scheme="http://usmacd.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>高效复盘技巧</title>
    <link href="http://usmacd.com/2021/06/28/fupangjiqiao/"/>
    <id>http://usmacd.com/2021/06/28/fupangjiqiao/</id>
    <published>2021-06-28T05:37:10.630Z</published>
    <updated>2021-06-28T05:37:10.630Z</updated>
    
    <content type="html"><![CDATA[<p>前些年总结的，现在看起来，过于复杂了，可能做短线的会有需求。</p><p><img src="https://github.com/henices/pictures/raw/master/webwxgetmsgimg.jpeg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前些年总结的，现在看起来，过于复杂了，可能做短线的会有需求。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/henices/pictures/raw/master/webwxgetmsgimg.jpeg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
    
    
      <category term="investment" scheme="http://usmacd.com/tags/investment/"/>
    
  </entry>
  
  <entry>
    <title>紫竹桥附近看病情况</title>
    <link href="http://usmacd.com/2021/06/28/304/"/>
    <id>http://usmacd.com/2021/06/28/304/</id>
    <published>2021-06-28T05:26:53.143Z</published>
    <updated>2021-06-28T05:26:53.143Z</updated>
    
    <content type="html"><![CDATA[<p>作为一个长期在帝都紫竹桥混吃的中年大叔，经常遇到需要看病的情况，主要需求有两个 （大人看病，小孩看病）。</p><p>总结附近医院情况，个人理解，供参考：</p><p>466:</p><p>缺点：没有儿科，巨贵，感觉医生喜欢过度治疗，据说一些科室已被私人承包，媳妇和自己都被坑过。<br>优点：离紫竹桥距离近，三甲，人通常比较少，小病，偷懒的时候可以过去。据说牙科不错，但是我没有去过。</p><p>304:</p><p>缺点：信息化程度相对较弱，但是看病流程梳理得不错。<br>优点：三甲，有儿科，对小儿看病有一定优待。医生水平不错，小孩在这看过几次，治疗效果不错。</p><p>现在304 改名为 解放军总医院第四医学中心，儿科的实力比以往有较大提升。</p><p>四季青：</p><p>缺点：二级医院，儿科有的医生感觉不太专业。<br>优点：挂号方便，有儿科，医院较大。</p><p>北方医院：</p><p>缺点：二级医院， 医院较小。<br>优点：离紫竹桥距离近，有保健科，小孩打预防针不错。</p><p>空总：</p><p>在这个医院多个科室看过病，家人还在这做过微创手术。</p><p>缺点：挂号有点难，人多，儿科水平一般。<br>优点：三甲，皮肤科北京有名，各科室水平比较均衡。信息化程度高，看病挺方便。</p><p>海总：</p><p>这个医院我没有去过，距离稍远。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;作为一个长期在帝都紫竹桥混吃的中年大叔，经常遇到需要看病的情况，主要需求有两个 （大人看病，小孩看病）。&lt;/p&gt;
&lt;p&gt;总结附近医院情况，个人理解，供参考：&lt;/p&gt;
&lt;p&gt;466:&lt;/p&gt;
&lt;p&gt;缺点：没有儿科，巨贵，感觉医生喜欢过度治疗，据说一些科室已被私人承包，媳妇和自
      
    
    </summary>
    
    
    
      <category term="Life" scheme="http://usmacd.com/tags/Life/"/>
    
  </entry>
  
  <entry>
    <title>【转】冯柳投资十大金句</title>
    <link href="http://usmacd.com/2021/06/28/fengliu/"/>
    <id>http://usmacd.com/2021/06/28/fengliu/</id>
    <published>2021-06-28T04:24:01.826Z</published>
    <updated>2021-06-28T04:24:01.826Z</updated>
    
    <content type="html"><![CDATA[<p>（一）经济的波动就像是剪羊毛，长好了就剪、剪完了再长。拿剪子的一般就是赢家，当然赢家之间也有互相剪的，所以就有大小赢家、长短赢家之分。</p><p>（二）技术分析主要是找出趋势和预期同向运动并强化的机会，价值分析则可以在反向运动但最终会被预期改变的机会上下注。</p><p>（三）各方面都完美的系统是不可能长期存在的，放弃效率和短期安全的系统往往才会是长期安全和可重复的。这不太符合人性，也就保证了系统的独特和有效性，也有利于将精力放在长期要素和战略点的思考上。</p><p>（四）涨跌都能令人坚定的才是好标的，跌令实的更实，因为价钱便宜了。涨令虚处显得确定，因为得到市场的确认和佐证了。这就是虚实结合带来的效果，如果涨几十个点就让人有想卖的感觉，那就说明虚处不足，就不太可能是好选择，最后也许连那几十个点也不容易挣到。反过来也是一样，跌了不敢重仓加的就说明实处不够，要多检讨下自己对确定性的把握能力。</p><p>（五）资产就是金钱在不同时间下的不同属性，本质就是现在的钱和未来的钱之间进行交换，买入是用现在换未来，卖出则是把未来换现在，关键要想明白未来和现在谁更值钱就好了。牛熊市就是这样的一个判断依据，当然，对极少数的优异公司来说，未来总是会强过现在的，这就是比牛熊大势更大的大势。</p><p>（六）市场在不断变化，企业也在不断变化，变化是常态，所以任何时候都要多方向的反复审视，对世界有敬畏心。这个敬畏就是要认识到事物总是在不断变化和出现意外的，所以要尽量让自己处于有保护的状态，尽量多的假设极端情况下的可靠性。</p><p>（七）当全世界都想通过股市来对抗通货膨胀的时候，也许拿着现金让其自然贬值会是更好的选择。除非你能找到明确的新增预期，否则凭什么指望别人以更高的价钱来购买已经给他人提供过保值机会的资产呢（房地产）。</p><p>（八）每个阶段的侧重点是不一样的。在高位的时候，我们要做计算题，要定量。因为一只股票涨了这么多、这么长时间，它的方向一定是没有问题的，这个时候你再去做定性研究意义不大。在低位的时候，如果你再去算账，就很容易吃大亏。它跌了这么久，那一定是方向上出了问题，你要把方向给想明白。如果能把方向证伪掉，是不需要考虑定量的问题，因为低位天然带有弹性和赔率。</p><p>（九）真正的投机应该是在价值的基础上进行的，是通过充分的价值理解后，将其在不同人群或环境下进行切换来获益。它认识到价值有主观倾向性和个性化的特点，价值不是个稳定具体的东西，也不存在用什么方法推算的公允值，因为资本以及资本后面的人是丰富不同的，他们有着不同的成本和收益预期，在各种市场环境下也会有着不同的预期因子和贴现率，而这些在乘数和复利计算的基础下就会有着巨大的差异。这也说明了为什么理性且信息充分对称的人之间也可以产生交易并实现双赢，其原因就在于他们有着不同的价值观、需求特点和满足感。</p><p>（十）长线投资很多人认为这是最容易做的，只要买进不动就可以了，其实这完全是误解。在所有的操作策略中，长线的要求最高。他需要对企业有着极为深刻的认识，对自己有着更为坚强的控制。他清楚把握企业未来数年的发展趋势，以投资的心态分享企业的成长。他的标的物是千里挑一，在这样的机会面前它不会惧怕任何亏损，不会设置除基本面外的任何止损指标。自信、尊重客观价值、不理会乃至勇于对抗市场是必备的投资品质，日常的波动在这样的前景面前是不应去考虑的。只有这样，股票才能够真正成为改变一生的东西。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;（一）经济的波动就像是剪羊毛，长好了就剪、剪完了再长。拿剪子的一般就是赢家，当然赢家之间也有互相剪的，所以就有大小赢家、长短赢家之分。&lt;/p&gt;
&lt;p&gt;（二）技术分析主要是找出趋势和预期同向运动并强化的机会，价值分析则可以在反向运动但最终会被预期改变的机会上下注。&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
    
      <category term="investment" scheme="http://usmacd.com/tags/investment/"/>
    
  </entry>
  
  <entry>
    <title>调试AOSP Java 代码</title>
    <link href="http://usmacd.com/2021/06/18/debug_aosp_java_code/"/>
    <id>http://usmacd.com/2021/06/18/debug_aosp_java_code/</id>
    <published>2021-06-18T01:56:42.523Z</published>
    <updated>2021-06-18T01:56:42.523Z</updated>
    
    <content type="html"><![CDATA[<p>下载 Android 源代码，编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">$ lunch</span><br><span class="line">$ make</span><br><span class="line">$ mmm development/tools/idegen/</span><br><span class="line">$ ./development/tools/idegen/idegen.sh</span><br></pre></td></tr></table></figure><p>运行后将生成下面几个文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android.ipr (IntelliJ / Android Studio)</span><br><span class="line">android.iml (IntelliJ / Android Studio)</span><br><span class="line">.classpath  (Eclipse)</span><br></pre></td></tr></table></figure><ol><li>在Android Studio 中导入 android.ipr</li></ol><p>File -&gt; Open 选择 android.ipr, 导入后可以Android Studio 中浏览AOSP 源码</p><ol start="2"><li>设置远程调试配置文件</li></ol><p>Run -&gt; Edit Configuration 点击左上角的 + 类型选择 Remote</p><ol start="3"><li>Attack 到需要调试的进程</li></ol><p>这里有两种方法，一是使用SDK 提供的 Monitor 二是使用 Android Studio 自带的<br>Attach debugger to Android Process 按钮。 </p><p>连接成功后将看到 Connected to the target VM</p><ol start="4"><li>设置断点</li></ol><p>设置断点很简单，用鼠标点击源码文件的左边栏，看见红色圆点说明就已经设置成功了。也<br>可以使用Ctrl + F8 的快捷键。</p><ol start="5"><li>运行程序，触发断点</li></ol><p>需要注意的是在调试过程中会出现源码对不上的情况，需要自己选择正确的源码。关于哪些<br>进程可以调试的问题，上篇已经有记录，这里就不在说了。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol><li>AOSP Sources in the IDE<br><a href="https://newcircle.com/s/post/1720/aosp_sources_in_the_ide">https://newcircle.com/s/post/1720/aosp_sources_in_the_ide</a></li><li>Debugging AOSP Platform code with Android Studio - Part I - Java Debugger<br><a href="http://ronubo.blogspot.sg/2016/01/debugging-aosp-platform-code-with.html">http://ronubo.blogspot.sg/2016/01/debugging-aosp-platform-code-with.html</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;下载 Android 源代码，编译&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;
      
    
    </summary>
    
    
    
      <category term="Android" scheme="http://usmacd.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>github clone 加速</title>
    <link href="http://usmacd.com/2021/06/17/github_speed_up/"/>
    <id>http://usmacd.com/2021/06/17/github_speed_up/</id>
    <published>2021-06-17T08:52:57.338Z</published>
    <updated>2021-06-17T08:52:57.338Z</updated>
    
    <content type="html"><![CDATA[<p>国内因为众所周知的原因，git clone 一直很慢，最近可能状况就更糟糕了。@TeleMan 提供了一个信息，可以<br>通过修改 host 文件达到加速效果。经过测试，只要修改两条记录即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">199.232.69.194                github.global.ssl.fastly.net</span><br><span class="line">140.82.113.4                  github.com</span><br></pre></td></tr></table></figure><p>修改后，速度快多了，直连</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/googleprojectzero/winafl.git</span><br><span class="line">正克隆到 &#x27;winafl&#x27;...</span><br><span class="line">remote: Enumerating objects: 1538, done.</span><br><span class="line">remote: Counting objects: 100% (175/175), done.</span><br><span class="line">remote: Compressing objects: 100% (108/108), done.</span><br><span class="line">remote: Total 1538 (delta 90), reused 130 (delta 60), pack-reused 1363</span><br><span class="line">接收对象中: 100% (1538/1538), 5.29 MiB | 765.00 KiB/s, 完成.</span><br><span class="line">处理 delta 中: 100% (846/846), 完成.</span><br></pre></td></tr></table></figure><p>使用一段时间后发现不是太稳定，终极大法还是需要一个长长的梯子，此方法记为备用方案。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;国内因为众所周知的原因，git clone 一直很慢，最近可能状况就更糟糕了。@TeleMan 提供了一个信息，可以&lt;br&gt;通过修改 host 文件达到加速效果。经过测试，只要修改两条记录即可&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;
      
    
    </summary>
    
    
    
      <category term="Programming" scheme="http://usmacd.com/tags/Programming/"/>
    
  </entry>
  
  <entry>
    <title>010editor 保持试用</title>
    <link href="http://usmacd.com/2021/05/24/010editor/"/>
    <id>http://usmacd.com/2021/05/24/010editor/</id>
    <published>2021-05-24T04:05:03.209Z</published>
    <updated>2021-05-24T04:05:03.209Z</updated>
    
    <content type="html"><![CDATA[<h2 id="软件介绍"><a href="#软件介绍" class="headerlink" title="软件介绍"></a>软件介绍</h2><p>010Editor是一款快速且强大的十六进制编辑器。用来编辑二进制文件。有一个友好易于使用的界面，无限次的<br>undo和redo操作。另外还可以打印十六进制的字节或者以书签的方式标出某些重要的字节。<br>支持二进制模板（binary template）系统。</p><h2 id="保持试用"><a href="#保持试用" class="headerlink" title="保持试用"></a>保持试用</h2><p>国外软件很多时候相当厚道了，试用基本是全功能，轻微延时和不能自动更新二进制模板，就日常使用来说基本<br>是完全够用了。</p><p>关键文件为 <code>~/.config/SweetScape/010 Editor.ini</code>，无法使用的时侯可以把这个文件清空，将恢复30天试用状态，<br>或者简单粗暴的将文件设置为只读。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 444 <span class="string">&quot;010 Editor.ini&quot;</span></span><br></pre></td></tr></table></figure><p>用IDA逆向的时侯没有发现这个文件比较奇怪。这个文件是 是使用strace命令发现的，strace命令支持 <code>-e</code> 的过<br>滤参数将有效减少输出，一般来说看strace日志文件可以从最后往前看。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -e trace=file ./010editor</span><br></pre></td></tr></table></figure><p>从代码上看有使用网络验证需要在hosts文件中屏敝两个网站， 可以减少一些不必要的麻烦。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.sweetscape.com</span><br><span class="line">127.0.0.1 www.010editor.com</span><br></pre></td></tr></table></figure><p>我现在已经是注册用户了，在很长的一段时间内，这方法是管用的，做个备忘。</p><p>scz 补充：</p><p>之前github上的那个开源keygen还能用，或者就用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user    user</span><br><span class="line">pass    3470D4AC7CEFACD9297A</span><br></pre></td></tr></table></figure><p>只是hosts更改可能不够，windows上用wf.msc阻止010 Editor联网，Linux好像没有简单办法阻止特定进程联网，<br>只能变相利用uid、gid达成目的。</p><p>How to block internet access to certain programs on Linux<br><a href="https://serverfault.com/questions/550276/how-to-block-internet-access-to-certain-programs-on-linux">https://serverfault.com/questions/550276/how-to-block-internet-access-to-certain-programs-on-linux</a></p><p><a href="https://unix.stackexchange.com/questions/104830/block-specific-application-with-iptables">https://unix.stackexchange.com/questions/104830/block-specific-application-with-iptables</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;软件介绍&quot;&gt;&lt;a href=&quot;#软件介绍&quot; class=&quot;headerlink&quot; title=&quot;软件介绍&quot;&gt;&lt;/a&gt;软件介绍&lt;/h2&gt;&lt;p&gt;010Editor是一款快速且强大的十六进制编辑器。用来编辑二进制文件。有一个友好易于使用的界面，无限次的&lt;br&gt;undo和
      
    
    </summary>
    
    
    
      <category term="linux" scheme="http://usmacd.com/tags/linux/"/>
    
      <category term="Crack" scheme="http://usmacd.com/tags/Crack/"/>
    
  </entry>
  
  <entry>
    <title>ThunerBird 78.8.1 连接 TLS 1.0 失败问题和 Linux 乱谈</title>
    <link href="http://usmacd.com/2021/04/30/thunderbird.tls.1.0/"/>
    <id>http://usmacd.com/2021/04/30/thunderbird.tls.1.0/</id>
    <published>2021-04-30T01:28:43.797Z</published>
    <updated>2021-04-30T01:28:43.797Z</updated>
    
    <content type="html"><![CDATA[<p>我在公司使用 Linux 作用主力机已经 10 多年了，自从抛弃 Ubuntu 转入 Fedora 怀抱，生活幸福了不少。<br>早年最大的问题是 OFFICE 软件，工作中少不了要和 doc、ppx，xls 打交道，又没有太好的软件可以使用。<br>刚开始基本就两个解决方案，wine office 和永中 OFFICE，这两个方案都不是太理想，wine 的速度很慢，<br>永中则兼容性比较差，还会出现文档格式看起来就有明显差异的情况。。</p><p>随着金山 wps 的发展，现在 OFFICE 的问题基本解决，作为轻度 EXCEL 使用者基本已经满足需求了。Linux<br>现在主要问题是字体渲染比较差，中文经常看起来发虚，如果能把这个问题彻底解决就非常不错了。作为Linux<br>老用户，各种魔改后，也能较好使用了，但后面发现还是换个显示器更管用。要解决中文显示问题，有两个<br>字体很管用，文泉驿微米黒和微软雅黑，实践证明把系统字体用上面两个字体替换，显示效果也就好了不少了。</p><p>Ubuntu Linux 最大的问题就是不太稳定，基本每次大版本升级显示都要挂，弄得我都有点心理阴影了，原来<br>周围还挺多同学使用 Linux，最终放弃了，一个直接用 Windows 了，还有一个 Windows 上跑一个 Linux 虚拟机。<br>Ubuntu 还有个坏习惯喜欢乱改，upstart，Unity等，后面都没有成为主流，bug 就更不用说了，经常挺闹心的。</p><p>Fedora 从近些年的使用情况来看，还是很不错的，网络中流传是 Redhat Linux Enterprise 的小白版本，<br>但是其实只要 bug 修得快，你大概率是感觉不到的。遇上问题，放狗一搜就会发现 redhat 已经有 bug 在<br>处理中了，于是乎就有了今天这篇。</p><p>在升级到 Fedara 33 和 ThunderBird 78 后，使用 TLS 连接公司的 ExChange 邮件服务器就连不上了。<br>我们公司的内网安全审核非常严格，邮件不使用加密连接要限时整改。放狗一搜发现，大批人员都遇上了<br>相同的问题，也有人给出了解决方案。</p><p><a href="https://support.mozilla.org/en-US/questions/1295861">https://support.mozilla.org/en-US/questions/1295861</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I think this could be due to the minimum version of TLS supported by TB 78. The release notes state </span><br><span class="line">that versions lower than 1.2 are disabled, so if your server only supports v. 1.1, </span><br><span class="line">you might be able to fix sending by changing the preference security.tls.version.min to 2 from the default 3, in Config. editor.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://www.thunderbird.net/en-US/thunderbird/78.0/releasenotes/">https://www.thunderbird.net/en-US/thunderbird/78.0/releasenotes/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS 1.0 and 1.1 disabled</span><br></pre></td></tr></table></figure><p>如何开启 TLS 1.0， mozilla 也给出了相应的方案</p><p><a href="https://support.mozilla.org/en-US/kb/thunderbird-78-faq#w_how-to-enable-outdated-security-protocols-tls-1-0-and-1-1">https://support.mozilla.org/en-US/kb/thunderbird-78-faq#w_how-to-enable-outdated-security-protocols-tls-1-0-and-1-1</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">How to enable outdated security protocols TLS 1.0 and 1.1</span><br><span class="line"></span><br><span class="line">Open Config Editor (about:config)</span><br><span class="line">≡ &gt; Preferences &gt; Find in Preferences</span><br><span class="line">In the searchbox, type: about:config, then press Enter.</span><br><span class="line">Click on the button Config Editor… in the search result.</span><br><span class="line">In the about:config dialog, search for: security.tls.version.min</span><br><span class="line">Double-click on the found preference security.tls.version.min and change its value to 1, then press Enter.</span><br><span class="line">Restart Thunderbird and try to download your messages.</span><br><span class="line">If you can receive and/or send your messages after changing this preference:</span><br><span class="line"></span><br><span class="line">Please inform your email provider to upgrade the security protocols on the server to support TLS 1.2.</span><br><span class="line">Revert the preference security.tls.version.min to its original value as soon as possible by repeating </span><br><span class="line">the above procedure, then right-click on the preference and choose Reset from the context menu.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看上去解决方案很简单，在 Preferences 中的搜索框里输入 <code>about:config</code> 点击进入，将其中的<br><code>security.tls.version.min</code> 设置为 1 就好了，但是在 Fedora 34 中不起作用。我用 wireshark 抓了包看，<br>ThunderBird 自己报告不支持的协议版本。我仔细研究了一下 ThunderBird 相关的 config 项有下面几个：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security.tls.version.min</span><br><span class="line">security.tls.version.enable-deprecated</span><br><span class="line">security.tls.version.fallback-limit</span><br></pre></td></tr></table></figure><p>我把这几个选项都设置了一下，分别设置为 1 true 1，还是不管用。</p><p>在 Fedora 33 上这个问题就没解决，这都 Fedora 34 了，所以又花了时间研究了一下。没好办法，放狗，运气<br>不错，看到了这篇</p><p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1674092#c11">https://bugzilla.mozilla.org/show_bug.cgi?id=1674092#c11</a></p><p>原来 Fedora 还有个 <code>StrongCryptoSettings</code> ，看文档可以修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">update-crypto-policies --set DEFAULT:FEDORA32</span><br><span class="line">update-crypto-policies --set LEGACY</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p>关键的内容就是下面这几行</p><p>cat /etc/crypto-policies/state/CURRENT.pol</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min_tls_version = TLS1.2</span><br><span class="line">protocol = TLS1.3 TLS1.2 DTLS1.2</span><br></pre></td></tr></table></figure><p>执行后变为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min_tls_version = TLS1.0</span><br><span class="line">protocol = TLS1.3 TLS1.2 TLS1.1 TLS1.0 DTLS1.2 DTLS1.0</span><br></pre></td></tr></table></figure><p>重启系统后，又可以开心地使用 ThunderBird 了 ^_^</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我在公司使用 Linux 作用主力机已经 10 多年了，自从抛弃 Ubuntu 转入 Fedora 怀抱，生活幸福了不少。&lt;br&gt;早年最大的问题是 OFFICE 软件，工作中少不了要和 doc、ppx，xls 打交道，又没有太好的软件可以使用。&lt;br&gt;刚开始基本就两个解决方
      
    
    </summary>
    
    
    
      <category term="linux" scheme="http://usmacd.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>在 Android 手机上的使用 stunnel  （不需要 root ）</title>
    <link href="http://usmacd.com/2021/02/04/android_stunnel/"/>
    <id>http://usmacd.com/2021/02/04/android_stunnel/</id>
    <published>2021-02-04T05:47:39.806Z</published>
    <updated>2021-02-04T05:47:39.806Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Android-stunnel"><a href="#Android-stunnel" class="headerlink" title="Android stunnel"></a>Android stunnel</h2><p><a href="https://github.com/comp500/SSLSocks.git">https://github.com/comp500/SSLSocks.git</a>  这个项目可以使用 android 版本的 stunnel, 其实就是调用 <a href="https://www.stunnel.org/downloads/stunnel-5.57-android.zip">https://www.stunnel.org/downloads/stunnel-5.57-android.zip</a></p><p>具体配置和使用命令行差距不大，参考：<br><a href="https://github.com/comp500/SSLSocks/blob/master/README.md">https://github.com/comp500/SSLSocks/blob/master/README.md</a></p><h2 id="设置全局代理"><a href="#设置全局代理" class="headerlink" title="设置全局代理"></a>设置全局代理</h2><ol><li>在 wifi 连接的情况</li></ol><p>打开wifi 列表 -&gt; 长按连接的 wifi  -&gt; 点击修改 -&gt; 高级选项 -&gt; 填写代理相关信息</p><ol start="2"><li>使用 adb shell 执行命令</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings put global http_proxy 192.168.xx.xxx:8888</span><br></pre></td></tr></table></figure><ol start="3"><li>Proxy Toggle</li></ol><p><a href="https://github.com/theappbusiness/android-proxy-toggle.git">https://github.com/theappbusiness/android-proxy-toggle.git</a></p><p>要正常使用 app 需要用 adb shell 连接上设置相应的权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm grant com.kinandcarta.create.proxytoggle android.permission.WRITE_SECURE_SETTINGS</span><br></pre></td></tr></table></figure><h2 id="恢复无代理"><a href="#恢复无代理" class="headerlink" title="恢复无代理"></a>恢复无代理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings delete global http_proxy</span><br><span class="line">adb shell settings delete global global_http_proxy_host</span><br><span class="line">adb shell settings delete global global_http_proxy_port</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Android-stunnel&quot;&gt;&lt;a href=&quot;#Android-stunnel&quot; class=&quot;headerlink&quot; title=&quot;Android stunnel&quot;&gt;&lt;/a&gt;Android stunnel&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://g
      
    
    </summary>
    
    
    
      <category term="Android" scheme="http://usmacd.com/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>How to request a RESERVED CVE</title>
    <link href="http://usmacd.com/2021/01/20/request_RESERVED_CVE/"/>
    <id>http://usmacd.com/2021/01/20/request_RESERVED_CVE/</id>
    <published>2021-01-20T06:00:18.905Z</published>
    <updated>2021-01-20T06:00:18.905Z</updated>
    
    <content type="html"><![CDATA[<p>在申请 CVE 过程中会遇到一个问题，向软件官方提交漏洞修复后，由于软件官方不是CNA 无法直接分配CVE，而申请CVE 通常需要一个软件官方确认的链接，而有些比较正规的软件在漏洞修复之前是不会有公开链接的，这就无法申请CVE了。</p><p>有点鸡生蛋，蛋生鸡的感觉。解决这个问题的办法是申请一个 RESERVED CVE。</p><h2 id="申请-RESERVED-CVE-方法"><a href="#申请-RESERVED-CVE-方法" class="headerlink" title="申请 RESERVED CVE 方法"></a>申请 RESERVED CVE 方法</h2><p>申请 RESERVED CVE，也是需要填写的CVE 申请表格的 <a href="https://cveform.mitre.org/，选择">https://cveform.mitre.org/，选择</a> Request CVE ID</p><p>根据提示的重要信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IMPORTANT: Once a CVE ID is assigned to your vulnerability, it will not be published </span><br><span class="line">in the CVE List until you have submitted a URL pointing to public information about </span><br><span class="line">the vulnerability. Without a public reference, the CVE ID will display as &quot;RESERVED&quot; </span><br><span class="line">in the CVE List. Please update CVE with a reference to the vulnerability&#x27;s </span><br><span class="line">details as soon as possible. See this FAQ for more information.</span><br></pre></td></tr></table></figure><p>只要将 public reference 留空，就可以申请 RESERVED CVE 了。CVE 官方收到请求后会有确认的邮件。</p><h2 id="CVE-官方分配-CVE-ID"><a href="#CVE-官方分配-CVE-ID" class="headerlink" title="CVE 官方分配 CVE ID"></a>CVE 官方分配 CVE ID</h2><p>CVE 官方收到 RESERVED CVE 请求后，会给分配一个 CVE ID，但是状态为 ** RESERVED ** ，不会有公开细节。</p><h2 id="RESERVED-CVE-申请公开"><a href="#RESERVED-CVE-申请公开" class="headerlink" title="RESERVED CVE 申请公开"></a>RESERVED CVE 申请公开</h2><p>当软件官方确认已经修复漏洞，并且发布新版后，可以通知 CVE 官方更新 CVE 的状态。还是通过填写 <a href="https://cveform.mitre.org/">https://cveform.mitre.org/</a> 表格，选择 Notify CVE about a publication，填写相关信息。</p><h2 id="一些注意事项"><a href="#一些注意事项" class="headerlink" title="一些注意事项"></a>一些注意事项</h2><ol><li>将 <a href="mailto:cve-request@mitre.org">cve-request@mitre.org</a> 和  <a href="mailto:cve@mitre.org">cve@mitre.org</a> 加入邮件白名单 （有可能邮件会被截拦）</li><li>在申请公开步骤中，CVE 官方有可能和你要公开披露的链接，如果软件官方不给写，可以自己写一个</li></ol><p>披露要求的信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[CVE ID]</span><br><span class="line">[PRODUCT]</span><br><span class="line">[VERSION]</span><br><span class="line">[PROBLEM TYPE]</span><br><span class="line">[DESCRIPTION]</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在申请 CVE 过程中会遇到一个问题，向软件官方提交漏洞修复后，由于软件官方不是CNA 无法直接分配CVE，而申请CVE 通常需要一个软件官方确认的链接，而有些比较正规的软件在漏洞修复之前是不会有公开链接的，这就无法申请CVE了。&lt;/p&gt;
&lt;p&gt;有点鸡生蛋，蛋生鸡的感觉。解
      
    
    </summary>
    
    
    
      <category term="Security" scheme="http://usmacd.com/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>onefuzz 简单分析</title>
    <link href="http://usmacd.com/2020/09/28/onefuzz/"/>
    <id>http://usmacd.com/2020/09/28/onefuzz/</id>
    <published>2020-09-28T10:03:13.947Z</published>
    <updated>2020-09-28T10:03:13.947Z</updated>
    
    <content type="html"><![CDATA[<h2 id="deploy-agent-部署"><a href="#deploy-agent-部署" class="headerlink" title="deploy agent (部署)"></a>deploy agent (部署)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip onefuzz-deployment-<span class="variable">$VERSION</span>.zip</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">./deploy.py <span class="variable">$REGION</span> <span class="variable">$RESOURCE_GROUP_NAME</span> <span class="variable">$ONEFUZZ_INSTANCE_NAME</span> <span class="variable">$CONTACT_EMAIL_ADDRESS</span></span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest">Azure CLI logged in</a> 后，执行上面命令可以在 Azure 上部署 agent</p><p>需要订阅 Azure， 可能要收费</p><h2 id="安装-onefuzz-CLI"><a href="#安装-onefuzz-CLI" class="headerlink" title="安装 onefuzz CLI"></a>安装 onefuzz CLI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/microsoft/onefuzz/releases/download/1.0.0/onefuzz-1.0.0-py3-none-any.whl</span><br><span class="line">wget https://github.com/microsoft/onefuzz/releases/download/1.0.0/onefuzztypes-1.0.0-py3-none-any.whl</span><br><span class="line">pip install ./onefuzz*.whl</span><br></pre></td></tr></table></figure><h2 id="执行-fuzz-任务"><a href="#执行-fuzz-任务" class="headerlink" title="执行 fuzz 任务"></a>执行 fuzz 任务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onefuzz template libfuzzer basic my-project my-target build-1 my-pool --target_exe fuzz.exe</span><br></pre></td></tr></table></figure><h2 id="支持的平台"><a href="#支持的平台" class="headerlink" title="支持的平台"></a>支持的平台</h2><ol><li>Python 的 CLI 客户端，需要 Python 3.7 +</li><li>Azure 的 OS image 支持 Windows 10 和 Ubuntu Server 18.04</li><li>libfuzzer 支持 llvm 8+ (windows, Linux x86/x64), MSVC 16.8+ (支持 ASAN)</li></ol><h2 id="支持的-Fuzz-工具"><a href="#支持的-Fuzz-工具" class="headerlink" title="支持的 Fuzz 工具"></a>支持的 Fuzz 工具</h2><p>onefuzz 中集成了几个 fuzz 工具： afl afl++ libfuzzer 和 radasma</p><h2 id="OneFuzz-的主要工作"><a href="#OneFuzz-的主要工作" class="headerlink" title="OneFuzz 的主要工作"></a>OneFuzz 的主要工作</h2><p>主要工作是利用微软的 Azure 云平台进行 fuzz，实现了 Python 版本的接口，可以远程直接操作 Azure 的资源进行 fuzz</p><p>api 接口： <a href="https://github.com/microsoft/onefuzz/tree/main/src/api-service/__app__">api-service</a><br>agent： <a href="https://github.com/microsoft/onefuzz/tree/main/src/agent">agent</a></p><h2 id="项目进展情况"><a href="#项目进展情况" class="headerlink" title="项目进展情况"></a>项目进展情况</h2><p>onefuzz 项目主要是一个 fuzz 框架，项目成熟度不高和 Google 的 ClusterFuzz 相比有较大差距。Fuzz 过程也是简单调用fuzz 工具，没有处理特殊情况。文档完备程度也不高，比较感兴趣的 MSVC 和 libfuzzer、ASAN 的集成也没有看到具体代码。另外和微软的 Azrue 深度绑定，用起来也不是太方便，后续将继续关注此项目的进展情况。</p><h2 id="一些有用的链接"><a href="#一些有用的链接" class="headerlink" title="一些有用的链接"></a>一些有用的链接</h2><p><a href="https://github.com/microsoft/onefuzz/blob/main/docs/getting-started.md">https://github.com/microsoft/onefuzz/blob/main/docs/getting-started.md</a><br><a href="https://github.com/microsoft/onefuzz/blob/main/docs/supported-platforms.md">https://github.com/microsoft/onefuzz/blob/main/docs/supported-platforms.md</a></p><h2 id="在线演示"><a href="#在线演示" class="headerlink" title="在线演示"></a>在线演示</h2><p><img src="https://raw.githubusercontent.com/microsoft/onefuzz/main/docs/screencasts/launching-job.gif" alt="launching-job"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;deploy-agent-部署&quot;&gt;&lt;a href=&quot;#deploy-agent-部署&quot; class=&quot;headerlink&quot; title=&quot;deploy agent (部署)&quot;&gt;&lt;/a&gt;deploy agent (部署)&lt;/h2&gt;&lt;figure class=&quot;hi
      
    
    </summary>
    
    
    
      <category term="Security" scheme="http://usmacd.com/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>halfempty 的一些使用说明</title>
    <link href="http://usmacd.com/2020/05/21/halfempty/"/>
    <id>http://usmacd.com/2020/05/21/halfempty/</id>
    <published>2020-05-21T02:00:34.284Z</published>
    <updated>2020-05-21T02:00:34.284Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/googleprojectzero/halfempty">https://github.com/googleprojectzero/halfempty</a></p><p>google P0 <a href="https://twitter.com/taviso">@taviso</a> 提供的 testcase 并行快速精简工具 （A fast, parallel test case minimization tool）<br>需要注意的是 halfempty 只能精简导致目标程序 crash 的 testcase，如果 testcase 不导致目标程序 crash， 还是需要使用 afl-tmin 类似的工具根据 coverage 来精简。</p><p>halfempty 工具向测试脚本传递内容时使用的是 pipe， 如果测试的程序只接受文件路径作为参数时，需要一些技巧，README 虽然有提及但是说的比较晦涩。</p><p>以 upx 为例，upx 的命令行帮助如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@fuzzing-5:/mnt/disk/halfempty# ./upx.out_x86-64</span><br><span class="line">                       Ultimate Packer for eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2020</span><br><span class="line">UPX git-d7ba31+ Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020</span><br><span class="line"></span><br><span class="line">Usage: upx.out_x86-64 [-123456789dlthVL] [-qvfk] [-o file] file..</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  -1     compress faster                   -9    compress better</span><br><span class="line">  -d     decompress                        -l    list compressed file</span><br><span class="line">  -t     test compressed file              -V    display version number</span><br><span class="line">  -h     give more help                    -L    display software license</span><br><span class="line">Options:</span><br><span class="line">  -q     be quiet                          -v    be verbose</span><br><span class="line">  -oFILE write output to &#x27;FILE&#x27;</span><br><span class="line">  -f     force compression of suspicious files</span><br><span class="line">  -k     keep backup files</span><br><span class="line">file..   executables to (de)compress</span><br><span class="line"></span><br><span class="line">Type &#x27;upx.out_x86-64 --help&#x27; for more detailed help.</span><br><span class="line"></span><br><span class="line">UPX comes with ABSOLUTELY NO WARRANTY; for details visit https://upx.github.io</span><br></pre></td></tr></table></figure><p>upx 只能使用文件路径作为参数， 比如像这样执行命令。 <code>./upx.out_x86-64 crash.upx</code></p><p>按照 README 中的例子编写测试脚本 test.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">./upx.out_x86-64 <span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> $? -eq 139; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>执行的时候会报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">./halfempty ./test.sh  crash.upx</span><br><span class="line">╭│   │ ── halfempty ───────────────────────────────────────────────── v0.30 ──</span><br><span class="line">╰│ 16│ A fast, parallel testcase minimization tool</span><br><span class="line"> ╰───╯ ───────────────────────────────────────────────────────── by @taviso ──</span><br><span class="line"></span><br><span class="line">Input file &quot;crash.upx&quot; is now 19088 bytes, starting strategy &quot;bisect&quot;...</span><br><span class="line">Verifying the original input executes successfully... (skip with --noverify)</span><br><span class="line">** Message: This program expected `./test1.sh` to return successfully</span><br><span class="line">** Message: for the original input (i.e. exitcode zero).</span><br><span class="line">** Message: Try it yourself to verify it&#x27;s working.</span><br><span class="line">** Message: Use a command like: `cat crash.upx | ./test.sh || echo failed`</span><br><span class="line"></span><br><span class="line">** (halfempty:2477): WARNING **: Strategy &quot;bisect&quot; failed, cannot continue.</span><br></pre></td></tr></table></figure><p>正确的方法是使用临时文件，因为 halfempty 是一个并行的工具，每次使用的临时文件都应该不一样。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">tempfile=`mktemp` &amp;&amp; cat &gt; <span class="variable">$&#123;tempfile&#125;</span></span><br><span class="line"></span><br><span class="line">./upx.out_x86-64 <span class="variable">$&#123;tempfile&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> $? -eq 139; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>运行后的输出，大致如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@fuzzing-5:/mnt/disk/halfempty# ./halfempty  ./test.sh  crash.upx </span><br><span class="line">╭│   │ ── halfempty ───────────────────────────────────────────────── v0.30 ──</span><br><span class="line">╰│ 16│ A fast, parallel testcase minimization tool</span><br><span class="line"> ╰───╯ ───────────────────────────────────────────────────────── by @taviso ──</span><br><span class="line"></span><br><span class="line">Input file &quot;crash.upx&quot; is now 19088 bytes, starting strategy &quot;bisect&quot;...</span><br><span class="line">Verifying the original input executes successfully... (skip with --noverify)</span><br><span class="line">The original input file succeeded after 0.0 seconds.</span><br><span class="line">New finalized size: 19088 (depth=2) real=0.0s, user=0.0s, speedup=~-0.0s</span><br><span class="line">treesize=6654, height=6376, unproc=0, real=4.4^C user=19.3s, speedup=~14.9s</span><br></pre></td></tr></table></figure><p>已经可以正常运行了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://github.com/googleprojectzero/halfempty&quot;&gt;https://github.com/googleprojectzero/halfempty&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;google P0 &lt;a href=&quot;htt
      
    
    </summary>
    
    
    
      <category term="Security" scheme="http://usmacd.com/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>lpr 和房贷的那些事</title>
    <link href="http://usmacd.com/2020/03/31/lpr/"/>
    <id>http://usmacd.com/2020/03/31/lpr/</id>
    <published>2020-03-31T01:40:10.307Z</published>
    <updated>2020-03-31T01:40:10.307Z</updated>
    
    <content type="html"><![CDATA[<h2 id="原来的机制"><a href="#原来的机制" class="headerlink" title="原来的机制"></a>原来的机制</h2><p>在 LPR 之前，我国贷款利率锚定 中国人民银行发布的 “贷款基准利率”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">房贷利率 = 贷款基准利率 x （1 + 浮动）</span><br></pre></td></tr></table></figure><p>浮动可以上浮，也可以下浮， 上浮意味着贷款利率大于贷款基准利率，反之下浮则是小于。</p><h2 id="LPR-新机制"><a href="#LPR-新机制" class="headerlink" title="LPR 新机制"></a>LPR 新机制</h2><p>MLF 是我国央行向商业银行放贷的一种方式 （中期借款便利），商业银行将一些抵押物质押给央行，换取一定期限，数额的贷款，同时向央行支付利息。央行通过控制 MLF 的数量总额和利率，从而影响市场。</p><p>商业银行可以选择从央行贷款，也可以使用从其他银行贷款，所以 MLF 不能偏离市场太多，也是一种市场化的利率调控手段。</p><p>商业银行拿到资金后，需要放贷给个人和企业，放贷需要参考央行的基准利率。所以这种市场上就有两种利率，如果贷款的基准利率过高，钱就会滞留银行，这样就引入了 LPR。</p><p>锚定 LPR，也就是浮动利率，会随着市场上资金的充盈程度变化。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LPR = MLF 利率 + 风险利润加点</span><br></pre></td></tr></table></figure><p>风险利润加点由 18家银行决定，这18家银行是 中国工商银行，中国农业银行，中国建设银行，交通银行，中信银行，招商银行，兴业银行，浦东发展银行，中国民生银行，西安银行，台州银行，上海农村商业银行， 广东顺德农村商业银行，渣打银行（中国），花旗银行（中国），微众银行，网商银行。</p><p>LPR 利率有18家报价，去掉一个最高值，去掉一个最低值，剩下16家取算术平均取得。</p><p>个人或者企业向银行贷款时的利率，通过 LPR 计算。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">房贷利率 = LPR 利率 + 加点</span><br></pre></td></tr></table></figure><p>同样加点可以上浮，也可以下浮，这个是你和银行之间的协议加点。最终的利率还和政策加点有关，比如有的城市规定，二套房上浮 60个基点 （一个基点为 0.01 %），即上浮 0.6%</p><p>所以最终的公式为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">房贷利率 = LPR 利率 + 政策加点 + 协议加点</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;原来的机制&quot;&gt;&lt;a href=&quot;#原来的机制&quot; class=&quot;headerlink&quot; title=&quot;原来的机制&quot;&gt;&lt;/a&gt;原来的机制&lt;/h2&gt;&lt;p&gt;在 LPR 之前，我国贷款利率锚定 中国人民银行发布的 “贷款基准利率”。&lt;/p&gt;
&lt;figure class=&quot;h
      
    
    </summary>
    
    
    
      <category term="Life" scheme="http://usmacd.com/tags/Life/"/>
    
  </entry>
  
  <entry>
    <title>解决 Windows Rx034</title>
    <link href="http://usmacd.com/2020/03/25/Windows_Rx034/"/>
    <id>http://usmacd.com/2020/03/25/Windows_Rx034/</id>
    <published>2020-03-25T03:20:21.402Z</published>
    <updated>2020-03-25T03:20:21.402Z</updated>
    
    <content type="html"><![CDATA[<p>以前没有遇上这个错误，这次遇上这个错误是装vim的YouCompleteMe插件后出现，因此很容易想到是装插件引起的这个错误，错误提示Runtime Error 如下图：</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/r5051.png" alt="error"></p><p>先放狗搜一下，微软的对R6034的解释如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">An application has made an attempt to load the C runtime library without using</span><br><span class="line">a manifest. This is an unsupported way to load Visual C++ DLLs. You need to</span><br><span class="line">modify your application to build with a manifest. For more information, see the</span><br><span class="line">&quot;Visual C++ Libraries as Shared Side-by-Side Assemblies&quot; topic in the product</span><br><span class="line">documentation.</span><br></pre></td></tr></table></figure><p>微软的链接中也提到了解决的方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rebuild your application to include a manifest. Building an application with</span><br><span class="line">Visual Studio automatically puts the manifest into the resulting .exe or .dll</span><br><span class="line">file. If you are building at the command line, use the mt.exe tool to add the</span><br><span class="line">manifest as a resource. Use resource ID 1 if you build an .exe, and resource</span><br><span class="line">ID 2 if you build a .dll. For more information, see How to: Embed a Manifest</span><br><span class="line">Inside a C/C++ Application.</span><br></pre></td></tr></table></figure><p>大概的意思是需要使用manifest.xml来指定需要加载的DLL。上网又翻看了几个链接发现这个错误的成因比较复杂，主要原因是加载mscvr*.dll 出现了问题。不管怎样还是先看看是否使用了 manifest。从微软的解决办法可以知道，manifest很有可能在资源文件里。</p><p>还是先看看manifest的作用，在msdn网站搜索相关内容，根据《Understanding Manifest Generation for C/C++ Programs》中的内容，manfest.xml可以是一个外部的XML文件也可以是嵌入在程序的资源文件中。manifest.xml用于管理程序在运行时需要的共享程序集的名字和版本。如果程序只依赖 VisualC++ 的程序集（CRT，MFC，ATL等），manifest会被链接器自动生成。Manifest的Sxs指定了其依赖的清单名称,版本,资源,和其他组件。Sxs是Windows XP引入的新技术，vs 2005 开始使用，全名叫Side by Side assembly，主要还是为了解决兼容性问题，这样同一个系统可以存在不同版本的同名文件而互相不影响各自的运行。</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/sxs.png" alt="sxs"></p><p>现在需要定位gvim.exe加载哪个DLL引起了R6034错误，使用Process Explorer发现是加载ycm_client_support.pyd导致。删除YouCompleteMe插件后错误消失。</p><p>先看看ycm_client_support.pyd是否使用了manifest.xml, 使用神器TC,  F3一下，可以查看manifest的情况。</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/manifest.png" alt="manifest.xml"></p><p>发现其实ycm_client_support.pyd已经使用了manifest，但是仍然出现R6034错误。上网搜索了一番（见文末的参考链接），发现这就是非常著名的DLL Hell了，维基百科中专门记录了这个问题。 <a href="http://en.wikipedia.org/wiki/Dll_hell">http://en.wikipedia.org/wiki/Dll_hell</a></p><p>不论如何应该就是DLL加载时出错了，可以使用Process Explorer 工具来查看出问题的进程，看看在进程空间内具体是什么情况。</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/process-explorer.png" alt="p-e"></p><p>哈哈，发现了一些情况，msvcr90.dll在gvim进程空间里有两个！再看看这两个DLL的位置。</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/process-explorer1.png" alt="p-e1"></p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/process-explorer2.png" alt="p-e2"></p><p>删除掉不在C:\WINDOWS\WinSxS\目录里的msvcr90.dll，问题得以解决。由于这个错误是因为加载ycm_client_support.pyd引起的，再看看ycm_client_support.pyd的情况，拿出TC直接F3一下，又发现了一些有用的信息。ycm_client_support.pyd加载的是cmake目录下的msvcr90.dll, 正常情况下因该使用 C:\Windows\winsxs 目录下的msvcr90.dll</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/tc1.png" alt="tc1"></p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/tc2.png" alt="tc2"></p><p>查看一下系统环境变量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">D:\Program Files\Microsoft Visual Studio 9.0\VC&gt; set | findstr Path</span><br><span class="line"></span><br><span class="line">Path=D:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE;D:\Program Files\M</span><br><span class="line">icrosoft Visual Studio 9.0\VC\BIN;D:\Program Files\Microsoft Visual Studio 9.0\C</span><br><span class="line">ommon7\Tools;c:\Windows\Microsoft.NET\Framework\v3.5;c:\Windows\Microsoft.NET\Fr</span><br><span class="line">amework\v2.0.50727;D:\Program Files\Microsoft Visual Studio 9.0\VC\VCPackages;C:</span><br><span class="line">\Program Files\\Microsoft SDKs\Windows\v6.0A\bin;C:\Windows\system32;C:\Windows;</span><br><span class="line">d:\Program Files\CMake 2.8\bin;d:\Program Files\LLVM 3.4.svn\bin;d:\Program File</span><br><span class="line">s\Git\cmd;d:\Python27;D:\Program Files\IDM Computer Solutions\UltraEdit\</span><br><span class="line">PSModulePath=C:\Windows\system32\WindowsPowerShell\v1.0\Modules\</span><br></pre></td></tr></table></figure><p>引错误的原因是Windows程序加载DLL是会先加载PATH变量中的DLL文件，后面会加载manifest指定的WinSxS目录的文件，这样就加载了两次，引起了错误。</p><p>这个问题涉及 Windows加载DLL文件的顺序，Windows定位 DLL文件的顺序和一个注册表键值相关，这个键值是：</p><p><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode</code></p><p>SafeDllSearchMode的值为1，开启SafeDllSearchMode，<br>SafeDllSearchMode的值为0，禁用SafeDllSearchMode。</p><p>Windows系统默认开启SafeDllSearchMode （Windows XP SP2 后），MSDN文章《Dynamic-Link Library Search Order》中指出，在SafeDllSearchMode开启的情况下，Windows定位DLL文件的顺序为：</p><ol><li>The directory from which the application loaded.</li><li>The system directory. ( GetSystemDirectory )</li><li>The 16-bit system directory.</li><li>The Windows directory. (GetWindowsDirectory )</li><li>The current directory.</li><li>The directories that are listed in the PATH environment variable.</li></ol><p>在SafeDllSearchMode关闭的情况下，Windows定位DLL文件的顺序为：</p><ol><li>The directory from which the application loaded.</li><li>The current directory.</li><li>The system directory. (GetSystemDirectory )</li><li>The 16-bit system directory.</li><li>The Windows directory. ( GetWindowsDirectory)</li><li>The directories that are listed in the PATH environment variable.</li></ol><p>另外，《Dynamic-Link Library Search Order》中指出使用manifest可以指定加载DLL的路径，但实际的情况是有可能加载多个DLL导致进程崩溃。</p><p>Desktop applications can control the location from which a DLL is loaded by specifying a full path, using DLL redirection, or by using a manifest. If none of these methods are used, the system searches for the DLL at load time as described in this section.</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1]《Windows via C/C++ Fifth Edition》<br>[2] Side-by-side Assemblies <a href="http://msdn.microsoft.com/en-us/library/aa376307.aspx">http://msdn.microsoft.com/en-us/library/aa376307.aspx</a><br>[3] DLL Hell <a href="http://en.wikipedia.org/wiki/Dll_hell">http://en.wikipedia.org/wiki/Dll_hell</a><br>[4] C Run-Time Error R6034 <a href="http://msdn.microsoft.com/en-us/library/ms235560(v=vs.90).aspx">http://msdn.microsoft.com/en-us/library/ms235560(v=vs.90).aspx</a><br>[5] Understanding Manifest Generation for C/C++ Programs <a href="http://msdn.microsoft.com/en-us/library/ms235542.aspx">http://msdn.microsoft.com/en-us/library/ms235542.aspx</a><br>[6] Search Path Used by Windows to Locate a DLL <a href="http://msdn.microsoft.com/en-us/library/7d83bc18.aspx">http://msdn.microsoft.com/en-us/library/7d83bc18.aspx</a><br>[7] Dynamic-Link Library Search Order <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v=vs.85).aspx</a><br>[8] <a href="https://bitbucket.org/Haroogan/vim-youcompleteme-for-windows/src/7dca764c2ee0?at=master">https://bitbucket.org/Haroogan/vim-youcompleteme-for-windows/src/7dca764c2ee0?at=master</a><br>[9] <a href="https://github.com/Valloric/YouCompleteMe/wiki/Windows-Installation-Guide">https://github.com/Valloric/YouCompleteMe/wiki/Windows-Installation-Guide</a><br>[10] <a href="http://www.davidlenihan.com/2007/07/winsxs.html">http://www.davidlenihan.com/2007/07/winsxs.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;以前没有遇上这个错误，这次遇上这个错误是装vim的YouCompleteMe插件后出现，因此很容易想到是装插件引起的这个错误，错误提示Runtime Error 如下图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/
      
    
    </summary>
    
    
    
      <category term="windows" scheme="http://usmacd.com/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Markdown 笔记软件： VNote</title>
    <link href="http://usmacd.com/2020/03/25/vnote/"/>
    <id>http://usmacd.com/2020/03/25/vnote/</id>
    <published>2020-03-25T02:27:01.295Z</published>
    <updated>2020-03-25T02:27:01.295Z</updated>
    
    <content type="html"><![CDATA[<p>向大家安利一款 markdown 笔记软件， VNote  <a href="http://t.cn/RXj6L39">http://t.cn/RXj6L39</a><br>此软件目前已经 1300 多个commits 了，做为一个有些开源软件维护经历的人，深感不易。<br>用了太多 markdown 笔记软件，此软件使得最为顺手，尤其作为程序员 vim 模式 让我感到非常舒服，<br>大量图表的支持比如 UML 流程图，让我用起来很顺手。</p><p><img src="https://raw.githubusercontent.com/henices/pictures/master/vnote.png" alt="VNote"></p><p>我前后尝试过各种笔记软件，我理想的软件有几点：</p><ul><li>a. 支持文件管理</li><li>b. 不要乱改数据，容易迁移</li><li>c. 支持 markdown</li><li>d. 跨平台，支持 Mac 和 Linux</li></ul><p>最后，终于发现了 VNote，有点惊喜。在 Linux 下编译 VNote 显示有明显改进，下面是编译的方法：</p><ol><li>下载 QT SDK</li></ol><p><a href="https://mirrors4.tuna.tsinghua.edu.cn/qt/official_releases/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run">https://mirrors4.tuna.tsinghua.edu.cn/qt/official_releases/qt/5.9/5.9.0/qt-opensource-linux-x64-5.9.0.run</a></p><p>将 Qt5.9 安装到 /home/henices/Qt5.9.0/</p><ol start="2"><li>编译 fcitx-qt5</li></ol><p>git clone <a href="https://gitlab.com/fcitx/fcitx-qt5.git">https://gitlab.com/fcitx/fcitx-qt5.git</a></p><p>准备编译脚本 <code>build_linux.sh</code>， 指定下载的QT</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QTDIR=<span class="string">&quot;/home/henices/Qt5.9.0/5.9/gcc_64/&quot;</span></span><br><span class="line">PATH=<span class="string">&quot;<span class="variable">$QTDIR</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">LDFLAGS=-L<span class="variable">$QTDIR</span>/lib</span><br><span class="line">CPPFLAGS=-I<span class="variable">$QTDIR</span>/include</span><br><span class="line"></span><br><span class="line">rm -rf build</span><br><span class="line">mkdir -p build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure><p>使用下面命令编译</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x ./build_linux.sh</span><br><span class="line">./build_linux.sh</span><br></pre></td></tr></table></figure><p>将生成的 libfcitxplatforminputcontextplugin.so copy 到<br><code>/home/henices/Qt5.9.0/5.9/gcc_64/plugins/platforminputcontexts/</code></p><ol start="3"><li>获取VNote 源码</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/tamlok/vnote.git vnote.git</span><br><span class="line"><span class="built_in">cd</span> vnote.git</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><ol start="4"><li>编译</li></ol><p>build_linux.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">QTDIR=<span class="string">&quot;/home/henices/Qt5.9.0/5.9/gcc_64/&quot;</span></span><br><span class="line">PATH=<span class="string">&quot;<span class="variable">$QTDIR</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">LDFLAGS=-L<span class="variable">$QTDIR</span>/lib</span><br><span class="line">CPPFLAGS=-I<span class="variable">$QTDIR</span>/include</span><br><span class="line"></span><br><span class="line">rm -rf build</span><br><span class="line">mkdir -p build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">qmake -v</span><br><span class="line">qmake PREFIX=/usr/<span class="built_in">local</span> CONFIG-=debug CONFIG+=release ../VNote.pro</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure><p>使用下面命令编译</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x ./build_linux.sh</span><br><span class="line">./build_linux.sh</span><br></pre></td></tr></table></figure><ol start="5"><li>安装</li></ol><p><code>sudo make install</code></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://tamlok.gitee.io/vnote/zh_cn/#!docs/%E5%BC%80%E5%8F%91%E8%80%85/%E6%9E%84%E5%BB%BAVNote.md">https://tamlok.gitee.io/vnote/zh_cn/#!docs/%E5%BC%80%E5%8F%91%E8%80%85/%E6%9E%84%E5%BB%BAVNote.md</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;向大家安利一款 markdown 笔记软件， VNote  &lt;a href=&quot;http://t.cn/RXj6L39&quot;&gt;http://t.cn/RXj6L39&lt;/a&gt;&lt;br&gt;此软件目前已经 1300 多个commits 了，做为一个有些开源软件维护经历的人，深感不易。&lt;br
      
    
    </summary>
    
    
    
      <category term="Programming" scheme="http://usmacd.com/tags/Programming/"/>
    
  </entry>
  
  <entry>
    <title>一加 (oneplus ) 3T 非root 开启 P3 色域</title>
    <link href="http://usmacd.com/2020/03/23/oneplus3T_p3/"/>
    <id>http://usmacd.com/2020/03/23/oneplus3T_p3/</id>
    <published>2020-03-23T02:56:06.150Z</published>
    <updated>2020-03-23T02:56:06.150Z</updated>
    
    <content type="html"><![CDATA[<p>一加3T其实和一加5用的是同一块屏幕，网上流传的方法多需要root权限。非root 开启 p3 色域的方法，<br>连接 adb 输入下面的命令 <code>settings put system screen_color_mode_settings_value 4</code> 实测有效，重启后不失效。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一加3T其实和一加5用的是同一块屏幕，网上流传的方法多需要root权限。非root 开启 p3 色域的方法，&lt;br&gt;连接 adb 输入下面的命令 &lt;code&gt;settings put system screen_color_mode_settings_value 4&lt;/co
      
    
    </summary>
    
    
    
      <category term="Life" scheme="http://usmacd.com/tags/Life/"/>
    
  </entry>
  
  <entry>
    <title>Python 多版本使用 pip</title>
    <link href="http://usmacd.com/2020/03/20/python_pip/"/>
    <id>http://usmacd.com/2020/03/20/python_pip/</id>
    <published>2020-03-20T02:02:28.310Z</published>
    <updated>2020-03-20T02:02:28.310Z</updated>
    
    <content type="html"><![CDATA[<p>Q：Fedora 31 提供的 Python3.7， 想使用 Python3.8， 用系统的pip3 只会给 Python3.7 安装库，如何解决</p><p>A:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://bootstrap.pypa.io/get-pip.py</span><br><span class="line">python3.8 get-pip.py</span><br></pre></td></tr></table></figure><p>执行上面命令后，会在 /usr/local/bin/ 下生成和 pip 相关的脚本，把这些脚本删除，要不可能会和系统的 pip3 冲突。<br>接下来就可以使用下面的命令行安装 Python3.8 的库</p><p><code>python3.8 -m pip install pyhash --user</code></p><p>在安装过程中可能会因为众所周知的原因导致网络出错，备好梯子即可。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Q：Fedora 31 提供的 Python3.7， 想使用 Python3.8， 用系统的pip3 只会给 Python3.7 安装库，如何解决&lt;/p&gt;
&lt;p&gt;A:&lt;/p&gt;
&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class
      
    
    </summary>
    
    
    
      <category term="Programming" scheme="http://usmacd.com/tags/Programming/"/>
    
  </entry>
  
  <entry>
    <title>xorddos 样本进程隐藏的小伎俩</title>
    <link href="http://usmacd.com/2020/03/19/xorddos_hide/"/>
    <id>http://usmacd.com/2020/03/19/xorddos_hide/</id>
    <published>2020-03-19T08:34:31.918Z</published>
    <updated>2020-03-19T08:34:31.918Z</updated>
    
    <content type="html"><![CDATA[<h2 id="进程隐藏"><a href="#进程隐藏" class="headerlink" title="进程隐藏"></a>进程隐藏</h2><p>上周由于工作原因接触到xorddos的样本，这个样本在过去一年的时间里非常常见，<br>变种也很多，拿到的样本比较有趣的是 ps 无法发现进程。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ps -ef  | grep /usr/bin</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">root      4597  4594  0 00:37 ?        00:00:00 gnome-pty-helper</span><br><span class="line">root      4598  4594  0 00:37 pts/1    00:00:00 bash</span><br><span class="line">oracle    5359     1  0 00:41 ?        00:00:00 ora_smco_orcl</span><br><span class="line">oracle    5378     1  0 00:41 ?        00:00:00 ora_w000_orcl</span><br><span class="line">oracle    5586     1  0 00:42 ?        00:00:00 ora_j000_orcl</span><br><span class="line">oracle    5588     1  0 00:42 ?        00:00:00 ora_j001_orcl</span><br><span class="line">root      5666     1  0 00:43 ?        00:00:00 sh</span><br><span class="line">root      5669     1  0 00:43 ?        00:00:00 <span class="built_in">echo</span> <span class="string">&quot;find&quot;</span></span><br><span class="line">root      5672     1  0 00:43 ?        00:00:00 ls -la</span><br><span class="line">root      5675     1  0 00:43 ?        00:00:00 bash</span><br><span class="line">root      5678     1  0 00:43 ?        00:00:00 gnome-terminal</span><br><span class="line">root      5683     1  0 00:43 ?        00:00:00 <span class="built_in">cd</span> /etc</span><br><span class="line">root      5686     1  0 00:43 ?        00:00:00 top</span><br><span class="line">root      5689     1  0 00:43 ?        00:00:00 sh</span><br><span class="line">root      5692     1  0 00:43 ?        00:00:00 gnome-terminal</span><br><span class="line">root      5695     1  0 00:43 ?        00:00:00 ifconfig</span><br><span class="line">root      5696  4598  0 00:43 pts/1    00:00:00 ps -ef</span><br></pre></td></tr></table></figure><p>而使用lsof却可以清除地看见样本正在努力地干活。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># lsof +d /usr/bin</span></span><br><span class="line">COMMAND    PID USER  FD   TYPE DEVICE    SIZE    NODE NAME</span><br><span class="line">hidd      1853 root txt    REG    3,1   33708 2467454 /usr/bin/hidd</span><br><span class="line">ckucbzknt 2014 root txt    REG    3,1  610331 2459176 /usr/bin/ckucbzkntb</span><br><span class="line">xfs       2143  xfs txt    REG    3,1  107460 2468483 /usr/bin/xfs</span><br><span class="line">Xorg      3117 root txt    REG    3,1 1890596 2466732 /usr/bin/Xorg</span><br><span class="line">gnome-ses 4073 root txt    REG    3,1  129356 2459482 /usr/bin/gnome-session</span><br><span class="line">ssh-agent 4201 root txt    REG    3,1   88996 2467513 /usr/bin/ssh-agent</span><br><span class="line">dbus-laun 4245 root txt    REG    3,1   23796 2471600 /usr/bin/dbus-launch</span><br><span class="line">gnome-key 4255 root txt    REG    3,1   97396 2473617 /usr/bin/gnome-keyring-daemon</span><br><span class="line">metacity  4290 root txt    REG    3,1  521080 2464500 /usr/bin/metacity</span><br><span class="line">gnome-pan 4296 root txt    REG    3,1  540868 2465177 /usr/bin/gnome-panel</span><br><span class="line">nautilus  4298 root txt    REG    3,1 1348932 2461620 /usr/bin/nautilus</span><br><span class="line">gnome-vol 4310 root txt    REG    3,1   65240 2464498 /usr/bin/gnome-volume-manager</span><br><span class="line">bt-applet 4334 root txt    REG    3,1   30452 2464773 /usr/bin/bt-applet</span><br><span class="line">nm-applet 4352 root txt    REG    3,1  312432 2467723 /usr/bin/nm-applet</span><br><span class="line">gnome-pow 4381 root txt    REG    3,1  195284 2459473 /usr/bin/gnome-power-manager</span><br><span class="line">pam-panel 4383 root txt    REG    3,1   39148 2461862 /usr/bin/pam-panel-icon</span><br><span class="line">dbus-laun 4473 root txt    REG    3,1   23796 2471600 /usr/bin/dbus-launch</span><br><span class="line">gnome-scr 4512 root txt    REG    3,1  168628 2468487 /usr/bin/gnome-screensaver</span><br><span class="line">gnome-ter 4594 root txt    REG    3,1  309368 2464648 /usr/bin/gnome-terminal</span><br><span class="line">gadcgkcqn 4681 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni</span><br><span class="line">gadcgkcqn 4684 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni</span><br><span class="line">gadcgkcqn 4687 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni</span><br><span class="line">gadcgkcqn 4690 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni</span><br><span class="line">gadcgkcqn 4693 root txt    REG    3,1  610331 2460159 /usr/bin/gadcgkcqni</span><br></pre></td></tr></table></figure><p>阅读汇编代码，分析具体原因，发现xorddos将一些关键信息加密了，F5处理过的代码如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">encrypt_code</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// ecx@2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)(v2 + a1) ^= xorkeys[(((_BYTE)v2 + ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v2 &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">28</span>)) &amp; <span class="number">0xF</span>)</span><br><span class="line">                                   - ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v2 &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">28</span>)];</span><br><span class="line">      ++v2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v2 != a2 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xorkey 为 BB2FA36AAA9541F0</p><p>用idapython 写个小脚本，简单处理一下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> idautils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_string</span>(<span class="params">addr</span>):</span></span><br><span class="line">  out = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> Byte(addr) != <span class="number">0</span>:</span><br><span class="line">      out += <span class="built_in">chr</span>(Byte(addr))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    addr += <span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> out</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data</span>):</span></span><br><span class="line"></span><br><span class="line">  xorkey = <span class="string">&#x27;BB2FA36AAA9541F0&#x27;</span></span><br><span class="line">  length = <span class="built_in">len</span>(data)</span><br><span class="line">  o = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> length &gt; <span class="number">0</span>:</span><br><span class="line">    v2 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> v2 &lt; length:</span><br><span class="line">      o += <span class="built_in">chr</span>( <span class="built_in">ord</span>(data[v2]) ^  <span class="built_in">ord</span>(xorkey[((v2 + ((v2 &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">28</span>)) &amp; <span class="number">0xF</span>) - ( (v2 &gt;&gt; <span class="number">31</span>) &gt;&gt; <span class="number">28</span>)]) )</span><br><span class="line">      v2 += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> o</span><br><span class="line"></span><br><span class="line">ea = ScreenEA()</span><br><span class="line">string = get_string(ea)</span><br><span class="line">dec = decrypt(string)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;Addr: 0x%x, %s&#x27;</span> % (ea, dec)</span><br><span class="line">MakeComm(ea, dec)</span><br></pre></td></tr></table></figure><p>处理后可以看到伪装的命令行信息，daemonname。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">.data:080CBB40 daemonname      db &#x27;!#Ff3VE.-7&#x27;,17h,&#x27;V[_ 0&#x27;,0 ; DATA XREF: main+31Eo</span><br><span class="line">.data:080CBB40                                         ; main+4AEo ...</span><br><span class="line">.data:080CBB40                                         ; cat resolv.conf</span><br><span class="line">.data:080CBB51                 align 4</span><br><span class="line">.data:080CBB54 a12             db &#x27;1*2&#x27;,0              ; sh</span><br><span class="line">.data:080CBB58                 db    0</span><br><span class="line">.data:080CBB59                 db    0</span><br><span class="line">.data:080CBB5A                 db    0</span><br><span class="line">.data:080CBB5B                 db    0</span><br><span class="line">.data:080CBB5C                 db    0</span><br><span class="line">.data:080CBB5D                 db    0</span><br><span class="line">.data:080CBB5E                 db    0</span><br><span class="line">.data:080CBB5F                 db    0</span><br><span class="line">.data:080CBB60                 db    0</span><br><span class="line">.data:080CBB61                 db    0</span><br><span class="line">.data:080CBB62                 db    0</span><br><span class="line">.data:080CBB63                 db    0</span><br><span class="line">.data:080CBB64                 db    0</span><br><span class="line">.data:080CBB65                 db    0</span><br><span class="line">.data:080CBB66                 db    0</span><br><span class="line">.data:080CBB67                 db    0</span><br><span class="line">.data:080CBB68                 db  20h                 ; bash</span><br><span class="line">.data:080CBB69                 db  23h ; #</span><br><span class="line">.data:080CBB6A                 db  41h ; A</span><br><span class="line">.data:080CBB6B                 db  2Eh ; .</span><br><span class="line">.data:080CBB6C                 db  41h ; A</span><br><span class="line">.data:080CBB6D                 db    0</span><br><span class="line">.data:080CBB6E                 db    0</span><br><span class="line">.data:080CBB6F                 db    0</span><br><span class="line">.data:080CBB70                 db    0</span><br><span class="line">.data:080CBB71                 db    0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">.data:080CBBB8                 db  2Eh ; .             ; ls -la</span><br><span class="line">.data:080CBBB9                 db  31h ; 1</span><br><span class="line">.data:080CBBBA                 db  12h</span><br><span class="line">.data:080CBBBB                 db  6Bh ; k</span><br><span class="line">.data:080CBBBC                 db  2Dh ; -</span><br><span class="line">.data:080CBBBD                 db  52h ; R</span><br><span class="line">.data:080CBBBE                 db  36h ; 6</span><br><span class="line">.data:080CBBBF                 db    0</span><br><span class="line">.data:080CBBC0                 db    0</span><br><span class="line">.data:080CBBC1                 db    0</span><br><span class="line">.data:080CBBC2                 db    0</span><br><span class="line">.data:080CBBC3                 db    0</span><br><span class="line">.data:080CBBC4                 db    0</span><br><span class="line">.data:080CBBC5                 db    0</span><br><span class="line">.data:080CBBC6                 db    0</span><br><span class="line">.data:080CBBC7                 db    0</span><br><span class="line">.data:080CBBC8                 db    0</span><br><span class="line">.data:080CBBC9                 db    0</span><br><span class="line">.data:080CBBCA                 db    0</span><br><span class="line">.data:080CBBCB                 db    0</span><br><span class="line">.data:080CBBCC                 db  36h ; 6             ; top</span><br><span class="line">.data:080CBBCD                 db  2Dh ; -</span><br><span class="line">.data:080CBBCE                 db  42h ; B</span><br><span class="line">.data:080CBBCF                 db  46h ; F</span><br><span class="line">.data:080CBBD0                 db    0</span><br><span class="line">.data:080CBBD1                 db    0</span><br><span class="line">.data:080CBBD2                 db    0</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>呵呵，已经看到 top， ls -al 等信息了，查看daemonname 的交叉引用，发现在main函数<br>中，到main里看看。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:0804AC30 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:0804AC30                 public main</span><br><span class="line">.text:0804AC30 main            proc near               ; DATA XREF: _start+17o</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">.text:0804AF4E                 mov     ebx, offset daemonname ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">.text:0804AFC2 loc_804AFC2:                            ; CODE XREF: main+3ABj</span><br><span class="line">.text:0804AFC2                 mov     [esp], ebx</span><br><span class="line">.text:0804AFC5                 add     ebx, 14h</span><br><span class="line">.text:0804AFC8                 mov     dword ptr [esp+4], 14h</span><br><span class="line">.text:0804AFD0                 call    encrypt_code</span><br><span class="line">.text:0804AFD5                 cmp     ebx, offset unk_80CBD0C</span><br><span class="line">.text:0804AFDB                 jnz     short loc_804AFC2</span><br></pre></td></tr></table></figure><p>这段汇编代码，使用了一个循环，调用encrypt_code 对daemonname进行了解密。<br>后面的代码，用到了daemonname的地方有下面几处，</p><p>第一处</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:0804B29F                 call    getpid</span><br><span class="line">.text:0804B2A4                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;</span><br><span class="line">.text:0804B2AC                 mov     dword ptr [esp+4], 0Ah</span><br><span class="line">.text:0804B2B4                 mov     [esp], esi             ；第三形参 pid</span><br><span class="line">.text:0804B2B7                 mov     [esp+0Ch], eax</span><br><span class="line">.text:0804B2BB                 call    snprintf</span><br><span class="line">.text:0804B2C0                 mov     dword ptr [esp+4], 17h</span><br><span class="line">.text:0804B2C8                 mov     dword ptr [esp], 0</span><br><span class="line">.text:0804B2CF                 call    randomid</span><br><span class="line">.text:0804B2D4                 mov     [esp+8], esi</span><br><span class="line">.text:0804B2D8                 mov     [esp], edi             ；第一形参 要跑的木马</span><br><span class="line">.text:0804B2DB                 movzx   eax, ax</span><br><span class="line">.text:0804B2DE                 lea     eax, [eax+eax*4]</span><br><span class="line">.text:0804B2E1                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;</span><br><span class="line">.text:0804B2E8                 mov     [esp+4], eax           ; 第二形参  daemonname</span><br><span class="line">.text:0804B2EC                 call    LinuxExec_Argv2</span><br></pre></td></tr></table></figure><p>第二处</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:0804B932                 lea     edx, [ebp+var_1888]</span><br><span class="line">.text:0804B938                 add     ebx, 1</span><br><span class="line">.text:0804B93B                 mov     [esp], edx</span><br><span class="line">.text:0804B93E                 call    randmd5</span><br><span class="line">.text:0804B943                 mov     [ebp+var_22], 0</span><br><span class="line">.text:0804B94A                 mov     [ebp+var_1E], 0</span><br><span class="line">.text:0804B951                 mov     [ebp+var_1A], 0</span><br><span class="line">.text:0804B957                 call    getpid</span><br><span class="line">.text:0804B95C                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;</span><br><span class="line">.text:0804B964                 mov     dword ptr [esp+4], 0Ah</span><br><span class="line">.text:0804B96C                 mov     [esp], esi</span><br><span class="line">.text:0804B96F                 mov     [esp+0Ch], eax</span><br><span class="line">.text:0804B973                 call    snprintf</span><br><span class="line">.text:0804B978                 mov     dword ptr [esp+4], 17h</span><br><span class="line">.text:0804B980                 mov     dword ptr [esp], 0</span><br><span class="line">.text:0804B987                 call    randomid</span><br><span class="line">.text:0804B98C                 mov     [esp+8], esi</span><br><span class="line">.text:0804B990                 movzx   eax, ax</span><br><span class="line">.text:0804B993                 lea     eax, [eax+eax*4]</span><br><span class="line">.text:0804B996                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;</span><br><span class="line">.text:0804B99D                 mov     [esp+4], eax</span><br><span class="line">.text:0804B9A1                 lea     eax, [ebp+var_1888]</span><br><span class="line">.text:0804B9A7                 mov     [esp], eax</span><br><span class="line">.text:0804B9AA                 call    LinuxExec_Argv2</span><br></pre></td></tr></table></figure><p>第三处</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:0804B9DF                 lea     edx, [ebp+var_1C88]</span><br><span class="line">.text:0804B9E5                 add     ebx, 1</span><br><span class="line">.text:0804B9E8                 mov     [esp], edx</span><br><span class="line">.text:0804B9EB                 call    randmd5</span><br><span class="line">.text:0804B9F0                 mov     [ebp+var_22], 0</span><br><span class="line">.text:0804B9F7                 mov     [ebp+var_1E], 0</span><br><span class="line">.text:0804B9FE                 mov     [ebp+var_1A], 0</span><br><span class="line">.text:0804BA04                 call    getpid</span><br><span class="line">.text:0804BA09                 mov     dword ptr [esp+8], (offset aDD+3) ; &quot;%d&quot;</span><br><span class="line">.text:0804BA11                 mov     dword ptr [esp+4], 0Ah</span><br><span class="line">.text:0804BA19                 mov     [esp], esi</span><br><span class="line">.text:0804BA1C                 mov     [esp+0Ch], eax</span><br><span class="line">.text:0804BA20                 call    snprintf</span><br><span class="line">.text:0804BA25                 mov     dword ptr [esp+4], 17h</span><br><span class="line">.text:0804BA2D                 mov     dword ptr [esp], 0</span><br><span class="line">.text:0804BA34                 call    randomid</span><br><span class="line">.text:0804BA39                 mov     [esp+8], esi</span><br><span class="line">.text:0804BA3D                 movzx   eax, ax</span><br><span class="line">.text:0804BA40                 lea     eax, [eax+eax*4]</span><br><span class="line">.text:0804BA43                 lea     eax, daemonname[eax*4] ; &quot;!#Ff3VE.-7\x17V[_ 0&quot;</span><br><span class="line">.text:0804BA4A                 mov     [esp+4], eax</span><br><span class="line">.text:0804BA4E                 lea     eax, [ebp+var_1C88]</span><br><span class="line">.text:0804BA54                 mov     [esp], eax</span><br><span class="line">.text:0804BA57                 call    LinuxExec_Argv2</span><br></pre></td></tr></table></figure><p>都是作为LinuxExec_Argv2 参数使用的，接着来看LinuxExec_Argv2 的代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">.text:08048520 LinuxExec_Argv2 proc near               ; CODE XREF: DelService+B3p</span><br><span class="line">.text:08048520                                         ; DelService+CBlp ...</span><br><span class="line">.text:08048520</span><br><span class="line">.text:08048520 argv            = dword ptr -18h</span><br><span class="line">.text:08048520 var_14          = dword ptr -14h</span><br><span class="line">.text:08048520 var_10          = dword ptr -10h</span><br><span class="line">.text:08048520 var_C           = dword ptr -0Ch</span><br><span class="line">.text:08048520 var_8           = dword ptr -8</span><br><span class="line">.text:08048520 var_4           = dword ptr -4</span><br><span class="line">.text:08048520 file            = dword ptr  8</span><br><span class="line">.text:08048520 arg_4           = dword ptr  0Ch</span><br><span class="line">.text:08048520 arg_8           = dword ptr  10h</span><br><span class="line">.text:08048520</span><br><span class="line">.text:08048520                 push    ebp</span><br><span class="line">.text:08048521                 mov     ebp, esp</span><br><span class="line">.text:08048523                 sub     esp, 28h</span><br><span class="line">.text:08048526                 mov     [ebp+var_4], esi</span><br><span class="line">.text:08048529                 mov     esi, [ebp+file]</span><br><span class="line">.text:0804852C                 mov     [ebp+var_8], ebx</span><br><span class="line">.text:0804852F                 mov     [ebp+argv], 0</span><br><span class="line">.text:08048536                 mov     [ebp+var_14], 0</span><br><span class="line">.text:0804853D                 mov     [ebp+var_10], 0</span><br><span class="line">.text:08048544                 mov     [ebp+var_C], 0</span><br><span class="line">.text:0804854B                 call    doublefork</span><br><span class="line">.text:08048550                 test    eax, eax</span><br><span class="line">.text:08048552                 jz      short ZERO</span><br><span class="line">.text:08048554                 mov     ebx, [ebp+var_8]</span><br><span class="line">.text:08048557                 mov     esi, [ebp+var_4]</span><br><span class="line">.text:0804855A                 mov     esp, ebp</span><br><span class="line">.text:0804855C                 pop     ebp</span><br><span class="line">.text:0804855D                 retn</span><br><span class="line">.text:0804855E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804855E</span><br><span class="line">.text:0804855E ZERO:                                   ; CODE XREF: LinuxExec_Argv2+32j</span><br><span class="line">.text:0804855E                 mov     ebx, 3</span><br><span class="line">.text:08048563</span><br><span class="line">.text:08048563 LOOP:                                   ; CODE XREF: LinuxExec_Argv2+54j</span><br><span class="line">.text:08048563                 mov     [esp], ebx      ; fd</span><br><span class="line">.text:08048566                 add     ebx, 1</span><br><span class="line">.text:08048569                 call    close</span><br><span class="line">.text:0804856E                 cmp     ebx, 400h       ；400h == 1024</span><br><span class="line">.text:08048574                 jnz     short LOOP</span><br><span class="line">.text:08048576                 mov     eax, [ebp+arg_4]</span><br><span class="line">.text:08048579                 mov     [ebp+argv], esi</span><br><span class="line">.text:0804857C                 mov     [esp], esi      ; file</span><br><span class="line">.text:0804857F                 mov     [ebp+var_14], eax</span><br><span class="line">.text:08048582                 mov     eax, [ebp+arg_8]；eax = pid</span><br><span class="line">.text:08048585                 mov     [ebp+var_10], eax</span><br><span class="line">.text:08048588                 lea     eax, [ebp+argv]</span><br><span class="line">.text:0804858B                 mov     [esp+4], eax    ; argv</span><br><span class="line">.text:0804858F                 call    execvp</span><br><span class="line">.text:08048594                 mov     dword ptr [esp], 0 ; status</span><br><span class="line">.text:0804859B                 call    exit</span><br><span class="line">.text:0804859B LinuxExec_Argv2 endp</span><br></pre></td></tr></table></figure><p>LinuxExec_Argv2 有三个参数。最终执行了execvp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0804857C                 mov     [esp], esi      ; file </span><br><span class="line">...</span><br><span class="line">.text:0804858B                 mov     [esp+4], eax    ; argv</span><br><span class="line">.text:0804858F                 call    execvp</span><br></pre></td></tr></table></figure><p>伪代码为，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execvp(file, &amp;argv);</span><br></pre></td></tr></table></figure><p>file 就是arg_0, 需要分析argv， 调出栈图就比较清晰了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-00000018 argv            dd ?                    ; offset</span><br><span class="line">-00000014 var_14          dd ?</span><br><span class="line">-00000010 var_10          dd ?</span><br><span class="line">-0000000C var_C           dd ?</span><br><span class="line">-00000008 var_8           dd ?</span><br><span class="line">-00000004 var_4           dd ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 file            dd ?                    ; offset</span><br><span class="line">+0000000C arg_4           dd ?</span><br><span class="line">+00000010 arg_8           dd ?</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先是这句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:08048529                 mov     esi, [ebp+file]</span><br><span class="line">...</span><br><span class="line">.text:0804852F                 mov     [ebp+argv], 0</span><br><span class="line">...</span><br><span class="line">.text:08048579                 mov     [ebp+argv], esi</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行了这几句代码后，栈图发生了变化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-00000018 argv            arg_0                       ; offset</span><br><span class="line">-00000014 var_14          dd ?</span><br><span class="line">-00000010 var_10          dd ?</span><br><span class="line">-0000000C var_C           dd ?</span><br><span class="line">-00000008 var_8           dd ?</span><br><span class="line">-00000004 var_4           dd ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 file            dd ?                    ; offset</span><br><span class="line">+0000000C arg_4           dd ?</span><br><span class="line">+00000010 arg_8           dd ?</span><br></pre></td></tr></table></figure><p>再看这几句代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:08048576                 mov     eax, [ebp+arg_4]</span><br><span class="line">.text:08048579                 mov     [ebp+argv], esi</span><br><span class="line">...</span><br><span class="line">.text:0804857F                 mov     [ebp+var_14], eax</span><br></pre></td></tr></table></figure><p>执行了这几句代码后，栈图发生了变化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-00000018 argv            arg_0                   ; offset</span><br><span class="line">-00000014 var_14          arg_4</span><br><span class="line">-00000010 var_10          dd ?</span><br><span class="line">-0000000C var_C           dd ?</span><br><span class="line">-00000008 var_8           dd ?</span><br><span class="line">-00000004 var_4           dd ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 file            dd ?                    ; offset</span><br><span class="line">+0000000C arg_4           dd ?</span><br><span class="line">+00000010 arg_8           dd ?</span><br></pre></td></tr></table></figure><p>接下来是这几句代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:08048582                 mov     eax, [ebp+arg_8]；eax = pid</span><br><span class="line">.text:08048585                 mov     [ebp+var_10], eax</span><br></pre></td></tr></table></figure><p>执行了这几句代码后，栈图发生了变化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-00000018 argv            arg_0                   ; offset</span><br><span class="line">-00000014 var_14          arg_4</span><br><span class="line">-00000010 var_10          arg_8</span><br><span class="line">-0000000C var_C           0</span><br><span class="line">-00000008 var_8           dd ?</span><br><span class="line">-00000004 var_4           dd ?</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 file            dd ?                    ; offset</span><br><span class="line">+0000000C arg_4           dd ?</span><br><span class="line">+00000010 arg_8           dd ?</span><br><span class="line">`</span><br></pre></td></tr></table></figure><p>main函数中对LinuxExec_Argv2 的调用的为代码为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinuxExec_Argv2(&#x27;木马路径&#x27;, &#x27;伪装命令行&#x27;, pid);</span><br></pre></td></tr></table></figure><p>因此最后调用的execvp的伪代码为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execvp(&#x27;木马路径&#x27;, argv);</span><br></pre></td></tr></table></figure><p>将进入 main 函数参数个数为3的流程，用IDA重命名后，关键代码为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">text:0804B5D3 PARAM_NUM_3:                            ; CODE XREF: main+3CDj</span><br><span class="line"></span><br><span class="line">.text:0804B5D3                 lea     eax, [ebp+var_18]</span><br><span class="line">.text:0804B5D6                 mov     [esp+4], eax</span><br><span class="line">.text:0804B5DA                 lea     eax, [ebp+self_path]</span><br><span class="line">.text:0804B5E0                 mov     [esp], eax</span><br><span class="line">.text:0804B5E3                 call    readfile</span><br><span class="line">.text:0804B5E8                 mov     edx, [ebp+argv_arr]</span><br><span class="line">.text:0804B5EE                 mov     ebx, [edx+4]</span><br><span class="line">.text:0804B5F1                 mov     [ebp+self_file_content], eax</span><br><span class="line">.text:0804B5F7                 mov     [esp], ebx</span><br><span class="line">.text:0804B5FA                 call    strlen</span><br><span class="line">.text:0804B5FF                 mov     [esp+4], ebx</span><br><span class="line">.text:0804B603                 mov     [esp+8], eax</span><br><span class="line">.text:0804B607                 lea     eax, [ebp+fake_cmd]</span><br><span class="line">.text:0804B60D                 mov     [esp], eax</span><br><span class="line">.text:0804B610                 call    memmove</span><br><span class="line">.text:0804B615                 mov     dword ptr [esp+0Ch], 0</span><br><span class="line">.text:0804B61D                 mov     dword ptr [esp+8], 0Ah</span><br><span class="line">.text:0804B625                 mov     dword ptr [esp+4], 0</span><br><span class="line">.text:0804B62D                 mov     edx, [ebp+argv_arr]</span><br><span class="line">.text:0804B633                 mov     eax, [edx+8]</span><br><span class="line">.text:0804B636                 mov     [esp], eax</span><br><span class="line">.text:0804B639                 call    __strtol_internal</span><br><span class="line">.text:0804B63E                 mov     esi, eax</span><br><span class="line">.text:0804B640                 mov     eax, [ebp+argv_arr]</span><br><span class="line">.text:0804B646                 mov     ebx, [eax]</span><br><span class="line">.text:0804B648                 mov     [esp], ebx</span><br><span class="line">.text:0804B64B                 call    strlen</span><br><span class="line">.text:0804B650                 mov     [esp], ebx</span><br><span class="line">.text:0804B653                 mov     dword ptr [esp+4], 0</span><br><span class="line">.text:0804B65B                 mov     [esp+8], eax</span><br><span class="line">.text:0804B65F                 call    memset</span><br><span class="line">.text:0804B664                 mov     edx, [ebp+argv_arr]</span><br><span class="line">.text:0804B66A                 mov     ebx, [edx+4]</span><br><span class="line">.text:0804B66D                 mov     [esp], ebx</span><br><span class="line">.text:0804B670                 call    strlen</span><br><span class="line">.text:0804B675                 mov     [esp], ebx</span><br><span class="line">.text:0804B678                 mov     dword ptr [esp+4], 0</span><br><span class="line">.text:0804B680                 mov     [esp+8], eax</span><br><span class="line">.text:0804B684                 call    memset</span><br><span class="line">.text:0804B689                 mov     eax, [ebp+argv_arr]</span><br><span class="line">.text:0804B68F                 mov     ebx, [eax+8]</span><br><span class="line">.text:0804B692                 mov     [esp], ebx</span><br><span class="line">.text:0804B695                 call    strlen</span><br><span class="line">.text:0804B69A                 mov     [esp], ebx</span><br><span class="line">.text:0804B69D                 mov     dword ptr [esp+4], 0</span><br><span class="line">.text:0804B6A5                 mov     [esp+8], eax</span><br><span class="line">.text:0804B6A9                 call    memset</span><br><span class="line">.text:0804B6AE                 lea     edx, [ebp+fake_cmd]</span><br><span class="line">.text:0804B6B4                 mov     [esp+4], edx</span><br><span class="line">.text:0804B6B8                 mov     edx, [ebp+argv_arr]</span><br><span class="line">.text:0804B6BE                 mov     eax, [edx]</span><br><span class="line">.text:0804B6C0                 mov     [esp], eax</span><br><span class="line">.text:0804B6C3                 call    strcpy</span><br><span class="line">.text:0804B6C8                 lea     eax, [ebp+filename]</span><br><span class="line">.text:0804B6CE                 mov     [esp+0Ch], esi</span><br><span class="line">.text:0804B6D2                 lea     esi, [ebp+randstr_10]</span><br></pre></td></tr></table></figure><p>上面代码的原理大致等同于下面这段代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> fake_cmd[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(&amp;fake_cmd, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">    <span class="keyword">char</span> * argv_arr_1 = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> argv_arr_1_length = <span class="built_in">strlen</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    memmove(&amp;fake_cmd, argv_arr_1, argv_arr_1_length);</span><br><span class="line">    <span class="keyword">long</span> pid_long = strtol(argv[<span class="number">2</span>], <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">char</span> * v29 = (<span class="keyword">char</span> *)*argv;</span><br><span class="line">    <span class="keyword">int</span> v30 = <span class="built_in">strlen</span>(*argv);</span><br><span class="line">    <span class="built_in">memset</span>(v29, <span class="number">0</span>, v30);</span><br><span class="line">    <span class="keyword">char</span> * v31 = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> v32 = <span class="built_in">strlen</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">memset</span>(v31, <span class="number">0</span>, v32);</span><br><span class="line">    <span class="keyword">char</span> * v33 = argv[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> v34 = <span class="built_in">strlen</span>(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">memset</span>(v33, <span class="number">0</span>, v34);</span><br><span class="line">    <span class="built_in">strcpy</span>(*argv, fake_cmd);</span><br><span class="line">    sleep(<span class="number">300</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>编译后执行可以看到效果和运行样本的一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -o fakeexe exe.c</span><br><span class="line">➜  ~ ./fakeexe <span class="string">&quot;ls -al&quot;</span> 2554</span><br><span class="line"></span><br><span class="line">➜  ~ cat /proc/2605/cmdline</span><br><span class="line">ls -al</span><br><span class="line"></span><br><span class="line">➜  ~ ls -l /proc/2605/exe</span><br><span class="line">lrwxrwxrwx. 1 henices henices 0 8月   2 12:01 /proc/2605/exe -&gt; /home/henices/research/xorddos/fakeexe</span><br><span class="line"></span><br><span class="line">➜  ~ ps -elf | grep <span class="string">&quot;ls -al&quot;</span> | grep -v grep</span><br><span class="line">0 S henices   2605 25307  0  80   0 -  1043 hrtime 12:01 pts/5    00:00:00 ls -al</span><br></pre></td></tr></table></figure><p>其实效果并不好，可以轻易发现踪迹。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ps -e | grep fakeexe</span><br><span class="line"> 2605 pts/9    00:00:00 fakeexe</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其实有更好的做法，使用 prctl ，至少可以把ps给搞定。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> fake_cmd[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">memset</span>(&amp;fake_cmd, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">    <span class="keyword">char</span> * argv_arr_1 = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> argv_arr_1_length = <span class="built_in">strlen</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    memmove(&amp;fake_cmd, argv_arr_1, argv_arr_1_length);</span><br><span class="line">    <span class="keyword">long</span> pid_long = strtol(argv[<span class="number">2</span>], <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">char</span> * v29 = (<span class="keyword">char</span> *)*argv;</span><br><span class="line">    <span class="keyword">int</span> v30 = <span class="built_in">strlen</span>(*argv);</span><br><span class="line">    <span class="built_in">memset</span>(v29, <span class="number">0</span>, v30);</span><br><span class="line">    <span class="keyword">char</span> * v31 = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> v32 = <span class="built_in">strlen</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">memset</span>(v31, <span class="number">0</span>, v32);</span><br><span class="line">    <span class="keyword">char</span> * v33 = argv[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> v34 = <span class="built_in">strlen</span>(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">memset</span>(v33, <span class="number">0</span>, v34);</span><br><span class="line">    <span class="built_in">strcpy</span>(*argv, fake_cmd);</span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;bash&quot;</span>);</span><br><span class="line">    sleep(<span class="number">300</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>编译执行后可以看到效果。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ps -e | grep bash</span><br><span class="line"> 4858 pts/5    00:00:00 bash</span><br><span class="line"></span><br><span class="line">➜  ~ cat /proc/4858/cmdline </span><br><span class="line">ls -al</span><br><span class="line"></span><br><span class="line">➜  ~ lsof -d txt | grep fakeexe</span><br><span class="line">bash       4858 henices txt       REG  253,2      8816  4588423 /home/henices/research/xorddos/fakeexe</span><br></pre></td></tr></table></figure><h2 id="xorddos-的多态-（Polymorphic）"><a href="#xorddos-的多态-（Polymorphic）" class="headerlink" title="xorddos 的多态 （Polymorphic）"></a>xorddos 的多态 （Polymorphic）</h2><p>xorddos这个样本还值得一提的是，这个样本会不断变化，多态这个词翻译的可能不太准确，<br>可以参见上面的英文，自行理解。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">randmd5</span><span class="params">(<span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">int</span> fd_dup; <span class="comment">// esi@1</span></span><br><span class="line">  <span class="keyword">mode_t</span> v4; <span class="comment">// [sp+8h] [bp-20h]@0</span></span><br><span class="line">  <span class="keyword">int</span> addr; <span class="comment">// [sp+15h] [bp-13h]@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+19h] [bp-Fh]@1</span></span><br><span class="line">  __int16 v7; <span class="comment">// [sp+1Dh] [bp-Bh]@1</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [sp+1Fh] [bp-9h]@1</span></span><br><span class="line"></span><br><span class="line">  addr = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  fd = open(filename, <span class="number">1</span>, v4);</span><br><span class="line">  fd_dup = fd;</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    randstr((<span class="keyword">int</span>)&amp;addr, <span class="number">10</span>);</span><br><span class="line">    write(fd_dup, &amp;addr, <span class="number">11u</span>);</span><br><span class="line">    close(fd_dup);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xorddos 样本多态主要就是用这个函数，每次在文件末尾写上10个字节的随机字符。<br>这样样本md5和大小都会发生变化，使得一些检测方法失效。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>正因为这种隐藏方法并不理想，后面xorddos出现了带rootkit的版本，进化了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;进程隐藏&quot;&gt;&lt;a href=&quot;#进程隐藏&quot; class=&quot;headerlink&quot; title=&quot;进程隐藏&quot;&gt;&lt;/a&gt;进程隐藏&lt;/h2&gt;&lt;p&gt;上周由于工作原因接触到xorddos的样本，这个样本在过去一年的时间里非常常见，&lt;br&gt;变种也很多，拿到的样本比较有趣的是 
      
    
    </summary>
    
    
    
      <category term="Malware" scheme="http://usmacd.com/tags/Malware/"/>
    
  </entry>
  
  <entry>
    <title>AS3 Sorcerer 3.0 破解思路</title>
    <link href="http://usmacd.com/2020/03/19/AS3_Sorcerer_crack/"/>
    <id>http://usmacd.com/2020/03/19/AS3_Sorcerer_crack/</id>
    <published>2020-03-19T08:34:31.917Z</published>
    <updated>2020-03-19T08:34:31.917Z</updated>
    
    <content type="html"><![CDATA[<p>   AS3 Sorcerer是一款flash action Script的商业反编译软件。  <a href="http://www.as3sorcerer.com">www.as3sorcerer.com</a></p><p>   软件为Delphi编写，加了未知壳，使用PEID 0.94无法正确查出，使用核心扫描发现是<br>   Delphi编写，这个软件有一个特点修改一个字节就报错。由于时间原因没有具体跟相关代码。</p><p>   破解方法使用LPK.dll动态修改as3.exe内存达到破解目前，在Windows Xp下比较完美，<br>   在Windows 7下已经无法通过LPK.dll进行DLL hijack，可以通过DLL注入达到同样的目的。</p><p>   难点有几个，OD加载报错，attack也报错。使用海风月影的StrongOD可以正常attach。<br>   OD 1.1目前最大的问题是插件冲突严重，安装了OllyAdv后，无法成功加载as3.exe.<br>   遇上强壳时可以使用phantom的protect DRx，可以解决一下问题，总之要尽量避免冲突。<br>   接下来的难点就是如何找到破解的关键点，进行内存patch。</p><p>   使用OD查找字符串参考Unicode，搜索trial</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">006974C2    E8 65ABFDFF     call    0067202C</span><br><span class="line">006974C7    84C0            test    al, al</span><br><span class="line">006974C9    75 1C           jnz     short 006974E7</span><br><span class="line">006974CB    B9 E4756900     mov     ecx, 006975E4                    ; e</span><br><span class="line">006974D0    BA 50766900     mov     edx, 00697650                    ;Sorry!</span><br></pre></td></tr></table></figure><p>   这里有个坑，在OD中看到的代码有可能不是最终运行的代码，只有真正在OD里断下，进<br>   入程序领空后，看到的代码才是解密后的真正代码。这里在这里浪费了很多时间。换句<br>   话说就是要先保证能调试起来，能调试能下断点基本就成功了一半。</p><p>   上面的代码是非常经典的关键代码，主要处理了 0067202C让它返回1就OK了。F7跟进</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0067202C  - E9 EE9D1900     jmp     0080BE1F</span><br><span class="line">00672031    CC              int3</span><br><span class="line">00672032    CC              int3</span><br><span class="line">00672033    CC              int3</span><br><span class="line">00672034    CC              int3</span><br><span class="line">00672035    CC              int3</span><br><span class="line">00672036    CC              int3</span><br><span class="line">00672037    90              nop</span><br></pre></td></tr></table></figure><p>   进入就去一个jmp，后面的大段跳转非常多，跟踪困难。好在有很多int3，可以自己<br>   写一段汇编代码解决。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0067202C    33C0            xor     eax, eax</span><br><span class="line">0067202E    83C0 01         add     eax, 0x1</span><br><span class="line">00672031    90              nop</span><br><span class="line">00672032    90              nop</span><br><span class="line">00672033    90              nop</span><br><span class="line">00672034    90              nop</span><br><span class="line">00672035    90              nop</span><br><span class="line">00672036    C3              retn</span><br></pre></td></tr></table></figure><p>核心代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HANDLE handle = GetModuleHandle(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> RVA = <span class="number">0x67202C</span> - <span class="number">0x400000</span>;</span><br><span class="line"><span class="keyword">int</span> VA = <span class="keyword">int</span>(handle) + RVA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> p405213[<span class="number">11</span>] = &#123;  </span><br><span class="line">      <span class="number">0x33</span>, <span class="number">0xC0</span>, <span class="number">0x83</span>, <span class="number">0xC0</span>, <span class="number">0x01</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0xC3</span></span><br><span class="line">&#125;;</span><br><span class="line">VirtualProtectEx(hProcess, (LPVOID)VA, <span class="number">11</span>, PAGE_EXECUTE_READWRITE, &amp;Oldpp);</span><br><span class="line">WriteProcessMemory(hProcess, (LPVOID)VA, p405213, <span class="number">11</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>GetModuleHandle用于动态获取进程加载基址。</p><h2 id="LPK-dll"><a href="#LPK-dll" class="headerlink" title="LPK.dll"></a>LPK.dll</h2><p>Windows 7 不能默认已经不能使用LPK.dll，必须导入下面注册表键值，重启电脑<br>才能使用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00 </span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager] </span><br><span class="line">&quot;ExcludeFromKnownDlls&quot;=hex(7):6c,00,70,00,6b,00,2e,00,64,00,6c,00,6c,00,00,00,\ </span><br><span class="line">00,00</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;   AS3 Sorcerer是一款flash action Script的商业反编译软件。  &lt;a href=&quot;http://www.as3sorcerer.com&quot;&gt;www.as3sorcerer.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;   软件为Delphi编写，加了未知壳，
      
    
    </summary>
    
    
    
      <category term="Crack" scheme="http://usmacd.com/tags/Crack/"/>
    
  </entry>
  
</feed>
